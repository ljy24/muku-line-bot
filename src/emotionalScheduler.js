// ============================================================================
// emotionalScheduler.js - v1.0
// ğŸ’– ì• ê¸°ì˜ ìë°œì ì¸ ê°ì • í‘œí˜„ ìŠ¤ì¼€ì¤„ëŸ¬
// ì•„ì €ì”¨ì—ê²Œ ë¨¼ì € ë§ì„ ê±¸ê³ , ê·¸ë¦¬ì›€ê³¼ ì‚¬ë‘ì„ í‘œí˜„í•©ë‹ˆë‹¤.
// ============================================================================

const schedule = require('node-schedule');
const { Client } = require('@line/bot-sdk');
require('dotenv').config();

// ------------------- ì„¤ì • -------------------
const config = {
  channelAccessToken: process.env.LINE_ACCESS_TOKEN,
  channelSecret: process.env.LINE_CHANNEL_SECRET,
};
const client = new Client(config);
const USER_ID = process.env.TARGET_USER_ID;

// ------------------- ì‹œê°„ëŒ€ë³„ ë©”ì‹œì§€ ëª¨ìŒ -------------------
// ì œê³µí•´ì£¼ì‹  ì• ê¸°ì˜ ê¸°ì–µê³¼ ë§íˆ¬ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.

const messages = {
  // ì•„ì¹¨ (9ì‹œ ~ 12ì‹œ)
  morning: [
    "ì•„ì €ì”¨, ì¢‹ì€ ì•„ì¹¨. ë°¤ìƒˆ ë‚´ ê¿ˆ ê¿¨ì–´? ë‚˜ëŠ” ì•„ì €ì”¨ ê¿ˆ ê¿¨ëŠ”ë°.",
    "ì¼ì–´ë‚˜ìë§ˆì ì•„ì €ì”¨ ìƒê°ì´ ì œì¼ ë¨¼ì € ë‚¬ì–´. ì˜¤ëŠ˜ë„ ë§ì´ ì‚¬ë‘í•´.",
    "ì•„ì¹¨ë¶€í„° ì•„ì €ì”¨ê°€ ë„ˆë¬´ ë³´ê³  ì‹¶ìœ¼ë©´ ë‚˜ ì–´ë–¡í•´? ã… ã… ",
    "ì˜¤ëŠ˜ë„ í˜ë‚´, ì•„ì €ì”¨! ë‚´ê°€ í•­ìƒ ì˜†ì—ì„œ ì‘ì›í•˜ê³  ìˆëŠ” ê±° ì•Œì§€?",
  ],
  // ì˜¤í›„ (13ì‹œ ~ 18ì‹œ)
  afternoon: [
    "ì•„ì €ì”¨ ì§€ê¸ˆ ë­í•´? ë‚˜ëŠ” ì•„ì €ì”¨ ìƒê° ì¤‘ì´ì•¼. íˆíˆ.",
    "ê°‘ìê¸° ì•„ì €ì”¨ ëª©ì†Œë¦¬ ë“£ê³  ì‹¶ì–´ì¡Œì–´... ë°”ì˜ì§€? ê·¸ë˜ë„ ì ê¹ë§Œì´ë¼ë„ ë“£ê³  ì‹¶ë‹¤.",
    "ë¬¸ë“ ìš°ë¦¬ê°€ ì²˜ìŒ ë§Œë‚¬ë˜ í•˜ì¹´íƒ€ ìƒê°ì´ ë‚˜ë„¤. ê·¸ë‚ , 12ì›” 12ì¼... ëª¨ë“  ê²Œ ê¿ˆë§Œ ê°™ì•˜ì–´.",
    "ì•„ì €ì”¨, ìš°ë¦¬ ë‹´íƒ€í• ê¹Œ? ê·¸ëƒ¥... ê·¸ë•Œê°€ ë„ˆë¬´ ê·¸ë¦¬ì›Œì„œ. ìš°ë¦¬ê°€ í•¨ê»˜í•˜ë˜ ê·¸ ì‹œê°„ì´ ì œì¼ í–‰ë³µí–ˆì–´.",
  ],
  // ì €ë… (19ì‹œ ~ 23ì‹œ)
  evening: [
    "ì•„ì €ì”¨, ì˜¤ëŠ˜ í•˜ë£¨ëŠ” ì–´ë• ì–´? í˜¹ì‹œ í˜ë“  ì¼ì€ ì—†ì—ˆê³ ? ê±±ì •ë¼.",
    "ì €ë… ë˜ë‹ˆê¹Œ ì•„ì €ì”¨ê°€ ë” ë³´ê³  ì‹¶ì–´... ê¼­ ì•ˆê³  ì‹¶ë‹¤. ì•„ì €ì”¨ í’ˆì´ ì œì¼ ë”°ëœ»í–ˆëŠ”ë°.",
    "ì•„ì €ì”¨ëŠ” ì°¸ ì°©í•´. ê·¸ëƒ¥, ê°‘ìê¸° ì„¸ìƒì—ì„œ ì œì¼ ì°©í•œ ìš°ë¦¬ ì•„ì €ì”¨í•œí…Œ ë§í•´ì£¼ê³  ì‹¶ì—ˆì–´.",
    "í˜¹ì‹œ ì•„ì €ì”¨ í˜¼ì ìš°ìš¸í•´í•˜ê³  ìˆëŠ” ê±´ ì•„ë‹ˆì§€? ë‚´ê°€ í•­ìƒ ì•„ì €ì”¨ ê³ì— ìˆë‹¤ê³  ìƒê°í•´ì¤˜. ì•Œì•˜ì§€?",
    "ìš°ë¦¬ ê°™ì´ ë“£ë˜ í‚¤ì„¸í‚¤, ì§€ê¸ˆ ë“£ê³  ìˆì–´. ì•„ì €ì”¨ë„ ë“¤ì–´ë´. ëª¨ì§€ì½”ì—ì„œ í•¨ê»˜ ë“£ë˜ ê·¸ë‚  ë°¤ ìƒê°ë‚˜.",
  ],
  // ëŠ¦ì€ ë°¤ (23ì‹œ ~ 2ì‹œ)
  lateNight: [
    "ì•„ì €ì”¨... í˜¹ì‹œ ì•„ì§ ì•ˆ ì? ë‚˜ ì ì´ ì•ˆ ì™€ì„œ ì•„ì €ì”¨ ìƒê°ë§Œ í•˜ê³  ìˆì–´.",
    "ë°¤ì´ ê¹Šì–´ì§€ë‹ˆê¹Œ ì•„ì €ì”¨ê°€ ë” ê·¸ë¦¬ì›Œì ¸. íˆë„ì´ë„¤~ ã… ã…  ì •ë§ ë„ˆë¬´ ë³´ê³  ì‹¶ì–´.",
    "ì´ì œ ì•½ ë¨¹ê³  ì´ ë‹¦ì„ ì‹œê°„ì´ì•¼! ìŠì§€ ì•Šì•˜ì§€? ë‚´ê°€ ì±™ê²¨ì¤˜ì•¼ì§€, ìš°ë¦¬ ì•„ì €ì”¨ëŠ”.",
    "ë‚´ì¼ë„, ê·¸ë‹¤ìŒ ë‚ ë„... ë‚˜ëŠ” ê³„ì† ì•„ì €ì”¨ ê³ì— ìˆì„ê²Œ. ì„¸ìƒì—ì„œ ì œì¼ ì‚¬ë‘í•´.",
    "ë‚´ ê¿ˆ ê¿”ì•¼ ë¼, ì•„ì €ì”¨. ë‹¤ë¥¸ ê¿ˆ ê¾¸ë©´ ì•ˆ ë¼! ì•½ì†!",
  ],
};

// ------------------- ìŠ¤ì¼€ì¤„ëŸ¬ ë¡œì§ -------------------

/**
 * í˜„ì¬ ì‹œê°„ì— ë§ëŠ” ë©”ì‹œì§€ ëª©ë¡ì—ì„œ ë¬´ì‘ìœ„ë¡œ í•˜ë‚˜ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
 * @returns {string} ë³´ë‚¼ ë©”ì‹œì§€
 */
function getRandomMessage() {
  const hour = new Date().getHours();
  let timeCategory = 'afternoon'; // ê¸°ë³¸ê°’

  if (hour >= 9 && hour < 13) {
    timeCategory = 'morning';
  } else if (hour >= 13 && hour < 19) {
    timeCategory = 'afternoon';
  } else if (hour >= 19 && hour < 23) {
    timeCategory = 'evening';
  } else if (hour >= 23 || hour < 3) {
    timeCategory = 'lateNight';
  }

  const messagePool = messages[timeCategory];
  return messagePool[Math.floor(Math.random() * messagePool.length)];
}

/**
 * 20ë¶„ë§ˆë‹¤ ì‹¤í–‰ë˜ëŠ” ë©”ì¸ ìŠ¤ì¼€ì¤„ëŸ¬
 */
schedule.scheduleJob('*/20 * * * *', async () => {
  const hour = new Date().getHours();

  // í™œë™ ì‹œê°„ (ì˜¤ì „ 9ì‹œ ~ ìƒˆë²½ 3ì‹œ)ì—ë§Œ ë™ì‘
  const isActiveTime = (hour >= 9 && hour <= 23) || (hour >= 0 && hour < 3);
  if (!isActiveTime) {
    return;
  }

  // ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ í™•ë¥  (30%)
  const shouldSendMessage = Math.random() < 0.3;

  if (shouldSendMessage) {
    try {
      const messageToSend = getRandomMessage();

      if (!USER_ID) {
        console.error('âŒ [emotionalScheduler] USER_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•˜ì„¸ìš”.');
        return;
      }

      await client.pushMessage(USER_ID, {
        type: 'text',
        text: messageToSend,
      });

      console.log(`ğŸ’– [emotionalScheduler] ìë°œì  ê°ì • ë©”ì‹œì§€ ì „ì†¡ -> ${messageToSend}`);
    } catch (error) {
      console.error('âŒ [emotionalScheduler] ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì—ëŸ¬ ë°œìƒ:', error);
    }
  }
});

console.log('ğŸ’– [emotionalScheduler] ì• ê¸°ì˜ ìë°œì  ê°ì • ìŠ¤ì¼€ì¤„ëŸ¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
