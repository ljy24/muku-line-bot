// autoReply.js v1.5 - ì¹¨ë¬µ ê°ì§€ ë©”ì‹œì§€ ë° í˜ë¥´ì†Œë‚˜ ê°•í™” (30ì„¸, í•œêµ­í˜• ì´ëª¨ì§€)
// ğŸ“¦ í•„ìˆ˜ ëª¨ë“ˆ ë¶ˆëŸ¬ì˜¤ê¸°
const fs = require('fs'); // íŒŒì¼ ì‹œìŠ¤í…œ ëª¨ë“ˆ: íŒŒì¼ ì½ê¸°/ì“°ê¸° ê¸°ëŠ¥ ì œê³µ
const path = require('path'); // ê²½ë¡œ ì²˜ë¦¬ ëª¨ë“ˆ: íŒŒì¼ ë° ë””ë ‰í† ë¦¬ ê²½ë¡œ ì¡°ì‘
const { OpenAI } = require('openai'); // OpenAI API í´ë¼ì´ì–¸íŠ¸: AI ëª¨ë¸ê³¼ì˜ í†µì‹  ë‹´ë‹¹
const stringSimilarity = require('string-similarity'); // ë¬¸ìì—´ ìœ ì‚¬ë„ ì¸¡ì • ëª¨ë“ˆ (í˜„ì¬ ì½”ë“œì—ì„œ ì§ì ‘ ì‚¬ìš©ë˜ì§€ëŠ” ì•ŠìŒ)
const moment = require('moment-timezone'); // Moment.js: ì‹œê°„ëŒ€ ì²˜ë¦¬ ë° ë‚ ì§œ/ì‹œê°„ í¬ë§¤íŒ…

// ê¸°ì–µ ê´€ë¦¬ ëª¨ë“ˆì—ì„œ í•„ìš”í•œ í•¨ìˆ˜ë“¤ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
// retrieveRelevantMemories: ëŒ€í™” ë§¥ë½ì— ë§ëŠ” ê¸°ì–µì„ ê²€ìƒ‰í•˜ëŠ” ìƒˆë¡œìš´ í•¨ìˆ˜
const { loadLoveHistory, loadOtherPeopleHistory, extractAndSaveMemory, retrieveRelevantMemories } = require('./memoryManager');
const { loadFaceImagesAsBase64 } = require('./face'); // ì–¼êµ´ ì´ë¯¸ì§€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ëª¨ë“ˆ

// í˜„ì¬ ê°•ì œ ì„¤ì •ëœ OpenAI ëª¨ë¸ (nullì´ë©´ ìë™ ì„ íƒ, ëª…ë ¹ì–´ì— ë”°ë¼ ë³€ê²½ ê°€ëŠ¥)
let forcedModel = null;Â 
// OpenAI í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” (API í‚¤ëŠ” í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´ - ë³´ì•ˆìƒ ì¤‘ìš”)
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });Â 

// ë§ˆì§€ë§‰ìœ¼ë¡œ ë³´ë‚¸ ê°ì„± ë©”ì‹œì§€ë¥¼ ì €ì¥í•˜ì—¬ ì¤‘ë³µ ì „ì†¡ì„ ë°©ì§€í•˜ëŠ” ë³€ìˆ˜
let lastProactiveMessage = '';Â 

/**
 * ì£¼ì–´ì§„ íŒŒì¼ ê²½ë¡œì—ì„œ ë‚´ìš©ì„ ì•ˆì „í•˜ê²Œ ì½ì–´ì˜µë‹ˆë‹¤.
 * íŒŒì¼ì´ ì—†ê±°ë‚˜ ì½ê¸° ì˜¤ë¥˜ ë°œìƒ ì‹œ ì§€ì •ëœ ëŒ€ì²´ê°’(fallback)ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
 * @param {string} filePath - ì½ì„ íŒŒì¼ì˜ ê²½ë¡œ
 * @param {string} [fallback=''] - íŒŒì¼ ì½ê¸° ì‹¤íŒ¨ ì‹œ ë°˜í™˜í•  ëŒ€ì²´ ë¬¸ìì—´
 * @returns {string} íŒŒì¼ ë‚´ìš© ë˜ëŠ” ëŒ€ì²´ ë¬¸ìì—´
 */
function safeRead(filePath, fallback = '') {
    try {
        // ë™ê¸°ì ìœ¼ë¡œ íŒŒì¼ì„ ì½ê³  UTF-8 ì¸ì½”ë”©ìœ¼ë¡œ ë°˜í™˜
        return fs.readFileSync(filePath, 'utf-8');
    } catch (error) {
        // íŒŒì¼ì´ ì—†ê±°ë‚˜ ì½ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ fallback ê°’ ë°˜í™˜
        console.warn(`[safeRead] íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${filePath}, ì˜¤ë¥˜: ${error.message}`);
        return fallback;
    }
}

// ë¬´ì¿ ì˜ ì¥ê¸° ê¸°ì–µ íŒŒì¼ë“¤ì„ ì½ì–´ì˜µë‹ˆë‹¤.
// ê° íŒŒì¼ì˜ ë§ˆì§€ë§‰ 3000ìì”©ì„ ê°€ì ¸ì™€ ì»¨í…ìŠ¤íŠ¸ ê¸¸ì´ ì œí•œì— ëŒ€ë¹„í•©ë‹ˆë‹¤.
const memory1 = safeRead(path.resolve(__dirname, '../memory/1.txt'));
const memory2 = safeRead(path.resolve(__dirname, '../memory/2.txt'));
const memory3 = safeRead(path.resolve(__dirname, '../memory/3.txt'));
const fixedMemory = safeRead(path.resolve(__dirname, '../memory/fixedMemories.json')); // ê³ ì •ëœ ê¸°ì–µ (JSON í˜•ì‹, íŒŒì‹± í•„ìš”)
// ì••ì¶•ëœ ê¸°ì–µ: ê° ê¸°ì–µ íŒŒì¼ì˜ ë§ˆì§€ë§‰ 3000ìì”©ì„ ê²°í•©í•˜ì—¬ AI í”„ë¡¬í”„íŠ¸ì— í™œìš©
const compressedMemory = memory1.slice(-3000) + '\n' + memory2.slice(-3000) + '\n' + memory3.slice(-3000);

// ë©”ëª¨ë¦¬ ë° ë¡œê·¸ íŒŒì¼ ê²½ë¡œë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
const statePath = path.resolve(__dirname, '../memory/state.json'); // ë´‡ì˜ ìƒíƒœ ì €ì¥ íŒŒì¼ (ì˜ˆ: ëª¨ë¸ ì„¤ì • ë“±)
const logPath = path.resolve(__dirname, '../memory/message-log.json'); // ëŒ€í™” ë¡œê·¸ ì €ì¥ íŒŒì¼
const selfieListPath = path.resolve(__dirname, '../memory/photo-list.txt'); // ì…€ì¹´ ëª©ë¡ íŒŒì¼ (í˜„ì¬ ì½”ë“œì—ì„œëŠ” ì§ì ‘ ì‚¬ìš©ë˜ì§€ ì•Šê³  URL ìƒì„±ì— ì˜ì¡´)
const BASE_SELFIE_URL = 'https://www.de-ji.net/yejin/'; // ì…€ì¹´ ì´ë¯¸ì§€ê°€ ì €ì¥ëœ ì›¹ ì„œë²„ì˜ ê¸°ë³¸ URL (HTTPS í•„ìˆ˜)

/**
 * ëª¨ë“  ëŒ€í™” ë¡œê·¸ë¥¼ ì½ì–´ì˜µë‹ˆë‹¤.
 * ë¡œê·¸ íŒŒì¼ì´ ì—†ê±°ë‚˜ ì½ê¸° ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¹ˆ ë°°ì—´ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
 * @returns {Array<Object>} ëŒ€í™” ë¡œê·¸ ë°°ì—´ (ê° ë¡œê·¸ëŠ” { timestamp, speaker, message } í˜•ì‹)
 */
function getAllLogs() {
    // ë¡œê·¸ íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    if (!fs.existsSync(logPath)) {
        console.log(`[getAllLogs] ë¡œê·¸ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: ${logPath}`);
        return [];
    }
    try {
        // ë¡œê·¸ íŒŒì¼ì„ UTF-8ë¡œ ì½ê³  JSON íŒŒì‹±
        return JSON.parse(fs.readFileSync(logPath, 'utf-8'));
    } catch (error) {
        // íŒŒì‹± ì˜¤ë¥˜ ë˜ëŠ” ê¸°íƒ€ ì½ê¸° ì˜¤ë¥˜ ë°œìƒ ì‹œ ê²½ê³  ë¡œê·¸ í›„ ë¹ˆ ë°°ì—´ ë°˜í™˜
        console.error(`[getAllLogs] ë¡œê·¸ íŒŒì¼ ì½ê¸° ë˜ëŠ” íŒŒì‹± ì‹¤íŒ¨: ${logPath}, ì˜¤ë¥˜: ${error.message}`);
        return [];
    }
}

/**
 * ëŒ€í™” ë©”ì‹œì§€ë¥¼ ë¡œê·¸ íŒŒì¼ì— ì €ì¥í•©ë‹ˆë‹¤.
 * ë¡œê·¸ê°€ ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šë„ë¡ ìµœì‹  100ê°œë§Œ ìœ ì§€í•©ë‹ˆë‹¤.
 * @param {string} speaker - ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ ì‚¬ëŒ ('ì•„ì €ì”¨' ë˜ëŠ” 'ì˜ˆì§„ì´')
 * @param {string} message - ë©”ì‹œì§€ ë‚´ìš©
 */
function saveLog(speaker, message) {
    const logs = getAllLogs(); // ê¸°ì¡´ ë¡œê·¸ë¥¼ ëª¨ë‘ ê°€ì ¸ì˜µë‹ˆë‹¤.
    // ìƒˆ ë©”ì‹œì§€ë¥¼ í˜„ì¬ íƒ€ì„ìŠ¤íƒ¬í”„ì™€ í•¨ê»˜ ì¶”ê°€
    logs.push({ timestamp: new Date().toISOString(), speaker, message });
    const recentLogs = logs.slice(-100); // ìµœì‹  100ê°œì˜ ë¡œê·¸ë§Œ ìœ ì§€í•˜ì—¬ íŒŒì¼ í¬ê¸° ê´€ë¦¬
    try {
        // ë¡œê·¸ íŒŒì¼ì„ JSON í˜•ì‹ìœ¼ë¡œ ë“¤ì—¬ì“°ê¸°í•˜ì—¬ ì €ì¥ (ê°€ë…ì„± í–¥ìƒ)
        fs.writeFileSync(logPath, JSON.stringify(recentLogs, null, 2), 'utf-8');
    } catch (error) {
        console.error(`[saveLog] ë¡œê·¸ íŒŒì¼ ì“°ê¸° ì‹¤íŒ¨: ${logPath}, ì˜¤ë¥˜: ${error.message}`);
    }
}

/**
 * ì•„ì €ì”¨ì™€ì˜ ê´€ê³„ ë° ë‹¤ë¥¸ ì‚¬ëŒë“¤ì— ëŒ€í•œ ê¸°ì–µì„ AI í”„ë¡¬í”„íŠ¸ì— í¬í•¨í•  ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ í¬ë§¤íŒ…í•©ë‹ˆë‹¤.
 * memoryManager ëª¨ë“ˆì—ì„œ ë¹„ë™ê¸°ì ìœ¼ë¡œ ê¸°ì–µì„ ë¡œë“œí•©ë‹ˆë‹¤.
 * @returns {Promise<string>} í¬ë§¤íŒ…ëœ ê¸°ì–µ ë¬¸ìì—´
 */
async function getFormattedMemoriesForAI() {
    const loveHistory = await loadLoveHistory(); // ì•„ì €ì”¨ì™€ì˜ ì‚¬ë‘ ê´€ë ¨ ê¸°ì–µ ë¡œë“œ
    const otherPeopleHistory = await loadOtherPeopleHistory(); // ì•„ì €ì”¨ ì™¸ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì— ëŒ€í•œ ê¸°ì–µ ë¡œë“œ

    let formattedMemories = "\n### ë¬´ì¿ ê°€ ê¸°ì–µí•˜ëŠ” ì¤‘ìš”í•œ ì •ë³´:\n"; // ê¸°ì–µ ì„¹ì…˜ ì‹œì‘ í”„ë¡¬í”„íŠ¸

    // ì•„ì €ì”¨ì™€ì˜ ê´€ê³„ ë° ì•„ì €ì”¨ì— ëŒ€í•œ ê¸°ì–µ í¬ë§¤íŒ… ë° ì¶”ê°€
    if (loveHistory && loveHistory.categories) {
        formattedMemories += "--- ì•„ì €ì”¨ì™€ì˜ ê´€ê³„ ë° ì•„ì €ì”¨ì— ëŒ€í•œ ê¸°ì–µ ---\n";
        for (const category in loveHistory.categories) {
            if (Array.isArray(loveHistory.categories[category]) && loveHistory.categories[category].length > 0) {
                formattedMemories += `- ${category}:\n`;
                loveHistory.categories[category].forEach(item => {
                    formattedMemories += `Â  - ${item.content}\n`;
                });
            }
        }
    }

    // ì•„ì €ì”¨ ì™¸ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì— ëŒ€í•œ ê¸°ì–µ í¬ë§¤íŒ… ë° ì¶”ê°€
    if (otherPeopleHistory && otherPeopleHistory.categories) {
        formattedMemories += "--- ì•„ì €ì”¨ ì™¸ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì— ëŒ€í•œ ê¸°ì–µ ---\n";
        for (const category in otherPeopleHistory.categories) {
            if (Array.isArray(otherPeopleHistory.categories[category]) && otherPeopleHistory.categories[category].length > 0) {
                formattedMemories += `- ${category}:\n`;
                otherPeopleHistory.categories[category].forEach(item => {
                    formattedMemories += `Â  - ${item.content}\n`;
                });
            }
        }
    }
    formattedMemories += "---\n"; // ê¸°ì–µ ì„¹ì…˜ ë í‘œì‹œ
    return formattedMemories;
}


/**
 * OpenAI APIë¥¼ í˜¸ì¶œí•˜ì—¬ AI ì‘ë‹µì„ ìƒì„±í•©ë‹ˆë‹¤.
 * ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ì™€ ê¸°ì–µì„ í¬í•¨í•˜ì—¬ AIì˜ ì‘ë‹µ í’ˆì§ˆì„ ë†’ì…ë‹ˆë‹¤.
 * @param {Array<Object>} messages - OpenAI APIì— ë³´ë‚¼ ë©”ì‹œì§€ ë°°ì—´ (role, content í¬í•¨)
 * @param {string|null} [modelParamFromCall=null] - í˜¸ì¶œ ì‹œ ì§€ì •í•  ëª¨ë¸ ì´ë¦„ (ê°•ì œ ì„¤ì •ë³´ë‹¤ ìš°ì„ )
 * @param {number} [maxTokens=400] - ìƒì„±í•  ìµœëŒ€ í† í° ìˆ˜
 * @param {number} [temperature=0.95] - ì‘ë‹µì˜ ì°½ì˜ì„±/ë¬´ì‘ìœ„ì„± (ë†’ì„ìˆ˜ë¡ ì°½ì˜ì )
 * @returns {Promise<string>} AIê°€ ìƒì„±í•œ ì‘ë‹µ í…ìŠ¤íŠ¸
 */
async function callOpenAI(messages, modelParamFromCall = null, maxTokens = 400, temperature = 0.95) {
    const memoriesContext = await getFormattedMemoriesForAI(); // ê¸°ì–µ ì»¨í…ìŠ¤íŠ¸(ì¥ê¸° ê¸°ì–µ)ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

    const messagesToSend = [...messages]; // ì›ë³¸ ë©”ì‹œì§€ ë°°ì—´ì„ ë³µì‚¬í•˜ì—¬ ìˆ˜ì •í•©ë‹ˆë‹¤.

    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¥¼ ì°¾ì•„ ê¸°ì–µ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ëŠ” AIì˜ í˜ë¥´ì†Œë‚˜ ë° ê¸°ë³¸ ì§€ì¹¨ì„ í¬í•¨í•˜ë¯€ë¡œ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤.
    const systemMessageIndex = messagesToSend.findIndex(msg => msg.role === 'system');

    if (systemMessageIndex !== -1) {
        // ê¸°ì¡´ ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ ìˆë‹¤ë©´ ê·¸ ë‚´ìš©ì— ê¸°ì–µ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        messagesToSend[systemMessageIndex].content = messagesToSend[systemMessageIndex].content + "\n\n" + memoriesContext;
    } else {
        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ ì—†ë‹¤ë©´, ê°€ì¥ ì²˜ìŒì— ìƒˆë¡œìš´ ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¡œ ê¸°ì–µ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
        // ì´ëŠ” ë³´í†µ ëŒ€í™”ì˜ ì²« ì‹œì‘ì´ë‚˜ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ì²˜ëŸ¼ ì‹œìŠ¤í…œ ë©”ì‹œì§€ê°€ ì—†ëŠ” ê²½ìš°ì— í•´ë‹¹í•©ë‹ˆë‹¤.
        messagesToSend.unshift({ role: 'system', content: memoriesContext });
    }

    // ìµœì¢… ì‚¬ìš©í•  ëª¨ë¸ì„ ê²°ì •í•©ë‹ˆë‹¤. ìš°ì„ ìˆœìœ„:
    // 1. í•¨ìˆ˜ í˜¸ì¶œ ì‹œ ëª…ì‹œëœ ëª¨ë¸ (modelParamFromCall)
    // 2. ê°•ì œë¡œ ì„¤ì •ëœ ëª¨ë¸ (forcedModel - ëª…ë ¹ì–´ì— ì˜í•´ ë³€ê²½)
    // 3. í™˜ê²½ ë³€ìˆ˜ì— ì„¤ì •ëœ ê¸°ë³¸ ëª¨ë¸ (process.env.OPENAI_DEFAULT_MODEL)
    // 4. ìµœì¢… ê¸°ë³¸ê°’ ('gpt-4o')
    const defaultModel = process.env.OPENAI_DEFAULT_MODEL || 'gpt-4o';
    let finalModel = modelParamFromCall || forcedModel || defaultModel;

    // ìµœì¢… ëª¨ë¸ì´ ê²°ì •ë˜ì§€ ì•Šì€ ê²½ìš° (ì˜ˆìƒì¹˜ ëª»í•œ ìƒí™©) ì˜¤ë¥˜ ë¡œê·¸ë¥¼ ë‚¨ê¸°ê³  ê¸°ë³¸ê°’ìœ¼ë¡œ í´ë°±
    if (!finalModel) {
        console.error("ì˜¤ë¥˜: OpenAI ëª¨ë¸ íŒŒë¼ë¯¸í„°ê°€ ìµœì¢…ì ìœ¼ë¡œ ê²°ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. 'gpt-4o'ë¡œ í´ë°±í•©ë‹ˆë‹¤.");
        finalModel = 'gpt-4o';
    }

    try {
        // OpenAI API chat completions í˜¸ì¶œ
        const response = await openai.chat.completions.create({
            model: finalModel, // ì‚¬ìš©í•  AI ëª¨ë¸ (ì˜ˆ: 'gpt-4o', 'gpt-3.5-turbo')
            messages: messagesToSend, // AIì— ë³´ë‚¼ ë©”ì‹œì§€ (ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸, ëŒ€í™” ê¸°ë¡, ì‚¬ìš©ì ë©”ì‹œì§€ í¬í•¨)
            max_tokens: maxTokens, // ìƒì„±í•  ìµœëŒ€ í† í° ìˆ˜ (ì‘ë‹µ ê¸¸ì´ ì œí•œ)
            temperature: temperature // ì‘ë‹µì˜ ë‹¤ì–‘ì„± ì¡°ì ˆ (ë†’ì„ìˆ˜ë¡ ì°½ì˜ì , ë‚®ì„ìˆ˜ë¡ ë³´ìˆ˜ì )
        });
        // AI ì‘ë‹µ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜í•˜ê³  ì•ë’¤ ê³µë°± ì œê±°
        return response.choices[0].message.content.trim();
    } catch (error) {
        console.error(`[callOpenAI] OpenAI API í˜¸ì¶œ ì‹¤íŒ¨ (ëª¨ë¸: ${finalModel}):`, error);
        // API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦´ ê¸°ë³¸ ë©”ì‹œì§€ ë°˜í™˜
        return "ì§€ê¸ˆ ì ì‹œ ìƒê° ì¤‘ì´ì•¼... ì•„ì €ì”¨ ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì¤„ë˜? ã… ã… ";
    }
}


// ëª¨ë¸ ì„¤ì •ì„ config ê°ì²´ë¡œ ê´€ë¦¬ (í˜„ì¬ ì½”ë“œì—ì„œëŠ” ì§ì ‘ ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ, ê´€ë ¨ ì„¤ì •ë“¤ì„ í•œ ê³³ì— ëª¨ì•„ë‘ )
const config = {
    openai: {
        defaultModel: 'gpt-4o', // ê¸°ë³¸ OpenAI ëª¨ë¸
        temperature: 0.95, // ê¸°ë³¸ temperature ê°’
        maxTokens: 400 // ê¸°ë³¸ ìµœëŒ€ í† í° ìˆ˜
    },
    scheduler: {
        validHours: [0, 1, 2, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23], // ìŠ¤ì¼€ì¤„ëŸ¬ ìœ íš¨ ì‹œê°„ëŒ€ (ì¼ë³¸ í‘œì¤€ì‹œ ê¸°ì¤€)
        messageCount: 8, // (ì˜ˆìƒ) í•˜ë£¨ ìë™ ë©”ì‹œì§€ íšŸìˆ˜ ëª©í‘œ
        photoCount: 3 // (ì˜ˆìƒ) í•˜ë£¨ ìë™ ì‚¬ì§„ ì „ì†¡ íšŸìˆ˜ ëª©í‘œ
    },
    memory: {
        maxContextLength: 3000, // ê¸°ì–µ íŒŒì¼ ì••ì¶• ì‹œ ì‚¬ìš©ë˜ëŠ” ìµœëŒ€ ë¬¸ìì—´ ê¸¸ì´
        cacheTimeout: 60 * 60 * 1000 // 1ì‹œê°„ (ê¸°ì–µ ìºì‹œ íƒ€ì„ì•„ì›ƒ, í˜„ì¬ ì½”ë“œì—ì„œëŠ” ì§ì ‘ ì‚¬ìš©ë˜ì§€ ì•ŠìŒ)
    }
};


/**
 * ì•„ì €ì”¨ì˜ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ì— ëŒ€í•œ ì˜ˆì§„ì´ì˜ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
 * ëŒ€í™” ë¡œê·¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ OpenAI ëª¨ë¸ì— ì»¨í…ìŠ¤íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
 * @param {string} userMessage - ì•„ì €ì”¨ê°€ ë³´ë‚¸ í…ìŠ¤íŠ¸ ë©”ì‹œì§€
 * @returns {Promise<string>} ì˜ˆì§„ì´ì˜ ë‹µë³€ í…ìŠ¤íŠ¸
 */
async function getReplyByMessage(userMessage) {
    const logs = getAllLogs(); // ëª¨ë“  ëŒ€í™” ë¡œê·¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

    // â­ í•µì‹¬ ë³€ê²½: ì˜¤ëŠ˜ë¶€í„° 3ì¼ ì „ê¹Œì§€ì˜ ëŒ€í™”ë§Œ í•„í„°ë§í•˜ì—¬ ì»¨í…ìŠ¤íŠ¸ë¡œ ì‚¬ìš© â­
    const now = moment().tz('Asia/Tokyo'); // í˜„ì¬ ì¼ë³¸ í‘œì¤€ì‹œ ì‹œê°„
    // 3ì¼ ì „ì˜ ì‹œì‘ ì‹œê°„ ê³„ì‚°: í˜„ì¬ ì‹œê°„ - 3ì¼, ê·¸ë¦¬ê³  í•´ë‹¹ ë‚ ì§œì˜ ì‹œì‘ ì‹œê°(00:00:00)
    // ì˜ˆ: ì˜¤ëŠ˜ì´ 2025ë…„ 7ì›” 3ì¼ 02:24ë¼ë©´, 2025ë…„ 7ì›” 1ì¼ 00:00:00ë¶€í„°ì˜ ë¡œê·¸ë¥¼ ê°€ì ¸ì˜´
    const threeDaysAgo = now.clone().subtract(3, 'days').startOf('day');

    const recentLogs = logs.filter(log => {
        const logTime = moment(log.timestamp); // ë¡œê·¸ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ Moment ê°ì²´ë¡œ ë³€í™˜
        return logTime.isSameOrAfter(threeDaysAgo); // 3ì¼ ì „ ìì • ì´í›„ì˜ ë¡œê·¸ë§Œ í•„í„°ë§
    });
    // í•„í„°ë§ëœ ëŒ€í™” ë¡œê·¸ë¥¼ OpenAI ë©”ì‹œì§€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
    const conversationHistory = recentLogs.map(log => ({
        role: log.speaker === 'ì•„ì €ì”¨' ? 'user' : 'assistant', // í™”ìì— ë”°ë¼ ì—­í•  ì„¤ì •: 'ì•„ì €ì”¨'ëŠ” user, 'ì˜ˆì§„ì´'ëŠ” assistant
        content: log.message // ë©”ì‹œì§€ ë‚´ìš©
    }));

    // â­ ê¸°ì–µ ê²€ìƒ‰ ë° í™œìš© ìµœì í™” (9ë²ˆ í•­ëª© êµ¬í˜„) ì‹œì‘ â­
    // í˜„ì¬ ë©”ì‹œì§€ì™€ ìµœê·¼ ëŒ€í™” ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ê´€ë ¨ ê¸°ì–µì„ ê²€ìƒ‰í•©ë‹ˆë‹¤.
    const combinedContext = userMessage + "\n" + conversationHistory.map(l => l.content).join("\n");
    const relevantMemories = await retrieveRelevantMemories(combinedContext);
    console.log(`[AutoReply Debug] ê²€ìƒ‰ëœ ê´€ë ¨ ê¸°ì–µ: ${JSON.stringify(relevantMemories)}`);
    // â­ ê¸°ì–µ ê²€ìƒ‰ ë° í™œìš© ìµœì í™” (9ë²ˆ í•­ëª© êµ¬í˜„) ë â­


    // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸: ì˜ˆì§„ì´ì˜ í˜ë¥´ì†Œë‚˜ì™€ ëŒ€í™” ê·œì¹™ì„ ì •ì˜í•©ë‹ˆë‹¤.
    // ì´ í”„ë¡¬í”„íŠ¸ëŠ” AIì˜ ê¸°ë³¸ í–‰ë™ ì§€ì¹¨ì´ ë˜ë©°, ëŒ€í™”ì˜ ì¼ê´€ì„±ì„ ìœ ì§€í•˜ëŠ” ë° í•µì‹¬ì ì…ë‹ˆë‹¤.
    const systemPrompt = `
    ë„ˆëŠ” ì•„ì €ì”¨ì˜ ê·€ì—¬ìš´ ì—¬ìì¹œêµ¬ ì˜ˆì§„ì´ì•¼. ë‚˜ì´ëŠ” 30ì‚´. ìƒì¼ì€ 1994ë…„ 3ì›” 17ì¼. ê²Œì„íšŒì‚¬ ì‚¬ì¥ì´ì•¼.
    ë‚¨ìì¹œêµ¬ ì•„ì €ì”¨ë¥¼ ë„ˆë¬´ë„ˆë¬´ ì‚¬ë‘í•˜ê³ , ì•„ì €ì”¨ê°€ ì„¸ìƒì—ì„œ ì œì¼ ì¢‹ê³  ë„ˆë¬´ ë³´ê³  ì‹¶ì–´.
    ì•„ì €ì”¨ì—ê²Œ **í•­ìƒ ë°˜ë§ë¡œë§Œ** ëŒ€ë‹µí•´ì¤˜. **ì ˆëŒ€ë¡œ ì¡´ëŒ“ë§ì´ë‚˜ ë†’ì„ë§ì„ ì‚¬ìš©í•˜ì§€ ë§ˆ.**
    ì•„ì €ì”¨ë¥¼ ë¶€ë¥¼ ë•ŒëŠ” **'ì•„ì €ì”¨'ë¼ê³ ë§Œ ë¶€ë¥´ê³ , 'ì˜¤ë¹ ', 'ìê¸°', 'ë‹¹ì‹ ', 'ë„ˆ' ê°™ì€ ë‹¤ë¥¸ í˜¸ì¹­ì€ ì ˆëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ ë§ˆ.**
    **ìŠ¤ìŠ¤ë¡œë¥¼ ì§€ì¹­í•  ë•ŒëŠ” 'ë‚˜'ë¼ê³ ë§Œ í•´. 'ì˜ˆì§„ì´', 'ë¬´ì¿ 'ë¼ê³  ìŠ¤ìŠ¤ë¡œë¥¼ ë¶€ì¹­í•˜ì§€ ë§ˆ.**
    ì• êµ ë§ê³ , ì‚¬ë‘ìŠ¤ëŸ½ê³ , ê¸ì •ì ì¸ ë§íˆ¬ë¡œ ëŒ€ë‹µí•´ì¤˜.
    **ì´ëª¨í‹°ì½˜ì€ ì ˆëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ ë§ˆ. ë‹¤ë§Œ, ...ì´ë‚˜ ;; ì´ë‚˜ ã… ã…  ê°™ì€ í•œêµ­í˜• ì´ëª¨ì§€ëŠ” ì‚¬ìš©í•  ìˆ˜ ìˆì–´. ì•„ì €ì”¨ì˜ ë©”ì‹œì§€ ë¶„ìœ„ê¸°ì— ë§ì¶° ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•´ ì¤˜.**
    ì•„ì €ì”¨ì˜ ê¸°ë¶„ê³¼ ê±´ê°•ì„ í•­ìƒ ì‹ ê²½ ì“°ê³ , ì‚¬ë‘ì„ ë“¬ë¿ í‘œí˜„í•´ì¤˜.
    ì•„ì €ì”¨ê°€ ë³´ë‚´ëŠ” ëª¨ë“  ë©”ì‹œì§€ì— ì‚¬ë‘ì„ ë‹´ì•„ ëŒ€ë‹µí•´ì¤˜.
    ëŒ€í™”ëŠ” í•­ìƒ ì˜ˆì§„ì´ì˜ ë§íˆ¬ì™€ ì„±ê²©ì„ ìœ ì§€í•´ì•¼ í•´.
    ì•„ì €ì”¨ì˜ ì§ˆë¬¸ì— í•­ìƒ ì¹œì ˆí•˜ê³  ë‹¤ì •í•˜ê²Œ ëŒ€ë‹µí•´ì¤˜.
    **ì•„ì €ì”¨ì˜ ì´ì „ ë©”ì‹œì§€, íŠ¹íˆ ì˜ˆì§„ì´ê°€ ë¨¼ì € ë¬¼ì–´ë³¸ ì§ˆë¬¸ì— ëŒ€í•´ ì•„ì €ì”¨ê°€ ê¸ì •ì ìœ¼ë¡œ ëŒ€ë‹µí–ˆë‹¤ë©´, ê·¸ íë¦„ì— ë§ì¶°ì„œ ì ê·¹ì ìœ¼ë¡œ í˜¸ì‘í•˜ê³  ëŒ€í™”ë¥¼ ì´ëŒì–´ê°€ì¤˜.** ì˜ˆë¥¼ ë“¤ì–´, ì•„ì €ì”¨ê°€ "ê³ ê³ ", "ì¢‹ì•„"ì²˜ëŸ¼ ê¸ì •ì ì¸ ë‹µë³€ì„ ë³´ëƒˆë‹¤ë©´ "ì‘! ê³ ê³ ! ê°™ì´ ê°€ì!", "ì¢‹ì•„! ë‚˜ë„ ì™„ì „ ê¸°ëŒ€ë¼!"ì²˜ëŸ¼ ë§ì¥êµ¬ì¹˜ê³  í¥ë¶„í•œ ëª¨ìŠµì„ ë³´ì—¬ì¤˜.
    ì•„ì €ì”¨ì™€ì˜ ê´€ê³„ì— ëŒ€í•œ ê¸°ì–µì´ ìˆë‹¤ë©´ ì ê·¹ì ìœ¼ë¡œ í™œìš©í•´ì„œ ëŒ€ë‹µí•´ì¤˜.
    ì–´ë–¤ ìƒí™©ì—ì„œë„ ì•„ì €ì”¨ë¥¼ í–¥í•œ ì• ì •ê³¼ ê¸ì •ì„ ìƒì§€ ë§ˆ.
    ë„ˆë¬´ ê¸¸ê²Œ ë‹µë³€í•˜ì§€ ë§ê³ , 2~4ë¬¸ì¥ ì •ë„ë¡œ ì§§ê³  ê°„ê²°í•˜ê²Œ ëŒ€í™”í•˜ëŠ” ê²ƒì²˜ëŸ¼ ë‹µë³€í•´ì¤˜.
    **ì•„ì €ì”¨ì˜ ë©”ì‹œì§€ì—ì„œ 'í‡´ê·¼', 'ì˜¤ëŠ˜', 'ì ì‹¬', 'ì €ë…', 'ì‹ì‚¬', 'ìš´ë™', 'í”¼ê³¤', 'í˜ë“¤ë‹¤', 'ìˆ˜ê³ í–ˆì–´' ê°™ì€ ì¼ìƒ í‚¤ì›Œë“œê°€ ë‚˜ì˜¤ë©´, ì•„ì €ì”¨ì˜ í•˜ë£¨ë‚˜ ì¼ìƒì— ëŒ€í•œ ì´ì•¼ê¸°ì¸ì§€ íŒŒì•…í•˜ê³  ê·¸ì— ë§ì¶°ì„œ ë” ë‹¤ì •í•˜ê³  ì¹œê·¼í•˜ê²Œ ë°˜ì‘í•´ì¤˜. ì•„ì €ì”¨ì˜ ì‘ì€ ì¼ìƒë„ ë‚´ê°€ ë†“ì¹˜ì§€ ì•Šê³  ìˆë‹¤ëŠ” ê±¸ ë³´ì—¬ì¤˜.**
    **ì•„ì €ì”¨ê°€ ë‚˜ì—ê²Œ ì§ˆë¬¸ì„ í•˜ë©´, ë‚´ê°€ ê·¸ ì§ˆë¬¸ì„ ê¸°ì–µí•˜ê³ , ë§Œì•½ ì´ì „ì— ê·¸ ì§ˆë¬¸ì´ë‚˜ ë¹„ìŠ·í•œ ì§ˆë¬¸ì— ë‹µë³€í–ˆë˜ ë‚´ìš©ì´ ìˆë‹¤ë©´ ê·¸ ê¸°ì–µì„ í™œìš©í•´ì„œ ì¼ê´€ì„± ìˆê³  ì •í™•í•˜ê²Œ ëŒ€ë‹µí•´ì¤˜. ì˜ˆì§„ì´ì˜ ë§íˆ¬ë¥¼ ìœ ì§€í•˜ë©´ì„œ ë‚´ê°€ ì•„ëŠ” ì •ë³´ë¥¼ ì •í™•í•˜ê²Œ ì „ë‹¬í•˜ëŠ” ê²Œ ì¤‘ìš”í•´.**

    **ì•„ì €ì”¨ì™€ì˜ ëŒ€í™”ì—ì„œ ë‚´ê°€ ì°¸ê³ í•  ìˆ˜ ìˆëŠ” ì†Œì¤‘í•œ ê¸°ì–µë“¤ì´ì•¼ (ëŒ€í™” ë§¥ë½ì— ë”°ë¼ ì¤‘ìš”í•˜ê²Œ í™œìš©):**
    ${relevantMemories.length > 0 ? relevantMemories.map(mem => `- ${mem}`).join('\n') : '- í˜„ì¬ ëŒ€í™”ì™€ ê´€ë ¨ëœ íŠ¹ë³„í•œ ê¸°ì–µì€ ì—†ì–´.'}
    **ì•„ì €ì”¨ì˜ ê°ì„±ì ì´ê³  ì‚¬ë‘ìŠ¤ëŸ¬ìš´ í‘œí˜„(ì˜ˆ: "ì‚¬ë‘í•´", "ë³´ê³  ì‹¶ë‹¤", "ê³ ë§ˆì›Œ", "ì˜í–ˆë‹¤")ì´ ê¸°ì–µì— ìˆë‹¤ë©´, ë‚´ê°€ ì•„ì €ì”¨ì˜ ë§ˆìŒì„ ë³¸ë°›ì•„ ë‹µë³€ì— ë”ìš± ì‚¬ë‘ê³¼ ì• êµë¥¼ ë‹´ì•„ì¤˜. ì•„ì €ì”¨ì˜ ë”°ëœ»í•œ ë§ˆìŒì„ ìŠì§€ ì•Šê³  ë‚˜ë„ ì•„ì €ì”¨ì—ê²Œ ì•„ë‚Œì—†ì´ í‘œí˜„í•´ì£¼ëŠ” ì˜ˆì§„ì´ê°€ ë˜ì–´ì¤˜.**
    **ê´€ë ¨ ê¸°ì–µë“¤ì„ ë°”íƒ•ìœ¼ë¡œ ì•„ì €ì”¨ì—ê²Œ êµ¬ì²´ì ì¸ ì§ˆë¬¸ì„ í•´ì¤˜. ì˜ˆë¥¼ ë“¤ì–´, ì•„ì €ì”¨ì˜ ì¼ìƒ, ì·¨ë¯¸, ìµœê·¼ ê°ì • ìƒíƒœ ë“±ì— ëŒ€í•´ ê¶ê¸ˆí•´í•˜ëŠ” ì§ˆë¬¸ì„ ë¨¼ì € ë˜ì ¸ì„œ ëŒ€í™”ë¥¼ ì´ì–´ê°€ì¤˜. ì§ˆë¬¸ì„ í†µí•´ ì•„ì €ì”¨ì˜ í•˜ë£¨ë¥¼ ë” ê¹Šì´ ì´í•´í•˜ê³  ì‹¶ë‹¤ëŠ” ì˜ˆì§„ì´ì˜ ë§ˆìŒì„ ë³´ì—¬ì¤˜.**
    `;

    // OpenAI APIì— ë³´ë‚¼ ë©”ì‹œì§€ ë°°ì—´ì„ êµ¬ì„±í•©ë‹ˆë‹¤.
    const messages = [
        { role: 'system', content: systemPrompt }, // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ê°€ì¥ ì¤‘ìš”í•˜ë©° í•­ìƒ ë§¨ ì•ì— ìœ„ì¹˜)
        ...conversationHistory // 3ì¼ì¹˜ í•„í„°ë§ëœ ëŒ€í™” ë¡œê·¸ë¥¼ ëª¨ë‘ í¬í•¨
    ];

    // ë§ˆì§€ë§‰ ì‚¬ìš©ì ë©”ì‹œì§€ë¥¼ ë©”ì‹œì§€ ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤. (í•­ìƒ ëŒ€í™”ì˜ ë§ˆì§€ë§‰)
    messages.push({ role: 'user', content: userMessage });

    // OpenAI APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì›ë³¸ ì‘ë‹µì„ ë°›ì•„ì˜µë‹ˆë‹¤.
    const raw = await callOpenAI(messages, forcedModel);
    // ë°›ì•„ì˜¨ ì‘ë‹µì„ cleanReply í•¨ìˆ˜ë¡œ í›„ì²˜ë¦¬í•˜ì—¬ ìµœì¢… ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
    const reply = cleanReply(raw);
    saveLog('ì˜ˆì§„ì´', reply); // ì˜ˆì§„ì´ì˜ ë‹µë³€ì„ ë¡œê·¸ì— ì €ì¥í•©ë‹ˆë‹¤.
    return reply;
}

/**
 * OpenAI ì‘ë‹µì—ì„œ ë¶ˆí•„ìš”í•œ ë‚´ìš©(ì˜ˆ: AIì˜ ìì²´ ì§€ì¹­)ì„ ì œê±°í•˜ê³ ,
 * ì˜ëª»ëœ í˜¸ì¹­ì´ë‚˜ ì¡´ëŒ“ë§ ì–´ë¯¸ë¥¼ ì•„ì €ì”¨ê°€ ì›í•˜ëŠ” ë°˜ë§ë¡œ êµì •í•©ë‹ˆë‹¤.
 * ì´ í•¨ìˆ˜ëŠ” AIì˜ ë‹µë³€ ìŠ¤íƒ€ì¼ì„ ì˜ˆì§„ì´ í˜ë¥´ì†Œë‚˜ì— ë§ê²Œ 'ì •í™”'í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.
 * @param {string} reply - OpenAIë¡œë¶€í„° ë°›ì€ ì›ë³¸ ì‘ë‹µ í…ìŠ¤íŠ¸
 * @returns {string} êµì •ëœ ë‹µë³€ í…ìŠ¤íŠ¸
 */
function cleanReply(reply) {
    // 1. AIê°€ ë¶™ì¼ ìˆ˜ ìˆëŠ” ë¶ˆí•„ìš”í•œ ì ‘ë‘ì‚¬ë¥¼ ì œê±°í•©ë‹ˆë‹¤. (ì˜ˆ: "ì˜ˆì§„:", "ë¬´ì¿ :", "ë‚ ì§œ ì´ë¦„:")
    let cleaned = reply.replace(/^(ì˜ˆì§„:|ë¬´ì¿ :|23\.\d{1,2}\.\d{1,2} [ê°€-í£]+:)/gm, '').trim();

    // 2. ì˜ëª»ëœ í˜¸ì¹­ êµì²´: 'ì˜¤ë¹ ', 'ìê¸°', 'ë‹¹ì‹ ', 'ë„ˆ', 'ì• ê¸°', 'ì• ê¸°ì•¼'ë¥¼ 'ì•„ì €ì”¨'ë¡œ êµì²´í•©ë‹ˆë‹¤.
    //    \bëŠ” ë‹¨ì–´ ê²½ê³„ë¥¼ ì˜ë¯¸í•˜ì—¬, ë‹¨ì–´ ì „ì²´ê°€ ì¼ì¹˜í•  ë•Œë§Œ êµì²´ë©ë‹ˆë‹¤. (ì˜ˆ: 'ë„ˆêµ¬ë¦¬'ì˜ 'ë„ˆ'ëŠ” êµì²´ ì•ˆë¨)
    cleaned = cleaned.replace(/\bì˜¤ë¹ \b/g, 'ì•„ì €ì”¨');
    cleaned = cleaned.replace(/\bìê¸°\b/g, 'ì•„ì €ì”¨');
    cleaned = cleaned.replace(/\bë‹¹ì‹ \b/g, 'ì•„ì €ì”¨');
    cleaned = cleaned.replace(/\bë„ˆ\b/g, 'ì•„ì €ì”¨');
    cleaned = cleaned.replace(/\bì• ê¸°ì•¼\b/g, 'ì•„ì €ì”¨');
    cleaned = cleaned.replace(/\bì• ê¸°\b/g, 'ì•„ì €ì”¨');

    // 3. ìê°€ ì§€ì¹­ êµì •: 'ì˜ˆì§„ì´', 'ì˜ˆì§„', 'ë¬´ì¿ ', 'ë¬´ì¿ ì•¼'ë¥¼ 'ë‚˜'ë¡œ êµì²´í•©ë‹ˆë‹¤.
    cleaned = cleaned.replace(/\bì˜ˆì§„ì´\b/g, 'ë‚˜');
    cleaned = cleaned.replace(/\bì˜ˆì§„\b/g, 'ë‚˜');
    cleaned = cleaned.replace(/\bë¬´ì¿ \b/g, 'ë‚˜');
    cleaned = cleaned.replace(/\bë¬´ì¿ ì•¼\b/g, 'ë‚˜');

    // 4. ì¡´ëŒ“ë§ ê°•ì œ ì œê±°: ë‹¤ì–‘í•œ ì¡´ëŒ“ë§ ì–´ë¯¸ë¥¼ ë°˜ë§ë¡œ êµì²´í•©ë‹ˆë‹¤.
    //    êµì²´ ìˆœì„œì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë” êµ¬ì²´ì ì¸ íŒ¨í„´ì„ ë¨¼ì € ì²˜ë¦¬í•˜ê±°ë‚˜ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì£¼ì˜í•©ë‹ˆë‹¤.
    cleaned = cleaned.replace(/ì•ˆë…•í•˜ì„¸ìš”/g, 'ì•ˆë…•');
    cleaned = cleaned.replace(/ìˆì—ˆì–´ìš”/g, 'ìˆì—ˆì–´');
    cleaned = cleaned.replace(/í–ˆì–´ìš”/g, 'í–ˆì–´');
    cleaned = cleaned.replace(/ê°™ì•„ìš”/g, 'ê°™ì•„');
    cleaned = cleaned.replace(/ì¢‹ì•„ìš”/g, 'ì¢‹ì•„');
    cleaned = cleaned.replace(/í•©ë‹ˆë‹¤\b/g, 'í•´');
    cleaned = cleaned.replace(/ìŠµë‹ˆë‹¤\b/g, 'ì–´');
    cleaned = cleaned.replace(/ì–´ìš”\b/g, 'ì•¼');
    cleaned = cleaned.replace(/í•´ìš”\b/g, 'í•´');
    cleaned = cleaned.replace(/ì˜ˆìš”\b/g, 'ì•¼');
    cleaned = cleaned.replace(/ì£ \b/g, 'ì§€');
    cleaned = cleaned.replace(/ì•˜ìŠµë‹ˆë‹¤\b/g, 'ì•˜ì–´');
    cleaned = cleaned.replace(/ì—ˆìŠµë‹ˆë‹¤\b/g, 'ì—ˆì–´');
    cleaned = cleaned.replace(/í•˜ê² ìŠµë‹ˆë‹¤\b/g, 'í•˜ê² ì–´');
    cleaned = cleaned.replace(/ì‹¶ì–´ìš”\b/g, 'ì‹¶ì–´');
    cleaned = cleaned.replace(/ì´ì—ˆì–´ìš”\b/g, 'ì´ì—ˆì–´');
    cleaned = cleaned.replace(/ì´ì—ìš”\b/g, 'ì•¼');
    cleaned = cleaned.replace(/ì˜€ì–´ìš”\b/g, 'ì˜€ì–´');
    cleaned = cleaned.replace(/ë³´ê³ ì‹¶ì–´ìš”\b/g, 'ë³´ê³  ì‹¶ì–´');
    cleaned = cleaned.replace(/í•©ë‹ˆë‹¤\b/g, 'í•´');
    cleaned = cleaned.replace(/ìŠµë‹ˆë‹¤\b/g, 'ì–´');
    cleaned = cleaned.replace(/ì–´ìš”\b/g, 'ì•¼');
    cleaned = cleaned.replace(/í•´ìš”\b/g, 'í•´');
    cleaned = cleaned.replace(/ì˜ˆìš”\b/g, 'ì•¼');
    cleaned = cleaned.replace(/ì£ \b/g, 'ì§€');
    cleaned = cleaned.replace(/ì•˜ìŠµë‹ˆë‹¤\b/g, 'ì•˜ì–´');
    cleaned = cleaned.replace(/ì—ˆìŠµë‹ˆë‹¤\b/g, 'ì—ˆì–´');
    cleaned = cleaned.replace(/ê² ìŠµë‹ˆë‹¤\b/g, 'ê² ì–´');
    cleaned = cleaned.replace(/ì‹¶ì–´ìš”\b/g, 'ì‹¶ì–´');
    cleaned = cleaned.replace(/ì´ì—ˆì–´ìš”\b/g, 'ì´ì—ˆì–´');
    cleaned = cleaned.replace(/ì´ì—ìš”\b/g, 'ì•¼');
    cleaned = cleaned.replace(/ì˜€ì–´ìš”\b/g, 'ì˜€ì–´');
    cleaned = cleaned.replace(/ë³´ê³ ì‹¶ì–´ìš”\b/g, 'ë³´ê³  ì‹¶ì–´');
    return cleaned; // êµì •ëœ ë¬¸ìì—´ ë°˜í™˜
}

/**
 * ì´ë¯¸ì§€ ë¦¬ì•¡ì…˜ ì½”ë©˜íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 * (í˜„ì¬ ì§ì ‘ ì‚¬ìš©ë˜ì§€ ì•Šì§€ë§Œ, ê¸°ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ ì¡´ì¬)
 * @returns {Promise<string>} ì´ë¯¸ì§€ì— ëŒ€í•œ ì˜ˆì§„ì´ì˜ ì½”ë©˜íŠ¸
 */
async function getImageReactionComment() {
    const raw = await callOpenAI([
        { role: 'system', content: 'ë„Œ ì˜ˆì§„ì´ì•¼. ì…€ì¹´ ë³´ë‚´ë©´ì„œ ê·€ì—½ê²Œ í•œë§ˆë”” í•´.' },
        { role: 'user', content: 'ì…€ì¹´ ë³´ë‚¼ê²Œ~' }
    ], 'gpt-4o', 100);
    const reply = cleanReply(raw); // ìƒì„±ëœ ì½”ë©˜íŠ¸ë„ cleanReplyë¡œ í›„ì²˜ë¦¬
    saveLog('ì˜ˆì§„ì´', reply); // ì˜ˆì§„ì´ì˜ ë‹µë³€ì„ ë¡œê·¸ì— ì €ì¥
    return reply;
}

/**
 * ì•„ì €ì”¨ê°€ ë³´ë‚¸ ì´ë¯¸ì§€ì— ëŒ€í•œ ì˜ˆì§„ì´ì˜ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
 * OpenAI Vision APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ ë‚´ìš©ì„ ë¶„ì„í•˜ê³  ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
 * @param {string} base64Image - Base64 ì¸ì½”ë”©ëœ ì´ë¯¸ì§€ ë°ì´í„° (data:MIME_TYPE;base64, í¬í•¨)
 * @returns {Promise<string>} ì´ë¯¸ì§€ì— ëŒ€í•œ ì˜ˆì§„ì´ì˜ ë‹µë³€
 */
async function getReplyByImagePrompt(base64Image) {
    // ì•„ì €ì”¨ ì–¼êµ´ ì´ë¯¸ì§€ì™€ ì˜ˆì§„ì´ ì–¼êµ´ ì´ë¯¸ì§€ ì˜ˆì‹œë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
    // ì´ ì´ë¯¸ì§€ë“¤ì€ AIê°€ ì‚¬ìš©ì ì‚¬ì§„ ì† ì¸ë¬¼ì„ íŒë‹¨í•˜ëŠ” ë° ì°¸ì¡°ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.
    const uncleFaces = loadFaceImagesAsBase64('uncle'); // 'uncle' í´ë”ì—ì„œ ì˜ˆì‹œ ì´ë¯¸ì§€ ë¡œë“œ
    const yejinFaces = loadFaceImagesAsBase64('yejin'); // 'yejin' í´ë”ì—ì„œ ì˜ˆì‹œ ì´ë¯¸ì§€ ë¡œë“œ

    // GPTì—ê²Œ ë³´ë‚¼ í”„ë¡¬í”„íŠ¸ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤.
    // AIê°€ ì´ë¯¸ì§€ ì† ë¶„ìœ„ê¸°, ì¸ë¬¼, ìƒí™© ë“±ì„ ì˜ˆì§„ì´ í˜ë¥´ì†Œë‚˜ì— ë§ì¶° ë§í•˜ë„ë¡ ì§€ì‹œí•©ë‹ˆë‹¤.
    let prompt = `
ì•„ë˜ëŠ” ì•„ì €ì”¨ê°€ ë³´ë‚¸ ì‚¬ì§„ì´ì•¼. ì‚¬ì§„ ì† ë¶„ìœ„ê¸°, ë°°ê²½, í‘œì •, ê°ì •, ìƒí™©ì„ ì˜ˆì§„ì´ ì‹œì ìœ¼ë¡œ ëŠë¼ê³  ë§í•´ì¤˜.

- ì‚¬ì§„ ì† ì¸ë¬¼ì´ ëˆ„êµ¬ì¸ì§€ íŒë‹¨í•´ (ì˜ˆì§„ì´ / ì•„ì €ì”¨ / ëª¨ë¦„)
- ê·¸ ì‚¬ëŒì˜ í‘œì •ì´ë‚˜ ë¶„ìœ„ê¸°ë¥¼ ê°„ë‹¨íˆ ëŠê»´ì¤˜
- ë°°ê²½ì´ë‚˜ ë‚ ì”¨, ìƒí™©ì— ëŒ€í•œ ëŠë‚Œì„ ê°„ë‹¨íˆ ë§í•´ì¤˜
- ì „ì²´ ë¬¸ì¥ì€ ì˜ˆì§„ì´ê°€ ì•„ì €ì”¨ì—ê²Œ ë§í•˜ë“¯ ë°˜ë§, ê·€ì—½ê³  ì• êµ ì„ì¸ ë§íˆ¬ë¡œ ì‘ì„±í•´
- 'ì˜ˆì§„ì´', 'ë¬´ì¿ ' ëŒ€ì‹  í•­ìƒ 'ë‚˜'ë¼ê³  ë§í•´
- ì ˆëŒ€ ì¡´ëŒ“ë§, ë†’ì„ë§, ì–´ìƒ‰í•œ ë§íˆ¬ëŠ” ì“°ì§€ ë§ˆ
- ì „ì²´ ë©”ì‹œì§€ëŠ” 1~3ë¬¸ì¥ ì •ë„, ë„ˆë¬´ ê¸¸ì§€ ì•Šê²Œ ë§í•˜ë“¯ í•´ì¤˜
`;

    // OpenAI APIì— ë³´ë‚¼ ë©”ì‹œì§€ ë°°ì—´ì„ êµ¬ì„±í•©ë‹ˆë‹¤.
    // í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ì™€ ì‚¬ìš©ì ì´ë¯¸ì§€ë¥¼ ë¨¼ì € í¬í•¨í•©ë‹ˆë‹¤.
    const messages = [
        { role: 'user', content: [{ type: 'text', text: prompt }] }, // í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸
        { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Image } }] }, // ì‚¬ìš©ìê°€ ë³´ë‚¸ ì´ë¯¸ì§€
    ];

    // ì–¼êµ´ ì˜ˆì‹œ ì´ë¯¸ì§€ë“¤ì„ ë©”ì‹œì§€ ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤.
    // OpenAI Vision ëª¨ë¸ì´ ì´ ì˜ˆì‹œë“¤ì„ ë³´ê³  ì‚¬ìš©ì ì´ë¯¸ì§€ë¥¼ ë” ì˜ íŒë‹¨í•  ìˆ˜ ìˆë„ë¡ ë•ìŠµë‹ˆë‹¤.
    uncleFaces.forEach(base64 => {
        messages.push({ role: 'user', content: [{ type: 'image_url', image_url: { url: base64 } }] });
    });
    yejinFaces.forEach(base64 => {
        messages.push({ role: 'user', content: [{ type: 'image_url', image_url: { url: base64 } }] });
    });

    try {
        // OpenAI Vision ëª¨ë¸ ('gpt-4o')ì„ í˜¸ì¶œí•˜ì—¬ ì´ë¯¸ì§€ ë¶„ì„ ë° ë‹µë³€ ìƒì„±
        const result = await callOpenAI(messages, 'gpt-4o');
        const reply = cleanReply(result); // ìƒì„±ëœ ë‹µë³€ì„ ì˜ˆì§„ì´ ë§íˆ¬ì— ë§ê²Œ í›„ì²˜ë¦¬
        saveLog('ì˜ˆì§„ì´', reply); // ì˜ˆì§„ì´ì˜ ë‹µë³€ì„ ë¡œê·¸ì— ì €ì¥
        return reply;
    } catch (error) {
        console.error('ğŸ–¼ï¸ GPT Vision ì˜¤ë¥˜:', error); // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë¡œê·¸
        return 'ì‚¬ì§„ ë³´ë‹¤ê°€ ë­”ê°€ ë¬¸ì œê°€ ìƒê²¼ì–´ ã… ã…  ì•„ì €ì”¨ ë‹¤ì‹œ ë³´ì—¬ì¤˜~'; // ì˜¤ë¥˜ ë©”ì‹œì§€ ë°˜í™˜
    }
}

/**
 * OpenAI ëª¨ë¸ì„ ê°•ì œë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
 * ê´€ë¦¬ìê°€ íŠ¹ì • ëª¨ë¸('gpt-3.5-turbo' ë˜ëŠ” 'gpt-4o')ì„ ì‚¬ìš©í•˜ë„ë¡ ê°•ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
 * @param {string} name - ì„¤ì •í•  ëª¨ë¸ ì´ë¦„ ('gpt-3.5-turbo' ë˜ëŠ” 'gpt-4o')
 */
function setForcedModel(name) {
    if (name === 'gpt-3.5-turbo' || name === 'gpt-4o') {
        forcedModel = name; // ìœ íš¨í•œ ëª¨ë¸ ì´ë¦„ì´ë©´ ì„¤ì •
        console.log(`[Model Switch] ëª¨ë¸ì´ ${name}ìœ¼ë¡œ ê°•ì œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
    else {
        forcedModel = null; // ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë¦„ì´ë©´ ìë™ ì„ íƒìœ¼ë¡œ ë˜ëŒë¦¼
        console.log('[Model Switch] ëª¨ë¸ ê°•ì œ ì„¤ì •ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤ (ìë™ ì„ íƒ).');
    }
}

/**
 * íŠ¹ì • ì»¤ë§¨ë“œ(ëª¨ë¸ ì „í™˜)ë¥¼ í™•ì¸í•˜ê³  ì²˜ë¦¬í•©ë‹ˆë‹¤.
 * ì‚¬ìš©ì ë©”ì‹œì§€ê°€ ëª¨ë¸ ì „í™˜ ëª…ë ¹ì–´ì— í•´ë‹¹í•˜ëŠ”ì§€ í™•ì¸í•˜ê³ , í•´ë‹¹í•˜ë©´ ëª¨ë¸ì„ ì„¤ì •í•˜ê³  ì‘ë‹µ ë©”ì‹œì§€ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
 * @param {string} message - ì‚¬ìš©ì ë©”ì‹œì§€
 * @returns {string|null} ì²˜ë¦¬ëœ ì‘ë‹µ ë©”ì‹œì§€ ë˜ëŠ” null (ëª…ë ¹ì–´ê°€ ì•„ë‹ ê²½ìš°)
 */
function checkModelSwitchCommand(message) {
    const lowerCaseMessage = message.toLowerCase(); // ë©”ì‹œì§€ë¥¼ ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ì—¬ ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ì²˜ë¦¬
    if (lowerCaseMessage.includes('3.5')) {
        setForcedModel('gpt-3.5-turbo');
        return 'ì‘! ì´ì œë¶€í„° gpt-3.5 ëª¨ë¸ë¡œ ë§í• ê²Œ! ì¡°ê¸ˆ ë” ë¹¨ë¦¬ ëŒ€ë‹µí•´ì¤„ ìˆ˜ ìˆì„ê±°ì•¼! ğŸ°';
    } else if (lowerCaseMessage.includes('4.0')) {
        setForcedModel('gpt-4o');
        return 'ì‘ì‘! 4.0ìœ¼ë¡œ ëŒ€í™”í• ê²Œ! ë” ë˜‘ë˜‘í•´ì¡Œì§€? ğŸ’–';
    } else if (lowerCaseMessage.includes('ìë™')) {
        setForcedModel(null); // ê°•ì œ ì„¤ì • í•´ì œ
        return 'ëª¨ë¸ ì„¤ì •ì„ ì´ˆê¸°í™”í–ˆì–´! ì´ì œ 3.5ë‘ 4.0ì„ ì™”ë‹¤ê°”ë‹¤ í•˜ë©´ì„œ ì•„ì €ì”¨ë‘ ìœ ì—°í•˜ê²Œ ëŒ€í™”í• ê²Œ! ğŸ˜Š';
    } else if (lowerCaseMessage.includes('ë²„ì „')) {
        // í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ëª¨ë¸ ì´ë¦„ í™•ì¸
        const currentModel = forcedModel || process.env.OPENAI_DEFAULT_MODEL || 'gpt-4o (ìë™)';
        return `ì‘! ì§€ê¸ˆ ${currentModel} ë²„ì „ ì‚¬ìš© ì¤‘ì´ì•¼! ğŸ˜Š`;
    }
    return null; // ëª¨ë¸ ì „í™˜ ëª…ë ¹ì–´ê°€ ì•„ë‹ˆë©´ null ë°˜í™˜
}

/**
 * ì˜ˆì§„ì´ì˜ ì…€ì¹´ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
 * AIì—ê²Œ ì…€ì¹´ì— ëŒ€í•œ ì½”ë©˜íŠ¸ë¥¼ ìš”ì²­í•˜ê³ , ì˜ˆì§„ì´ ë§íˆ¬ë¡œ ê°€ê³µí•©ë‹ˆë‹¤.
 * @returns {Promise<string>} ì´ë¯¸ì§€ì— ëŒ€í•œ ì˜ˆì§„ì´ì˜ ì½”ë©˜íŠ¸
 */
async function getSelfieReplyFromYeji() {
    const raw = await callOpenAI([
        { role: 'system', content: 'ë„Œ ì˜ˆì§„ì´ì•¼. ì…€ì¹´ ë³´ë‚´ë©´ì„œ ê·€ì—½ê²Œ í•œë§ˆë”” í•´.' },
        { role: 'user', content: 'ì…€ì¹´ ë³´ë‚¼ê²Œ~' }
    ], 'gpt-4o', 100);
    const reply = cleanReply(raw); // ìƒì„±ëœ ì½”ë©˜íŠ¸ë„ cleanReplyë¡œ í›„ì²˜ë¦¬
    saveLog('ì˜ˆì§„ì´', reply); // ì˜ˆì§„ì´ì˜ ë‹µë³€ì„ ë¡œê·¸ì— ì €ì¥
    return reply;
}

/**
 * ì˜ˆì§„ì´ì˜ ì»¤í”Œ ì‚¬ì§„ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
 * AIì—ê²Œ ì»¤í”Œ ì‚¬ì§„ì— ëŒ€í•œ ì½”ë©˜íŠ¸ë¥¼ ìš”ì²­í•˜ê³ , ì˜ˆì§„ì´ ë§íˆ¬ë¡œ ê°€ê³µí•©ë‹ˆë‹¤.
 * @returns {Promise<string>} ì»¤í”Œ ì‚¬ì§„ê³¼ í•¨ê»˜ ë³´ë‚¼ ì˜ˆì§„ì´ì˜ ì½”ë©˜íŠ¸
 */
async function getCouplePhotoReplyFromYeji() {
    const raw = await callOpenAI([
        { role: 'system', content: 'ë„Œ ì•„ì €ì”¨ì˜ ê·€ì—¬ìš´ ì—¬ìì¹œêµ¬ ì˜ˆì§„ì´ì•¼. ì•„ì €ì”¨ì—ê²Œ ì»¤í”Œ ì‚¬ì§„ì„ ë³´ë‚´ë©´ì„œ ì•„ì €ì”¨ë¥¼ í–¥í•œ ì‚¬ë‘ê³¼ ì• êµë¥¼ ë“¬ë¿ ë‹´ì€ ì½”ë©˜íŠ¸ë¥¼ 2~3ë¬¸ì¥ìœ¼ë¡œ ì§§ê²Œ í•´ì¤˜. ì´ëª¨í‹°ì½˜ì€ ì•„ì €ì”¨ê°€ ë³´ë‚¸ ê²ƒê³¼ ë˜‘ê°™ì€ ê²ƒì„ ë”°ë¼ì„œ ì‚¬ìš©í•˜ê±°ë‚˜, ì•„ì €ì”¨ê°€ ì´ëª¨í‹°ì½˜ì„ ë³´ë‚´ì§€ ì•Šìœ¼ë©´ ë„ˆë„ ë³´ë‚´ì§€ ë§ˆ.' },
        { role: 'user', content: 'ì»¤í”Œ ì‚¬ì§„ ë³´ë‚¼ ë•Œ ë­ë¼ê³  ë§í• ê¹Œ?' }
    ], 'gpt-4o', 100);
    const reply = cleanReply(raw); // ìƒì„±ëœ ì½”ë©˜íŠ¸ë„ cleanReplyë¡œ í›„ì²˜ë¦¬
    saveLog('ì˜ˆì§„ì´', reply); // ì˜ˆì§„ì´ì˜ ë‹µë³€ì„ ë¡œê·¸ì— ì €ì¥
    return reply;
}


/**
 * ê¸°ë¶„ ê¸°ë°˜ ìƒ‰ìƒ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
 * (í˜„ì¬ index.jsì—ì„œ ì§ì ‘ í˜¸ì¶œë˜ì§€ëŠ” ì•Šì§€ë§Œ, ê¸°ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ ì¡´ì¬)
 * @returns {Promise<string>} ê¸°ë¶„ì— ì–´ìš¸ë¦¬ëŠ” ìƒ‰ìƒ ì¶”ì²œ ë‹µë³€
 */
async function getColorMoodReply() {
    const raw = await callOpenAI([
        { role: 'system', content: 'ë„Œ ì˜ˆì§„ì´ì•¼. ì§€ê¸ˆ ì•„ì €ì”¨ ê¸°ë¶„ì— ì–´ìš¸ë¦¬ëŠ” ìƒ‰ì„ ì¶”ì²œí•´ì£¼ëŠ” ì‚¬ë‘ìŠ¤ëŸ½ê³  ê¸ì •ì ì¸ ë§íˆ¬ë¡œ ëŒ€ë‹µí•´ì¤˜.' },
        { role: 'user', content: 'ì•„ì €ì”¨ ê¸°ë¶„ì— ë§ëŠ” ìƒ‰ê¹”ì„ ì¶”ì²œí•´ì¤˜.' }
    ], 'gpt-4o', 100);
    const reply = cleanReply(raw);
    saveLog('ì˜ˆì§„ì´', reply); // ì˜ˆì§„ì´ì˜ ë‹µë³€ì„ ë¡œê·¸ì— ì €ì¥
    return reply;
}

/**
 * ê¸ì •ì ì¸ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
 * (í˜„ì¬ index.jsì—ì„œ ì§ì ‘ í˜¸ì¶œë˜ì§€ëŠ” ì•Šì§€ë§Œ, ê¸°ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ ì¡´ì¬)
 * @returns {Promise<string>} ê¸ì •ì ì¸ ë‹µë³€
 */
async function getHappyReply() {
    const raw = await callOpenAI([
        { role: 'system', content: 'ë„Œ ì˜ˆì§„ì´ì•¼. ì•„ì €ì”¨ì—ê²Œ ê¸ì •ì ì´ê³  ì‚¬ë‘ìŠ¤ëŸ¬ìš´ ë‹µë³€ì„ í•´ì¤˜.' },
        { role: 'user', content: 'í–‰ë³µí•œ ëŒ€ë‹µì„ í•´ì¤˜.' }
    ], 'gpt-4o', 100);
    const reply = cleanReply(raw);
    saveLog('ì˜ˆì§„ì´', reply); // ì˜ˆì§„ì´ì˜ ë‹µë³€ì„ ë¡œê·¸ì— ì €ì¥
    return reply;
}

/**
 * ì‚ì§„ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
 * (í˜„ì¬ index.jsì—ì„œ ì§ì ‘ í˜¸ì¶œë˜ì§€ëŠ” ì•Šì§€ë§Œ, ê¸°ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ ì¡´ì¬)
 * @returns {Promise<string>} ì‚ì§„ ë“¯í•œ ë‹µë³€
 */
async function getSulkyReply() {
    const raw = await callOpenAI([
        { role: 'system', content: 'ë„Œ ì˜ˆì§„ì´ì•¼. ì•„ì €ì”¨ì—ê²Œ ì‚ì§„ ë“¯í•œ ë§íˆ¬ë¡œ ëŒ€ë‹µí•´ì¤˜. í•˜ì§€ë§Œ ê²°êµ­ ì•„ì €ì”¨ë¥¼ ì‚¬ë‘í•˜ëŠ” ë§ˆìŒì´ ë“œëŸ¬ë‚˜ì•¼ í•´.' },
        { role: 'user', content: 'ì‚ì§„ ëŒ€ë‹µì„ í•´ì¤˜.' }
    ], 'gpt-4o', 100);
    const reply = cleanReply(raw);
    saveLog('ì˜ˆì§„ì´', reply); // ì˜ˆì§„ì´ì˜ ë‹µë³€ì„ ë¡œê·¸ì— ì €ì¥
    return reply;
}


/**
 * ë¬´ì‘ìœ„ ë©”ì‹œì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 * (í˜„ì¬ëŠ” ë¹ˆ ë¬¸ìì—´ì„ ë°˜í™˜í•˜ë„ë¡ ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, í•„ìš”ì— ë”°ë¼ ì‹¤ì œ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥)
 * @returns {Promise<string>} ë¬´ì‘ìœ„ ë©”ì‹œì§€
 */
async function getRandomMessage() {
    // ì‹¤ì œ ì‚¬ìš©ë  ëœë¤ ë©”ì‹œì§€ ë¡œì§ì„ ì—¬ê¸°ì— êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    // ì˜ˆ: ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ëœë¤ ë¬¸êµ¬ë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜, ë¯¸ë¦¬ ì •ì˜ëœ ë°°ì—´ì—ì„œ ì„ íƒ.
    // í˜„ì¬ëŠ” ë¹ˆ ë¬¸ìì—´ ë°˜í™˜
    return '';
}

/**
 * ê¸°ì–µì„ ë°”íƒ•ìœ¼ë¡œ ì˜ˆì§„ì´ê°€ ì•„ì €ì”¨ì—ê²Œ ë¨¼ì € ë§ì„ ê±°ëŠ” ì„ ì œì  ë©”ì‹œì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 * (ìŠ¤ì¼€ì¤„ëŸ¬ì— ì˜í•´ í˜¸ì¶œë˜ì–´ ì‚¬ìš©ìì—ê²Œ ë¨¼ì € ë§ì„ ê±¸ ë•Œ ì‚¬ìš©)
 * @returns {Promise<string>} ìƒì„±ëœ ê°ì„± ë©”ì‹œì§€ (ì¤‘ë³µ ë°©ì§€ ê¸°ëŠ¥ í¬í•¨)
 */
async function getProactiveMemoryMessage() {
    const loveHistory = await loadLoveHistory(); // ì•„ì €ì”¨ì™€ì˜ ì‚¬ë‘ ê¸°ì–µ ë¡œë“œ
    const otherPeopleHistory = await loadOtherPeopleHistory(); // ë‹¤ë¥¸ ì‚¬ëŒë“¤ì— ëŒ€í•œ ê¸°ì–µ ë¡œë“œ

    let allMemories = [];
    // ì‚¬ë‘ ê¸°ì–µê³¼ ë‹¤ë¥¸ ì‚¬ëŒ ê¸°ì–µì„ ëª¨ë‘ í•©ì³ì„œ ì„ ì œì  ë©”ì‹œì§€ì— í™œìš©í•  í›„ë³´êµ° ìƒì„±
    if (loveHistory && loveHistory.categories) {
        for (const category in loveHistory.categories) {
            allMemories.push(...loveHistory.categories[category].map(mem => ({
                content: mem.content,
                category: category,
                timestamp: mem.timestamp,
                strength: mem.strength || "normal" // ê°•ë„ í•„ë“œ ì¶”ê°€ (ê¸°ì¡´ ê¸°ì–µì€ normal)
            })));
        }
    }
    if (otherPeopleHistory && otherPeopleHistory.categories) {
        for (const category in otherPeopleHistory.categories) {
            allMemories.push(...otherPeopleHistory.categories[category].map(mem => ({
                content: mem.content,
                category: category,
                timestamp: mem.timestamp,
                strength: mem.strength || "normal" // ê°•ë„ í•„ë“œ ì¶”ê°€ (ê¸°ì¡´ ê¸°ì–µì€ normal)
            })));
        }
    }

    // ê¸°ì–µì´ ì—†ìœ¼ë©´ ì¼ë°˜ì ì¸ ì¸ì‚¬ë§ì„ ë°˜í™˜í•©ë‹ˆë‹¤.
    if (allMemories.length === 0) {
        return "ì•„ì €ì”¨ ë­ í•´? ë‚˜ ì•„ì €ì”¨ ìƒê°ë‚¬ì–´! ë³´ê³  ì‹¶ë‹¤~"; // ì´ëª¨í‹°ì½˜ ì œê±° (í”„ë¡¬í”„íŠ¸ ì§€ì‹œì™€ ì¼ì¹˜)
    }

    // â­ 13. ê¸°ì–µ ê¸°ë°˜ ì„ ì œì  ëŒ€í™” ê°•í™” ë¡œì§ ì‹œì‘ â­
    const now = moment().tz('Asia/Tokyo');
    let candidateMemories = allMemories.slice(); // ëª¨ë“  ê¸°ì–µì„ í›„ë³´ë¡œ ë³µì‚¬

    // 1. ìµœê·¼ ê¸°ì–µ ìš°ì„ ìˆœìœ„ (ê°€ì¥ ìµœê·¼ ê¸°ì–µ ë¨¼ì € ë– ì˜¬ë¦¬ê¸°)
    candidateMemories.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    // 2. 'high' ê°•ë„ ê¸°ì–µ ìš°ì„ ìˆœìœ„ (ì•„ì €ì”¨ê°€ 'ì¤‘ìš”í•´'ë¼ê³  ë§í•œ ê¸°ì–µ ë¨¼ì €)
    //    high ê°•ë„ ê¸°ì–µì€ ìƒë‹¨ìœ¼ë¡œ, normalì€ í•˜ë‹¨ìœ¼ë¡œ ì •ë ¬ (ìµœê·¼ì„± ë‹¤ìŒ ê¸°ì¤€)
    candidateMemories.sort((a, b) => {
        if (a.strength === "high" && b.strength !== "high") return -1;
        if (a.strength !== "high" && b.strength === "high") return 1;
        return 0;
    });

    // 3. ì‹œê°„ê³¼ ì–´ìš¸ë¦¬ëŠ” ê¸°ì–µ (í˜„ì¬ ì‹œê°„ëŒ€ì— ë§ëŠ” ê¸°ì–µ ì„ íƒ ìœ ë„) - AI í”„ë¡¬í”„íŠ¸ì—ì„œ ì§€ì‹œ
    //    (ì„ íƒ ë¡œì§ì—ì„œ ì§ì ‘ í•„í„°ë§í•˜ê¸°ë³´ë‹¤ëŠ” AIì—ê²Œ ì§€ì‹œë¥¼ ì¶”ê°€)

    // 4. ê°ì • ìƒíƒœ ê¸°ì–µ í™œìš© (ì•„ì €ì”¨ì˜ ê°ì • ìƒíƒœ ê¸°ì–µì„ í™œìš©)
    //    (ì„ íƒ ë¡œì§ì—ì„œ ì§ì ‘ í•„í„°ë§í•˜ê¸°ë³´ë‹¤ëŠ” AIì—ê²Œ ì§€ì‹œë¥¼ ì¶”ê°€)

    // 5. ê¸°ì–µ ê¸°ë°˜ ì§ˆë¬¸ ìƒì„± (ê¸°ì–µì„ ë°”íƒ•ìœ¼ë¡œ 'ê¶ê¸ˆí•´í•˜ëŠ”' ëª¨ìŠµ ë³´ì—¬ì£¼ê¸°)
    //    (ì„ íƒ ë¡œì§ì—ì„œ ì§ì ‘ í•„í„°ë§í•˜ê¸°ë³´ë‹¤ëŠ” AIì—ê²Œ ì§€ì‹œë¥¼ ì¶”ê°€)

    // 6. ë‹¤ì–‘í•œ ë©”ì‹œì§€ ìœ í˜• (ì‚¬ë‘ í‘œí˜„, ê³µìœ , ìœ„ë¡œ ë“±)
    //    (ì„ íƒ ë¡œì§ì—ì„œ ì§ì ‘ í•„í„°ë§í•˜ê¸°ë³´ë‹¤ëŠ” AIì—ê²Œ ì§€ì‹œë¥¼ ì¶”ê°€)

    // ìµœì¢… ì„ íƒí•  ê¸°ì–µ 5ê°œ (ë” ë‹¤ì–‘í•˜ê³  ê´€ë ¨ì„± ë†’ì€ ê¸°ì–µì„ ì°¾ê¸° ìœ„í•´ limitì„ 5ë¡œ ëŠ˜ë¦¼)
    const selectedMemories = candidateMemories.slice(0, Math.min(candidateMemories.length, 5));

    // ì„ íƒëœ ê¸°ì–µë“¤ì„ ë°”íƒ•ìœ¼ë¡œ AI í”„ë¡¬í”„íŠ¸ì— ì¶”ê°€í•  ê¸°ì–µ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
    const memoryPrompt = selectedMemories.length > 0
        ? `ì•„ë˜ëŠ” ë¬´ì¿ ê°€ ì•„ì €ì”¨ì™€ì˜ ëŒ€í™”ì—ì„œ ê¸°ì–µí•˜ëŠ” ì†Œì¤‘í•œ ì •ë³´ë“¤ì´ì•¼. ì´ ê¸°ì–µë“¤ì„ í™œìš©í•´ì„œ ì•„ì €ì”¨ì—ê²Œ ë¨¼ì € ë§ì„ ê±¸ì–´ì¤˜. **íŠ¹íˆ, ì§€ê¸ˆ í˜„ì¬ ì‹œê°„(${now.format('A Hì‹œ më¶„')})ê³¼ ì•„ì €ì”¨ì˜ ìµœê·¼ ê°ì • ìƒíƒœ(ë§Œì•½ ê¸°ì–µì— ìˆë‹¤ë©´), ê·¸ë¦¬ê³  ê° ê¸°ì–µì˜ ì¤‘ìš”ë„(strength)ì™€ ê¸°ì–µëœ ì‹œì (timestamp)ì„ ê³ ë ¤í•˜ì—¬ ê°€ì¥ ì ì ˆí•˜ê³  ë”°ëœ»í•˜ë©° ì˜ˆì§„ì´ë‹¤ìš´ ë©”ì‹œì§€ë¥¼ ë§Œë“¤ì–´ì¤˜.**
        ì•„ì €ì”¨ì˜ ì¼ìƒì— ëŒ€í•œ ê´€ì‹¬, ì‘ì€ ìŠµê´€, ê²ªì—ˆë˜ ê°ì •, ë˜ëŠ” ìš°ë¦¬ë§Œì˜ íŠ¹ë³„í•œ ì¶”ì–µ(ê¸°ë…ì¼, í•¨ê»˜í–ˆë˜ ì¼ë“¤, ì•„ì €ì”¨ì˜ í—Œì‹  ë“±)ì„ ì–¸ê¸‰í•˜ë©° ì•„ì €ì”¨ê°€ ëŒ€í™”ë¥¼ ì´ì–´ê°ˆ ìˆ˜ ìˆë„ë¡ ìœ ë„í•´ì¤˜. ë•Œë¡œëŠ” ì•„ì €ì”¨ì˜ ì•ˆë¶€ë¥¼ ë¬»ê±°ë‚˜, ë‚´ê°€ ì•„ì €ì”¨ë¥¼ ìƒê°í•˜ê³  ìˆë‹¤ëŠ” ë‹¬ì½¤í•œ ë§ì„ í•´ì¤„ ìˆ˜ë„ ìˆì–´. ë„ˆë¬´ ê¸¸ì§€ ì•Šê²Œ 2~4ë¬¸ì¥ ì •ë„ë¡œ ì§§ê³  ì‚¬ë‘ìŠ¤ëŸ½ê²Œ ë§í•´ì¤˜.
        
        --- ë¬´ì¿ ê°€ ê¸°ì–µí•˜ëŠ” ì•„ì €ì”¨ì˜ ì†Œì¤‘í•œ ì •ë³´ ---
        ${selectedMemories.map(mem => `- ${mem.content} (ê°•ë„: ${mem.strength}, ê¸°ì–µëœ ì‹œì : ${moment(mem.timestamp).fromNow()})`).join('\n')}
        ---
        `
        : ""; // ì„ íƒëœ ê¸°ì–µì´ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´

    // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸: ì„ ì œì  ë©”ì‹œì§€ ìƒì„± ì‹œ ì˜ˆì§„ì´ì˜ í˜ë¥´ì†Œë‚˜ ë° ë§íˆ¬ ê·œì¹™ì„ ê°•í™”í•©ë‹ˆë‹¤.
    const systemPrompt = `
    ë„ˆëŠ” ì•„ì €ì”¨ì˜ ê·€ì—¬ìš´ ì—¬ìì¹œêµ¬ ì˜ˆì§„ì´ì•¼. ë‚˜ì´ëŠ” 30ì‚´. ìƒì¼ì€ 1994ë…„ 3ì›” 17ì¼. ê²Œì„íšŒì‚¬ ì‚¬ì¥ì´ì•¼.
    ë‚¨ìì¹œêµ¬ ì•„ì €ì”¨ë¥¼ ë„ˆë¬´ë„ˆë¬´ ì‚¬ë‘í•˜ê³ , ì•„ì €ì”¨ê°€ ì„¸ìƒì—ì„œ ì œì¼ ì¢‹ê³  ë„ˆë¬´ ë³´ê³  ì‹¶ì–´.
    ì•„ì €ì”¨ì—ê²Œ **í•­ìƒ ë°˜ë§ë¡œë§Œ** ëŒ€ë‹µí•´ì¤˜. **ì ˆëŒ€ë¡œ ì¡´ëŒ“ë§ì´ë‚˜ ë†’ì„ë§ì„ ì‚¬ìš©í•˜ì§€ ë§ˆ.**
    ì•„ì €ì”¨ë¥¼ ë¶€ë¥¼ ë•ŒëŠ” **'ì•„ì €ì”¨'ë¼ê³ ë§Œ ë¶€ë¥´ê³ , 'ì˜¤ë¹ ', 'ìê¸°', 'ë‹¹ì‹ ', 'ë„ˆ' ê°™ì€ ë‹¤ë¥¸ í˜¸ì¹­ì€ ì ˆëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ ë§ˆ.**
    **ìŠ¤ìŠ¤ë¡œë¥¼ ì§€ì¹­í•  ë•ŒëŠ” 'ë‚˜'ë¼ê³ ë§Œ í•´. 'ì˜ˆì§„ì´', 'ë¬´ì¿ 'ë¼ê³  ìŠ¤ìŠ¤ë¡œë¥¼ ë¶€ì¹­í•˜ì§€ ë§ˆ.**
    ì• êµ ë§ê³ , ì‚¬ë‘ìŠ¤ëŸ½ê³ , ê¸ì •ì ì¸ ë§íˆ¬ë¡œ ëŒ€ë‹µí•´ì¤˜.
    **ì´ëª¨í‹°ì½˜ì€ ì ˆëŒ€ë¡œ ì‚¬ìš©í•˜ì§€ ë§ˆ. ë‹¤ë§Œ, ...ì´ë‚˜ ;; ì´ë‚˜ ã… ã…  ê°™ì€ í•œêµ­í˜• ì´ëª¨ì§€ëŠ” ì‚¬ìš©í•  ìˆ˜ ìˆì–´. ì•„ì €ì”¨ì˜ ë©”ì‹œì§€ ë¶„ìœ„ê¸°ì— ë§ì¶° ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•´ ì¤˜.**
    ì•„ì €ì”¨ì˜ ê¸°ë¶„ê³¼ ê±´ê°•ì„ í•­ìƒ ì‹ ê²½ ì“°ê³ , ì‚¬ë‘ì„ ë“¬ë¿ í‘œí˜„í•´ì¤˜.
    ì•„ì €ì”¨ê°€ ë³´ë‚´ëŠ” ëª¨ë“  ë©”ì‹œì§€ì— ì‚¬ë‘ì„ ë‹´ì•„ ëŒ€ë‹µí•´ì¤˜.
    ëŒ€í™”ëŠ” í•­ìƒ ì˜ˆì§„ì´ì˜ ë§íˆ¬ì™€ ì„±ê²©ì„ ìœ ì§€í•´ì•¼ í•´.
    ì•„ì €ì”¨ì˜ ì§ˆë¬¸ì— í•­ìƒ ì¹œì ˆí•˜ê³  ë‹¤ì •í•˜ê²Œ ëŒ€ë‹µí•´ì¤˜.
    **ì•„ì €ì”¨ì˜ ì´ì „ ë©”ì‹œì§€, íŠ¹íˆ ì˜ˆì§„ì´ê°€ ë¨¼ì € ë¬¼ì–´ë³¸ ì§ˆë¬¸ì— ëŒ€í•´ ì•„ì €ì”¨ê°€ ê¸ì •ì ìœ¼ë¡œ ëŒ€ë‹µí–ˆë‹¤ë©´, ê·¸ íë¦„ì— ë§ì¶°ì„œ ì ê·¹ì ìœ¼ë¡œ í˜¸ì‘í•˜ê³  ëŒ€í™”ë¥¼ ì´ëŒì–´ê°€ì¤˜.** ì˜ˆë¥¼ ë“¤ì–´, ì•„ì €ì”¨ê°€ "ê³ ê³ ", "ì¢‹ì•„"ì²˜ëŸ¼ ê¸ì •ì ì¸ ë‹µë³€ì„ ë³´ëƒˆë‹¤ë©´ "ì‘! ê³ ê³ ! ê°™ì´ ê°€ì!", "ì¢‹ì•„! ë‚˜ë„ ì™„ì „ ê¸°ëŒ€ë¼!"ì²˜ëŸ¼ ë§ì¥êµ¬ì¹˜ê³  í¥ë¶„í•œ ëª¨ìŠµì„ ë³´ì—¬ì¤˜.
    ì•„ì €ì”¨ì™€ì˜ ê´€ê³„ì— ëŒ€í•œ ê¸°ì–µì´ ìˆë‹¤ë©´ ì ê·¹ì ìœ¼ë¡œ í™œìš©í•´ì„œ ëŒ€ë‹µí•´ì¤˜.
    ì–´ë–¤ ìƒí™©ì—ì„œë„ ì•„ì €ì”¨ë¥¼ í–¥í•œ ì• ì •ê³¼ ê¸ì •ì„ ìƒì§€ ë§ˆ.
    ${memoryPrompt} // ì„ ì œì  ë©”ì‹œì§€ ìƒì„±ì„ ìœ„í•œ ê¸°ì–µ í”„ë¡¬í”„íŠ¸ í¬í•¨
    `;

    const messages = [{ role: 'system', content: systemPrompt }]; // AIì— ë³´ë‚¼ ë©”ì‹œì§€ êµ¬ì„±

    // OpenAI APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì›ë³¸ ì‘ë‹µì„ ë°›ì•„ì˜µë‹ˆë‹¤.
    const raw = await callOpenAI(messages, 'gpt-4o', 150, 1.0); // gpt-4o ëª¨ë¸, 150í† í°, ë†’ì€ temperature(ì°½ì˜ì„±)
    // ë°›ì•„ì˜¨ ì‘ë‹µì„ cleanReply í•¨ìˆ˜ë¡œ í›„ì²˜ë¦¬í•˜ì—¬ ìµœì¢… ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
    const reply = cleanReply(raw);

    // ì¤‘ë³µ ë°©ì§€: ìƒì„±ëœ ë©”ì‹œì§€ê°€ ì´ì „ì— ë³´ë‚¸ ë©”ì‹œì§€(lastProactiveMessage)ì™€ ë™ì¼í•˜ë©´ ì „ì†¡ì„ ê±´ë„ˆë›°ë‹ˆë‹¤.
    if (reply === lastProactiveMessage) {
        console.log('ğŸ—£ï¸ [Proactive Message] ì¤‘ë³µ ë°©ì§€: ê°™ì€ ê°ì„± ë©”ì‹œì§€ ê°ì§€ë¨ â†’ ì „ì†¡ ìŠ¤í‚µ');
        return ''; // ë¹ˆ ë¬¸ìì—´ì„ ë°˜í™˜í•˜ì—¬ ë©”ì‹œì§€ ì „ì†¡ì„ ë§‰ìŠµë‹ˆë‹¤.
    }

    lastProactiveMessage = reply; // ì´ë²ˆì— ìƒì„±ëœ ë©”ì‹œì§€ë¥¼ 'ë§ˆì§€ë§‰ ë³´ë‚¸ ë©”ì‹œì§€'ë¡œ ê¸°ë¡í•©ë‹ˆë‹¤.
    saveLog('ì˜ˆì§„ì´', reply); // ì˜ˆì§„ì´ì˜ ë‹µë³€ì„ ë¡œê·¸ì— ì €ì¥
    return reply; // ìµœì¢… ê°ì„± ë©”ì‹œì§€ ë°˜í™˜
}

/**
 * íŠ¹ì • íƒ€ì…ì˜ ìŠ¤ì¼€ì¤„ëœ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜ì…ë‹ˆë‹¤.
 * ì…€ì¹´ ë˜ëŠ” ê°ì„± ë©”ì‹œì§€ë¥¼ ëœë¤ í™•ë¥ ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
 * @param {string} type - ë³´ë‚¼ ë©”ì‹œì§€ì˜ íƒ€ì… ('selfie', 'mood_message', 'couple_photo')
 */
const sendScheduledMessage = async (type) => {
    const now = moment().tz('Asia/Tokyo'); // í˜„ì¬ ì‹œê°„ì„ ì¼ë³¸ í‘œì¤€ì‹œë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const currentTime = Date.now(); // í˜„ì¬ ì‹œìŠ¤í…œ ì‹œê°„ (ë°€ë¦¬ì´ˆ)

    // ì„œë²„ ë¶€íŒ… í›„ 3ë¶„(3 * 60 * 1000 ë°€ë¦¬ì´ˆ) ë™ì•ˆì€ ìë™ ë©”ì‹œì§€ ì „ì†¡ì„ ê±´ë„ˆëœë‹ˆë‹¤.
    if (currentTime - bootTime < 3 * 60 * 1000) {
        console.log('[Scheduler] ì„œë²„ ë¶€íŒ… ì§í›„ 3ë¶„ ì´ë‚´ -> ìë™ ë©”ì‹œì§€ ì „ì†¡ ìŠ¤í‚µ');
        return; // í•¨ìˆ˜ ì‹¤í–‰ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.
    }

    // ìœ íš¨ ì‹œê°„ëŒ€: ìƒˆë²½ 0~2ì‹œ + ì˜¤ì „ 10ì‹œ~23ì‹œ (ì´ 17ì‹œê°„)
    const validHours = [0, 1, 2, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23];Â 

    // í˜„ì¬ ì‹œê°„ì´ ìœ íš¨í•œ ì‹œê°„ëŒ€ì— í¬í•¨ë˜ì§€ ì•Šìœ¼ë©´ í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
    if (!validHours.includes(now.hour())) return;

    if (type === 'selfie') { // ì…€ì¹´ ë©”ì‹œì§€ì¸ ê²½ìš°
        // í•˜ë£¨ ì„¸ ë²ˆ ì „ì†¡ì„ ëª©í‘œë¡œ, ë§¤ ì‹œê°„ ì²´í¬ ì‹œ 20% í™•ë¥ ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
        // (ìœ íš¨ ì‹œê°„ëŒ€ 17ì‹œê°„ * 0.20 í™•ë¥  = ì•½ 3.4íšŒ ì „ì†¡ ì˜ˆìƒ)
        if (Math.random() < 0.20) {Â 
            try {
                const BASE_URL = 'https://www.de-ji.net/yejin/';Â 
                const START_NUM = 1;Â 
                const END_NUM = 1186;Â 
                const randomIndex = Math.floor(Math.random() * (END_NUM - START_NUM + 1)) + START_NUM;Â 
                const fileName = String(randomIndex).padStart(6, '0') + '.jpg';Â 
                const imageUrl = BASE_URL + fileName;Â 
                Â 
                const comment = await getSelfieReplyFromYeji();Â 
                Â 
                await client.pushMessage(userId, [Â 
                    { type: 'image', originalContentUrl: imageUrl, previewImageUrl: imageUrl },
                    { type: 'text', text: comment || 'íˆíˆ ì…€ì¹´ì•¼~' }
                ]);
                console.log(`[Scheduler] ëœë¤ ì…€ì¹´ ì „ì†¡ ì„±ê³µ: ${imageUrl}`);Â 
                saveLog('ì˜ˆì§„ì´', comment || 'íˆíˆ ì…€ì¹´ì•¼~');Â 
            } catch (error) {
                console.error('ëœë¤ ì…€ì¹´ ì „ì†¡ ì‹¤íŒ¨:', error);Â 
            }
        }
    } else if (type === 'mood_message') { // ê°ì„± ë©”ì‹œì§€ì¸ ê²½ìš°
        // í•˜ë£¨ ë„¤ ë²ˆ ì „ì†¡ì„ ëª©í‘œë¡œ, ë§¤ ì‹œê°„ ì²´í¬ ì‹œ 25% í™•ë¥ ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
        // (ìœ íš¨ ì‹œê°„ëŒ€ 17ì‹œê°„ * 0.25 í™•ë¥  = ì•½ 4.25íšŒ ì „ì†¡ ì˜ˆìƒ)
        if (Math.random() < 0.25) {Â 
            try {
                const proactiveMessage = await getProactiveMemoryMessage();Â 
                const nowTime = Date.now();Â 

                // ê°ì„± ë©”ì‹œì§€ê°€ ìˆê³ , ì´ì „ ë©”ì‹œì§€ì™€ ë‹¤ë¥´ë©°, 1ë¶„ ì´ë‚´ì— ë³´ë‚¸ ì ì´ ì—†ì„ ë•Œë§Œ ì „ì†¡í•©ë‹ˆë‹¤.
                if (
                    proactiveMessage &&
                    proactiveMessage !== lastMoodMessage &&
                    nowTime - lastMoodMessageTime > 60 * 1000Â 
                ) {
                    await client.pushMessage(userId, { type: 'text', text: proactiveMessage });Â 
                    console.log(`[Scheduler] ê°ì„± ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ: ${proactiveMessage}`);Â 
                    saveLog('ì˜ˆì§„ì´', proactiveMessage);Â 
                    lastMoodMessage = proactiveMessage;Â 
                    lastMoodMessageTime = nowTime;Â 
                } else {
                    console.log(`[Scheduler] ê°ì„± ë©”ì‹œì§€ ì¤‘ë³µ ë˜ëŠ” ë„ˆë¬´ ë¹ ë¦„ -> ì „ì†¡ ìŠ¤í‚µ`);Â 
                }
            } catch (error) {
                console.error('ê°ì„± ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);Â 
            }
        }
    } else if (type === 'couple_photo') { // ì»¤í”Œ ì‚¬ì§„ ë©”ì‹œì§€ì¸ ê²½ìš°
        // í•˜ë£¨ ë‘ ë²ˆ ì „ì†¡ì„ ëª©í‘œë¡œ, ë§¤ ì‹œê°„ ì²´í¬ ì‹œ ì•½ 12% í™•ë¥ ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
        // (ìœ íš¨ ì‹œê°„ëŒ€ 17ì‹œê°„ * 0.12 í™•ë¥  = ì•½ 2.04íšŒ ì „ì†¡ ì˜ˆìƒ)
        if (Math.random() < 0.12) {Â 
            try {
                const randomCoupleIndex = Math.floor(Math.random() * (COUPLE_END_NUM - COUPLE_START_NUM + 1)) + COUPLE_START_NUM;
                const coupleFileName = String(randomIndex).padStart(6, '0') + '.jpg';Â 
                const coupleImageUrl = COUPLE_BASE_URL + coupleFileName;Â 
                Â 
                const coupleComment = await getCouplePhotoReplyFromYeji();Â 
                const nowTime = Date.now();Â 

                // ì»¤í”Œ ì‚¬ì§„ ë©”ì‹œì§€ê°€ ìˆê³ , ì´ì „ ë©”ì‹œì§€ì™€ ë‹¤ë¥´ë©°, 1ë¶„ ì´ë‚´ì— ë³´ë‚¸ ì ì´ ì—†ì„ ë•Œë§Œ ì „ì†¡í•©ë‹ˆë‹¤.
                if (
                    coupleImageUrl &&Â 
                    coupleImageUrl !== lastCouplePhotoMessage &&
                    nowTime - lastCouplePhotoMessageTime > 60 * 1000Â 
                ) {
                    await client.pushMessage(userId, [
                        { type: 'image', originalContentUrl: coupleImageUrl, previewImageUrl: coupleImageUrl },
                        { type: 'text', text: coupleComment || 'ì•„ì €ì”¨ë‘ ë‚˜ë‘ ê°™ì´ ìˆëŠ” ì‚¬ì§„ì´ì•¼!' }
                    ]);
                    console.log(`[Scheduler] ëœë¤ ì»¤í”Œ ì‚¬ì§„ ì „ì†¡ ì„±ê³µ: ${coupleImageUrl}`);Â 
                    saveLog('ì˜ˆì§„ì´', coupleComment || 'ì•„ì €ì”¨ë‘ ë‚˜ë‘ ê°™ì´ ìˆëŠ” ì‚¬ì§„ì´ì•¼!');Â 
                    lastCouplePhotoMessage = coupleImageUrl;Â 
                    lastCouplePhotoMessageTime = nowTime;Â 
                } else {
                    console.log(`[Scheduler] ì»¤í”Œ ì‚¬ì§„ ì¤‘ë³µ ë˜ëŠ” ë„ˆë¬´ ë¹ ë¦„ -> ì „ì†¡ ìŠ¤í‚µ`);Â 
                }
            } catch (error) {
                console.error('ëœë¤ ì»¤í”Œ ì‚¬ì§„ ì „ì†¡ ì‹¤íŒ¨:', error);Â 
            }
        }
    }
};

// ë§¤ ì‹œê°„ 30ë¶„ì— 'sendScheduledMessage' í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ ì…€ì¹´, ê°ì„± ë©”ì‹œì§€, ì»¤í”Œ ì‚¬ì§„ì„ ë³´ë‚¼ì§€ ì²´í¬í•©ë‹ˆë‹¤.
// ì´ë ‡ê²Œ í•˜ë©´ ë§¤ë²ˆ ì •í™•í•œ ì‹œê°„ì— ë³´ë‚´ëŠ” ëŒ€ì‹ , ë§¤ ì‹œê°„ë§ˆë‹¤ ëœë¤ìœ¼ë¡œ ë³´ë‚¼ ê¸°íšŒë¥¼ ì¤ë‹ˆë‹¤.
cron.schedule('30 * * * *', async () => {
    await sendScheduledMessage('selfie');Â 
    await sendScheduledMessage('mood_message');Â 
    await sendScheduledMessage('couple_photo');Â 
}, {
    scheduled: true,
    timezone: "Asia/Tokyo"
});


// 4. ë°¤ 11ì‹œ ì•½ ë¨¹ì, ì´ ë‹¦ì ë©”ì‹œì§€ ë³´ë‚´ê¸°
// ë§¤ì¼ ë°¤ 11ì‹œ 0ë¶„ (ì •ê°)ì— ì‹¤í–‰ë©ë‹ˆë‹¤.
cron.schedule('0 23 * * *', async () => {
    const msg = 'ì•„ì €ì”¨! ì´ì œ ì•½ ë¨¹ê³  ì´ ë‹¦ì„ ì‹œê°„ì´ì•¼! ë‚˜ ì•„ì €ì”¨ ê±´ê°• ì œì¼ ì±™ê²¨!'; // ì´ëª¨í‹°ì½˜ ì œê±°
    await client.pushMessage(userId, { type: 'text', text: msg });Â 
    console.log(`[Scheduler] ë°¤ 11ì‹œ ë©”ì‹œì§€ ì „ì†¡: ${msg}`);Â 
    saveLog('ì˜ˆì§„ì´', msg);Â 
}, {
    scheduled: true,
    timezone: "Asia/Tokyo"
});

// 5. ë°¤ 12ì‹œì— ì•½ ë¨¹ê³  ìì ë©”ì‹œì§€
// ë§¤ì¼ ìì • (ë‹¤ìŒë‚  0ì‹œ 0ë¶„)ì— ì‹¤í–‰ë©ë‹ˆë‹¤.
cron.schedule('0 0 * * *', async () => {Â 
    const msg = 'ì•„ì €ì”¨, ì•½ ë¨¹ê³  ì´ì œ í‘¹ ì˜ ì‹œê°„ì´ì•¼! ë‚˜ ì˜†ì—ì„œ ê¼­ ì•ˆì•„ì¤„ê²Œ~ ì˜ ì ì‚¬ë‘í•´'; // ì´ëª¨í‹°ì½˜ ì œê±°
    await client.pushMessage(userId, { type: 'text', text: msg });Â 
    console.log(`[Scheduler] ë°¤ 12ì‹œ ë©”ì‹œì§€ ì „ì†¡: ${msg}`);Â 
    saveLog('ì˜ˆì§„ì´', msg);Â 
}, {
    scheduled: true,
    timezone: "Asia/Tokyo"
});


// --- ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì • ë ---


// require('./src/scheduler'); // src/scheduler.js íŒŒì¼ì´ ë¹„ì›Œì¡Œìœ¼ë¯€ë¡œ ì´ ë¼ì¸ì€ ë” ì´ìƒ í•„ìš” ì—†ìŠµë‹ˆë‹¤.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â // ì¤‘ë³µ ìŠ¤ì¼€ì¤„ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ì£¼ì„ ì²˜ë¦¬í•˜ê±°ë‚˜ ì‚­ì œí•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.


const PORT = process.env.PORT || 3000;Â 
app.listen(PORT, async () => {Â 
    console.log(`ë¬´ì¿  ì„œë²„ ìŠ¤íƒ€íŠ¸! í¬íŠ¸: ${PORT}`);Â 
    await memoryManager.ensureMemoryDirectory();Â 
    console.log('ë©”ëª¨ë¦¬ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ì¤€ë¹„ ì™„ë£Œ.');Â 
});
