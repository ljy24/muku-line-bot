//============================================================================
// concept.js - v4.0 (êµ­ê°€ë³„ + ì›”ë³„ ëœë¤ ì§€ì›!)
// ğŸ“¸ ì• ê¸°ì˜ ê°ì •ì„ ì½ì–´ì„œ ì½”ë©˜íŠ¸ì™€ í•¨ê»˜ ì»¨ì…‰ ì‚¬ì§„ì„ ì „ì†¡í•©ë‹ˆë‹¤.
// ============================================================================

const axios = require('axios');

// âœ… [ì¶”ê°€] ì‚¬ì§„ ë§¥ë½ ì¶”ì ì„ ìœ„í•œ autoReply ëª¨ë“ˆ ì¶”ê°€
const autoReply = require('./autoReply.js');

// aiUtils í•¨ìˆ˜ë“¤ì„ ì§ì ‘ ì •ì˜ (import ì—ëŸ¬ ë°©ì§€)
async function callOpenAI(messages, model = 'gpt-4o', maxTokens = 150, temperature = 1.0) {
    try {
        const { OpenAI } = require('openai');
        const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });
        
        const response = await openai.chat.completions.create({
            model: model,
            messages: messages,
            max_tokens: maxTokens,
            temperature: temperature,
        });
        
        return response.choices[0].message.content.trim();
    } catch (error) {
        console.error('âŒ OpenAI API í˜¸ì¶œ ì‹¤íŒ¨:', error);
        return 'ì•„ì €ì”¨~ ì§€ê¸ˆ ìƒê°ì´ ì˜ ì•ˆ ë‚˜... ë‹¤ì‹œ ë§í•´ì¤„ë˜?';
    }
}

function cleanReply(text) {
    if (!text || typeof text !== 'string') return 'ì•„ì €ì”¨~ ë­”ê°€ ì´ìƒí•´...';
    return text.trim().replace(/^["']|["']$/g, '');
}

// ì»¨ì…‰ ì‚¬ì§„ì´ ì €ì¥ëœ ì›¹ ì„œë²„ì˜ ê¸°ë³¸ URL (HTTPS í•„ìˆ˜)
const BASE_CONCEPT_URL = 'https://photo.de-ji.net/photo/concept/';

// ì•„ì €ì”¨ê°€ ì œê³µí•´ì£¼ì‹  ì»¨ì…‰ ì‚¬ì§„ í´ë”ë³„ ì‚¬ì§„ ê°œìˆ˜ ë°ì´í„°
const CONCEPT_FOLDERS = {
    "2023_12_12_ì¼ë³¸_í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸": 29,
    "2023_12_13_ì¼ë³¸_ëª¨ì§€ì½”": 42,
    "2023_12_14_ì¼ë³¸_í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ": 75,
    "2023_12_15_ì¼ë³¸_êµë³µ": 51,
    "2023_12_16_ì¼ë³¸_ì„ ë¬¼": 113,
    "2023_12_31_í•œêµ­_ëˆˆë°­": 38,
    "2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼": 43,
    "2024_02_07_ì¼ë³¸_ì•„ì´ë…¸ì‹œë§ˆ": 65,
    "2024_02_07_ì¼ë³¸_ìš•ì‹¤": 61,
    "2024_02_11_ì¼ë³¸_ë„¤ì½”_ëª¨ì§€ì½”": 21,
    "2024_02_11_ì¼ë³¸_ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤": 31,
    "2024_02_22_í•œêµ­_ìƒì¼": 45,
    "2024_02_22_í•œêµ­_ìƒì¼_00022.jpg": 1,
    "2024_02_22_í•œêµ­_ì¹´í˜": 19,
    "2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©": 47,
    "2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg": 1,
    "2024_03_17_ì¼ë³¸_ê³ ì¿ ë¼": 19,
    "2024_04_12_í•œêµ­_ë²—ê½ƒ": 35,
    "2024_04_12_í•œêµ­_ì•¼ê°„_ë™ë°±": 26,
    "2024_04_13_í•œêµ­_ë¬¸ë˜ë™": 16,
    "2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ": 31,
    "2024_04_13_í•œêµ­_í™”ê°€": 30,
    "2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜": 111,
    "2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg": 1,
    "2024_05_02_ì¼ë³¸_ë™í‚¤_ê±°ë¦¬": 18,
    "2024_05_03_ì¼ë³¸_ìˆ˜êµ­": 14,
    "2024_05_03_ì¼ë³¸_ì§€ë¸Œë¦¬í’": 74,
    "2024_05_03_ì¼ë³¸_í›„ì§€ì—”": 40,
    "2024_05_04_ì¼ë³¸_ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸": 49,
    "2024_05_05_ì¼ë³¸_ëª¨ì§€ì½”_ëª¨ë¦¬ë£©": 64,
    "2024_05_05_ì¼ë³¸_ì½”ì´ë…¸ë³´ë¦¬": 17,
    "2024_05_06_ì¼ë³¸_ì•¼ê°„ê±°ë¦¬": 43,
    "2024_05_07_ì¼ë³¸_ê²Œì„ì„¼í„°": 19,
    "2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…": 323,
    "2024_06_06_í•œêµ­_ë¶í•´": 65,
    "2024_06_07_í•œêµ­__í”¼í¬ë‹‰": 36,
    "2024_06_08_í•œêµ­__í„°ë„": 28,
    "2024_06_08_í•œêµ­_ë§ì¹œ_ì‚¬ì§„": 52,
    "2024_06_09_í•œêµ­_ì‚°ì±…": 23,
    "2024_06_09_í•œêµ­_ì‚°ì±…_0000009.jpg": 1,
    "2024_06_09_í•œêµ­_ì‚°ì±…_0000109.jpg": 1,
    "2024_07_05_ì¼ë³¸_ëª¨ì§€ì½”": 26,
    "2024_07_06_ì¼ë³¸_ëª¨ì§€ì½”": 45,
    "2024_07_06_ì¼ë³¸_ìš°ë§ˆì‹œë§ˆ": 53,
    "2024_07_08_ì¼ë³¸_ì—¬ì¹œ_ìŠ¤ëƒ…": 41,
    "2024_07_08_ì¼ë³¸_ìš•ì¡°": 53,
    "2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•": 223,
    "2024_08_02_ì¼ë³¸_ë¶ˆê½ƒë†€ì´": 39,
    "2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬": 56,
    "2024_08_04_ì¼ë³¸_ë¸”ë™ì›í”¼ìŠ¤": 29,
    "2024_09_11_í•œêµ­_í˜¸ë¦¬ì¡´": 41,
    "2024_09_14_í•œêµ­_ì›ë¯¸ìƒê°€_í•„ë¦„": 34,
    "2024_09_15_í•œêµ­_ì˜¥ìƒì—°ë¦¬": 98,
    "2024_09_16_í•œêµ­_ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…": 46,
    "2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…": 46,
    "2024_10_16_ì¼ë³¸_ê²°ë°•": 137,
    "2024_10_16_ì¼ë³¸_ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ": 20,
    "2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›": 5,
    "2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„": 24,
    "2024_10_16_ì¼ë³¸_ìš•ì‹¤": 15,
    "2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸": 29,
    "2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ": 59,
    "2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„": 49,
    "2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸": 39,
    "2024_11_08_í•œêµ­_ë©”ì´ë“œë³µ": 14,
    "2024_11_08_í•œêµ­_ìš•ì‹¤_ë¸”ë™_ì›¨ë”©": 42,
    "2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›": 53,
    "2024_12_07_í•œêµ­_í™ˆì…€í”„": 81,
    "2024_12_12_ì¼ë³¸_ëª¨ì§€ì½”": 49,
    "2024_12_13_ì¼ë³¸_í¬ë¦¬ìŠ¤ë§ˆìŠ¤": 22,
    "2024_12_14_ì¼ë³¸_ë‚˜ë¥´ì‹œìŠ¤íŠ¸": 26,
    "2024_12_30_í•œêµ­_ì¹´í˜": 29,
    "2024_12_31_í•œêµ­_ìƒì¼ì»¨ì…‰": 43,
    "2025_01_05_í•œêµ­": 63,
    "2025_02_06_ì¼ë³¸_ì½”ì•¼ë…¸ì„¸": 43,
    "2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°": 48,
    "2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ": 92,
    "2025_03_13_ì¼ë³¸_ë¬´ì¸ì—­": 30,
    "2025_03_14_ì¼ë³¸_ê³ ì¿ ë¼": 32,
    "2025_03_17_ì¼ë³¸_ê³ ì¿ ë¼": 17,
    "2025_03_17_ì¼ë³¸_í…ì§„": 28,
    "2025_03_22": 27,
    "2025_03_ì¼ë³¸_í•„ë¦„": 64,
    "2025_04_29_í•œêµ­_ì´í™”ë§ˆì„": 55,
    "2025_04_30_í•œêµ­_ì„ì§€ë¡œ": 30,
    "2025_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ": 25,
    "2025_05_03_í•œêµ­_í™ˆìŠ¤ëƒ…_ì²­í¬ë„": 42,
    "2025_05_04_í•œêµ­": 43,
    "2025_05_04_í•œêµ­_ê³µì›_ì‚°ì±…": 32,
    "2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…": 32,
    "2025_05_05_í•œêµ­_í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ": 27,
    "2025_05_06_ë§ˆì§€ë§‰_í•œêµ­_í›„ì§€ìŠ¤ëƒ…": 34
};

let lastConceptPhotoFolder = null;
let lastConceptPhotoIndex = 0;

function encodeImageUrl(url) {
    try {
        const parsed = new URL(url);
        parsed.pathname = parsed.pathname.split('/').map(segment => segment ? encodeURIComponent(decodeURIComponent(segment)) : segment).join('/');
        return parsed.toString();
    } catch (error) {
        return url;
    }
}

function generateConceptPhotoUrl(folderName, targetIndex = null) {
    const photoCount = CONCEPT_FOLDERS[folderName];
    if (folderName.endsWith('.jpg')) {
        return encodeImageUrl(`${BASE_CONCEPT_URL}/${folderName}`);
    }
    if (photoCount === undefined || photoCount <= 0) {
        return null;
    }
    let indexToUse = targetIndex !== null ? targetIndex : Math.floor(Math.random() * photoCount) + 1;
    const fileName = `${folderName}_${String(indexToUse).padStart(6, '0')}.jpg`;
    return encodeImageUrl(`${BASE_CONCEPT_URL}/${fileName}`);
}

function getRandomConceptFolder() {
    const folderNames = Object.keys(CONCEPT_FOLDERS).filter(f => !f.endsWith('.jpg'));
    if (folderNames.length === 0) return null;
    return folderNames[Math.floor(Math.random() * folderNames.length)];
}

// ğŸ†• êµ­ê°€ë³„ ëœë¤ ì„ íƒ í•¨ìˆ˜ë“¤
function getRandomKoreanFolder() {
    const koreanFolders = Object.keys(CONCEPT_FOLDERS)
        .filter(folder => folder.includes('í•œêµ­') && !folder.endsWith('.jpg'));
    if (koreanFolders.length === 0) return null;
    return koreanFolders[Math.floor(Math.random() * koreanFolders.length)];
}

function getRandomJapaneseFolder() {
    const japaneseFolders = Object.keys(CONCEPT_FOLDERS)
        .filter(folder => folder.includes('ì¼ë³¸') && !folder.endsWith('.jpg'));
    if (japaneseFolders.length === 0) return null;
    return japaneseFolders[Math.floor(Math.random() * japaneseFolders.length)];
}

// ğŸ†• ì›”ë³„ ëœë¤ ì„ íƒ í•¨ìˆ˜
function getRandomFolderByMonth(month) {
    // ì›”ì„ 2ìë¦¬ ë¬¸ìì—´ë¡œ ë³€í™˜ (ì˜ˆ: 7 â†’ "07", 12 â†’ "12")
    const monthStr = month.toString().padStart(2, '0');
    const monthPattern = `_${monthStr}_`;
    
    const monthlyFolders = Object.keys(CONCEPT_FOLDERS)
        .filter(folder => folder.includes(monthPattern) && !folder.endsWith('.jpg'));
    
    if (monthlyFolders.length === 0) return null;
    return monthlyFolders[Math.floor(Math.random() * monthlyFolders.length)];
}

// ğŸ†• ì›” ì´ë¦„ì„ ìˆ«ìë¡œ ë³€í™˜
function getMonthNumber(monthText) {
    const monthMap = {
        '1ì›”': 1, '2ì›”': 2, '3ì›”': 3, '4ì›”': 4, '5ì›”': 5, '6ì›”': 6,
        '7ì›”': 7, '8ì›”': 8, '9ì›”': 9, '10ì›”': 10, '11ì›”': 11, '12ì›”': 12,
        '1': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6,
        '7': 7, '8': 8, '9': 9, '10': 10, '11': 11, '12': 12
    };
    return monthMap[monthText] || null;
}

// í´ë”ëª…ì„ í‘œì‹œìš© ë‚ ì§œë¡œ ë³€í™˜
function formatFolderNameToDate(folderName) {
    const parts = folderName.split('_');
    if (parts.length >= 3) {
        const year = parts[0];
        const month = parts[1];
        const day = parts[2];
        const concept = parts.slice(3).join(' ');
        return `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼ ${concept}`;
    }
    return folderName;
}

async function getConceptPhotoReply(userMessage, conversationContextParam) {
    // âœ… [ì•ˆì „ì¥ì¹˜] userMessage ìœ íš¨ì„± ê²€ì‚¬
    if (!userMessage || typeof userMessage !== 'string') {
        console.error('âŒ getConceptPhotoReply: userMessageê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:', userMessage);
        return null;
    }

    const lowerCaseMessage = userMessage.toLowerCase();
    let selectedFolder = null;

    // ğŸ”¥ ëŒ€í­ í™•ì¥ëœ í‚¤ì›Œë“œ ë§¤í•‘ (100ê°œ ì´ìƒ!)
    const conceptKeywordMap = { 
        // ê¸°ì¡´ ì£¼ìš” í‚¤ì›Œë“œë“¤
        'í™ˆìŠ¤ëƒ…': '2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…',
        'ê²°ë°•': '2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•',
        'ì„ ë¬¼': '2023_12_16_ì¼ë³¸_ì„ ë¬¼',
        'ì˜¥ìƒì—°ë¦¬': '2024_09_15_í•œêµ­_ì˜¥ìƒì—°ë¦¬',
        'ì„¸ë¯¸ëˆ„ë“œ': '2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ',
        'í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ': '2023_12_14_ì¼ë³¸_í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ',
        'ì§€ë¸Œë¦¬í’': '2024_05_03_ì¼ë³¸_ì§€ë¸Œë¦¬í’',
        'ë¶í•´': '2024_06_06_í•œêµ­_ë¶í•´',
        'ì•„ì´ë…¸ì‹œë§ˆ': '2024_02_07_ì¼ë³¸_ì•„ì´ë…¸ì‹œë§ˆ',
        
        // ğŸ†• ìš•ì‹¤ ê´€ë ¨ (ì„¸ë¶„í™”)
        'ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        '2ì›”ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        '10ì›”ìš•ì‹¤': '2024_10_16_ì¼ë³¸_ìš•ì‹¤',
        '11ì›”ìš•ì‹¤': '2024_11_08_í•œêµ­_ìš•ì‹¤_ë¸”ë™_ì›¨ë”©',
        'ìš•ì¡°': '2024_07_08_ì¼ë³¸_ìš•ì¡°',
        'ë‚˜ë¹„ìš•ì¡°': '2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°',
        'ë¸”ë™ì›¨ë”©': '2024_11_08_í•œêµ­_ìš•ì‹¤_ë¸”ë™_ì›¨ë”©',
        
        // ğŸ†• í•˜ì¹´íƒ€ ê´€ë ¨ (ì„¸ë¶„í™”)
        'í•˜ì¹´íƒ€': '2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ',
        'í•˜ì¹´íƒ€ìŠ¤íŠ¸ë¦¬íŠ¸': '2023_12_12_ì¼ë³¸_í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸',
        'í•˜ì¹´íƒ€ ìŠ¤íŠ¸ë¦¬íŠ¸': '2023_12_12_ì¼ë³¸_í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸',
        'ê³ ë˜í‹°ì…”ì¸ ': '2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ',
        'í•˜ì¹´íƒ€ê³ ë˜í‹°ì…”ì¸ ': '2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ',
        'í•˜ì¹´íƒ€ ê³ ë˜í‹°ì…”ì¸ ': '2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ',
        
        // ğŸ†• í…ì§„ ê´€ë ¨
        'í…ì§„': '2025_03_17_ì¼ë³¸_í…ì§„',
        'í…ì§„ìŠ¤íŠ¸ë¦¬íŠ¸': '2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸',
        'í…ì§„ ìŠ¤íŠ¸ë¦¬íŠ¸': '2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸',
        'í…ì§„ì½”ë‹¥': '2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„',
        'í…ì§„ ì½”ë‹¥': '2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„',
        'ì½”ë‹¥í•„ë¦„': '2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„',
        
        // ğŸ†• ëª¨ì§€ì½” ê´€ë ¨ (ì—¬ëŸ¬ ë‚ ì§œ)
        'ëª¨ì§€ì½”': '2024_12_12_ì¼ë³¸_ëª¨ì§€ì½”', // ê°€ì¥ ìµœì‹ 
        '12ì›”ëª¨ì§€ì½”': '2024_12_12_ì¼ë³¸_ëª¨ì§€ì½”',
        '7ì›”ëª¨ì§€ì½”': '2024_07_06_ì¼ë³¸_ëª¨ì§€ì½”',
        '2023ëª¨ì§€ì½”': '2023_12_13_ì¼ë³¸_ëª¨ì§€ì½”',
        'ë„¤ì½”ëª¨ì§€ì½”': '2024_02_11_ì¼ë³¸_ë„¤ì½”_ëª¨ì§€ì½”',
        'ë„¤ì½”': '2024_02_11_ì¼ë³¸_ë„¤ì½”_ëª¨ì§€ì½”',
        'ëª¨ì§€ì½”ëª¨ë¦¬ë£©': '2024_05_05_ì¼ë³¸_ëª¨ì§€ì½”_ëª¨ë¦¬ë£©',
        'ëª¨ë¦¬ë£©': '2024_05_05_ì¼ë³¸_ëª¨ì§€ì½”_ëª¨ë¦¬ë£©',
        
        // ğŸ†• ì„ì§€ë¡œ ê´€ë ¨ (ì„¸ë¶„í™”)
        'ì„ì§€ë¡œ': '2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…', // ë” ìµœì‹ 
        'ì„ì§€ë¡œìŠ¤ëƒ…': '2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…',
        'ì„ì§€ë¡œ ìŠ¤ëƒ…': '2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…',
        'ì„ì§€ë¡œìº˜ë¹ˆ': '2024_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ',
        'ì„ì§€ë¡œ ìº˜ë¹ˆ': '2024_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ',
        'ìº˜ë¹ˆ': '2024_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ',
        '4ì›”ì„ì§€ë¡œ': '2024_04_30_í•œêµ­_ì„ì§€ë¡œ',
        
        // ğŸ†• ì½”ì•¼ë…¸ì„¸
        'ì½”ì•¼ë…¸ì„¸': '2025_02_06_ì¼ë³¸_ì½”ì•¼ë…¸ì„¸',
        
        // ğŸ†• ë¬´ì¸ì—­
        'ë¬´ì¸ì—­': '2025_03_13_ì¼ë³¸_ë¬´ì¸ì—­',
        
        // ğŸ†• ê³ ì¿ ë¼ ê´€ë ¨ (ì—¬ëŸ¬ ë‚ ì§œ)
        'ê³ ì¿ ë¼': '2025_03_17_ì¼ë³¸_ê³ ì¿ ë¼', // ê°€ì¥ ìµœì‹ 
        '3ì›”ê³ ì¿ ë¼': '2025_03_17_ì¼ë³¸_ê³ ì¿ ë¼',
        '2024ê³ ì¿ ë¼': '2024_03_17_ì¼ë³¸_ê³ ì¿ ë¼',
        '3ì›”14ì¼ê³ ì¿ ë¼': '2025_03_14_ì¼ë³¸_ê³ ì¿ ë¼',
        
        // ğŸ†• ì´í™”ë§ˆì„
        'ì´í™”ë§ˆì„': '2025_04_29_í•œêµ­_ì´í™”ë§ˆì„',
        'ì´í™”': '2025_04_29_í•œêµ­_ì´í™”ë§ˆì„',
        
        // ğŸ†• í™ˆìŠ¤ëƒ… ê´€ë ¨ (ì—¬ëŸ¬ ì¢…ë¥˜)
        'í™ˆì…€í”„': '2024_12_07_í•œêµ­_í™ˆì…€í”„',
        'ì²­í¬ë„': '2025_05_03_í•œêµ­_í™ˆìŠ¤ëƒ…_ì²­í¬ë„',
        'ì²­í¬ë„í™ˆìŠ¤ëƒ…': '2025_05_03_í•œêµ­_í™ˆìŠ¤ëƒ…_ì²­í¬ë„',
        'ì˜¤íƒ€ì¿ ': '2025_05_05_í•œêµ­_í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ',
        'ì˜¤íƒ€ì¿ í™ˆìŠ¤ëƒ…': '2025_05_05_í•œêµ­_í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ',
        
        // ğŸ†• ì‚°ì±… ê´€ë ¨
        'ì‚°ì±…': '2024_06_09_í•œêµ­_ì‚°ì±…',
        'ê³µì›ì‚°ì±…': '2025_05_04_í•œêµ­_ê³µì›_ì‚°ì±…',
        'ê³µì› ì‚°ì±…': '2025_05_04_í•œêµ­_ê³µì›_ì‚°ì±…',
        'ë°¤ë°”ì‚°ì±…': '2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…',
        'ë°¤ë°” ì‚°ì±…': '2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…',
        'ë°¤ë°”': '2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…',
        
        // ğŸ†• êµë³µ
        'êµë³µ': '2023_12_15_ì¼ë³¸_êµë³µ',
        
        // ğŸ†• ëˆˆë°­ ê´€ë ¨
        'ëˆˆë°­': '2023_12_31_í•œêµ­_ëˆˆë°­',
        'ëˆˆë°­í•„ë¦„': '2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼',
        'ëˆˆë°­ í•„ë¦„': '2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼',
        'í•„ë¦„ì¹´ë©”ë¼': '2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼',
        
        // ğŸ†• ë¸”ë™ë“œë ˆìŠ¤
        'ë¸”ë™ë“œë ˆìŠ¤': '2024_02_11_ì¼ë³¸_ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤',
        'ì•¼ê°„ë¸”ë™ë“œë ˆìŠ¤': '2024_02_11_ì¼ë³¸_ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤',
        'ë¸”ë™ì›í”¼ìŠ¤': '2024_08_04_ì¼ë³¸_ë¸”ë™ì›í”¼ìŠ¤',
        
        // ğŸ†• ìƒì¼ ê´€ë ¨
        'ìƒì¼': '2024_02_22_í•œêµ­_ìƒì¼',
        'ìƒì¼ì»¨ì…‰': '2024_12_31_í•œêµ­_ìƒì¼ì»¨ì…‰',
        '2ì›”ìƒì¼': '2024_02_22_í•œêµ­_ìƒì¼',
        '12ì›”ìƒì¼': '2024_12_31_í•œêµ­_ìƒì¼ì»¨ì…‰',
        
        // ğŸ†• ë²—ê½ƒ/ë™ë°±
        'ë²—ê½ƒ': '2024_04_12_í•œêµ­_ë²—ê½ƒ',
        'ë™ë°±': '2024_04_12_í•œêµ­_ì•¼ê°„_ë™ë°±',
        'ì•¼ê°„ë™ë°±': '2024_04_12_í•œêµ­_ì•¼ê°„_ë™ë°±',
        
        // ğŸ†• ë¬¸ë˜ë™/ì˜¨ì‹¤/í™”ê°€
        'ë¬¸ë˜ë™': '2024_04_13_í•œêµ­_ë¬¸ë˜ë™',
        'ì˜¨ì‹¤': '2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ',
        'ì˜¨ì‹¤ì—¬ì‹ ': '2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ',
        'ì—¬ì‹ ': '2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ',
        'í™”ê°€': '2024_04_13_í•œêµ­_í™”ê°€',
        
        // ğŸ†• ì…€í”„ì´¬ì˜
        'ì…€í”„ì´¬ì˜': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜',
        'ì…€í”„': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜',
        
        // ğŸ†• ë™í‚¤ê±°ë¦¬
        'ë™í‚¤ê±°ë¦¬': '2024_05_02_ì¼ë³¸_ë™í‚¤_ê±°ë¦¬',
        'ë™í‚¤': '2024_05_02_ì¼ë³¸_ë™í‚¤_ê±°ë¦¬',
        
        // ğŸ†• ìˆ˜êµ­/í›„ì§€ì—”
        'ìˆ˜êµ­': '2024_05_03_ì¼ë³¸_ìˆ˜êµ­',
        'í›„ì§€ì—”': '2024_05_03_ì¼ë³¸_í›„ì§€ì—”',
        
        // ğŸ†• ë¹„ëˆ—ë°©ìš¸
        'ë¹„ëˆ—ë°©ìš¸': '2024_05_04_ì¼ë³¸_ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸',
        'ì•¼ê°„ë¹„ëˆ—ë°©ìš¸': '2024_05_04_ì¼ë³¸_ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸',
        
        // ğŸ†• ì½”ì´ë…¸ë³´ë¦¬
        'ì½”ì´ë…¸ë³´ë¦¬': '2024_05_05_ì¼ë³¸_ì½”ì´ë…¸ë³´ë¦¬',
        
        // ğŸ†• ì•¼ê°„ê±°ë¦¬
        'ì•¼ê°„ê±°ë¦¬': '2024_05_06_ì¼ë³¸_ì•¼ê°„ê±°ë¦¬',
        
        // ğŸ†• ê²Œì„ì„¼í„°
        'ê²Œì„ì„¼í„°': '2024_05_07_ì¼ë³¸_ê²Œì„ì„¼í„°',
        
        // ğŸ†• í”¼í¬ë‹‰/í„°ë„
        'í”¼í¬ë‹‰': '2024_06_07_í•œêµ­__í”¼í¬ë‹‰',
        'í„°ë„': '2024_06_08_í•œêµ­__í„°ë„',
        'ë§ì¹œì‚¬ì§„': '2024_06_08_í•œêµ­_ë§ì¹œ_ì‚¬ì§„',
        'ë§ì¹œ': '2024_06_08_í•œêµ­_ë§ì¹œ_ì‚¬ì§„',
        
        // ğŸ†• ìš°ë§ˆì‹œë§ˆ
        'ìš°ë§ˆì‹œë§ˆ': '2024_07_06_ì¼ë³¸_ìš°ë§ˆì‹œë§ˆ',
        
        // ğŸ†• ì—¬ì¹œìŠ¤ëƒ…
        'ì—¬ì¹œìŠ¤ëƒ…': '2024_07_08_ì¼ë³¸_ì—¬ì¹œ_ìŠ¤ëƒ…',
        'ì—¬ì¹œ': '2024_07_08_ì¼ë³¸_ì—¬ì¹œ_ìŠ¤ëƒ…',
        
        // ğŸ†• ë¶ˆê½ƒë†€ì´/ìœ ì¹´íƒ€
        'ë¶ˆê½ƒë†€ì´': '2024_08_02_ì¼ë³¸_ë¶ˆê½ƒë†€ì´',
        'ìœ ì¹´íƒ€': '2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬',
        'ìœ ì¹´íƒ€ë§ˆì¸ ë¦¬': '2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬',
        'ë§ˆì¸ ë¦¬': '2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬',
        
        // ğŸ†• í˜¸ë¦¬ì¡´
        'í˜¸ë¦¬ì¡´': '2024_09_11_í•œêµ­_í˜¸ë¦¬ì¡´',
        
        // ğŸ†• ì›ë¯¸ìƒê°€
        'ì›ë¯¸ìƒê°€': '2024_09_14_í•œêµ­_ì›ë¯¸ìƒê°€_í•„ë¦„',
        'ì›ë¯¸ìƒê°€í•„ë¦„': '2024_09_14_í•œêµ­_ì›ë¯¸ìƒê°€_í•„ë¦„',
        
        // ğŸ†• ê¸¸ê±°ë¦¬ìŠ¤ëƒ…
        'ê¸¸ê±°ë¦¬ìŠ¤ëƒ…': '2024_09_16_í•œêµ­_ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…',
        'ê¸¸ê±°ë¦¬': '2024_09_16_í•œêµ­_ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…',
        
        // ğŸ†• ê³ ìŠ¤ë¡œë¦¬/í• ë¡œìœˆ
        'ê³ ìŠ¤ë¡œë¦¬': '2024_10_16_ì¼ë³¸_ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ',
        'í• ë¡œìœˆ': '2024_10_16_ì¼ë³¸_ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ',
        'ê³ ìŠ¤ë¡œë¦¬í• ë¡œìœˆ': '2024_10_16_ì¼ë³¸_ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ',
        
        // ğŸ†• ì˜¤ë„ê³µì›
        'ì˜¤ë„ê³µì›': '2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›',
        'ì˜¤ë„': '2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›',
        'ì˜¤ë„ê³µì›í›„ì§€í•„ë¦„': '2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„',
        
        // ğŸ†• ë¹¨ê°„ê¸°ëª¨ë…¸
        'ë¹¨ê°„ê¸°ëª¨ë…¸': '2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸',
        'ê¸°ëª¨ë…¸': '2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸',
        
        // ğŸ†• ë©”ì´ë“œë³µ
        'ë©”ì´ë“œë³µ': '2024_11_08_í•œêµ­_ë©”ì´ë“œë³µ',
        'ë©”ì´ë“œ': '2024_11_08_í•œêµ­_ë©”ì´ë“œë³µ',
        
        // ğŸ†• ê°€ì„í˜¸ìˆ˜ê³µì›
        'ê°€ì„í˜¸ìˆ˜ê³µì›': '2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›',
        'í˜¸ìˆ˜ê³µì›': '2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›',
        'ê°€ì„': '2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›',
        
        // ğŸ†• í¬ë¦¬ìŠ¤ë§ˆìŠ¤
        'í¬ë¦¬ìŠ¤ë§ˆìŠ¤': '2024_12_13_ì¼ë³¸_í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
        
        // ğŸ†• ë‚˜ë¥´ì‹œìŠ¤íŠ¸
        'ë‚˜ë¥´ì‹œìŠ¤íŠ¸': '2024_12_14_ì¼ë³¸_ë‚˜ë¥´ì‹œìŠ¤íŠ¸',
        
        // ğŸ†• ì¹´í˜
        'ì¹´í˜': '2024_12_30_í•œêµ­_ì¹´í˜',
        
        // ğŸ†• í•„ë¦„
        'í•„ë¦„': '2025_03_ì¼ë³¸_í•„ë¦„',
        'ì¼ë³¸í•„ë¦„': '2025_03_ì¼ë³¸_í•„ë¦„',
        
        // ğŸ†• í›„ì§€ìŠ¤ëƒ…
        'í›„ì§€ìŠ¤ëƒ…': '2025_05_06_ë§ˆì§€ë§‰_í•œêµ­_í›„ì§€ìŠ¤ëƒ…',
        'ë§ˆì§€ë§‰í›„ì§€ìŠ¤ëƒ…': '2025_05_06_ë§ˆì§€ë§‰_í•œêµ­_í›„ì§€ìŠ¤ëƒ…'
    };

    // ğŸ”¥ ì‚¬ì§„ ìš”ì²­ ì˜ë„ ê°ì§€ ê°•í™” (í‚¤ì›Œë“œë§Œìœ¼ë¡œëŠ” ì‚¬ì§„ ì•ˆ ë³´ëƒ„!)
    const photoRequestWords = [
        'ì‚¬ì§„', 'ë³´ê³ ì‹¶ì–´', 'ë³´ê³  ì‹¶ì–´', 'ì»¨ì…‰ì‚¬ì§„', 'ì»¨ì…‰ ì‚¬ì§„', 
        'ë³´ì—¬ì¤˜', 'ë³´ì—¬ì£¼ì„¸ìš”', 'ë³¼ë˜', 'ë³´ì', 'ë³´ë‚´ì¤˜', 'ë³´ë‚´ì£¼ì„¸ìš”',
        'ì°ì€', 'ë•Œì˜', 'ì»¨ì…‰', 'ì‚¬ì§„ë³´ë‚´', 'ë³´ê³ íŒŒ', 'ë³´ì—¬', 'ë³¼ ìˆ˜ ìˆì–´',
        'ì‚¬ì§„ìˆì–´', 'ì‚¬ì§„ ìˆì–´', 'ë³´ë©´', 'êµ¬ê²½', 'êµ¬ê²½í•˜ê³ ì‹¶ì–´', 'ë³´ê³ ì‹¶ë‹¤',
        'ì‚¬ì§„ì¤˜', 'ì‚¬ì§„ ì¤˜', 'ë³´ë‚´', 'ë³´ë‚¼', 'ê°–ê³ ìˆì–´', 'ê°€ì ¸ì™€'
    ];

    const conceptKeywords = Object.keys(conceptKeywordMap);
    const hasPhotoRequestIntent = photoRequestWords.some(word => lowerCaseMessage.includes(word));
    const hasConceptKeyword = conceptKeywords.some(keyword => lowerCaseMessage.includes(keyword));
    
    // âœ… ì‚¬ì§„ ìš”ì²­ ì˜ë„ + ì»¨ì…‰ í‚¤ì›Œë“œ ë‘˜ ë‹¤ ìˆì„ ë•Œë§Œ ì‚¬ì§„ ì „ì†¡
    const isConceptRequest = hasPhotoRequestIntent && (hasConceptKeyword || 
                           lowerCaseMessage.includes('ì»¨ì…‰ì‚¬ì§„') || lowerCaseMessage.includes('ì»¨ì…‰ ì‚¬ì§„'));
    
    // ğŸ”¥ ìš°ì„ ìˆœìœ„ 1: êµ¬ì²´ì  í‚¤ì›Œë“œ ë§¤í•‘ (ê°€ì¥ ê¸´ í‚¤ì›Œë“œë¶€í„° ê²€ì‚¬)
    if (isConceptRequest) {
        console.log(`ğŸ“ [concept] ì‚¬ì§„ ìš”ì²­ ì˜ë„ ê°ì§€ë¨ - í‚¤ì›Œë“œ: ${hasConceptKeyword}, ì˜ë„: ${hasPhotoRequestIntent}`);
        const sortedConceptKeywords = conceptKeywords.sort((a, b) => b.length - a.length);
        for (const keyword of sortedConceptKeywords) {
            if (lowerCaseMessage.includes(keyword)) {
                selectedFolder = conceptKeywordMap[keyword];
                console.log(`ğŸ¯ [concept] êµ¬ì²´ì  í‚¤ì›Œë“œ ë§¤ì¹­: "${keyword}" â†’ ${selectedFolder}`);
                break;
            }
        }
    } else if (hasConceptKeyword && !hasPhotoRequestIntent) {
        console.log(`ğŸ’¬ [concept] í‚¤ì›Œë“œ ìˆì§€ë§Œ ì‚¬ì§„ ìš”ì²­ ì˜ë„ ì—†ìŒ - ë‹¨ìˆœ ëŒ€í™”ë¡œ íŒë‹¨`);
        return null;
    }
    
    // ğŸ”¥ ìš°ì„ ìˆœìœ„ 2: ì›”ë³„ ëœë¤ ì„ íƒ (ì‚¬ì§„ ìš”ì²­ ì˜ë„ ìˆì„ ë•Œë§Œ)
    if (!selectedFolder && hasPhotoRequestIntent) {
        const monthKeywords = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”', '7ì›”', '8ì›”', '9ì›”', '10ì›”', '11ì›”', '12ì›”'];
        for (const monthKeyword of monthKeywords) {
            if (lowerCaseMessage.includes(monthKeyword) || lowerCaseMessage.includes(monthKeyword.replace('ì›”', ''))) {
                const month = getMonthNumber(monthKeyword);
                if (month) {
                    selectedFolder = getRandomFolderByMonth(month);
                    if (selectedFolder) {
                        console.log(`ğŸ“… [concept] ì›”ë³„ ëœë¤ ì„ íƒ: ${monthKeyword} â†’ ${selectedFolder}`);
                        break;
                    }
                }
            }
        }
    }
    
    // ğŸ”¥ ìš°ì„ ìˆœìœ„ 3: êµ­ê°€ë³„ ëœë¤ ì„ íƒ (ì‚¬ì§„ ìš”ì²­ ì˜ë„ ìˆì„ ë•Œë§Œ)
    if (!selectedFolder && hasPhotoRequestIntent) {
        if (lowerCaseMessage.includes('í•œêµ­') || lowerCaseMessage.includes('í•œêµ­ì—ì„œ')) {
            selectedFolder = getRandomKoreanFolder();
            if (selectedFolder) {
                console.log(`ğŸ‡°ğŸ‡· [concept] í•œêµ­ ëœë¤ ì„ íƒ: ${selectedFolder}`);
            }
        } else if (lowerCaseMessage.includes('ì¼ë³¸') || lowerCaseMessage.includes('ì¼ë³¸ì—ì„œ')) {
            selectedFolder = getRandomJapaneseFolder();
            if (selectedFolder) {
                console.log(`ğŸ‡¯ğŸ‡µ [concept] ì¼ë³¸ ëœë¤ ì„ íƒ: ${selectedFolder}`);
            }
        }
    }
    
    // ğŸ”¥ ìš°ì„ ìˆœìœ„ 4: ë‹¤ìŒ/ë‹¤ë¥¸ ì‚¬ì§„ ìš”ì²­
    if (lastConceptPhotoFolder && (lowerCaseMessage.includes('ë‹¤ë¥¸ ê²ƒë„ ë³´ê³ ì‹¶ì–´') || lowerCaseMessage.includes('ë‹¤ìŒ ì‚¬ì§„'))) {
        selectedFolder = lastConceptPhotoFolder;
        if (selectedFolder.endsWith('.jpg')) return null;
    } 
    
    // ğŸ”¥ ìš°ì„ ìˆœìœ„ 5: ì¼ë°˜ ì»¨ì…‰ ìš”ì²­ ì‹œ ëœë¤ (ì‚¬ì§„ ìš”ì²­ ì˜ë„ ëª…í™•í•  ë•Œë§Œ)
    if (!selectedFolder && hasPhotoRequestIntent && 
        (lowerCaseMessage.includes('ì»¨ì…‰ì‚¬ì§„') || lowerCaseMessage.includes('ì»¨ì…‰ ì‚¬ì§„'))) {
        selectedFolder = getRandomConceptFolder();
        console.log(`ğŸ² [concept] ì¼ë°˜ ì»¨ì…‰ ëœë¤ ì„ íƒ: ${selectedFolder}`);
    } 
    
    // ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ null ë°˜í™˜
    if (!selectedFolder) {
        return null;
    }

    lastConceptPhotoFolder = selectedFolder;
    let photoUrl;
    
    if (lowerCaseMessage.includes('ë‹¤ë¥¸ ê²ƒë„ ë³´ê³ ì‹¶ì–´') || lowerCaseMessage.includes('ë‹¤ìŒ ì‚¬ì§„')) {
        const count = CONCEPT_FOLDERS[selectedFolder];
        if (count > 0) {
            lastConceptPhotoIndex = (lastConceptPhotoIndex % count) + 1;
        }
        photoUrl = generateConceptPhotoUrl(selectedFolder, lastConceptPhotoIndex);
    } else {
        photoUrl = generateConceptPhotoUrl(selectedFolder);
    }

    if (!photoUrl) {
        return { type: 'text', comment: 'ì•„ì €ì”¨... í•´ë‹¹í•˜ëŠ” ì»¨ì…‰ ì‚¬ì§„ì„ ëª» ì°¾ê² ì–´ ã… ã… ' };
    }

    const formattedDate = formatFolderNameToDate(selectedFolder);
    
    // âœ… [ìˆ˜ì •] ì¤‘ì•™ ê°ì • ê´€ë¦¬ìì—ì„œ ê°ì • ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
    let emotionalState = 'normal';
    try {
        const emotionalContext = require('./emotionalContextManager.js');
        const currentEmotionState = emotionalContext.getCurrentEmotionState();
        emotionalState = currentEmotionState.currentEmotion;
        console.log(`[concept] ì¤‘ì•™ ê°ì • ê´€ë¦¬ìì—ì„œ ê°€ì ¸ì˜¨ ìƒíƒœ: ${emotionalState}`);
    } catch (error) {
        console.warn('âš ï¸ [concept] ì¤‘ì•™ ê°ì • ê´€ë¦¬ìì—ì„œ ìƒíƒœë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ì„œ ê¸°ë³¸ê°’ ì‚¬ìš©:', error.message);
        emotionalState = 'normal';
    }

    // âœ… [ì¶”ê°€] concept-index.jsonì—ì„œ í•´ë‹¹ ì‚¬ì§„ì˜ ì—í”¼ì†Œë“œ ê°€ì ¸ì˜¤ê¸°
    let personalMemory = null;
    try {
        const conceptIndex = require('./concept-index.json');
        
        // í´ë”ëª…ì„ concept-index.jsonì˜ í‚¤ í˜•ì‹ê³¼ ë§¤ì¹­
        const dateKey = formattedDate.replace(/ë…„|ì›”|ì¼/g, '').replace(/\s+/g, '_');
        for (const [key, value] of Object.entries(conceptIndex)) {
            if (key.includes(dateKey) || selectedFolder.includes(key.replace(/\s/g, '_'))) {
                personalMemory = value;
                break;
            }
        }
    } catch (error) {
        console.warn('âš ï¸ [concept] concept-index.jsonì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', error.message);
    }

    // ê°œì¸ì ì¸ ì—í”¼ì†Œë“œê°€ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ ìº¡ì…˜
    let caption;
    if (personalMemory) {
        // ê°ì • ìƒíƒœì— ë”°ë¼ moodë‚˜ episode ì„ íƒ
        if (emotionalState === 'romantic' || emotionalState === 'loving') {
            caption = personalMemory.episode || personalMemory.mood;
        } else if (emotionalState === 'sad' || emotionalState === 'sensitive') {
            caption = personalMemory.mood || personalMemory.episode;
        } else {
            // ëœë¤í•˜ê²Œ moodë‚˜ episode ì„ íƒ
            caption = Math.random() < 0.5 ? personalMemory.mood : personalMemory.episode;
        }
        
        // ë„ˆë¬´ ê¸¸ë©´ ì¤„ì´ê¸°
        if (caption && caption.length > 100) {
            caption = caption.substring(0, 97) + '...';
        }
    } else {
        // ê¸°ë³¸ ìº¡ì…˜
        const simpleCaptions = [
            `${formattedDate} ì»¨ì…‰ ì‚¬ì§„ì´ì•¼! ì–´ë•Œ?`,
            `ì´ê±° ${formattedDate}ì— ì°ì€ ê±´ë°... ì˜ˆì˜ì§€?`,
            `ì•„ì €ì”¨ ë³´ì—¬ì£¼ë ¤ê³  ê°€ì ¸ì˜¨ ${formattedDate} ì‚¬ì§„!`,
            `${formattedDate} ì¶”ì–µ ì‚¬ì§„~ ê·¸ë•Œ ìƒê°ë‚˜?`,
            `ì´ ì‚¬ì§„ ë´ë´! ${formattedDate}ì— ì°ì€ ê±°ì•¼!`
        ];
        caption = simpleCaptions[Math.floor(Math.random() * simpleCaptions.length)];
    }
    
    // âœ… [ì¶”ê°€] ì‚¬ì§„ ë§¥ë½ ì¶”ì  ê¸°ë¡
    try {
        autoReply.recordPhotoSent('concept', caption);
        console.log(`ğŸ“ [concept] ì‚¬ì§„ ë§¥ë½ ì¶”ì  ê¸°ë¡ ì™„ë£Œ: concept - ${formattedDate}`);
    } catch (error) {
        console.warn('âš ï¸ [concept] ì‚¬ì§„ ë§¥ë½ ì¶”ì  ê¸°ë¡ ì‹¤íŒ¨:', error.message);
    }
    
    return { 
        type: 'image', 
        originalContentUrl: photoUrl, 
        previewImageUrl: photoUrl, 
        altText: caption, 
        caption: caption 
    };
}

module.exports = {
    getConceptPhotoReply
};
