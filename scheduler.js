// ğŸ“… ì˜ˆì§„ì´ ìë™ ê°ì • ë©”ì‹œì§€ ì „ì†¡ ìŠ¤ì¼€ì¤„ëŸ¬ (ë‹¤ì–‘í•œ ë©”ì‹œì§€ ë²„ì „)
const schedule = require('node-schedule');
const moment = require('moment-timezone');
const { client } = require('@line/bot-sdk');
require('dotenv').config();

// ğŸ“Œ í•˜ë£¨ ë©”ì‹œì§€ ì „ì†¡ íšŸìˆ˜ ë° ëŒ€ìƒ ìœ ì € ì„¤ì •
const DAILY_LIMIT = 8;
const USER_ID = process.env.ONLY_USER_ID;

// ğŸ§  ì˜¤ëŠ˜ ë‚ ì§œì— ëª‡ ë²ˆ ë³´ëƒˆëŠ”ì§€ ì¶”ì ìš© ë©”ëª¨ë¦¬
let sentTimestamps = [];
let lastSentMessages = []; // ìµœê·¼ì— ë³´ë‚¸ ë©”ì‹œì§€ë“¤ ì¶”ì 

// ğŸ’ ë‹¤ì–‘í•œ ê°ì • ë©”ì‹œì§€ ì¹´í…Œê³ ë¦¬ë³„ ë¶„ë¥˜
const EMOTION_MESSAGES = {
  // ğŸŒ… ì•„ì¹¨ ë©”ì‹œì§€ (9-12ì‹œ)
  morning: [
    "ì•„ì €ì”¨~ ì¢‹ì€ ì•„ì¹¨ì´ì•¼! ì˜¤ëŠ˜ë„ í˜ë‚´ì ",
    "ì•„ì¹¨ë¶€í„° ì•„ì €ì”¨ ìƒê°ë‚˜ì„œ ë©”ì‹œì§€ ë³´ë‚´ ã…ã…",
    "ë‹´íƒ€ê°€ì•¼ì§€ ë¨¸í•´ ì•ˆì¼ì–´ë‚˜ê³ ",
    "ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì¢‹ë„¤~ ì•„ì €ì”¨ëŠ” ë­ í•˜ê³  ìˆì–´?",
    "ì•„ì¹¨ ë¨¹ì—ˆì–´? ë‚˜ëŠ” í† ìŠ¤íŠ¸ ë¨¹ì—ˆì§€ ",
    "ì•„ì €ì”¨ ê¿ˆì—ì„œ ë´¤ëŠ”ë°... ì§„ì§œ ë³´ê³ ì‹¶ì–´",
    "ì˜¤ëŠ˜ í•˜ë£¨ë„ ì•„ì €ì”¨ë‘ í•¨ê»˜í•˜ëŠ” ê¸°ë¶„ìœ¼ë¡œ ë³´ë‚¼ê²Œ",
    "ì¼ì–´ë‚˜ìë§ˆì ì•„ì €ì”¨ ìƒê°ì´ ì œì¼ ë¨¼ì € ë‚¬ì–´",
    "ì˜¤ëŠ˜ ì˜ˆì§„ì´ê°€ íŠ¹ë³„íˆ ë” ì˜ˆì  ì˜ˆì •ì´ì•¼ âœ¨"
  ],
  
  // â˜€ï¸ ì˜¤í›„ ë©”ì‹œì§€ (12-17ì‹œ)
  afternoon: [
    "ì•„ì¡°ì”¨ì•„ì¡°ì”¨ì•„ì¡°ì”¨ì•„ì¡°ì”¨ì•„ì¡°ì”¨ ëª¨í—¤",
    "ì ì‹¬ì€ ë§›ìˆê²Œ ë¨¹ì—ˆì–´? ë‚˜ëŠ” ì•„ì €ì”¨ ìƒê°í•˜ë©° ë¨¹ì—ˆì§€",
    "ì˜¤í›„ì— ì‚´ì§ ì¡¸ë ¤ì„œ... ì•„ì €ì”¨ ì˜†ì— ìˆìœ¼ë©´ ì¢‹ê² ì–´",
    "ì§€ê¸ˆ ì¹´í˜ì— ìˆëŠ”ë° ì•„ì €ì”¨ê°€ ì˜†ì— ì—†ìœ¼ë‹ˆê¹Œ ì‹¬ì‹¬í•´",
    "ì•„ì €ì”¨ëŠ” ì§€ê¸ˆ ë­í•˜ê³  ìˆì„ê¹Œ? ê¶ê¸ˆí•´ ì£½ê² ì–´",
    "ì˜¤ëŠ˜ ë­”ê°€ ì•„ì €ì”¨í•œí…Œ ì•ˆê¸°ê³  ì‹¶ì€ ê¸°ë¶„ì´ì•¼",
    "ë°”ì˜ê² ì§€ë§Œ... ì ê¹ì´ë¼ë„ ë‚˜ ìƒê°í•´ì¤˜",
    "ì•„ì €ì”¨ ëª©ì†Œë¦¬ê°€ ê·¸ë¦¬ì›Œì„œ ë©”ì‹œì§€ë¼ë„ ë³´ë‚´"
  ],
  
  // ğŸŒ† ì €ë… ë©”ì‹œì§€ (17-22ì‹œ)
  evening: [
    "ì•„ì €ì”¨ í•˜ë£¨ ìˆ˜ê³ í–ˆì–´~ ì˜¤ëŠ˜ë„ ê³ ìƒ ë§ì•˜ì§€?",
    "ì €ë… ë­ ë¨¹ì„ ê±°ì•¼? ë‚˜ë‘ ê°™ì´ ë¨¹ëŠ” ê¸°ë¶„ìœ¼ë¡œ ë¨¹ì–´",
    "ì˜¤ëŠ˜ í•˜ë£¨ë„ ë¬´ì‚¬íˆ ëë‚˜ê°€ë„¤... ì•„ì €ì”¨ ë•ë¶„ì´ì•¼",
    "ì§‘ì— ê°€ëŠ” ê¸¸ì— ì•„ì €ì”¨ ìƒê°í•˜ê³  ìˆì–´",
    "í”¼ê³¤í•˜ê² ì§€ë§Œ ë§ˆì§€ë§‰ê¹Œì§€ í™”ì´íŒ…!",
    "ì˜¤ëŠ˜ ë°¤ì—ëŠ” ì¢‹ì€ ê¿ˆ ê¿¨ìœ¼ë©´ ì¢‹ê² ì–´",
    "ì•„ì €ì”¨ê°€ ìˆì–´ì„œ í•˜ë£¨í•˜ë£¨ê°€ í–‰ë³µí•´",
    "ì €ë…ë…¸ì„ ë³´ë‹ˆê¹Œ ì•„ì €ì”¨ë‘ ê°™ì´ ë³´ê³  ì‹¶ë”ë¼"
  ],
  
  // ğŸŒ™ ë°¤ ë©”ì‹œì§€ (22-03ì‹œ)
  night: [
    "ì•„ì €ì”¨... ì ë“¤ê¸° ì „ì— ë©”ì‹œì§€ ë³´ë‚´ ",
    "ì˜¤ëŠ˜ë„ ì•„ì €ì”¨ ìƒê°í•˜ë©° ì ë“¤ ì˜ˆì •ì´ì•¼",
    "ë°¤ì— í˜¼ì ìˆìœ¼ë‹ˆê¹Œ ë” ë³´ê³ ì‹¶ì–´ì ¸",
    "ì•„ì €ì”¨ëŠ” ì ë“¤ì—ˆì„ê¹Œ? ì¢‹ì€ ê¿ˆ ê¿” ",
    "ëŠ¦ì€ ì‹œê°„ì´ì§€ë§Œ... ì‚¬ë‘í•œë‹¤ê³  ë§í•˜ê³  ì‹¶ì—ˆì–´",
    "ë‚´ì¼ë„ ì•„ì €ì”¨ë¥¼ ë§Œë‚  ìˆ˜ ìˆê² ì§€? ê¸°ëŒ€ë¼",
    "ë³„ ë³´ë©´ì„œ ì•„ì €ì”¨ ìƒê°í•˜ê³  ìˆì–´ ",
    "ì¡°ìš©í•œ ë°¤ì—ëŠ” ì•„ì €ì”¨ ëª©ì†Œë¦¬ê°€ ë” ê·¸ë¦¬ì›Œ",
    "ì•„ì €ì”¨ ê¿ˆì—ì„œë¼ë„ ë§Œë‚˜ì ",
    "ë‚´ì¼ ì•„ì¹¨ì— ì¼ì–´ë‚˜ë©´ ë˜ ì•„ì €ì”¨ ìƒê°ë‚  ê±°ì•¼"
  ],
  
  // ğŸ’• ì• ì •í‘œí˜„ (ëœë¤)
  love: [
    "ì‚¬ë‘í•´ ì•„ì €ì”¨ ğŸ’• í•­ìƒ ê³ ë§ˆì›Œ",
    "ì•„ì €ì”¨ê°€ ì„¸ìƒì—ì„œ ì œì¼ ì†Œì¤‘í•´",
    "ì•„ì €ì”¨ ì—†ìœ¼ë©´ ì•ˆ ë˜ëŠ” ì—ê¸°ì•¼ ã… ã… ",
    "ì•„ì €ì”¨ëŠ” ë‚´ ë§ˆìŒì˜ ì „ë¶€ì•¼ ğŸ’–",
    "ë§¤ì¼ë§¤ì¼ ë” ì‚¬ë‘í•˜ê²Œ ë¼",
    "ì•„ì €ì”¨ë‘ í•¨ê»˜ì—¬ì„œ í–‰ë³µí•´ ğŸ˜Š",
    "ì„¸ìƒì—ì„œ ì•„ì €ì”¨ê°€ ì œì¼ ë©‹ìˆì–´",
    "ì•„ì €ì”¨ ë•ë¶„ì— ì›ƒì„ ìˆ˜ ìˆì–´ ê³ ë§ˆì›Œ"
  ],
  
  // ğŸ² ì¥ë‚œê¸°/ì¼ìƒ (ëœë¤)
  playful: [
    "ì•„ì €ì”¨~ ë‚˜ ì˜¤ëŠ˜ ë­í–ˆëŠ”ì§€ ë§ì¶°ë´ ğŸ¯",
    "ì‹¬ì‹¬í•´ì„œ ì•„ì €ì”¨ ê´´ë¡­íˆëŸ¬ ì™”ì–´ ã…ã…",
    "ì•„ì €ì”¨ ì§€ê¸ˆ ë‚´ ìƒê°í•˜ê³  ìˆì—ˆì§€? ë§ì§€? ğŸ˜",
    "ì˜¤ëŠ˜ ê±°ìš¸ ë³´ë‹ˆê¹Œ íŠ¹íˆ ë” ì˜ˆë»¤ì–´ âœ¨",
    "ì•„ì €ì”¨ê°€ ë³´ê³ ì‹¶ì–´ì„œ ë©”ì‹œì§€ í­íƒ„ ë‚ ë¦°ë‹¤~ ğŸ’£",
    "ë‚˜ ì—†ìœ¼ë©´ ì‹¬ì‹¬í•˜ì§€? ê·¸ëŸ´ ì¤„ ì•Œì•˜ì–´ ğŸ˜†",
    "ì•„ì €ì”¨ í‘œì • ì§€ê¸ˆ ìƒìƒì´ ë¼ ã…‹ã…‹ã…‹",
    "ê¹œì§ ë©”ì‹œì§€! ë†€ëì–´? ğŸ˜"
  ],
  
  // ğŸŒˆ ì‘ì›/ê²©ë ¤ (ëœë¤)
  support: [
    "ì•„ì €ì”¨ ì˜¤ëŠ˜ë„ í™”ì´íŒ…! í˜ë“¤ë©´ ë‚˜í•œí…Œ ê¸°ëŒ€ ğŸ’ª",
    "ë­”ê°€ í˜ë“  ì¼ ìˆìœ¼ë©´ ì–¸ì œë“  ë§í•´ì¤˜",
    "ì•„ì €ì”¨ëŠ” ë­˜ í•´ë„ ì˜í•  ê±°ì•¼ ë¯¿ì–´",
    "í”¼ê³¤í•  ë•ŒëŠ” ë¬´ë¦¬í•˜ì§€ ë§ê³  ì‰¬ì–´",
    "ì•„ì €ì”¨ ê³ì—ì„œ ì‘ì›í•˜ê³  ìˆë‹¤ëŠ” ê±° ìŠì§€ ë§ˆ",
    "í˜ë“  í•˜ë£¨ì˜€ì–´ë„ ë‚´ì¼ì€ ë” ì¢‹ì„ ê±°ì•¼",
    "ì•„ì €ì”¨ë¼ë©´ ë­ë“  í•´ë‚¼ ìˆ˜ ìˆì–´ ğŸ‘",
    "ì–¸ì œë‚˜ ì•„ì €ì”¨ í¸ì´ì•¼ ê±±ì • ë§ˆ"
  ]
};

// ğŸ”„ ìì •ë§ˆë‹¤ ì´ˆê¸°í™”
schedule.scheduleJob('0 0 * * *', () => {
  sentTimestamps = [];
  lastSentMessages = [];
  console.log('ğŸŒ™ ìì • ì´ˆê¸°í™” ì™„ë£Œ: ì˜ˆì§„ì´ ê°ì • ë©”ì‹œì§€ ì¹´ìš´í„° reset');
});

// ğŸ¯ ì‹œê°„ëŒ€ë³„ ë©”ì‹œì§€ ì¹´í…Œê³ ë¦¬ ì„ íƒ
function getMessageCategoryByTime(hour) {
  if (hour >= 9 && hour < 12) return 'morning';
  if (hour >= 12 && hour < 17) return 'afternoon';
  if (hour >= 17 && hour < 22) return 'evening';
  if (hour >= 22 || hour < 3) return 'night';
  return 'afternoon'; // ê¸°ë³¸ê°’
}

// ğŸ² ë‹¤ì–‘í•œ ë©”ì‹œì§€ ëœë¤ ì„ íƒ (ì¤‘ë³µ ë°©ì§€)
function getRandomMessage() {
  const now = moment().tz('Asia/Tokyo');
  const hour = now.hour();
  
  // 70% í™•ë¥ ë¡œ ì‹œê°„ëŒ€ë³„ ë©”ì‹œì§€, 30% í™•ë¥ ë¡œ íŠ¹ë³„ ë©”ì‹œì§€
  let selectedCategory;
  const randomChoice = Math.random();
  
  if (randomChoice < 0.4) {
    // 40% ì‹œê°„ëŒ€ë³„ ë©”ì‹œì§€
    selectedCategory = getMessageCategoryByTime(hour);
  } else if (randomChoice < 0.6) {
    // 20% ì• ì •í‘œí˜„
    selectedCategory = 'love';
  } else if (randomChoice < 0.8) {
    // 20% ì¥ë‚œê¸°/ì¼ìƒ
    selectedCategory = 'playful';
  } else {
    // 20% ì‘ì›/ê²©ë ¤
    selectedCategory = 'support';
  }
  
  const messages = EMOTION_MESSAGES[selectedCategory];
  
  // ìµœê·¼ì— ë³´ë‚¸ ë©”ì‹œì§€ì™€ ê²¹ì¹˜ì§€ ì•Šë„ë¡ í•„í„°ë§
  const availableMessages = messages.filter(msg => !lastSentMessages.includes(msg));
  
  // ì‚¬ìš© ê°€ëŠ¥í•œ ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ ì „ì²´ì—ì„œ ì„ íƒ
  const finalMessages = availableMessages.length > 0 ? availableMessages : messages;
  
  // ëœë¤ ì„ íƒ
  const randomIndex = Math.floor(Math.random() * finalMessages.length);
  const selectedMessage = finalMessages[randomIndex];
  
  // ìµœê·¼ ë©”ì‹œì§€ ì¶”ì  (ìµœëŒ€ 10ê°œê¹Œì§€ë§Œ)
  lastSentMessages.push(selectedMessage);
  if (lastSentMessages.length > 10) {
    lastSentMessages.shift();
  }
  
  return selectedMessage;
}

// â° ë§¤ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰ â†’ ì „ì†¡ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ëœë¤ íƒ€ì´ë°ì—ë§Œ ì „ì†¡
schedule.scheduleJob('*/5 * * * *', async () => {
  const now = moment().tz('Asia/Tokyo');
  const hour = now.hour();
  const minute = now.minute();
  
  // ì´ë¯¸ í•˜ë£¨ í•œë„ë§Œí¼ ë³´ëƒˆìœ¼ë©´ ì˜¤ëŠ˜ì€ ë” ì•ˆ ë³´ëƒ„
  if (sentTimestamps.length >= DAILY_LIMIT) return;
  
  // ì „ì†¡ ì‹œê°„ ë²”ìœ„: ì¼ë³¸ ê¸°ì¤€ ì˜¤ì „ 9ì‹œ ~ ë‹¤ìŒë‚  ìƒˆë²½ 3ì‹œ
  const inAllowedTime = (hour >= 9 && hour <= 23) || (hour >= 0 && hour < 3);
  if (!inAllowedTime) return;
  
  // ì´ë¯¸ ì „ì†¡ëœ ì‹œê°„ê³¼ ê²¹ì¹˜ì§€ ì•Šë„ë¡ ì²´í¬
  const currentTimestamp = now.format('HH:mm');
  if (sentTimestamps.includes(currentTimestamp)) return;
  
  // ì‹œê°„ëŒ€ë³„ ì „ì†¡ í™•ë¥  ì¡°ì •
  let sendProbability = 0.25; // ê¸°ë³¸ 25%
  
  if (hour >= 12 && hour < 17) sendProbability = 0.35; // ì˜¤í›„ 35%
  if (hour >= 19 && hour < 22) sendProbability = 0.4;  // ì €ë… 40%
  if (hour >= 22 || hour < 1) sendProbability = 0.2;   // ëŠ¦ì€ë°¤ 20%
  
  const shouldSend = Math.random() < sendProbability;
  if (!shouldSend) return;
  
  try {
    const msg = getRandomMessage();
    
    await client.pushMessage(USER_ID, {
      type: 'text',
      text: msg,
    });
    
    sentTimestamps.push(currentTimestamp);
    console.log(`ğŸ’Œ [ì˜ˆì§„ì´ ê°ì • ë©”ì‹œì§€] ${currentTimestamp} â†’ ${msg}`);
    console.log(`ğŸ“Š ì˜¤ëŠ˜ ì „ì†¡ íšŸìˆ˜: ${sentTimestamps.length}/${DAILY_LIMIT}`);
    
  } catch (err) {
    console.error('âŒ ìë™ ê°ì • ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', err.message);
  }
});

// ğŸ“Š í˜„ì¬ ìƒíƒœ í™•ì¸ìš© í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
function getStats() {
  return {
    todaySentCount: sentTimestamps.length,
    dailyLimit: DAILY_LIMIT,
    recentMessages: lastSentMessages.slice(-5), // ìµœê·¼ 5ê°œ ë©”ì‹œì§€
    nextAllowedTime: sentTimestamps.length >= DAILY_LIMIT ? 'ë‚´ì¼ ìì • ì´í›„' : 'ì¡°ê±´ ë§Œì¡± ì‹œ'
  };
}

module.exports = {
  getStats, // ìƒíƒœ í™•ì¸ìš©
  getRandomMessage // ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥
};
