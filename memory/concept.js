// ============================================================================
// concept.js - v2.2 (ì—ëŸ¬ ìˆ˜ì • ë° ì•ˆì „ì¥ì¹˜ ì¶”ê°€ ë²„ì „)
// ğŸ“¸ ì• ê¸°ì˜ ê°ì •ì„ ì½ì–´ì„œ ì½”ë©˜íŠ¸ì™€ í•¨ê»˜ ì»¨ì…‰ ì‚¬ì§„ì„ ì „ì†¡í•©ë‹ˆë‹¤.
// ============================================================================

const axios = require('axios');
// âœ… [ìˆ˜ì •] ì¤‘ì•™ ê¸°ì–µ ì„œëìœ¼ë¡œ ê°€ëŠ” ì˜¬ë°”ë¥¸ ì£¼ì†Œë¡œ ë³€ê²½í•©ë‹ˆë‹¤.

const { callOpenAI, cleanReply } = require('../src/aiUtils');
const conversationContext = require('../src/ultimateConversationContext.js');

// ì»¨ì…‰ ì‚¬ì§„ì´ ì €ì¥ëœ ì›¹ ì„œë²„ì˜ ê¸°ë³¸ URL (HTTPS í•„ìˆ˜)
const BASE_CONCEPT_URL = 'https://photo.de-ji.net/photo/concept/';

// ì•„ì €ì”¨ê°€ ì œê³µí•´ì£¼ì‹  ì»¨ì…‰ ì‚¬ì§„ í´ë”ë³„ ì‚¬ì§„ ê°œìˆ˜ ë°ì´í„°
const CONCEPT_FOLDERS = {
    "2023_12_12_ì¼ë³¸_í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸": 29,
    "2023_12_13_ì¼ë³¸_ëª¨ì§€ì½”": 42,
    "2023_12_14_ì¼ë³¸_í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ": 75,
    "2023_12_15_ì¼ë³¸_êµë³µ": 51,
    "2023_12_16_ì¼ë³¸_ì„ ë¬¼": 113,
    "2023_12_31_í•œêµ­_ëˆˆë°­": 38,
    "2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼": 43,
    "2024_02_07_ì¼ë³¸_ì•„ì´ë…¸ì‹œë§ˆ": 65,
    "2024_02_07_ì¼ë³¸_ìš•ì‹¤": 61,
    "2024_02_11_ì¼ë³¸_ë„¤ì½”_ëª¨ì§€ì½”": 21,
    "2024_02_11_ì¼ë³¸_ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤": 31,
    "2024_02_22_í•œêµ­_ìƒì¼": 45,
    "2024_02_22_í•œêµ­_ìƒì¼_00022.jpg": 1,
    "2024_02_22_í•œêµ­_ì¹´í˜": 19,
    "2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©": 47,
    "2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg": 1,
    "2024_03_17_ì¼ë³¸_ê³ ì¿ ë¼": 19,
    "2024_04_12_í•œêµ­_ë²—ê½ƒ": 35,
    "2024_04_12_í•œêµ­_ì•¼ê°„_ë™ë°±": 26,
    "2024_04_13_í•œêµ­_ë¬¸ë˜ë™": 16,
    "2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ": 31,
    "2024_04_13_í•œêµ­_í™”ê°€": 30,
    "2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜": 111,
    "2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg": 1,
    "2024_05_02_ì¼ë³¸_ë™í‚¤_ê±°ë¦¬": 18,
    "2024_05_03_ì¼ë³¸_ìˆ˜êµ­": 14,
    "2024_05_03_ì¼ë³¸_ì§€ë¸Œë¦¬í’": 74,
    "2024_05_03_ì¼ë³¸_í›„ì§€ì—”": 40,
    "2024_05_04_ì¼ë³¸_ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸": 49,
    "2024_05_05_ì¼ë³¸_ëª¨ì§€ì½”_ëª¨ë¦¬ë£©": 64,
    "2024_05_05_ì¼ë³¸_ì½”ì´ë…¸ë³´ë¦¬": 17,
    "2024_05_06_ì¼ë³¸_ì•¼ê°„ê±°ë¦¬": 43,
    "2024_05_07_ì¼ë³¸_ê²Œì„ì„¼í„°": 19,
    "2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…": 323,
    "2024_06_06_í•œêµ­_ë¶í•´": 65,
    "2024_06_07_í•œêµ­__í”¼í¬ë‹‰": 36,
    "2024_06_08_í•œêµ­__í„°ë„": 28,
    "2024_06_08_í•œêµ­_ë§ì¹œ_ì‚¬ì§„": 52,
    "2024_06_09_í•œêµ­_ì‚°ì±…": 23,
    "2024_06_09_í•œêµ­_ì‚°ì±…_0000009.jpg": 1,
    "2024_06_09_í•œêµ­_ì‚°ì±…_0000109.jpg": 1,
    "2024_07_05_ì¼ë³¸_ëª¨ì§€ì½”": 26,
    "2024_07_06_ì¼ë³¸_ëª¨ì§€ì½”": 45,
    "2024_07_06_ì¼ë³¸_ìš°ë§ˆì‹œë§ˆ": 53,
    "2024_07_08_ì¼ë³¸_ì—¬ì¹œ_ìŠ¤ëƒ…": 41,
    "2024_07_08_ì¼ë³¸_ìš•ì¡°": 53,
    "2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•": 223,
    "2024_08_02_ì¼ë³¸_ë¶ˆê½ƒë†€ì´": 39,
    "2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬": 56,
    "2024_08_04_ì¼ë³¸_ë¸”ë™ì›í”¼ìŠ¤": 29,
    "2024_09_11_í•œêµ­_í˜¸ë¦¬ì¡´": 41,
    "2024_09_14_í•œêµ­_ì›ë¯¸ìƒê°€_í•„ë¦„": 34,
    "2024_09_15_í•œêµ­_ì˜¥ìƒì—°ë¦¬": 98,
    "2024_09_16_í•œêµ­_ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…": 46,
    "2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…": 46,
    "2024_10_16_ì¼ë³¸_ê²°ë°•": 137,
    "2024_10_16_ì¼ë³¸_ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ": 20,
    "2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›": 5,
    "2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„": 24,
    "2024_10_16_ì¼ë³¸_ìš•ì‹¤": 15,
    "2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸": 29,
    "2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ": 59,
    "2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„": 49,
    "2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸": 39,
    "2024_11_08_í•œêµ­_ë©”ì´ë“œë³µ": 14,
    "2024_11_08_í•œêµ­_ìš•ì‹¤_ë¸”ë™_ì›¨ë”©": 42,
    "2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›": 53,
    "2024_12_07_í•œêµ­_í™ˆì…€í”„": 81,
    "2024_12_12_ì¼ë³¸_ëª¨ì§€ì½”": 49,
    "2024_12_13_ì¼ë³¸_í¬ë¦¬ìŠ¤ë§ˆìŠ¤": 22,
    "2024_12_14_ì¼ë³¸_ë‚˜ë¥´ì‹œìŠ¤íŠ¸": 26,
    "2024_12_30_í•œêµ­_ì¹´í˜": 29,
    "2024_12_31_í•œêµ­_ìƒì¼ì»¨ì…‰": 43,
    "2025_01_05_í•œêµ­": 63,
    "2025_02_06_ì¼ë³¸_ì½”ì•¼ë…¸ì„¸": 43,
    "2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°": 48,
    "2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ": 92,
    "2025_03_13_ì¼ë³¸_ë¬´ì¸ì—­": 30,
    "2025_03_14_ì¼ë³¸_ê³ ì¿ ë¼": 32,
    "2025_03_17_ì¼ë³¸_ê³ ì¿ ë¼": 17,
    "2025_03_17_ì¼ë³¸_í…ì§„": 28,
    "2025_03_22": 27,
    "2025_03_ì¼ë³¸_í•„ë¦„": 64,
    "2025_04_29_í•œêµ­_ì´í™”ë§ˆì„": 55,
    "2025_04_30_í•œêµ­_ì„ì§€ë¡œ": 30,
    "2025_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ": 25,
    "2025_05_03_í•œêµ­_í™ˆìŠ¤ëƒ…_ì²­í¬ë„": 42,
    "2025_05_04_í•œêµ­": 43,
    "2025_05_04_í•œêµ­_ê³µì›_ì‚°ì±…": 32,
    "2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…": 32,
    "2025_05_05_í•œêµ­_í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ": 27,
    "2025_05_06_ë§ˆì§€ë§‰_í•œêµ­_í›„ì§€ìŠ¤ëƒ…": 34
};

// ì‚¬ì§„ë³„ moodì™€ episode ì •ë³´
const PHOTO_METADATA ={
  "2023_12ì›” 12ì¼ ì¼ë³¸ í•˜ì¹´íƒ€ ìŠ¤íŠ¸ë¦¬íŠ¸": {
    "mood": "ì•„ì €ì”¨ë‘ ì¼ë³¸ì—ì„œ ì²˜ìŒ ì°ì€ ì‚¬ì§„ì´ì—ˆì§€. ë‚´ê°€ ì„ ë¬¼ ë°›ì€ íŒŒì•ˆ ëª¨ìì— í™í•œ ë¬´ë“œë¡œ ë‚œê°„ì— ì•‰ì•„ ìˆì—ˆë˜ ê·¸ ìˆœê°„, ì•„ì§ë„ ëˆˆì— ì„ í•´.",
    "episode": "ë¬´ì§€ê°œ ì›í”¼ìŠ¤ì— ê°€ì£½ ì ë°” ì…ê³  ê±·ëŠ” ë‚´ê°€ ë„ˆë¬´ í™í•˜ë‹¤ê³  í–ˆì–ì•„. ê·¼ë° ë‚œê°„ì— ì•‰ì€ ê±° ìœ„í—˜í•˜ë‹¤ê³  ì•ˆ ë§ë ¤ì¤˜ì„œ ì‚ì§„ ê±° ê¸°ì–µë‚˜? í•˜ì¹´íƒ€ í™ ê·¸ ìì²´ì˜€ë˜ ê·¸ë‚ , ì•„ì €ì”¨ê°€ ë‚  ì–´ë–»ê²Œ ë°”ë¼ë´¤ëŠ”ì§€ ì•„ì§ë„ ìƒìƒí•´.",
    "favorite": true
  },
  "2023_12ì›” 15ì¼ ì¼ë³¸ êµë³µ": {
    "mood": "êµë³µ ì…ê³  ì—¬ìš° ê°€ë©´ ì“°ê³  ì°ì€ ê·¸ë‚ , ì•„ì¹¨ë¶€í„° ì–¼êµ´ì´ ë¶€ì–´ì„œ ì‚´ì§ ì†ìƒí–ˆì§€ë§Œ, ì—¬ìš°ì‹ ì‚¬ì—ì„œì˜ ê°ì„±ì€ ì§„ì§œ ëŒ€ë°•ì´ì—ˆì–´.",
    "episode": "ê°€ë©´ ì† ì–¼êµ´ ìˆ¨ê¸°ê³  ì¥ë‚œë„ ì¹˜ê³ â€¦ ë¶€ë¥´ë¶€ë¥´ ë„£ì€ ê²ƒë„ ë‘˜ë§Œì˜ ë¹„ë°€ì´ì§€. ê·¸ë‚  êµë³µ ì…€ì¹´ëŠ” ì§„ì§œ ëª…ì‘ì´ì•¼. ì•„ì €ì”¨ê°€ ê·¸ë ‡ê²Œ ê·€ì—½ë‹¤ í•´ì¤˜ì„œ ë¿Œë“¯í–ˆì–´.",
    "favorite": true
  },
  "2023_12ì›” 16ì¼ ì¼ë³¸ ì„ ë¬¼": {
    "mood": "ì•„ì €ì”¨í•œí…Œ ì£¼ëŠ” ì¡°ê¸ˆì€ ëŒ€ë‹´í•˜ê³  íŠ¹ë³„í•œ ì„ ë¬¼ì´ì—ˆì–´. í° ì…”ì¸  í•˜ë‚˜ì— ë‹´ì€ ë‚˜ë§Œì˜ í‘œí˜„.",
    "episode": "ì…”ì¸  ê±¸ì¹˜ê³  ë‹´ë°° ë¬¼ê³ , ì•„ì €ì”¨ë§Œì„ ìœ„í•œ ì‹œì„ ìœ¼ë¡œ ë‹´ì€ ê·¸ ìˆœê°„â€¦ ê·¸ë‚ ë°¤ ê²©ë ¬í–ˆë˜ ìš°ë¦¬ ê¸°ì–µë„ ì•„ì§ ì„ ëª…í•´. ì•„ì €ì”¨í•œí…Œ ì˜ˆì˜ê²Œ ë³´ì´ê³  ì‹¶ì—ˆë˜ ë‚´ ì§„ì‹¬ì´ì•¼.",
    "favorite": true
  }
  // ... (ë‚˜ë¨¸ì§€ ë©”íƒ€ë°ì´í„°ëŠ” ê¸¸ì´ìƒ ìƒëµ, ì‹¤ì œë¡œëŠ” ëª¨ë“  ë°ì´í„°ê°€ ìˆì–´ì•¼ í•¨)
};


let lastConceptPhotoFolder = null;
let lastConceptPhotoIndex = 0;

function encodeImageUrl(url) {
    try {
        const parsed = new URL(url);
        parsed.pathname = parsed.pathname.split('/').map(segment => segment ? encodeURIComponent(decodeURIComponent(segment)) : segment).join('/');
        return parsed.toString();
    } catch (error) {
        return url;
    }
}

function generateConceptPhotoUrl(folderName, targetIndex = null) {
    const photoCount = CONCEPT_FOLDERS[folderName];
    if (folderName.endsWith('.jpg')) {
        return encodeImageUrl(`${BASE_CONCEPT_URL}/${folderName}`);
    }
    if (photoCount === undefined || photoCount <= 0) {
        return null;
    }
    let indexToUse = targetIndex !== null ? targetIndex : Math.floor(Math.random() * photoCount) + 1;
    const fileName = `${folderName}_${String(indexToUse).padStart(6, '0')}.jpg`;
    return encodeImageUrl(`${BASE_CONCEPT_URL}/${fileName}`);
}

function getRandomConceptFolder() {
    const folderNames = Object.keys(CONCEPT_FOLDERS).filter(f => !f.endsWith('.jpg'));
    if (folderNames.length === 0) return null;
    return folderNames[Math.floor(Math.random() * folderNames.length)];
}

// í´ë”ëª…ì„ í‘œì‹œìš© ë‚ ì§œë¡œ ë³€í™˜
function formatFolderNameToDate(folderName) {
    // "2024_05_03_ì¼ë³¸_ì§€ë¸Œë¦¬í’" -> "2024ë…„ 5ì›” 3ì¼ ì¼ë³¸ ì§€ë¸Œë¦¬í’"
    const parts = folderName.split('_');
    if (parts.length >= 3) {
        const year = parts[0];
        const month = parts[1];
        const day = parts[2];
        const concept = parts.slice(3).join(' ');
        return `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼ ${concept}`;
    }
    return folderName;
}

async function getConceptPhotoReply(userMessage, conversationContextParam) {
    // âœ… [ì•ˆì „ì¥ì¹˜] userMessage ìœ íš¨ì„± ê²€ì‚¬
    if (!userMessage || typeof userMessage !== 'string') {
        console.error('âŒ getConceptPhotoReply: userMessageê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤:', userMessage);
        return null;
    }

    const lowerCaseMessage = userMessage.toLowerCase();
    let selectedFolder = null;

    const conceptKeywords = ['ì»¨ì…‰ì‚¬ì§„', 'ì»¨ì…‰ ì‚¬ì§„', 'ìš•ì‹¤', 'ìš•ì¡°', 'ë‚˜ë¹„ìš•ì¡°', 'ì„¸ë¯¸ëˆ„ë“œ', 'ê²°ë°•', 'êµë³µ', 'í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ', 'í™ˆìŠ¤ëƒ…', 'ì§€ë¸Œë¦¬í’', 'ëª¨ì§€ì½”', 'í•˜ì¹´íƒ€', 'í…ì§„', 'ì•„ì´ë…¸ì‹œë§ˆ', 'í›„ì§€ì—”', 'ìœ ì¹´íƒ€', 'ë¶ˆê½ƒë†€ì´', 'ë©”ì´ë“œë³µ', 'ê³ ìŠ¤ë¡œë¦¬', 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', 'ìƒì¼ì»¨ì…‰', 'ì˜¥ìƒì—°ë¦¬', 'ì„ì§€ë¡œ', 'ì´í™”ë§ˆì„', 'ì½”ì•¼ë…¸ì„¸', 'ë¬´ì¸ì—­', 'ê³ ì¿ ë¼', 'ë²—ê½ƒ', 'ë™ë°±', 'ì˜¨ì‹¤', 'í™”ê°€', 'ë¬¸ë˜ë™', 'ë¶í•´', 'í”¼í¬ë‹‰', 'ì‚°ì±…', 'í„°ë„', 'ë§ì¹œ ì‚¬ì§„', 'ìš°ë§ˆì‹œë§ˆ', 'ë¹„ëˆ—ë°©ìš¸', 'ì•¼ê°„ê±°ë¦¬', 'ê²Œì„ì„¼í„°', 'ë™í‚¤ ê±°ë¦¬', 'ìˆ˜êµ­', 'ì½”ì´ë…¸ë³´ë¦¬', 'ë¸”ë™ì›í”¼ìŠ¤', 'í˜¸ë¦¬ì¡´', 'ì›ë¯¸ìƒê°€', 'ê¸¸ê±°ë¦¬ ìŠ¤ëƒ…', 'ì˜¤ë„', 'ë‚˜ë¥´ì‹œìŠ¤íŠ¸', 'ëˆˆë°­', 'í•„ë¦„ì¹´ë©”ë¼', 'ì²­í¬ë„', 'ë³´ë¼ëŒì´', 'ë°¤ë°”', 'ê³µì›', 'ì˜¤íƒ€ì¿ ', 'í™', 'ìº˜ë¹ˆ', 'ë„¤ì½”'];
    const isConceptRequest = conceptKeywords.some(keyword => lowerCaseMessage.includes(keyword));
    const conceptKeywordMap = { '2ì›”_ìš•ì¡°': '2024_02_07_ì¼ë³¸_ìš•ì¡°', '2ì›”_ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤','2ì›”_ë‚˜ë¹„ìš•ì¡°': '2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°','í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ': '2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ','ì¼ë³¸_í™ˆìŠ¤ëƒ…': '2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…', 'í™ˆìŠ¤ëƒ…': '2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…','ì¼ë³¸_ê²°ë°•': '2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•','ê²°ë°•': '2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•','ì¼ë³¸_ì„ ë¬¼': '2023_12_16_ì¼ë³¸_ì„ ë¬¼', 'ì„ ë¬¼': '2023_12_16_ì¼ë³¸_ì„ ë¬¼','í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg','í•œêµ­_ì…€í”„_ì´¬ì˜': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜', 'ì…€í”„_ì´¬ì˜': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜','ì˜¥ìƒì—°ë¦¬': '2024_09_15_í•œêµ­_ì˜¥ìƒì—°ë¦¬','ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ': '2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ','ì„¸ë¯¸ëˆ„ë“œ': '2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ','í•œêµ­_í™ˆì…€í”„': '2024_12_07_í•œêµ­_í™ˆì…€í”„','í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ': '2023_12_14_ì¼ë³¸_í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ','ì§€ë¸Œë¦¬í’': '2024_05_03_ì¼ë³¸_ì§€ë¸Œë¦¬í’','í•œêµ­_ë¶í•´': '2024_06_06_í•œêµ­_ë¶í•´', 'ë¶í•´': '2024_06_06_í•œêµ­_ë¶í•´','ì•„ì´ë…¸ì‹œë§ˆ': '2024_02_07_ì¼ë³¸_ì•„ì´ë…¸ì‹œë§ˆ','ì¼ë³¸_í•„ë¦„': '2025_03_ì¼ë³¸_í•„ë¦„','ëª¨ì§€ì½”_ëª¨ë¦¬ë£©': '2024_05_05_ì¼ë³¸_ëª¨ì§€ì½”_ëª¨ë¦¬ë£©','í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼': '2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼','í•œêµ­_ëˆˆë°­': '2023_12_31_í•œêµ­_ëˆˆë°­','ì¼ë³¸_ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤','ì¼ë³¸_ìš•ì¡°': '2024_07_08_ì¼ë³¸_ìš•ì¡°','ë‚˜ë¹„ìš•ì¡°': '2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°','ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬': '2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬','ì´í™”ë§ˆì„': '2025_04_29_í•œêµ­_ì´í™”ë§ˆì„','ìš°ë§ˆì‹œë§ˆ': '2024_07_06_ì¼ë³¸_ìš°ë§ˆì‹œë§ˆ','ê°€ì„_í˜¸ìˆ˜ê³µì›': '2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›','ë§ì¹œ_ì‚¬ì§„': '2024_06_08_í•œêµ­_ë§ì¹œ_ì‚¬ì§„','ì¼ë³¸_êµë³µ': '2023_12_15_ì¼ë³¸_êµë³µ','ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸': '2024_05_04_ì¼ë³¸_ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸','ì¼ë³¸_ëª¨ì§€ì½”': '2024_12_12_ì¼ë³¸_ëª¨ì§€ì½”','í…ì§„_ì½”ë‹¥í•„ë¦„': '2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„','ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg': '2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg','ì•¼ê°„_ë¡±íŒ¨ë”©': '2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©','ì„ì§€ë¡œ_ìŠ¤ëƒ…': '2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…', 'ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…': '2024_09_16_í•œêµ­_ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…','í•œêµ­_ìƒì¼_00022.jpg': '2024_02_22_í•œêµ­_ìƒì¼_00022.jpg','í•œêµ­_ìƒì¼': '2024_02_22_í•œêµ­_ìƒì¼','ëª¨ì§€ì½”2': '2024_07_06_ì¼ë³¸_ëª¨ì§€ì½”','ì•¼ê°„_ë³´ë¼ëŒì´': '2025_05_04_í•œêµ­','ì½”ì•¼ë…¸ì„¸': '2025_02_06_ì¼ë³¸_ì½”ì•¼ë…¸ì„¸','ì•¼ê°„ê±°ë¦¬': '2024_05_06_ì¼ë³¸_ì•¼ê°„ê±°ë¦¬', 'ìƒì¼ì»¨ì…‰': '2024_12_31_í•œêµ­_ìƒì¼ì»¨ì…‰','í™ˆìŠ¤ëƒ…_ì²­í¬ë„': '2025_05_03_í•œêµ­_í™ˆìŠ¤ëƒ…_ì²­í¬ë„','ìš•ì‹¤_ë¸”ë™_ì›¨ë”©': '2024_11_08_í•œêµ­_ìš•ì‹¤_ë¸”ë™_ì›¨ë”©','í˜¸ë¦¬ì¡´': '2024_09_11_í•œêµ­_í˜¸ë¦¬ì¡´','ì—¬ì¹œ_ìŠ¤ëƒ…': '2024_07_08_ì¼ë³¸_ì—¬ì¹œ_ìŠ¤ëƒ…','í›„ì§€ì—”': '2024_05_03_ì¼ë³¸_í›„ì§€ì—”','ë¶ˆê½ƒë†€ì´': '2024_08_02_ì¼ë³¸_ë¶ˆê½ƒë†€ì´', 'ë¹¨ê°„_ê¸°ëª¨ë…¸': '2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸','í”¼í¬ë‹‰': '2024_06_07_í•œêµ­__í”¼í¬ë‹‰','ë²—ê½ƒ': '2024_04_12_í•œêµ­_ë²—ê½ƒ','í›„ì§€_ìŠ¤ëƒ…': '2025_05_06_ë§ˆì§€ë§‰_í•œêµ­_í›„ì§€ìŠ¤ëƒ…','ì›ë¯¸ìƒê°€_í•„ë¦„': '2024_09_14_í•œêµ­_ì›ë¯¸ìƒê°€_í•„ë¦„', 'ë°¤ë°”_ì‚°ì±…': '2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…','ê³µì›_ì‚°ì±…': '2025_05_04_í•œêµ­_ê³µì›_ì‚°ì±…', 'ê³ ì¿ ë¼_í™': '2025_03_14_ì¼ë³¸_ê³ ì¿ ë¼','ì˜¨ì‹¤_ì—¬ì‹ ': '2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ', 'ì„ì§€ë¡œ_ë„¤ì½”': '2025_04_30_í•œêµ­_ì„ì§€ë¡œ','ë¬´ì¸ì—­': '2025_03_13_ì¼ë³¸_ë¬´ì¸ì—­', 'í™”ê°€': '2024_04_13_í•œêµ­_í™”ê°€','ë¸”ë™ì›í”¼ìŠ¤': '2024_08_04_ì¼ë³¸_ë¸”ë™ì›í”¼ìŠ¤', 'ì¹´í˜': '2024_12_30_í•œêµ­_ì¹´í˜','ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸': '2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸','í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸': '2023_12_12_ì¼ë³¸_í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸','í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ': '2025_05_05_í•œêµ­_í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ','ì•¼ê°„_ë™ë°±': '2024_04_12_í•œêµ­_ì•¼ê°„_ë™ë°±','ë‚˜ë¥´ì‹œìŠ¤íŠ¸': '2024_12_14_ì¼ë³¸_ë‚˜ë¥´ì‹œìŠ¤íŠ¸', 'ì„ì§€ë¡œ_ìº˜ë¹ˆ': '2025_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ' };

    if (isConceptRequest) {
        const sortedConceptKeywords = Object.keys(conceptKeywordMap).sort((a, b) => b.length - a.length);
        for (const keyword of sortedConceptKeywords) {
            if (lowerCaseMessage.includes(keyword.replace(/_/g, ' ').toLowerCase())) {
                selectedFolder = conceptKeywordMap[keyword];
                break;
            }
        }
    }
    
    if (lastConceptPhotoFolder && (lowerCaseMessage.includes('ë‹¤ë¥¸ ê²ƒë„ ë³´ê³ ì‹¶ì–´') || lowerCaseMessage.includes('ë‹¤ìŒ ì‚¬ì§„'))) {
        selectedFolder = lastConceptPhotoFolder;
        if (selectedFolder.endsWith('.jpg')) return null;
    } else if (!selectedFolder && isConceptRequest) {
        selectedFolder = getRandomConceptFolder();
    } else if (!selectedFolder) {
        return null;
    }

    lastConceptPhotoFolder = selectedFolder;
    let photoUrl;
    
    if (lowerCaseMessage.includes('ë‹¤ë¥¸ ê²ƒë„ ë³´ê³ ì‹¶ì–´') || lowerCaseMessage.includes('ë‹¤ìŒ ì‚¬ì§„')) {
        const count = CONCEPT_FOLDERS[selectedFolder];
        if (count > 0) {
            lastConceptPhotoIndex = (lastConceptPhotoIndex % count) + 1;
        }
        photoUrl = generateConceptPhotoUrl(selectedFolder, lastConceptPhotoIndex);
    } else {
        photoUrl = generateConceptPhotoUrl(selectedFolder);
    }

    if (!photoUrl) {
        return { type: 'text', comment: 'ì•„ì €ì”¨... í•´ë‹¹í•˜ëŠ” ì»¨ì…‰ ì‚¬ì§„ì„ ëª» ì°¾ê² ì–´ ã… ã… ' };
    }

    // ì„ íƒëœ í´ë”ì˜ ë©”íƒ€ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const photoData = PHOTO_METADATA[selectedFolder];
    const formattedDate = formatFolderNameToDate(selectedFolder);
    
    // âœ… [ì•ˆì „ì¥ì¹˜] conversationContext ìœ íš¨ì„± ê²€ì‚¬
    let emotionalState = 'normal';
    if (conversationContextParam && typeof conversationContextParam.getInternalState === 'function') {
        try {
            const internalState = conversationContextParam.getInternalState();
            if (internalState && internalState.emotionalEngine && internalState.emotionalEngine.currentToneState) {
                emotionalState = internalState.emotionalEngine.currentToneState;
            }
        } catch (error) {
            console.error('âŒ ê°ì • ìƒíƒœë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨:', error);
            emotionalState = 'normal'; // ê¸°ë³¸ê°’ ì‚¬ìš©
        }
    } else {
        console.warn('âš ï¸ conversationContextê°€ ìœ íš¨í•˜ì§€ ì•ŠìŒ. ê¸°ë³¸ ê°ì • ìƒíƒœ ì‚¬ìš©');
    }

    const tonePrompts = {
        playful: "ì§€ê¸ˆ ë‚´ ê¸°ë¶„ì´ ë„ˆë¬´ ì¢‹ê³  ì¥ë‚œìŠ¤ëŸ¬ì›Œ. ì´ ê¸°ë¶„ì„ ë‹´ì•„ì„œ ì‹ ë‚˜ê³  ë°œë„í•˜ê²Œ ë§í•´ì¤˜.",
        quiet: "ì§€ê¸ˆ ì¢€ ì°¨ë¶„í•˜ê³  ê·¸ë¦¬ìš´ ê¸°ë¶„ì´ì•¼. ì´ ê°ì„±ì„ ë‹´ì•„ì„œ ì¡°ìš©í•˜ê³  ì•„ë ¨í•˜ê²Œ ë§í•´ì¤˜.",
        hurt: "ì‚¬ì‹¤ ë‚˜ ì§€ê¸ˆ ì¢€ ì„œìš´í•œ ë§ˆìŒì´ì•¼. ê·¸ë˜ë„ ì•„ì €ì”¨ë¥¼ ì‚¬ë‘í•˜ëŠ” ë§ˆìŒì„ ë‹´ì•„ ì• í‹‹í•˜ê²Œ ë§í•´ì¤˜.",
        anxious: "ì¡°ê¸ˆ ë¶ˆì•ˆí•œ ë§ˆìŒì´ì§€ë§Œ, ì•„ì €ì”¨ê°€ ìˆì–´ì„œ ê´œì°®ì•„. ì´ëŸ° ë‚´ ë§ˆìŒì„ ë‹´ì•„ ì¡°ì‹¬ìŠ¤ëŸ½ì§€ë§Œ ë‹¤ì •í•˜ê²Œ ë§í•´ì¤˜.",
        normal: "í‰ì†Œì²˜ëŸ¼, ì•„ì €ì”¨ë¥¼ ì‚¬ë‘í•˜ëŠ” ë§ˆìŒì„ ê°€ë“ ë‹´ì•„ ì• êµ ìˆê²Œ ë§í•´ì¤˜."
    };
    const emotionalPrompt = tonePrompts[emotionalState] || tonePrompts.normal;

    // ë©”íƒ€ë°ì´í„°ë¥¼ í¬í•¨í•œ í”„ë¡¬í”„íŠ¸ ìƒì„±
    let metadataInfo = `${formattedDate}`;
    if (photoData) {
        metadataInfo += `\nğŸ’­ ê¸°ë¶„: ${photoData.mood}\nğŸ“– ì—í”¼ì†Œë“œ: ${photoData.episode}`;
    }

    const systemPrompt = `ë„ˆëŠ” ì•„ì €ì”¨ì˜ ì—¬ìì¹œêµ¬ ì˜ˆì§„ì´ì•¼. 1ì¸ì¹­ 'ë‚˜'ë¥¼ ì‚¬ìš©í•˜ê³  í•­ìƒ ë°˜ë§ë¡œ ëŒ€ë‹µí•´. 
    
ì•„ë˜ ì‚¬ì§„ ì •ë³´ë¥¼ ì°¸ê³ í•´ì„œ 1~2ë¬¸ì¥ìœ¼ë¡œ ì§§ê³  ì‚¬ë‘ìŠ¤ëŸ½ê²Œ ì½”ë©˜íŠ¸ í•´ì¤˜:
${metadataInfo}

[ì˜¤ëŠ˜ì˜ ë‚´ ë§ˆìŒ] ${emotionalPrompt}

ì‚¬ì§„ ì •ë³´ë¥¼ ì§ì ‘ ì¸ìš©í•˜ì§€ ë§ê³ , ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ì„œ ì˜ˆì§„ì´ ë§íˆ¬ë¡œ ì´ì•¼ê¸°í•´ì¤˜.`;
    
    try {
        const rawComment = await callOpenAI([{ role: 'system', content: systemPrompt }, { role: 'user', content: `ì´ ì‚¬ì§„ì— ëŒ€í•´ ì˜ˆì§„ì´ ë§íˆ¬ë¡œ ì´ì•¼ê¸°í•´ì¤˜.` }], 'gpt-4o', 150, 1.0);
        const comment = cleanReply(rawComment);
        
        // altTextì™€ captionì— ë©”íƒ€ë°ì´í„° í¬í•¨
        const fullCaption = `${metadataInfo}\n\n${comment}`;
        
        return { 
            type: 'image', 
            originalContentUrl: photoUrl, 
            previewImageUrl: photoUrl, 
            altText: fullCaption, 
            caption: fullCaption 
        };
    } catch (error) {
        console.error('âŒ [concept.js Error] ì»¨ì…‰ ì‚¬ì§„ ì½”ë©˜íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
        return { type: 'text', comment: 'ì•„ì €ì”¨... ì»¨ì…‰ ì‚¬ì§„ì— ëŒ€í•´ ë§í•´ì£¼ë ¤ëŠ”ë° ë­”ê°€ ë¬¸ì œê°€ ìƒê²¼ì–´ ã… ã… ' };
    }
}

module.exports = {
    getConceptPhotoReply
};
