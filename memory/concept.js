// memory/concept.js v1.17 - 순환 의존성 완전 해결

// 📦 필수 모듈 불러오기
const moment = require('moment-timezone');
const path = require('path');
// ✨ 순환 의존성 해결: autoReply.js import 제거, 매개변수로 받음

// 컨셉 사진이 저장된 웹 서버의 기본 URL (HTTPS 필수)
const BASE_CONCEPT_URL = 'https://photo.de-ji.net/concept/';

// 아저씨가 제공해주신 컨셉 사진 폴더별 사진 개수 데이터
const CONCEPT_FOLDERS = {
    '2023/12월_12일_일본_하카타_스트리트': 29,
    '2023/12월_13일_일본_모지코': 42,
    '2023/12월_14일_일본_플라스틱러브': 75,
    '2023/12월_15일_일본_교복': 51,
    '2023/12월_16일_일본_선물': 113,
    '2023/12월_31일_한국_눈밭_필름카메라': 43,
    '2023/12월_31일_한국_눈밭': 38,
    '2024/2월_7일_일본_아이노시마': 65,
    '2024/2월_7일_일본_욕실': 61,
    '2024/2월_7일_일본_세미누드': 92,
    '2024/2월_7일_일본_나비욕조': 48,
    '2024/2월_11일_일본_네코_모지코': 21,
    '2024/2월_11일_일본_야간_블랙드레스': 20,
    '2024/2월_22일_한국_생일': 46,
    '2024/2월_22일_한국_카페': 19, // 수정: '_한국_카페'
    '2024/2월_23일_한국_야간_롱패딩': 48,
    '2024/3월_17일_일본_고쿠라': 19,
    '2024/4월_12일_한국_벗꽃': 35,
    '2024/4월_12일_한국_야간_동백': 26,
    '2024/4월_13일_한국_온실-여신': 31,
    '2024/4월_13일_한국_화가': 30,
    '2024/4월_13일_한국_문래동': 16,
    '2024/4월_28일_한국_셀프_촬영': 112,
    '2024/5월_2일_일본_동키_거리': 18,
    '2024/5월_3일_일본_후지엔': 40,
    '2024/5월_3일_일본_수국': 14,
    '2024/5월_3일_일본_지브리풍': 74,
    '2024/5월_4일_일본_야간_비눗방울': 49,
    '2024/5월_5일_일본_모지코_모리룩': 64,
    '2024/5월_5일_일본_모지코_모리룩_후보정': 64,
    '2024/5월_5일_일본_코이노보리': 17,
    '2024/5월_6일_일본_야간거리': 43,
    '2024/5월_7일_일본_홈스냅': 323,
    '2024/5월_7일_일본_게임센터': 19,
    '2024/6월_6일_한국_북해': 65,
    '2024/6월_7일_한국_피크닉': 36,
    '2024/6월_8일_한국_망친_사진': 52,
    '2024/6월_8일_한국_터널': 28,
    '2024/6월_9일_한국_산책': 25,
    '2024/7월_5일_일본_모지코': 26,
    '2024/7월_6일_일본_우마시마': 53,
    '2024/7월_6일_일본_모지코2': 45,
    '2024/7월_8일_일본_결박': 223,
    '2024/2월_7일_일본_욕조': 53,
    '2024/7월_8일_일본_여친_스냅': 41,
    '2024/8월_2일_일본_불꽃놀이': 39,
    '2024/8월_3일_일본_유카타_마츠리': 56,
    '2024/8월_4일_일본_블랙원피스': 29,
    '2024/9월_11일_한국_호리존': 41,
    '2024/9월_14일_한국_원미상가_필름': 34,
    '2024/9월_15일_한국_옥상연리': 98,
    '2024/9월_16일_한국_길거리_스냅': 46,
    '2024/9월_17일_한국_을지로_스냅': 46,
    '2024/10월_16일_일본_결박': 137,
    '2024/10월_16일_일본_욕실': 15,
    '2024/10월_16일_일본_오도공원_후지필름': 24,
    '2024/10월_16일_일본_오도': 5,
    '2024/10월_16일_일본_고스로리_할로윈': 20,
    '2024/10월_17일_일본_하카타_고래티셔츠': 59,
    '2024/10월_17일_일본_텐진_스트리트': 29,
    '2024/10월_18일_일본_텐진_코닥필름': 49,
    '2024/10월_19일_일본_빨간_기모노': 39,
    '2024/11월_7일_한국_가을_호수공원': 53,
    '2024/11월_8일_한국_욕실_블랙_웨딩': 42,
    '2024/11월_8일_한국_메이드복': 14,
    '2024/12월_7일_한국_홈셀프': 81,
    '2024/12월_12일_일본_모지코': 49,
    '2024/12월_13일_일본_크리스마스': 22,
    '2024/12월_14일_일본_나르시스트': 26,
    '2024/12월_30일_한국_카페': 29,
    '2024/12월_31일_한국_생일컨셉': 43,
    '2025/1월_5일_한국_눈밭': 63,
    '2025/2월_6일_일본_코야노세': 43,
    '2025/3월_13일_일본_무인역': 30,
    '2025/3월_14일_일본_고쿠라_힙': 32,
    '2025/3월_17일_일본_텐진_스트리트': 28,
    '2025/3월_17일_일본_고쿠라_야간': 17,
    '2025/3월_일본_필름': 64,
    '2025/3월_22_한국_홈셀프': 27,
    '2025/4월_29일_한국_이화마을': 55,
    '2025/4월_30일_한국_을지로_네코': 30,
    '2025/4월_30일_한국_을지로_캘빈': 25,
    '2025/5월_3일_한국_홈스냅_청포도': 42,
    '2025/5월_4일_한국_야간_보라돌이': 43,
    '2025/5월_4일_한국_밤바_산책': 32,
    '2025/5월_4일_한국_공원_산책': 32,
    '2025/5월_5일_한국_홈스냅_오타쿠': 27,
    '2025/5월_6일_한국_후지_스냅': 34
};

// ... (다른 코드 생략)

// 키워드 맵을 길이 기준으로 내림차순 정렬하여 더 구체적인 키워드가 먼저 매칭되도록 합니다.
const conceptKeywordMap = {
    // 기존 키워드 중 공백이 있는 것만 '_'로 변경
    '2월_욕조': '2024/2월_7일_일본_욕조',
    '2월_욕실': '2024/2월_7일_일본_욕실',
    '2월_나비욕조': '2024/2월_7일_일본_나비욕조',
    '하카타_고래티셔츠': '2024/10월_17일_일본_하카타_고래티셔츠',
    '일본_홈스냅': '2024/5월_7일_일본_홈스냅', 
    '홈스냅': '2024/5월_7일_일본_홈스냅',
    '일본_결박': '2024/7월_8일_일본_결박', 
    '결박': '2024/7월_8일_일본_결박',
    '일본_선물': '2023/12월_16일_일본_선물', 
    '선물': '2023/12월_16일_일본_선물',
    '한국_셀프_촬영': '2024/4월_28일_한국_셀프_촬영', 
    '셀프_촬영': '2024/4월_28일_한국_셀프_촬영',
    '옥상연리': '2024/9월_15일_한국_옥상연리',
    '일본_세미누드': '2024/2월_7일_일본_세미누드', 
    '세미누드': '2024/2월_7일_일본_세미누드',
    '한국_홈셀프': '2024/12월_7일_한국_홈셀프',
    '플라스틱러브': '2023/12월_14일_일본_플라스틱러브',
    '지브리풍': '2024/5월_3일_일본_지브리풍',
    '한국_북해': '2024/6월_6일_한국_북해', 
    '북해': '2024/6월_6일_한국_북해',
    '아이노시마': '2024/2월_7일_일본_아이노시마',
    '일본_필름': '2025/3월_일본_필름',
    '모지코_모리룩_후보정': '2024/5월_5일_일본_모지코_모리룩_후보정',
    '모지코_모리룩': '2024/5월_5일_일본_모지코_모리룩',
    '한국_눈밭': '2025/1월_5일_한국_눈밭',
    '일본_욕실': '2024/2월_7일_일본_욕실',
    '일본_욕조': '2024/7월_8일_일본_욕조',
    '나비욕조': '2024/2월_7일_일본_나비욕조',
    '유카타_마츠리': '2024/8월_3일_일본_유카타_마츠리',
    '이화마을': '2025/4월_29일_한국_이화마을',
    '우마시마': '2024/7월_6일_일본_우마시마',
    '가을_호수공원': '2024/11월_7일_한국_가을_호수공원',
    '망친_사진': '2024/6월_8일_한국_망친_사진',
    '일본_교복': '2023/12월_15일_일본_교복',
    '야간_비눗방울': '2024/5월_4일_일본_야간_비눗방울',
    '일본_모지코': '2024/12월_12일_일본_모지코',
    '텐진_코닥필름': '2024/10월_18일_일본_텐진_코닥필름',
    '야간_롱패딩': '2024/2월_23일_한국_야간_롱패딩',
    '을지로_스냅': '2024/9월_17일_한국_을지로_스냅', 
    '길거리_스냅': '2024/9월_16일_한국_길거리_스냅',
    '한국_생일': '2024/2월_22일_한국_생일',
    '모지코2': '2024/7월_6일_일본_모지코2',
    '야간_보라돌이': '2025/5월_4일_한국_야간_보라돌이', 
    '코야노세': '2025/2월_6일_일본_코야노세',
    '야간거리': '2024/5월_6일_일본_야간거리', 
    '생일컨셉': '2024/12월_31일_한국_생일컨셉',
    '눈밭_필름카메라': '2023/12월_31일_한국_눈밭_필름카메라',
    '홈스냅_청포도': '2025/5월_3일_한국_홈스냅_청포도',
    '욕실_블랙_웨딩': '2024/11월_8일_한국_욕실_블랙_웨딩',
    '호리존': '2024/9월_11일_한국_호리존',
    '여친_스냅': '2024/7월_8일_일본_여친_스냅',
    '후지엔': '2024/5월_3일_일본_후지엔',
    '불꽃놀이': '2024/8월_2일_일본_불꽃놀이', // '후보정'이 폴더명에 있으면 제거
    '빨간_기모노': '2024/10월_19일_일본_빨간_기모노',
    '피크닉': '2024/6월_7일_한국_피크닉',
    '벗꽃': '2024/4월_12일_한국_벗꽃',
    '후지_스냅': '2025/5월_6일_한국_후지_스냅',
    '원미상가_필름': '2024/9월_14일_한국_원미상가_필름', 
    '밤바_산책': '2025/5월_4일_한국_밤바_산책',
    '공원_산책': '2025/5월_4일_한국_공원_산책', 
    '고쿠라_힙': '2025/3월_14일_일본_고쿠라_힙',
    '온실-여신': '2024/4월_13일_한국_온실-여신',
    '을지로_네코': '2025/4월_30일_한국_을지로_네코',
    '무인역': '2025/3월_13일_일본_무인역', 
    '화가': '2024/4월_13일_한국_화가',
    '블랙원피스': '2024/8월_4일_일본_블랙원피스', 
    '카페': '2024/12월_30일_한국_카페',
    '일본_텐진_스트리트': '2024/10월_17일_일본_텐진_스트리트',
    '하카타_스트리트': '2023/12월_12일_일본_하카타_스트리트',
    '홈스냅_오타쿠': '2025/5월_5일_한국_홈스냅_오타쿠',
    '야간_동백': '2024/4월_12일_한국_야간_동백',
    '나르시스트': '2024/12월_14일_일본_나르시스트', 
    '을지로_캘빈': '2025/4월_30일_한국_을지로_캘빈',
    '산책': '2024/6월_9일_한국_산책',
    '오도공원_후지필름': '2024/10월_16일_일본_오도공원_후지필름',
    '크리스마스': '2024/12월_13일_일본_크리스마스',
    '네코_모지코': '2024/2월_11일_일본_네코_모지코',
    '야간_블랙드레스': '2024/2월_11일_일본_야간_블랙드레스',
    '고스로리_할로윈': '2024/10월_16일_일본_고스로리_할로윈',
    '게임센터': '2024/5월_7일_일본_게임센터',
    '동키_거리': '2024/5월_2일_일본_동키_거리',
    '고쿠라_야간': '2025/3월_17일_일본_고쿠라_야간',
    '코이노보리': '2024/5월_5일_일본_코이노보리', 
    '문래동': '2024/4월_13일_한국_문래동',
    '수국': '2024/5월_3일_일본_수국',
    '메이드복': '2024/11월_8일_한국_메이드복',
    '오도': '2024/10월_16일_일본_오도',
    '욕실': '2024/2월_7일_일본_욕실',
    '욕조': '2024/7월_8일_일본_욕조'
    };

// ... (다른 코드 생략)

/**
 * 특정 컨셉 폴더에서 랜덤 또는 다음 사진 URL을 생성합니다.
 * @param {string} folderName - 사진이 들어있는 폴더 이름
 * @param {number} [targetIndex=null] - 특정 인덱스의 사진을 가져올 경우
 * @returns {string|null} 사진 URL 또는 null
 */
function generateConceptPhotoUrl(folderName, targetIndex = null) {
    console.log(`[concept:generateConceptPhotoUrl] 폴더명: "${folderName}"`);
    const photoCount = CONCEPT_FOLDERS[folderName];
    console.log(`[concept:generateConceptPhotoUrl] 사진 개수: ${photoCount}`);
    
    if (photoCount === undefined || photoCount <= 0) {
        console.warn(`[concept.js] 폴더를 찾을 수 없거나 사진이 없습니다: ${folderName}`);
        return null;
    }
    
    let indexToUse;
    if (targetIndex !== null && targetIndex >= 1 && targetIndex <= photoCount) {
        indexToUse = targetIndex;
    } else {
        indexToUse = Math.floor(Math.random() * photoCount) + 1;
    }
    console.log(`[concept:generateConceptPhotoUrl] 사용할 인덱스: ${indexToUse}`);

    const fileName = String(indexToUse).padStart(6, '0') + '.jpg';
    console.log(`[concept:generateConceptPhotoUrl] 파일명: ${fileName}`);
    
    // 폴더명에서 연도와 나머지 경로를 분리하여 각각 인코딩
    const parts = folderName.split('/');
    let encodedPath = '';

    if (parts.length > 1) {
        const year = parts[0]; // 예: '2024'
        const restOfPath = parts.slice(1).join('/'); // 예: '9월_14일_한국_원미상가_필름'
        encodedPath = `${encodeURIComponent(year)}/${encodeURIComponent(restOfPath)}`;
    } else {
        // 연도 구분자가 없는 경우 (예: 'couple', 'yejin')
        encodedPath = encodeURIComponent(folderName);
    }
    
    const url = `${BASE_CONCEPT_URL}${encodedPath}/${fileName}`; // BASE_CONCEPT_URL 사용
    console.log(`[concept:generateConceptPhotoUrl] 최종 생성 URL: ${url}`);
    return url;
}

// ... (나머지 코드 변경 없음)
