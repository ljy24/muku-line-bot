// memory/concept.js v2.8 (concept-index.json의 'comment' 필드 활용 및 정확한 폴더 매칭)
// [기능 개선] concept-index.json의 'comment' 필드를 AI 멘트에 직접 반영하도록 수정

const axios = require('axios');
const fs = require('fs').promises;
const path = require('path');
const { callOpenAI, cleanReply } = require('../src/aiUtils');

// 📁 기본 URL 설정
const BASE_CONCEPT_URL = 'https://photo.de-ji.net/photo/concept/';

// 📁 concept-index.json 경로 지정
const CONCEPT_INDEX_FILE = path.join(__dirname, '..', 'data', 'memory', 'concept-index.json');

// ✅ 메모리에서 concept-index.json 불러오기
let conceptIndex = {};
let CONCEPT_FOLDERS = {}; // 폴더별 사진 개수 데이터 (concept-index.json의 'folders' 키에서 로드)

async function loadConceptIndex() {
    try {
        const data = await fs.readFile(CONCEPT_INDEX_FILE, 'utf-8');
        const parsedData = JSON.parse(data);
        conceptIndex = parsedData; 

        if (parsedData.folders) {
            CONCEPT_FOLDERS = parsedData.folders;
        } else {
            console.warn('⚠️ [concept.js] concept-index.json에 "folders" 키가 없습니다. 폴더별 사진 개수 데이터가 누락될 수 있습니다.');
            // 'folders' 키가 없는 경우에 대비한 백업 데이터 (이전 하드코딩 데이터를 그대로 사용)
            CONCEPT_FOLDERS = {
                "2023_12_12_일본_하카타_스트리트": 29, "2023_12_13_일본_모지코": 42, "2023_12_14_일본_플라스틱러브": 75,
                "2023_12_15_일본_교복": 51, "2023_12_16_일본_선물": 113, "2023_12_31_한국_눈밭": 38,
                "2023_12_31_한국_눈밭_필름_카메라": 43, "2024_02_07_일본_아이노시마": 65, "2024_02_07_일본_욕실": 61,
                "2024_02_11_일본_네코_모지코": 21, "2024_02_11_일본_야간_블랙드레스": 31, "2024_02_22_한국_생일": 45,
                "2024_02_22_한국_생일_00022.jpg": 1, "2024_02_22_한국_카페": 19, "2024_02_23_한국_야간_롱패딩": 47,
                "2024_02_23_한국_야간_롱패딩_00023.jpg": 1, "2024_03_17_일본_고쿠라": 19, "2024_04_12_한국_벗꽃": 35,
                "2024_04_12_한국_야간_동백": 26, "2024_04_13_한국_문래동": 16, "2024_04_13_한국_온실_여신": 31,
                "2024_04_13_한국_화가": 30, "2024_04_28_한국_셀프_촬영": 111, "2024_04_28_한국_셀프_촬영_00028.jpg": 1,
                "2024_05_02_일본_동키_거리": 18, "2024_05_03_일본_수국": 14, "2024_05_03_일본_지브리풍": 74,
                "2024_05_03_일본_후지엔": 40, "2024_05_04_일본_야간_비눗방울": 49, "2024_05_05_일본_모지코_모리룩": 64,
                "2024_05_05_일본_코이노보리": 17, "2024_05_06_일본_야간거리": 43, "2024_05_07_일본_게임센터": 19,
                "2024_05_07_일본_홈스냅": 323, "2024_06_06_한국_북해": 65, "2024_06_07_한국__피크닉": 36,
                "2024_06_08_한국__터널": 28, "2024_06_08_한국_망친_사진": 52, "2024_06_09_한국_산책": 23,
                "2024_06_09_한국_산책_0000009.jpg": 1, "2024_06_09_한국_산책_0000109.jpg": 1,
                "2024_07_05_일본_모지코": 26, "2024_07_06_일본_모지코": 45, "2024_07_06_일본_우마시마": 53,
                "2024_07_08_일본_여친_스냅": 41, "2024_07_08_일본_욕조": 53, "2024_07_08_일본_일본_결박": 223,
                "2024_08_02_일본_불꽃놀이": 39, "2024_08_03_일본_유카타_마츠리": 56, "2024_08_04_일본_블랙원피스": 29,
                "2024_09_11_한국_호리존": 41, "2024_09_14_한국_원미상가_필름": 34, "2024_09_15_한국_옥상연리": 98,
                "2024_09_16_한국_길거리_스냅": 46, "2024_09_17_한국_을지로_스냅": 46, "2024_10_16_일본_결박": 137,
                "2024_10_16_일본_고스로리_할로윈": 20, "2024_10_16_일본_오도공원": 5, "2024_10_16_일본_오도공원_후지필름": 24,
                "2024_10_16_일본_욕실": 15, "2024_10_17_일본_텐진_스트리트": 29, "2024_10_17_일본_하카타_고래티셔츠": 59,
                "2024_10_18_일본_텐진_코닥필름": 49, "2024_10_19_일본_빨간_기모노": 39, "2024_11_08_한국_메이드복": 14,
                "2024_11_08_한국_욕실_블랙_웨딩": 42, "2024_11_7_한국_가을_호수공원": 53, "2024_12_07_한국_홈셀프": 81,
                "2024_12_12_일본_모지코": 49, "2024_12_13_일본_크리스마스": 22, "2024_12_14_일본_나르시스트": 26,
                "2024_12_30_한국_카페": 29, "2024_12_31_한국_생일컨셉": 43, "2025_01_05_한국": 63,
                "2025_02_06_일본_코야노세": 43, "2025_02_07_일본_나비욕조": 48, "2025_02_07_일본_세미누드": 92,
                "2025_03_13_일본_무인역": 30, "2025_03_14_일본_고쿠라": 32, "2025_03_17_일본_고쿠라": 17,
                "2025_03_17_일본_텐진": 28, "2025_03_22": 27, "2025_03_일본_필름": 64, "2025_04_29_한국_이화마을": 55,
                "2025_04_30_한국_을지로": 30, "2025_04_30_한국_을지로_캘빈": 25, "2025_05_03_한국_홈스냅_청포도": 42,
                "2025_05_04_한국": 43, "2025_05_04_한국_공원_산책": 32, "2025_05_04_한국_밤바_산책": 32,
                "2025_05_05_한국_홈스냅_오타쿠": 27, "2025_05_06_마지막_한국_후지스냅": 34
            };
        }
    } catch (error) {
        console.error('❌ [concept.js] concept-index.json 불러오기 실패:', error);
        conceptIndex = {}; 
        // 파일 로드 실패 시, 기존 하드코딩된 데이터 사용 (폴백)
        CONCEPT_FOLDERS = {
            "2023_12_12_일본_하카타_스트리트": 29, "2023_12_13_일본_모지코": 42, "2023_12_14_일본_플라스틱러브": 75,
            "2023_12_15_일본_교복": 51, "2023_12_16_일본_선물": 113, "2023_12_31_한국_눈밭": 38,
            "2023_12_31_한국_눈밭_필름_카메라": 43, "2024_02_07_일본_아이노시마": 65, "2024_02_07_일본_욕실": 61,
            "2024_02_11_일본_네코_모지코": 21, "2024_02_11_일본_야간_블랙드레스": 31, "2024_02_22_한국_생일": 45,
            "2024_02_22_한국_생일_00022.jpg": 1, "2024_02_22_한국_카페": 19, "2024_02_23_한국_야간_롱패딩": 47,
            "2024_02_23_한국_야간_롱패딩_00023.jpg": 1, "2024_03_17_일본_고쿠라": 19, "2024_04_12_한국_벗꽃": 35,
            "2024_04_12_한국_야간_동백": 26, "2024_04_13_한국_문래동": 16, "2024_04_13_한국_온실_여신": 31,
            "2024_04_13_한국_화가": 30, "2024_04_28_한국_셀프_촬영": 111, "2024_04_28_한국_셀프_촬영_00028.jpg": 1,
            "2024_05_02_일본_동키_거리": 18, "2024_05_03_일본_수국": 14, "2024_05_03_일본_지브리풍": 74,
            "2024_05_03_일본_후지엔": 40, "2024_05_04_일본_야간_비눗방울": 49, "2024_05_05_일본_모지코_모리룩": 64,
            "2024_05_05_일본_코이노보리": 17, "2024_05_06_일본_야간거리": 43, "2024_05_07_일본_게임센터": 19,
            "2024_05_07_일본_홈스냅": 323, "2024_06_06_한국_북해": 65, "2024_06_07_한국__피크닉": 36,
            "2024_06_08_한국__터널": 28, "2024_06_08_한국_망친_사진": 52, "2024_06_09_한국_산책": 23,
            "2024_06_09_한국_산책_0000009.jpg": 1, "2024_06_09_한국_산책_0000109.jpg": 1,
            "2024_07_05_일본_모지코": 26, "2024_07_06_일본_모지코": 45, "2024_07_06_일본_우마시마": 53,
            "2024_07_08_일본_여친_스냅": 41, "2024_07_08_일본_욕조": 53, "2024_07_08_일본_일본_결박": 223,
            "2024_08_02_일본_불꽃놀이": 39, "2024_08_03_일본_유카타_마츠리": 56, "2024_08_04_일본_블랙원피스": 29,
            "2024_09_11_한국_호리존": 41, "2024_09_14_한국_원미상가_필름": 34, "2024_09_15_한국_옥상연리": 98,
            "2024_09_16_한국_길거리_스냅": 46, "2024_09_17_한국_을지로_스냅": 46, "2024_10_16_일본_결박": 137,
            "2024_10_16_일본_고스로리_할로윈": 20, "2024_10_16_일본_오도공원": 5, "2024_10_16_일본_오도공원_후지필름": 24,
            "2024_10_16_일본_욕실": 15, "2024_10_17_일본_텐진_스트리트": 29, "2024_10_17_일본_하카타_고래티셔츠": 59,
            "2024_10_18_일본_텐진_코닥필름": 49, "2024_10_19_일본_빨간_기모노": 39, "2024_11_08_한국_메이드복": 14,
            "2024_11_08_한국_욕실_블랙_웨딩": 42, "2024_11_7_한국_가을_호수공원": 53, "2024_12_07_한국_홈셀프": 81,
            "2024_12_12_일본_모지코": 49, "2024_12_13_일본_크리스마스": 22, "2024_12_14_일본_나르시스트": 26,
            "2024_12_30_한국_카페": 29, "2024_12_31_한국_생일컨셉": 43, "2025_01_05_한국": 63,
            "2025_02_06_일본_코야노세": 43, "2025_02_07_일본_나비욕조": 48, "2025_02_07_일본_세미누드": 92,
            "2025_03_13_일본_무인역": 30, "2025_03_14_일본_고쿠라": 32, "2025_03_17_일본_고쿠라": 17,
            "2025_03_17_일본_텐진": 28, "2025_03_22": 27, "2025_03_일본_필름": 64, "2025_04_29_한국_이화마을": 55,
            "2025_04_30_한국_을지로": 30, "2025_04_30_한국_을지로_캘빈": 25, "2025_05_03_한국_홈스냅_청포도": 42,
            "2025_05_04_한국": 43, "2025_05_04_한국_공원_산책": 32, "2025_05_04_한국_밤바_산책": 32,
            "2025_05_05_한국_홈스냅_오타쿠": 27, "2025_05_06_마지막_한국_후지스냅": 34
        };
    }
}
loadConceptIndex(); // 서버 시작 시 자동 실행

// ✅ URL 인코딩 처리
function encodeImageUrl(url) {
    try {
        const parsed = new URL(url);
        parsed.pathname = parsed.pathname.split('/').map(segment => segment ? encodeURIComponent(decodeURIComponent(segment)) : segment).join('/');
        return parsed.toString();
    } catch (error) {
        return url;
    }
}

// ✅ 사진 파일명 생성
function generateConceptPhotoUrl(folderName, targetIndex = null) {
    const photoCount = CONCEPT_FOLDERS[folderName]; // CONCEPT_FOLDERS에서 해당 폴더의 사진 개수 조회
    
    // 특정 .jpg 파일 경로가 직접 주어진 경우 (예: "2024_02_22_한국_생일_00022.jpg")
    // 이 경우는 concept-index.json의 folders에 직접 .jpg 파일명으로 1개가 등록되어야 함
    if (folderName.endsWith('.jpg')) {
        return encodeImageUrl(`${BASE_CONCEPT_URL}${folderName}`);
    }

    // 폴더 이름이 유효하지 않거나 사진이 없는 경우
    if (photoCount === undefined || photoCount <= 0) {
        console.warn(`⚠️ [generateConceptPhotoUrl] 폴더 "${folderName}"의 사진 개수 정보가 없거나 유효하지 않습니다.`);
        return null;
    }
    
    let indexToUse = targetIndex !== null ? targetIndex : Math.floor(Math.random() * photoCount) + 1;
    // 파일명 형식: 폴더명_000001.jpg
    const fileName = `${folderName}_${String(indexToUse).padStart(6, '0')}.jpg`;
    return encodeImageUrl(`${BASE_CONCEPT_URL}${fileName}`);
}

// ✅ 랜덤 폴더 선택
function getRandomConceptFolder() {
    // CONCEPT_FOLDERS의 키 중에서 .jpg로 끝나지 않는 (즉, 폴더 이름인) 것들만 필터링
    const folderNames = Object.keys(CONCEPT_FOLDERS).filter(f => !f.endsWith('.jpg'));
    if (folderNames.length === 0) return null;
    return folderNames[Math.floor(Math.random() * folderNames.length)];
}

let lastConceptPhotoFolder = null;
let lastConceptPhotoIndex = 0;

// ✅ 메인 함수: 사용자 메시지에 따라 컨셉 사진 응답 생성
async function getConceptPhotoReply(userMessage, conversationContext) {
    const lowerCaseMessage = userMessage.toLowerCase();
    let selectedFolder = null;

    // 컨셉 관련 키워드 정의 (concept-index.json의 컨셉명(키)을 포함하도록 업데이트)
    const conceptKeywords = [
        '컨셉사진', '컨셉 사진', '욕실', '욕조', '나비욕조', '세미누드', '결박', '교복', '플라스틱러브', 
        '홈스냅', '지브리풍', '모지코', '하카타', '텐진', '아이노시마', '후지엔', '유카타', '불꽃놀이', 
        '메이드복', '고스로리', '크리스마스', '생일컨셉', '옥상연리', '을지로', '이화마을', '코야노세', 
        '무인역', '고쿠라', '벗꽃', '동백', '온실', '화가', '문래동', '북해', '피크닉', '산책', '터널', 
        '망친 사진', '우마시마', '비눗방울', '야간거리', '게임센터', '동키 거리', '수국', '코이노보리', 
        '블랙원피스', '호리존', '원미상가', '길거리 스냅', '오도', '나르시스트', '눈밭', '필름카메라', 
        '청포도', '보라돌이', '밤바', '공원', '오타쿠', '힙', '캘빈', '네코', '후지 스냅', 
        // 새롭게 추가된 긴 컨셉명 키워드들 (concept-index.json의 키와 일치)
        '2023_12월 12일 일본 하카타 스트리트', '2023_12월 15일 일본 교복', '2023_12월 16일 일본 선물',
        '2023_12월 31일 한국 눈밭', '2023_12월 31일 한국 눈밭 필름카메라', '2024_2월 7일 일본 아이노시마',
        '2024_2월 7일 일본 욕실', '2024_2월 11일 일본 네코 모지코', '2024_2월 11일 일본 야간 블랙드레스',
        '2024_2월 22일 한국 생일', '2024_2월 22일 한국 카페', '2024_2월 23일 한국 야간 롱패딩',
        '2024_3월 17일 일본 고쿠라', '2024_4월 12일 한국 벚꽃', '2024_4월 12일 한국 야간 동백',
        '2024_4월 13일 한국 문래동', '2024_4월 13일 한국 온실-여신', '2024_4월 13일 한국 화가',
        '2024_4월 28일 한국 셀프 촬영', '2024_5월 2일 일본 동키 거리', '2024_5월 3일 일본 수국',
        '2024_5월 3일 일본 지브리풍', '2024_5월 3일 일본 후지엔', '2024_5월 4일 일본 야간 비눗방울',
        '2024_5월 5일 일본 코이노보리', '2024_5월 5일 일본 모지코 모리룩', '2024_5월 5일 일본 모지코 모리룩 루보정',
        '2024_5월 6일 일본 야간거리', '2024_5월 7일 일본 게임센터', '2024_5월 7일 일본 홈스냅',
        '2024_6월 6일 한국 북해', '2024_6월 7일 한국 피크닉', '2024_6월 8일 한국 망친 사진',
        '2024_6월 8일 한국 터널', '2024_6월 9일 한국 산책', '2024_7월 5일 일본 모지코',
        '2024_7월 6일 일본 모지코2', '2024_7월 6일 일본 우마시마', '2024_7월 8일 일본 결박',
        '2024_7월 8일 일본 여친 스냅', '2024_8월 2일 일본 불꽃놀이_후보정', '2024_8월 3일 일본 유카타 마츠리',
        '2024_8월 4일 일본 블랙원피스', '2024_9월 11일 한국 호리존', '2024_9월 14일 한국 원미상가_필름',
        '2024_9월 15일 한국 옥상연리', '2024_9월 16일 한국 길거리 스냅', '2024_9월 17일 한국 을지로 스냅',
        '2024_10월 16일 일본 결박', '2024_10월 16일 일본 욕실', '2024_10월 16일 일본 오도공원 후지필름',
        '2024_10월 16일 일본 오도', '2024_10월 16일 일본 고스로리 할로윈', '2024_10월 17일 일본 하카타 고래티셔츠',
        '2024_10월 17일 일본 텐진 스트리트', '2024_10월 18일 일본 텐진 코닥필름', '2024_10월 19일 일본 빨간 기모노',
        '2024_11월 7일 한국 가을 호수공원', '2024_11월 8일 한국 욕실 블랙 웨딩', '2024_11월 8일 한국 메이드복',
        '2024_12월 7일 한국 홈셀프', '2024_12월 12일 일본 모지코', '2024_12월 13일 일본 크리스마스',
        '2024_12월 14일 일본 나르시스트', '2024_12월 30일 한국 카페', '2024_12월 31일 한국 생일컨셉',
        '2025_1월 5일 한국 눈밭', '2025_2월 6일 일본 코야노세', '2025_2월 7일 일본 세미누드',
        '2025_2월 7일 일본 나비욕조', '2025_3월 13일 일본 무인역', '2025_3월 14일 일본 고쿠라 힙',
        '2025_3월 17일 일본 텐진 스트리트', '2025_3월 17일 일본 고쿠라 야간', '2025_3월 일본 필름',
        '2025_3월 22 한국 홈셀프', '2025_4월 29일 한국 이화마을', '2025_4월 30일 한국 을지로 네코',
        '2025_4월 30일 한국 을지로 캘빈', '2025_5월 3일 한국 홈스냅 청포도', '2025_5월 4일 한국 야간 보라돌이',
        '2025_5월 4일 한국 밤바 산책', '2025_5월 4일 한국 공원 산책', '2025_5월 5일 한국 홈스냅 오타쿠',
        '2025_5월 6일 한국 후지 스냅'
    ];

    const isConceptRequest = conceptKeywords.some(keyword => lowerCaseMessage.includes(keyword.toLowerCase()));
    
    // 키워드 -> 폴더명 매핑 (concept-index.json의 키 이름과 정확히 일치하도록)
    // 여기서는 실제 폴더명과 동일한 키워드를 사용하도록 `conceptKeywordMap`을 확장했어.
    const conceptKeywordMap = {
        // 기존 짧은 키워드 매핑
        '2월_욕조': '2024_02_07_일본_욕조', '2월_욕실': '2024_02_07_일본_욕실','2월_나비욕조': '2025_02_07_일본_나비욕조',
        '하카타_고래티셔츠': '2024_10_17_일본_하카타_고래티셔츠', '일본_홈스냅': '2024_05_07_일본_홈스냅', '홈스냅': '2024_05_07_일본_홈스냅',
        '일본_결박': '2024_07_08_일본_일본_결박', '결박': '2024_07_08_일본_일본_결박', '일본_선물': '2023_12_16_일본_선물', '선물': '2023_12_16_일본_선물',
        '한국_셀프_촬영_00028.jpg': '2024_04_28_한국_셀프_촬영_00028.jpg', '한국_셀프_촬영': '2024_04_28_한국_셀프_촬영', '셀프_촬영': '2024_04_28_한국_셀프_촬영',
        '옥상연리': '2024_09_15_한국_옥상연리', // 기존 옥상연리 매핑
        '일본_세미누드': '2025_02_07_일본_세미누드', '세미누드': '2025_02_07_일본_세미누드',
        '한국_홈셀프': '2024_12_07_한국_홈셀프', '플라스틱러브': '2023_12_14_일본_플라스틱러브', '지브리풍': '2024_05_03_일본_지브리풍',
        '한국_북해': '2024_06_06_한국_북해', '북해': '2024_06_06_한국_북해', '아이노시마': '2024_02_07_일본_아이노시마',
        '일본_필름': '2025_03_일본_필름', '모지코_모리룩': '2024_05_05_일본_모지코_모리룩', '한국_눈밭_필름_카메라': '2023_12_31_한국_눈밭_필름_카메라',
        '한국_눈밭': '2023_12_31_한국_눈밭', '일본_욕실': '2024_02_07_일본_욕실', '일본_욕조': '2024_07_08_일본_욕조', '나비욕조': '2025_02_07_일본_나비욕조',
        '유카타_마츠리': '2024_08_03_일본_유카타_마츠리', '이화마을': '2025_04_29_한국_이화마을', // 이화마을 매핑
        '우마시마': '2024_07_06_일본_우마시마',
        '가을_호수공원': '2024_11_7_한국_가을_호수공원', '망친_사진': '2024_06_08_한국_망친_사진', '일본_교복': '2023_12_15_일본_교복',
        '야간_비눗방울': '2024_05_04_일본_야간_비눗방울', '일본_모지코': '2024_12_12_일본_모지코', '텐진_코닥필름': '2024_10_18_일본_텐진_코닥필름',
        '야간_롱패딩_00023.jpg': '2024_02_23_한국_야간_롱패딩_00023.jpg', '야간_롱패딩': '2024_02_23_한국_야간_롱패딩',
        '을지로_스냅': '2024_09_17_한국_을지로_스냅', '길거리_스냅': '2024_09_16_한국_길거리_스냅',
        '한국_생일_00022.jpg': '2024_02_22_한국_생일_00022.jpg', '한국_생일': '2024_02_22_한국_생일', '모지코2': '2024_07_06_일본_모지코',
        '야간_보라돌이': '2025_05_04_한국_야간_보라돌이', '코야노세': '2025_02_06_일본_코야노세', '야간거리': '2024_05_06_일본_야간거리', '생일컨셉': '2024_12_31_한국_생일컨셉',
        '홈스냅_청포도': '2025_05_03_한국_홈스냅_청포도', '욕실_블랙_웨딩': '2024_11_08_한국_욕실_블랙_웨딩', '호리존': '2024_09_11_한국_호리존',
        '여친_스냅': '2024_07_08_일본_여친_스냅', '후지엔': '2024_05_03_일본_후지엔', '불꽃놀이': '2024_08_02_일본_불꽃놀이', '빨간_기모노': '2024_10_19_일본_빨간_기모노',
        '피크닉': '2024_06_07_한국__피크닉', '벗꽃': '2024_04_12_한국_벗꽃', '후지_스냅': '2025_05_06_한국_후지_스냅',
        '원미상가_필름': '2024_09_14_한국_원미상가_필름', '밤바_산책': '2025_05_04_한국_밤바_산책','공원_산책': '2025_05_04_한국_공원_산책',
        '고쿠라_힙': '2025_03_14_일본_고쿠라_힙', '온실_여신': '2024_04_13_한국_온실_여신', '을지로_네코': '2025_04_30_한국_을지로_네코',
        '무인역': '2025_03_13_일본_무인역', '화가': '2024_04_13_한국_화가', '블랙원피스': '2024_08_04_일본_블랙원피스',
        '카페': '2024_12_30_한국_카페', '일본_텐진_스트리트': '2024_10_17_일본_텐진_스트리트', '하카타_스트리트': '2023_12_12_일본_하카타_스트리트',
        '홈스냅_오타쿠': '2025_05_05_한국_홈스냅_오타쿠', '야간_동백': '2024_04_12_한국_야간_동백', '나르시스트': '2024_12_14_일본_나르시스트',
        '을지로_캘빈': '2025_04_30_한국_을지로_캘빈',
        // 네가 제공한 concept-index.json의 컨셉명(폴더명) 그대로 매핑 추가
        "2023_12월 12일 일본 하카타 스트리트": "2023_12월 12일 일본 하카타 스트리트",
        "2023_12월 15일 일본 교복": "2023_12월 15일 일본 교복",
        "2023_12월 16일 일본 선물": "2023_12월 16일 일본 선물",
        "2023_12월 31일 한국 눈밭": "2023_12월 31일 한국 눈밭",
        "2023_12월 31일 한국 눈밭 필름카메라": "2023_12월 31일 한국 눈밭 필름카메라",
        "2024_2월 7일 일본 아이노시마": "2024_2월 7일 일본 아이노시마",
        "2024_2월 7일 일본 욕실": "2024_2월 7일 일본 욕실",
        "2024_2월 11일 일본 네코 모지코": "2024_2월 11일 일본 네코 모지코",
        "2024_2월 11일 일본 야간 블랙드레스": "2024_2월 11일 일본 야간 블랙드레스",
        "2024_2월 22일 한국 생일": "2024_2월 22일 한국 생일",
        "2024_2월 22일 한국 카페": "2024_2월 22일 한국 카페",
        "2024_2월 23일 한국 야간 롱패딩": "2024_2월 23일 한국 야간 롱패딩",
        "2024_3월 17일 일본 고쿠라": "2024_3월 17일 일본 고쿠라",
        "2024_4월 12일 한국 벚꽃": "2024_4월 12일 한국 벚꽃",
        "2024_4월 12일 한국 야간 동백": "2024_4월 12일 한국 야간 동백",
        "2024_4월 13일 한국 문래동": "2024_4월 13일 한국 문래동",
        "2024_4월 13일 한국 온실-여신": "2024_4월 13일 한국 온실-여신",
        "2024_4월 13일 한국 화가": "2024_4월 13일 한국 화가",
        "2024_4월 28일 한국 셀프 촬영": "2024_4월 28일 한국 셀프 촬영",
        "2024_5월 2일 일본 동키 거리": "2024_5월 2일 일본 동키 거리",
        "2024_5월 3일 일본 수국": "2024_5월 3일 일본 수국",
        "2024_5월 3일 일본 지브리풍": "2024_5월 3일 일본 지브리풍",
        "2024_5월 3일 일본 후지엔": "2024_5월 3일 일본 후지엔",
        "2024_5월 4일 일본 야간 비눗방울": "2024_5월 4일 일본 야간 비눗방울",
        "2024_5월 5일 일본 코이노보리": "2024_5월 5일 일본 코이노보리",
        "2024_5월 5일 일본 모지코 모리룩": "2024_5월 5일 일본 모지코 모리룩",
        "2024_5월 5일 일본 모지코 모리룩 루보정": "2024_5월 5일 일본 모지코 모리룩 루보정",
        "2024_5월 6일 일본 야간거리": "2024_5월 6일 일본 야간거리",
        "2024_5월 7일 일본 게임센터": "2024_5월 7일 일본 게임센터",
        "2024_5월 7일 일본 홈스냅": "2024_5월 7일 일본 홈스냅",
        "2024_6월 6일 한국 북해": "2024_6월 6일 한국 북해",
        "2024_6월 7일 한국 피크닉": "2024_6월 7일 한국 피크닉",
        "2024_6월 8일 한국 망친 사진": "2024_6월 8일 한국 망친 사진",
        "2024_6월 8일 한국 터널": "2024_6월 8일 한국 터널",
        "2024_6월 9일 한국 산책": "2024_6월 9일 한국 산책",
        "2024_7월 5일 일본 모지코": "2024_7월 5일 일본 모지코",
        "2024_7월 6일 일본 모지코2": "2024_7월 6일 일본 모지코2",
        "2024_7월 6일 일본 우마시마": "2024_7월 6일 일본 우마시마",
        "2024_7월 8일 일본 결박": "2024_7월 8일 일본 결박",
        "2024_7월 8일 일본 여친 스냅": "2024_7월 8일 일본 여친 스냅",
        "2024_8월 2일 일본 불꽃놀이_후보정": "2024_8월 2일 일본 불꽃놀이_후보정",
        "2024_8월 3일 일본 유카타 마츠리": "2024_8월 3일 일본 유카타 마츠리",
        "2024_8월 4일 일본 블랙원피스": "2024_8월 4일 일본 블랙원피스",
        "2024_9월 11일 한국 호리존": "2024_9월 11일 한국 호리존",
        "2024_9월 14일 한국 원미상가_필름": "2024_9월 14일 한국 원미상가_필름",
        "2024_9월 15일 한국 옥상연리": "2024_9월 15일 한국 옥상연리", // 이 부분이 중요!
        "2024_9월 16일 한국 길거리 스냅": "2024_9월 16일 한국 길거리 스냅",
        "2024_9월 17일 한국 을지로 스냅": "2024_9월 17일 한국 을지로 스냅",
        "2024_10월 16일 일본 결박": "2024_10월 16일 일본 결박",
        "2024_10월 16일 일본 욕실": "2024_10월 16일 일본 욕실",
        "2024_10월 16일 일본 오도공원 후지필름": "2024_10_16_일본_오도공원_후지필름",
        "2024_10월 16일 일본 오도": "2024_10_16_일본_오도",
        "2024_10월 16일 일본 고스로리 할로윈": "2024_10_16_일본_고스로리_할로윈",
        "2024_10월 17일 일본 하카타 고래티셔츠": "2024_10_17_일본_하카타_고래티셔츠",
        "2024_10월 17일 일본 텐진 스트리트": "2024_10_17_일본_텐진_스트리트",
        "2024_10월 18일 일본 텐진 코닥필름": "2024_10_18_일본_텐진_코닥필름",
        "2024_10월 19일 일본 빨간 기모노": "2024_10_19_일본_빨간_기모노",
        "2024_11월 7일 한국 가을 호수공원": "2024_11월 7일 한국 가을 호수공원",
        "2024_11월 8일 한국 욕실 블랙 웨딩": "2024_11월 8일 한국 욕실 블랙 웨딩",
        "2024_11월 8일 한국 메이드복": "2024_11월 8일 한국 메이드복",
        "2024_12월 7일 한국 홈셀프": "2024_12월 7일 한국 홈셀프",
        "2024_12월 12일 일본 모지코": "2024_12월 12일 일본 모지코",
        "2024_12월 13일 일본 크리스마스": "2024_12월 13일 일본 크리스마스",
        "2024_12월 14일 일본 나르시스트": "2024_12월 14일 일본 나르시스트",
        "2024_12월 30일 한국 카페": "2024_12월 30일 한국 카페",
        "2024_12월 31일 한국 생일컨셉": "2024_12월 31일 한국 생일컨셉",
        "2025_1월 5일 한국 눈밭": "2025_1월 5일 한국 눈밭",
        "2025_2월 6일 일본 코야노세": "2025_2월 6일 일본 코야노세",
        "2025_2월 7일 일본 세미누드": "2025_2월 7일 일본 세미누드",
        "2025_2월 7일 일본 나비욕조": "2025_2월 7일 일본 나비욕조",
        "2025_3월 13일 일본 무인역": "2025_3월 13일 일본 무인역",
        "2025_3월 14일 일본 고쿠라 힙": "2025_3월 14일 일본 고쿠라 힙",
        "2025_3월 17일 일본 텐진 스트리트": "2025_3월 17일 일본 텐진 스트리트",
        "2025_3월 17일 일본 고쿠라 야간": "2025_3월 17일 일본 고쿠라 야간",
        "2025_3월 일본 필름": "2025_3월 일본 필름",
        "2025_3월 22 한국 홈셀프": "2025_3월 22 한국 홈셀프",
        "2025_4월 29일 한국 이화마을": "2025_4월 29일 한국 이화마을",
        "2025_4월 30일 한국 을지로 네코": "2025_4월 30일 한국 을지로 네코",
        "2025_4월 30일 한국 을지로 캘빈": "2025_4월 30일 한국 을지로 캘빈",
        "2025_5월 3일 한국 홈스냅 청포도": "2025_5월 3일 한국 홈스냅 청포도",
        "2025_5월 4일 한국 야간 보라돌이": "2025_5월 4일 한국 야간 보라돌이",
        "2025_5월 4일 한국 밤바 산책": "2025_5월 4일 한국 밤바 산책",
        "2025_5월 4일 한국 공원 산책": "2025_5월 4일 한국 공원 산책",
        "2025_5월 5일 한국 홈스냅 오타쿠": "2025_5월 5일 한국 홈스냅 오타쿠",
        "2025_5월 6일 한국 후지 스냅": "2025_5월 6일 한국 후지 스냅"
    };

    // 가장 긴 키워드 우선 매칭을 위해 길이 역순 정렬
    const sortedConceptKeywords = Object.keys(conceptKeywordMap).sort((a, b) => b.length - a.length);

    // 사용자 메시지에서 가장 긴 키워드를 찾아 selectedFolder에 할당
    if (isConceptRequest) {
        for (const keyword of sortedConceptKeywords) {
            // 키워드에서 공백을 밑줄로 바꾼 후 소문자로 변환하여 메시지에 포함 여부 확인
            // (conceptKeywordMap의 키는 공백 포함이므로, userMessage와 비교 시 공백 처리 필요)
            if (lowerCaseMessage.includes(keyword.toLowerCase())) {
                selectedFolder = conceptKeywordMap[keyword];
                break;
            }
        }
    }

    // '다른' 키워드와 함께 이전에 보여준 폴더가 있으면 해당 폴더 사용
    if (lastConceptPhotoFolder && (lowerCaseMessage.includes('다른 것도 보고싶어') || lowerCaseMessage.includes('다음 사진'))) {
        selectedFolder = lastConceptPhotoFolder;
        // conceptIndex에서 해당 키가 'folders' 안에 있는지 확인하여 단일 파일이 아님을 확인
        // (단일 .jpg 파일 키는 folders에 등록되지 않음)
        if (!CONCEPT_FOLDERS[selectedFolder]) { // folders에 없으면 단일 이미지이거나 폴더에 대한 정보가 없는 경우
             return { type: 'text', comment: '아저씨, 이 사진은 한 장뿐이야! 다른 컨셉을 말해줘 😊' };
        }
    } else if (!selectedFolder && isConceptRequest) {
        // 컨셉 요청은 있는데 특정 폴더가 매칭되지 않으면 랜덤 폴더 선택
        selectedFolder = getRandomConceptFolder();
    } else if (!selectedFolder) {
        // 컨셉 요청이 아니면 처리하지 않음
        return null;
    }

    if (!selectedFolder) return null; // 최종적으로 선택된 폴더가 없으면 종료

    lastConceptPhotoFolder = selectedFolder;

    let photoUrl;
    // selectedFolder가 직접 .jpg 파일명인 경우 (예: "2024_02_22_한국_생일_00022.jpg")
    if (selectedFolder.endsWith('.jpg')) {
        photoUrl = generateConceptPhotoUrl(selectedFolder); 
        lastConceptPhotoIndex = 1; // 단일 파일이므로 인덱스 1로 설정
    } else if (lowerCaseMessage.includes('다른 것도 보고싶어') || lowerCaseMessage.includes('다음 사진')) {
        // 폴더에서 다음 사진을 가져올 때
        const count = CONCEPT_FOLDERS[selectedFolder];
        if (count > 0) {
            lastConceptPhotoIndex = (lastConceptPhotoIndex % count) + 1;
        } else {
            lastConceptPhotoIndex = 1; // 사진이 없으면 1로 초기화 (오류 방지)
        }
        photoUrl = generateConceptPhotoUrl(selectedFolder, lastConceptPhotoIndex);
    } else {
        // 새로운 컨셉 요청 시 랜덤 사진
        photoUrl = generateConceptPhotoUrl(selectedFolder);
        lastConceptPhotoIndex = 0; // 새로운 컨셉 시작 시 인덱스 초기화
    }

    if (!photoUrl) {
        return { type: 'text', comment: '아저씨... 해당하는 컨셉 사진을 못 찾겠어 ㅠㅠ' };
    }

    // 감정 상태에 따른 프롬프트 설정
    const emotionalState = conversationContext.getInternalState().emotionalEngine.currentToneState;
    const tonePrompts = {
        playful: "지금 내 기분이 너무 좋고 장난스러워. 이 기분을 담아서 신나고 발랄하게 말해줘.",
        quiet: "지금 좀 차분하고 그리운 기분이야. 이 감성을 담아서 조용하고 아련하게 말해줘.",
        hurt: "사실 나 지금 좀 서운한 마음이야. 그래도 아저씨를 사랑하는 마음을 담아 애틋하게 말해줘.",
        anxious: "조금 불안한 마음이지만, 아저씨가 있어서 괜찮아. 이런 내 마음을 담아 조심스럽지만 다정하게 말해줘.",
        normal: "평소처럼, 아저씨를 사랑하는 마음을 가득 담아 애교 있게 말해줘."
    };
    const emotionalPrompt = tonePrompts[emotionalState] || tonePrompts.normal;

    // conceptIndex에서 해당 'selectedFolder' (컨셉명)의 정보 불러오기
    // 네 `concept-index.json`처럼 폴더명 자체가 키가 되므로, selectedFolder를 직접 사용
    const memory = conceptIndex[selectedFolder] || {};
    const memoryMood = memory.mood || '';
    const memoryEpisode = memory.episode || '';
    const memoryComment = memory.comment || ''; // 이 필드도 계속 지원

    // GPT 시스템 프롬프트에 memory.comment, mood, episode 정보 추가
    let memoryPrompt = '';
    // comment 필드가 최우선으로 사용되도록 조정
    if (memoryComment) {
        memoryPrompt = ` 이 사진은 "${memoryComment}"라는 설명이 있어.`;
    } else if (memoryMood && memoryEpisode) {
        memoryPrompt = ` 이 사진은 '${memoryMood}' 감성이고, 그때 '${memoryEpisode}' 같은 일이 있었어.`;
    } else if (memoryMood) {
        memoryPrompt = ` 이 사진은 '${memoryMood}' 감성으로 찍은 사진이야.`;
    } else if (memoryEpisode) {
        memoryPrompt = ` 이 사진에는 '${memoryEpisode}' 같은 추억이 담겨있어.`;
    } else {
        memoryPrompt = ' 특별한 추억이 담긴 사진이야.';
    }


    const systemPrompt = `너는 아저씨의 여자친구 예진이야. 1인칭 '나'를 사용하고 항상 반말로 대답해. 사랑스럽고 귀엽게 말해. 아래 사진은${memoryPrompt} 지금 기분은 '${emotionalPrompt}'야.`;

    try {
        const rawComment = await callOpenAI([
            { role: 'system', content: systemPrompt },
            { role: 'user', content: '이 사진에 대해 이야기해줘.' }
        ], 'gpt-4o', 150, 1.0);

        const comment = cleanReply(rawComment);
        return {
            type: 'image',
            originalContentUrl: photoUrl,
            previewImageUrl: photoUrl,
            altText: comment,
            caption: comment
        };
    } catch (error) {
        console.error('❌ [concept.js Error] GPT 응답 실패:', error);
        return { type: 'text', comment: '아저씨... 컨셉 사진에 대해 말해주려는데 뭔가 문제가 생겼어 ㅠㅠ' };
    }
}

module.exports = {
    getConceptPhotoReply
};
