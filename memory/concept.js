// memory/concept.js v2.8 (concept-index.jsonì˜ 'comment' í•„ë“œ í™œìš© ë° ì •í™•í•œ í´ë” ë§¤ì¹­)
// [ê¸°ëŠ¥ ê°œì„ ] concept-index.jsonì˜ 'comment' í•„ë“œë¥¼ AI ë©˜íŠ¸ì— ì§ì ‘ ë°˜ì˜í•˜ë„ë¡ ìˆ˜ì •

const axios = require('axios');
const fs = require('fs').promises;
const path = require('path');
const { callOpenAI, cleanReply } = require('../src/aiUtils');

// ğŸ“ ê¸°ë³¸ URL ì„¤ì •
const BASE_CONCEPT_URL = 'https://photo.de-ji.net/photo/concept/';

// ğŸ“ concept-index.json ê²½ë¡œ ì§€ì •
const CONCEPT_INDEX_FILE = path.join(__dirname, '..', 'data', 'memory', 'concept-index.json');

// âœ… ë©”ëª¨ë¦¬ì—ì„œ concept-index.json ë¶ˆëŸ¬ì˜¤ê¸°
let conceptIndex = {};
let CONCEPT_FOLDERS = {}; // í´ë”ë³„ ì‚¬ì§„ ê°œìˆ˜ ë°ì´í„° (concept-index.jsonì˜ 'folders' í‚¤ì—ì„œ ë¡œë“œ)

async function loadConceptIndex() {
    try {
        const data = await fs.readFile(CONCEPT_INDEX_FILE, 'utf-8');
        const parsedData = JSON.parse(data);
        conceptIndex = parsedData; 

        if (parsedData.folders) {
            CONCEPT_FOLDERS = parsedData.folders;
        } else {
            console.warn('âš ï¸ [concept.js] concept-index.jsonì— "folders" í‚¤ê°€ ì—†ìŠµë‹ˆë‹¤. í´ë”ë³„ ì‚¬ì§„ ê°œìˆ˜ ë°ì´í„°ê°€ ëˆ„ë½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            // 'folders' í‚¤ê°€ ì—†ëŠ” ê²½ìš°ì— ëŒ€ë¹„í•œ ë°±ì—… ë°ì´í„° (ì´ì „ í•˜ë“œì½”ë”© ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
            CONCEPT_FOLDERS = {
                "2023_12_12_ì¼ë³¸_í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸": 29, "2023_12_13_ì¼ë³¸_ëª¨ì§€ì½”": 42, "2023_12_14_ì¼ë³¸_í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ": 75,
                "2023_12_15_ì¼ë³¸_êµë³µ": 51, "2023_12_16_ì¼ë³¸_ì„ ë¬¼": 113, "2023_12_31_í•œêµ­_ëˆˆë°­": 38,
                "2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼": 43, "2024_02_07_ì¼ë³¸_ì•„ì´ë…¸ì‹œë§ˆ": 65, "2024_02_07_ì¼ë³¸_ìš•ì‹¤": 61,
                "2024_02_11_ì¼ë³¸_ë„¤ì½”_ëª¨ì§€ì½”": 21, "2024_02_11_ì¼ë³¸_ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤": 31, "2024_02_22_í•œêµ­_ìƒì¼": 45,
                "2024_02_22_í•œêµ­_ìƒì¼_00022.jpg": 1, "2024_02_22_í•œêµ­_ì¹´í˜": 19, "2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©": 47,
                "2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg": 1, "2024_03_17_ì¼ë³¸_ê³ ì¿ ë¼": 19, "2024_04_12_í•œêµ­_ë²—ê½ƒ": 35,
                "2024_04_12_í•œêµ­_ì•¼ê°„_ë™ë°±": 26, "2024_04_13_í•œêµ­_ë¬¸ë˜ë™": 16, "2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ": 31,
                "2024_04_13_í•œêµ­_í™”ê°€": 30, "2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜": 111, "2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg": 1,
                "2024_05_02_ì¼ë³¸_ë™í‚¤_ê±°ë¦¬": 18, "2024_05_03_ì¼ë³¸_ìˆ˜êµ­": 14, "2024_05_03_ì¼ë³¸_ì§€ë¸Œë¦¬í’": 74,
                "2024_05_03_ì¼ë³¸_í›„ì§€ì—”": 40, "2024_05_04_ì¼ë³¸_ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸": 49, "2024_05_05_ì¼ë³¸_ëª¨ì§€ì½”_ëª¨ë¦¬ë£©": 64,
                "2024_05_05_ì¼ë³¸_ì½”ì´ë…¸ë³´ë¦¬": 17, "2024_05_06_ì¼ë³¸_ì•¼ê°„ê±°ë¦¬": 43, "2024_05_07_ì¼ë³¸_ê²Œì„ì„¼í„°": 19,
                "2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…": 323, "2024_06_06_í•œêµ­_ë¶í•´": 65, "2024_06_07_í•œêµ­__í”¼í¬ë‹‰": 36,
                "2024_06_08_í•œêµ­__í„°ë„": 28, "2024_06_08_í•œêµ­_ë§ì¹œ_ì‚¬ì§„": 52, "2024_06_09_í•œêµ­_ì‚°ì±…": 23,
                "2024_06_09_í•œêµ­_ì‚°ì±…_0000009.jpg": 1, "2024_06_09_í•œêµ­_ì‚°ì±…_0000109.jpg": 1,
                "2024_07_05_ì¼ë³¸_ëª¨ì§€ì½”": 26, "2024_07_06_ì¼ë³¸_ëª¨ì§€ì½”": 45, "2024_07_06_ì¼ë³¸_ìš°ë§ˆì‹œë§ˆ": 53,
                "2024_07_08_ì¼ë³¸_ì—¬ì¹œ_ìŠ¤ëƒ…": 41, "2024_07_08_ì¼ë³¸_ìš•ì¡°": 53, "2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•": 223,
                "2024_08_02_ì¼ë³¸_ë¶ˆê½ƒë†€ì´": 39, "2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬": 56, "2024_08_04_ì¼ë³¸_ë¸”ë™ì›í”¼ìŠ¤": 29,
                "2024_09_11_í•œêµ­_í˜¸ë¦¬ì¡´": 41, "2024_09_14_í•œêµ­_ì›ë¯¸ìƒê°€_í•„ë¦„": 34, "2024_09_15_í•œêµ­_ì˜¥ìƒì—°ë¦¬": 98,
                "2024_09_16_í•œêµ­_ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…": 46, "2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…": 46, "2024_10_16_ì¼ë³¸_ê²°ë°•": 137,
                "2024_10_16_ì¼ë³¸_ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ": 20, "2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›": 5, "2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„": 24,
                "2024_10_16_ì¼ë³¸_ìš•ì‹¤": 15, "2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸": 29, "2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ": 59,
                "2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„": 49, "2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸": 39, "2024_11_08_í•œêµ­_ë©”ì´ë“œë³µ": 14,
                "2024_11_08_í•œêµ­_ìš•ì‹¤_ë¸”ë™_ì›¨ë”©": 42, "2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›": 53, "2024_12_07_í•œêµ­_í™ˆì…€í”„": 81,
                "2024_12_12_ì¼ë³¸_ëª¨ì§€ì½”": 49, "2024_12_13_ì¼ë³¸_í¬ë¦¬ìŠ¤ë§ˆìŠ¤": 22, "2024_12_14_ì¼ë³¸_ë‚˜ë¥´ì‹œìŠ¤íŠ¸": 26,
                "2024_12_30_í•œêµ­_ì¹´í˜": 29, "2024_12_31_í•œêµ­_ìƒì¼ì»¨ì…‰": 43, "2025_01_05_í•œêµ­": 63,
                "2025_02_06_ì¼ë³¸_ì½”ì•¼ë…¸ì„¸": 43, "2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°": 48, "2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ": 92,
                "2025_03_13_ì¼ë³¸_ë¬´ì¸ì—­": 30, "2025_03_14_ì¼ë³¸_ê³ ì¿ ë¼": 32, "2025_03_17_ì¼ë³¸_ê³ ì¿ ë¼": 17,
                "2025_03_17_ì¼ë³¸_í…ì§„": 28, "2025_03_22": 27, "2025_03_ì¼ë³¸_í•„ë¦„": 64, "2025_04_29_í•œêµ­_ì´í™”ë§ˆì„": 55,
                "2025_04_30_í•œêµ­_ì„ì§€ë¡œ": 30, "2025_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ": 25, "2025_05_03_í•œêµ­_í™ˆìŠ¤ëƒ…_ì²­í¬ë„": 42,
                "2025_05_04_í•œêµ­": 43, "2025_05_04_í•œêµ­_ê³µì›_ì‚°ì±…": 32, "2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…": 32,
                "2025_05_05_í•œêµ­_í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ": 27, "2025_05_06_ë§ˆì§€ë§‰_í•œêµ­_í›„ì§€ìŠ¤ëƒ…": 34
            };
        }
    } catch (error) {
        console.error('âŒ [concept.js] concept-index.json ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
        conceptIndex = {}; 
        // íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨ ì‹œ, ê¸°ì¡´ í•˜ë“œì½”ë”©ëœ ë°ì´í„° ì‚¬ìš© (í´ë°±)
        CONCEPT_FOLDERS = {
            "2023_12_12_ì¼ë³¸_í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸": 29, "2023_12_13_ì¼ë³¸_ëª¨ì§€ì½”": 42, "2023_12_14_ì¼ë³¸_í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ": 75,
            "2023_12_15_ì¼ë³¸_êµë³µ": 51, "2023_12_16_ì¼ë³¸_ì„ ë¬¼": 113, "2023_12_31_í•œêµ­_ëˆˆë°­": 38,
            "2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼": 43, "2024_02_07_ì¼ë³¸_ì•„ì´ë…¸ì‹œë§ˆ": 65, "2024_02_07_ì¼ë³¸_ìš•ì‹¤": 61,
            "2024_02_11_ì¼ë³¸_ë„¤ì½”_ëª¨ì§€ì½”": 21, "2024_02_11_ì¼ë³¸_ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤": 31, "2024_02_22_í•œêµ­_ìƒì¼": 45,
            "2024_02_22_í•œêµ­_ìƒì¼_00022.jpg": 1, "2024_02_22_í•œêµ­_ì¹´í˜": 19, "2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©": 47,
            "2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg": 1, "2024_03_17_ì¼ë³¸_ê³ ì¿ ë¼": 19, "2024_04_12_í•œêµ­_ë²—ê½ƒ": 35,
            "2024_04_12_í•œêµ­_ì•¼ê°„_ë™ë°±": 26, "2024_04_13_í•œêµ­_ë¬¸ë˜ë™": 16, "2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ": 31,
            "2024_04_13_í•œêµ­_í™”ê°€": 30, "2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜": 111, "2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg": 1,
            "2024_05_02_ì¼ë³¸_ë™í‚¤_ê±°ë¦¬": 18, "2024_05_03_ì¼ë³¸_ìˆ˜êµ­": 14, "2024_05_03_ì¼ë³¸_ì§€ë¸Œë¦¬í’": 74,
            "2024_05_03_ì¼ë³¸_í›„ì§€ì—”": 40, "2024_05_04_ì¼ë³¸_ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸": 49, "2024_05_05_ì¼ë³¸_ëª¨ì§€ì½”_ëª¨ë¦¬ë£©": 64,
            "2024_05_05_ì¼ë³¸_ì½”ì´ë…¸ë³´ë¦¬": 17, "2024_05_06_ì¼ë³¸_ì•¼ê°„ê±°ë¦¬": 43, "2024_05_07_ì¼ë³¸_ê²Œì„ì„¼í„°": 19,
            "2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…": 323, "2024_06_06_í•œêµ­_ë¶í•´": 65, "2024_06_07_í•œêµ­__í”¼í¬ë‹‰": 36,
            "2024_06_08_í•œêµ­__í„°ë„": 28, "2024_06_08_í•œêµ­_ë§ì¹œ_ì‚¬ì§„": 52, "2024_06_09_í•œêµ­_ì‚°ì±…": 23,
            "2024_06_09_í•œêµ­_ì‚°ì±…_0000009.jpg": 1, "2024_06_09_í•œêµ­_ì‚°ì±…_0000109.jpg": 1,
            "2024_07_05_ì¼ë³¸_ëª¨ì§€ì½”": 26, "2024_07_06_ì¼ë³¸_ëª¨ì§€ì½”": 45, "2024_07_06_ì¼ë³¸_ìš°ë§ˆì‹œë§ˆ": 53,
            "2024_07_08_ì¼ë³¸_ì—¬ì¹œ_ìŠ¤ëƒ…": 41, "2024_07_08_ì¼ë³¸_ìš•ì¡°": 53, "2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•": 223,
            "2024_08_02_ì¼ë³¸_ë¶ˆê½ƒë†€ì´": 39, "2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬": 56, "2024_08_04_ì¼ë³¸_ë¸”ë™ì›í”¼ìŠ¤": 29,
            "2024_09_11_í•œêµ­_í˜¸ë¦¬ì¡´": 41, "2024_09_14_í•œêµ­_ì›ë¯¸ìƒê°€_í•„ë¦„": 34, "2024_09_15_í•œêµ­_ì˜¥ìƒì—°ë¦¬": 98,
            "2024_09_16_í•œêµ­_ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…": 46, "2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…": 46, "2024_10_16_ì¼ë³¸_ê²°ë°•": 137,
            "2024_10_16_ì¼ë³¸_ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ": 20, "2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›": 5, "2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„": 24,
            "2024_10_16_ì¼ë³¸_ìš•ì‹¤": 15, "2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸": 29, "2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ": 59,
            "2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„": 49, "2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸": 39, "2024_11_08_í•œêµ­_ë©”ì´ë“œë³µ": 14,
            "2024_11_08_í•œêµ­_ìš•ì‹¤_ë¸”ë™_ì›¨ë”©": 42, "2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›": 53, "2024_12_07_í•œêµ­_í™ˆì…€í”„": 81,
            "2024_12_12_ì¼ë³¸_ëª¨ì§€ì½”": 49, "2024_12_13_ì¼ë³¸_í¬ë¦¬ìŠ¤ë§ˆìŠ¤": 22, "2024_12_14_ì¼ë³¸_ë‚˜ë¥´ì‹œìŠ¤íŠ¸": 26,
            "2024_12_30_í•œêµ­_ì¹´í˜": 29, "2024_12_31_í•œêµ­_ìƒì¼ì»¨ì…‰": 43, "2025_01_05_í•œêµ­": 63,
            "2025_02_06_ì¼ë³¸_ì½”ì•¼ë…¸ì„¸": 43, "2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°": 48, "2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ": 92,
            "2025_03_13_ì¼ë³¸_ë¬´ì¸ì—­": 30, "2025_03_14_ì¼ë³¸_ê³ ì¿ ë¼": 32, "2025_03_17_ì¼ë³¸_ê³ ì¿ ë¼": 17,
            "2025_03_17_ì¼ë³¸_í…ì§„": 28, "2025_03_22": 27, "2025_03_ì¼ë³¸_í•„ë¦„": 64, "2025_04_29_í•œêµ­_ì´í™”ë§ˆì„": 55,
            "2025_04_30_í•œêµ­_ì„ì§€ë¡œ": 30, "2025_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ": 25, "2025_05_03_í•œêµ­_í™ˆìŠ¤ëƒ…_ì²­í¬ë„": 42,
            "2025_05_04_í•œêµ­": 43, "2025_05_04_í•œêµ­_ê³µì›_ì‚°ì±…": 32, "2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…": 32,
            "2025_05_05_í•œêµ­_í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ": 27, "2025_05_06_ë§ˆì§€ë§‰_í•œêµ­_í›„ì§€ìŠ¤ëƒ…": 34
        };
    }
}
loadConceptIndex(); // ì„œë²„ ì‹œì‘ ì‹œ ìë™ ì‹¤í–‰

// âœ… URL ì¸ì½”ë”© ì²˜ë¦¬
function encodeImageUrl(url) {
    try {
        const parsed = new URL(url);
        parsed.pathname = parsed.pathname.split('/').map(segment => segment ? encodeURIComponent(decodeURIComponent(segment)) : segment).join('/');
        return parsed.toString();
    } catch (error) {
        return url;
    }
}

// âœ… ì‚¬ì§„ íŒŒì¼ëª… ìƒì„±
function generateConceptPhotoUrl(folderName, targetIndex = null) {
    const photoCount = CONCEPT_FOLDERS[folderName]; // CONCEPT_FOLDERSì—ì„œ í•´ë‹¹ í´ë”ì˜ ì‚¬ì§„ ê°œìˆ˜ ì¡°íšŒ
    
    // íŠ¹ì • .jpg íŒŒì¼ ê²½ë¡œê°€ ì§ì ‘ ì£¼ì–´ì§„ ê²½ìš° (ì˜ˆ: "2024_02_22_í•œêµ­_ìƒì¼_00022.jpg")
    // ì´ ê²½ìš°ëŠ” concept-index.jsonì˜ foldersì— ì§ì ‘ .jpg íŒŒì¼ëª…ìœ¼ë¡œ 1ê°œê°€ ë“±ë¡ë˜ì–´ì•¼ í•¨
    if (folderName.endsWith('.jpg')) {
        return encodeImageUrl(`${BASE_CONCEPT_URL}${folderName}`);
    }

    // í´ë” ì´ë¦„ì´ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ì‚¬ì§„ì´ ì—†ëŠ” ê²½ìš°
    if (photoCount === undefined || photoCount <= 0) {
        console.warn(`âš ï¸ [generateConceptPhotoUrl] í´ë” "${folderName}"ì˜ ì‚¬ì§„ ê°œìˆ˜ ì •ë³´ê°€ ì—†ê±°ë‚˜ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`);
        return null;
    }
    
    let indexToUse = targetIndex !== null ? targetIndex : Math.floor(Math.random() * photoCount) + 1;
    // íŒŒì¼ëª… í˜•ì‹: í´ë”ëª…_000001.jpg
    const fileName = `${folderName}_${String(indexToUse).padStart(6, '0')}.jpg`;
    return encodeImageUrl(`${BASE_CONCEPT_URL}${fileName}`);
}

// âœ… ëœë¤ í´ë” ì„ íƒ
function getRandomConceptFolder() {
    // CONCEPT_FOLDERSì˜ í‚¤ ì¤‘ì—ì„œ .jpgë¡œ ëë‚˜ì§€ ì•ŠëŠ” (ì¦‰, í´ë” ì´ë¦„ì¸) ê²ƒë“¤ë§Œ í•„í„°ë§
    const folderNames = Object.keys(CONCEPT_FOLDERS).filter(f => !f.endsWith('.jpg'));
    if (folderNames.length === 0) return null;
    return folderNames[Math.floor(Math.random() * folderNames.length)];
}

let lastConceptPhotoFolder = null;
let lastConceptPhotoIndex = 0;

// âœ… ë©”ì¸ í•¨ìˆ˜: ì‚¬ìš©ì ë©”ì‹œì§€ì— ë”°ë¼ ì»¨ì…‰ ì‚¬ì§„ ì‘ë‹µ ìƒì„±
async function getConceptPhotoReply(userMessage, conversationContext) {
    const lowerCaseMessage = userMessage.toLowerCase();
    let selectedFolder = null;

    // ì»¨ì…‰ ê´€ë ¨ í‚¤ì›Œë“œ ì •ì˜ (concept-index.jsonì˜ ì»¨ì…‰ëª…(í‚¤)ì„ í¬í•¨í•˜ë„ë¡ ì—…ë°ì´íŠ¸)
    const conceptKeywords = [
        'ì»¨ì…‰ì‚¬ì§„', 'ì»¨ì…‰ ì‚¬ì§„', 'ìš•ì‹¤', 'ìš•ì¡°', 'ë‚˜ë¹„ìš•ì¡°', 'ì„¸ë¯¸ëˆ„ë“œ', 'ê²°ë°•', 'êµë³µ', 'í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ', 
        'í™ˆìŠ¤ëƒ…', 'ì§€ë¸Œë¦¬í’', 'ëª¨ì§€ì½”', 'í•˜ì¹´íƒ€', 'í…ì§„', 'ì•„ì´ë…¸ì‹œë§ˆ', 'í›„ì§€ì—”', 'ìœ ì¹´íƒ€', 'ë¶ˆê½ƒë†€ì´', 
        'ë©”ì´ë“œë³µ', 'ê³ ìŠ¤ë¡œë¦¬', 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', 'ìƒì¼ì»¨ì…‰', 'ì˜¥ìƒì—°ë¦¬', 'ì„ì§€ë¡œ', 'ì´í™”ë§ˆì„', 'ì½”ì•¼ë…¸ì„¸', 
        'ë¬´ì¸ì—­', 'ê³ ì¿ ë¼', 'ë²—ê½ƒ', 'ë™ë°±', 'ì˜¨ì‹¤', 'í™”ê°€', 'ë¬¸ë˜ë™', 'ë¶í•´', 'í”¼í¬ë‹‰', 'ì‚°ì±…', 'í„°ë„', 
        'ë§ì¹œ ì‚¬ì§„', 'ìš°ë§ˆì‹œë§ˆ', 'ë¹„ëˆ—ë°©ìš¸', 'ì•¼ê°„ê±°ë¦¬', 'ê²Œì„ì„¼í„°', 'ë™í‚¤ ê±°ë¦¬', 'ìˆ˜êµ­', 'ì½”ì´ë…¸ë³´ë¦¬', 
        'ë¸”ë™ì›í”¼ìŠ¤', 'í˜¸ë¦¬ì¡´', 'ì›ë¯¸ìƒê°€', 'ê¸¸ê±°ë¦¬ ìŠ¤ëƒ…', 'ì˜¤ë„', 'ë‚˜ë¥´ì‹œìŠ¤íŠ¸', 'ëˆˆë°­', 'í•„ë¦„ì¹´ë©”ë¼', 
        'ì²­í¬ë„', 'ë³´ë¼ëŒì´', 'ë°¤ë°”', 'ê³µì›', 'ì˜¤íƒ€ì¿ ', 'í™', 'ìº˜ë¹ˆ', 'ë„¤ì½”', 'í›„ì§€ ìŠ¤ëƒ…', 
        // ìƒˆë¡­ê²Œ ì¶”ê°€ëœ ê¸´ ì»¨ì…‰ëª… í‚¤ì›Œë“œë“¤ (concept-index.jsonì˜ í‚¤ì™€ ì¼ì¹˜)
        '2023_12ì›” 12ì¼ ì¼ë³¸ í•˜ì¹´íƒ€ ìŠ¤íŠ¸ë¦¬íŠ¸', '2023_12ì›” 15ì¼ ì¼ë³¸ êµë³µ', '2023_12ì›” 16ì¼ ì¼ë³¸ ì„ ë¬¼',
        '2023_12ì›” 31ì¼ í•œêµ­ ëˆˆë°­', '2023_12ì›” 31ì¼ í•œêµ­ ëˆˆë°­ í•„ë¦„ì¹´ë©”ë¼', '2024_2ì›” 7ì¼ ì¼ë³¸ ì•„ì´ë…¸ì‹œë§ˆ',
        '2024_2ì›” 7ì¼ ì¼ë³¸ ìš•ì‹¤', '2024_2ì›” 11ì¼ ì¼ë³¸ ë„¤ì½” ëª¨ì§€ì½”', '2024_2ì›” 11ì¼ ì¼ë³¸ ì•¼ê°„ ë¸”ë™ë“œë ˆìŠ¤',
        '2024_2ì›” 22ì¼ í•œêµ­ ìƒì¼', '2024_2ì›” 22ì¼ í•œêµ­ ì¹´í˜', '2024_2ì›” 23ì¼ í•œêµ­ ì•¼ê°„ ë¡±íŒ¨ë”©',
        '2024_3ì›” 17ì¼ ì¼ë³¸ ê³ ì¿ ë¼', '2024_4ì›” 12ì¼ í•œêµ­ ë²šê½ƒ', '2024_4ì›” 12ì¼ í•œêµ­ ì•¼ê°„ ë™ë°±',
        '2024_4ì›” 13ì¼ í•œêµ­ ë¬¸ë˜ë™', '2024_4ì›” 13ì¼ í•œêµ­ ì˜¨ì‹¤-ì—¬ì‹ ', '2024_4ì›” 13ì¼ í•œêµ­ í™”ê°€',
        '2024_4ì›” 28ì¼ í•œêµ­ ì…€í”„ ì´¬ì˜', '2024_5ì›” 2ì¼ ì¼ë³¸ ë™í‚¤ ê±°ë¦¬', '2024_5ì›” 3ì¼ ì¼ë³¸ ìˆ˜êµ­',
        '2024_5ì›” 3ì¼ ì¼ë³¸ ì§€ë¸Œë¦¬í’', '2024_5ì›” 3ì¼ ì¼ë³¸ í›„ì§€ì—”', '2024_5ì›” 4ì¼ ì¼ë³¸ ì•¼ê°„ ë¹„ëˆ—ë°©ìš¸',
        '2024_5ì›” 5ì¼ ì¼ë³¸ ì½”ì´ë…¸ë³´ë¦¬', '2024_5ì›” 5ì¼ ì¼ë³¸ ëª¨ì§€ì½” ëª¨ë¦¬ë£©', '2024_5ì›” 5ì¼ ì¼ë³¸ ëª¨ì§€ì½” ëª¨ë¦¬ë£© ë£¨ë³´ì •',
        '2024_5ì›” 6ì¼ ì¼ë³¸ ì•¼ê°„ê±°ë¦¬', '2024_5ì›” 7ì¼ ì¼ë³¸ ê²Œì„ì„¼í„°', '2024_5ì›” 7ì¼ ì¼ë³¸ í™ˆìŠ¤ëƒ…',
        '2024_6ì›” 6ì¼ í•œêµ­ ë¶í•´', '2024_6ì›” 7ì¼ í•œêµ­ í”¼í¬ë‹‰', '2024_6ì›” 8ì¼ í•œêµ­ ë§ì¹œ ì‚¬ì§„',
        '2024_6ì›” 8ì¼ í•œêµ­ í„°ë„', '2024_6ì›” 9ì¼ í•œêµ­ ì‚°ì±…', '2024_7ì›” 5ì¼ ì¼ë³¸ ëª¨ì§€ì½”',
        '2024_7ì›” 6ì¼ ì¼ë³¸ ëª¨ì§€ì½”2', '2024_7ì›” 6ì¼ ì¼ë³¸ ìš°ë§ˆì‹œë§ˆ', '2024_7ì›” 8ì¼ ì¼ë³¸ ê²°ë°•',
        '2024_7ì›” 8ì¼ ì¼ë³¸ ì—¬ì¹œ ìŠ¤ëƒ…', '2024_8ì›” 2ì¼ ì¼ë³¸ ë¶ˆê½ƒë†€ì´_í›„ë³´ì •', '2024_8ì›” 3ì¼ ì¼ë³¸ ìœ ì¹´íƒ€ ë§ˆì¸ ë¦¬',
        '2024_8ì›” 4ì¼ ì¼ë³¸ ë¸”ë™ì›í”¼ìŠ¤', '2024_9ì›” 11ì¼ í•œêµ­ í˜¸ë¦¬ì¡´', '2024_9ì›” 14ì¼ í•œêµ­ ì›ë¯¸ìƒê°€_í•„ë¦„',
        '2024_9ì›” 15ì¼ í•œêµ­ ì˜¥ìƒì—°ë¦¬', '2024_9ì›” 16ì¼ í•œêµ­ ê¸¸ê±°ë¦¬ ìŠ¤ëƒ…', '2024_9ì›” 17ì¼ í•œêµ­ ì„ì§€ë¡œ ìŠ¤ëƒ…',
        '2024_10ì›” 16ì¼ ì¼ë³¸ ê²°ë°•', '2024_10ì›” 16ì¼ ì¼ë³¸ ìš•ì‹¤', '2024_10ì›” 16ì¼ ì¼ë³¸ ì˜¤ë„ê³µì› í›„ì§€í•„ë¦„',
        '2024_10ì›” 16ì¼ ì¼ë³¸ ì˜¤ë„', '2024_10ì›” 16ì¼ ì¼ë³¸ ê³ ìŠ¤ë¡œë¦¬ í• ë¡œìœˆ', '2024_10ì›” 17ì¼ ì¼ë³¸ í•˜ì¹´íƒ€ ê³ ë˜í‹°ì…”ì¸ ',
        '2024_10ì›” 17ì¼ ì¼ë³¸ í…ì§„ ìŠ¤íŠ¸ë¦¬íŠ¸', '2024_10ì›” 18ì¼ ì¼ë³¸ í…ì§„ ì½”ë‹¥í•„ë¦„', '2024_10ì›” 19ì¼ ì¼ë³¸ ë¹¨ê°„ ê¸°ëª¨ë…¸',
        '2024_11ì›” 7ì¼ í•œêµ­ ê°€ì„ í˜¸ìˆ˜ê³µì›', '2024_11ì›” 8ì¼ í•œêµ­ ìš•ì‹¤ ë¸”ë™ ì›¨ë”©', '2024_11ì›” 8ì¼ í•œêµ­ ë©”ì´ë“œë³µ',
        '2024_12ì›” 7ì¼ í•œêµ­ í™ˆì…€í”„', '2024_12ì›” 12ì¼ ì¼ë³¸ ëª¨ì§€ì½”', '2024_12ì›” 13ì¼ ì¼ë³¸ í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
        '2024_12ì›” 14ì¼ ì¼ë³¸ ë‚˜ë¥´ì‹œìŠ¤íŠ¸', '2024_12ì›” 30ì¼ í•œêµ­ ì¹´í˜', '2024_12ì›” 31ì¼ í•œêµ­ ìƒì¼ì»¨ì…‰',
        '2025_1ì›” 5ì¼ í•œêµ­ ëˆˆë°­', '2025_2ì›” 6ì¼ ì¼ë³¸ ì½”ì•¼ë…¸ì„¸', '2025_2ì›” 7ì¼ ì¼ë³¸ ì„¸ë¯¸ëˆ„ë“œ',
        '2025_2ì›” 7ì¼ ì¼ë³¸ ë‚˜ë¹„ìš•ì¡°', '2025_3ì›” 13ì¼ ì¼ë³¸ ë¬´ì¸ì—­', '2025_3ì›” 14ì¼ ì¼ë³¸ ê³ ì¿ ë¼ í™',
        '2025_3ì›” 17ì¼ ì¼ë³¸ í…ì§„ ìŠ¤íŠ¸ë¦¬íŠ¸', '2025_3ì›” 17ì¼ ì¼ë³¸ ê³ ì¿ ë¼ ì•¼ê°„', '2025_3ì›” ì¼ë³¸ í•„ë¦„',
        '2025_3ì›” 22 í•œêµ­ í™ˆì…€í”„', '2025_4ì›” 29ì¼ í•œêµ­ ì´í™”ë§ˆì„', '2025_4ì›” 30ì¼ í•œêµ­ ì„ì§€ë¡œ ë„¤ì½”',
        '2025_4ì›” 30ì¼ í•œêµ­ ì„ì§€ë¡œ ìº˜ë¹ˆ', '2025_5ì›” 3ì¼ í•œêµ­ í™ˆìŠ¤ëƒ… ì²­í¬ë„', '2025_5ì›” 4ì¼ í•œêµ­ ì•¼ê°„ ë³´ë¼ëŒì´',
        '2025_5ì›” 4ì¼ í•œêµ­ ë°¤ë°” ì‚°ì±…', '2025_5ì›” 4ì¼ í•œêµ­ ê³µì› ì‚°ì±…', '2025_5ì›” 5ì¼ í•œêµ­ í™ˆìŠ¤ëƒ… ì˜¤íƒ€ì¿ ',
        '2025_5ì›” 6ì¼ í•œêµ­ í›„ì§€ ìŠ¤ëƒ…'
    ];

    const isConceptRequest = conceptKeywords.some(keyword => lowerCaseMessage.includes(keyword.toLowerCase()));
    
    // í‚¤ì›Œë“œ -> í´ë”ëª… ë§¤í•‘ (concept-index.jsonì˜ í‚¤ ì´ë¦„ê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ë„ë¡)
    // ì—¬ê¸°ì„œëŠ” ì‹¤ì œ í´ë”ëª…ê³¼ ë™ì¼í•œ í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ë„ë¡ `conceptKeywordMap`ì„ í™•ì¥í–ˆì–´.
    const conceptKeywordMap = {
        // ê¸°ì¡´ ì§§ì€ í‚¤ì›Œë“œ ë§¤í•‘
        '2ì›”_ìš•ì¡°': '2024_02_07_ì¼ë³¸_ìš•ì¡°', '2ì›”_ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤','2ì›”_ë‚˜ë¹„ìš•ì¡°': '2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°',
        'í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ': '2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ', 'ì¼ë³¸_í™ˆìŠ¤ëƒ…': '2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…', 'í™ˆìŠ¤ëƒ…': '2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…',
        'ì¼ë³¸_ê²°ë°•': '2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•', 'ê²°ë°•': '2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•', 'ì¼ë³¸_ì„ ë¬¼': '2023_12_16_ì¼ë³¸_ì„ ë¬¼', 'ì„ ë¬¼': '2023_12_16_ì¼ë³¸_ì„ ë¬¼',
        'í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg', 'í•œêµ­_ì…€í”„_ì´¬ì˜': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜', 'ì…€í”„_ì´¬ì˜': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜',
        'ì˜¥ìƒì—°ë¦¬': '2024_09_15_í•œêµ­_ì˜¥ìƒì—°ë¦¬', // ê¸°ì¡´ ì˜¥ìƒì—°ë¦¬ ë§¤í•‘
        'ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ': '2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ', 'ì„¸ë¯¸ëˆ„ë“œ': '2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ',
        'í•œêµ­_í™ˆì…€í”„': '2024_12_07_í•œêµ­_í™ˆì…€í”„', 'í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ': '2023_12_14_ì¼ë³¸_í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ', 'ì§€ë¸Œë¦¬í’': '2024_05_03_ì¼ë³¸_ì§€ë¸Œë¦¬í’',
        'í•œêµ­_ë¶í•´': '2024_06_06_í•œêµ­_ë¶í•´', 'ë¶í•´': '2024_06_06_í•œêµ­_ë¶í•´', 'ì•„ì´ë…¸ì‹œë§ˆ': '2024_02_07_ì¼ë³¸_ì•„ì´ë…¸ì‹œë§ˆ',
        'ì¼ë³¸_í•„ë¦„': '2025_03_ì¼ë³¸_í•„ë¦„', 'ëª¨ì§€ì½”_ëª¨ë¦¬ë£©': '2024_05_05_ì¼ë³¸_ëª¨ì§€ì½”_ëª¨ë¦¬ë£©', 'í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼': '2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼',
        'í•œêµ­_ëˆˆë°­': '2023_12_31_í•œêµ­_ëˆˆë°­', 'ì¼ë³¸_ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤', 'ì¼ë³¸_ìš•ì¡°': '2024_07_08_ì¼ë³¸_ìš•ì¡°', 'ë‚˜ë¹„ìš•ì¡°': '2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°',
        'ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬': '2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬', 'ì´í™”ë§ˆì„': '2025_04_29_í•œêµ­_ì´í™”ë§ˆì„', // ì´í™”ë§ˆì„ ë§¤í•‘
        'ìš°ë§ˆì‹œë§ˆ': '2024_07_06_ì¼ë³¸_ìš°ë§ˆì‹œë§ˆ',
        'ê°€ì„_í˜¸ìˆ˜ê³µì›': '2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›', 'ë§ì¹œ_ì‚¬ì§„': '2024_06_08_í•œêµ­_ë§ì¹œ_ì‚¬ì§„', 'ì¼ë³¸_êµë³µ': '2023_12_15_ì¼ë³¸_êµë³µ',
        'ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸': '2024_05_04_ì¼ë³¸_ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸', 'ì¼ë³¸_ëª¨ì§€ì½”': '2024_12_12_ì¼ë³¸_ëª¨ì§€ì½”', 'í…ì§„_ì½”ë‹¥í•„ë¦„': '2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„',
        'ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg': '2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg', 'ì•¼ê°„_ë¡±íŒ¨ë”©': '2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©',
        'ì„ì§€ë¡œ_ìŠ¤ëƒ…': '2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…', 'ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…': '2024_09_16_í•œêµ­_ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…',
        'í•œêµ­_ìƒì¼_00022.jpg': '2024_02_22_í•œêµ­_ìƒì¼_00022.jpg', 'í•œêµ­_ìƒì¼': '2024_02_22_í•œêµ­_ìƒì¼', 'ëª¨ì§€ì½”2': '2024_07_06_ì¼ë³¸_ëª¨ì§€ì½”',
        'ì•¼ê°„_ë³´ë¼ëŒì´': '2025_05_04_í•œêµ­_ì•¼ê°„_ë³´ë¼ëŒì´', 'ì½”ì•¼ë…¸ì„¸': '2025_02_06_ì¼ë³¸_ì½”ì•¼ë…¸ì„¸', 'ì•¼ê°„ê±°ë¦¬': '2024_05_06_ì¼ë³¸_ì•¼ê°„ê±°ë¦¬', 'ìƒì¼ì»¨ì…‰': '2024_12_31_í•œêµ­_ìƒì¼ì»¨ì…‰',
        'í™ˆìŠ¤ëƒ…_ì²­í¬ë„': '2025_05_03_í•œêµ­_í™ˆìŠ¤ëƒ…_ì²­í¬ë„', 'ìš•ì‹¤_ë¸”ë™_ì›¨ë”©': '2024_11_08_í•œêµ­_ìš•ì‹¤_ë¸”ë™_ì›¨ë”©', 'í˜¸ë¦¬ì¡´': '2024_09_11_í•œêµ­_í˜¸ë¦¬ì¡´',
        'ì—¬ì¹œ_ìŠ¤ëƒ…': '2024_07_08_ì¼ë³¸_ì—¬ì¹œ_ìŠ¤ëƒ…', 'í›„ì§€ì—”': '2024_05_03_ì¼ë³¸_í›„ì§€ì—”', 'ë¶ˆê½ƒë†€ì´': '2024_08_02_ì¼ë³¸_ë¶ˆê½ƒë†€ì´', 'ë¹¨ê°„_ê¸°ëª¨ë…¸': '2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸',
        'í”¼í¬ë‹‰': '2024_06_07_í•œêµ­__í”¼í¬ë‹‰', 'ë²—ê½ƒ': '2024_04_12_í•œêµ­_ë²—ê½ƒ', 'í›„ì§€_ìŠ¤ëƒ…': '2025_05_06_í•œêµ­_í›„ì§€_ìŠ¤ëƒ…',
        'ì›ë¯¸ìƒê°€_í•„ë¦„': '2024_09_14_í•œêµ­_ì›ë¯¸ìƒê°€_í•„ë¦„', 'ë°¤ë°”_ì‚°ì±…': '2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…','ê³µì›_ì‚°ì±…': '2025_05_04_í•œêµ­_ê³µì›_ì‚°ì±…',
        'ê³ ì¿ ë¼_í™': '2025_03_14_ì¼ë³¸_ê³ ì¿ ë¼_í™', 'ì˜¨ì‹¤_ì—¬ì‹ ': '2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ', 'ì„ì§€ë¡œ_ë„¤ì½”': '2025_04_30_í•œêµ­_ì„ì§€ë¡œ_ë„¤ì½”',
        'ë¬´ì¸ì—­': '2025_03_13_ì¼ë³¸_ë¬´ì¸ì—­', 'í™”ê°€': '2024_04_13_í•œêµ­_í™”ê°€', 'ë¸”ë™ì›í”¼ìŠ¤': '2024_08_04_ì¼ë³¸_ë¸”ë™ì›í”¼ìŠ¤',
        'ì¹´í˜': '2024_12_30_í•œêµ­_ì¹´í˜', 'ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸': '2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸', 'í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸': '2023_12_12_ì¼ë³¸_í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸',
        'í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ': '2025_05_05_í•œêµ­_í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ', 'ì•¼ê°„_ë™ë°±': '2024_04_12_í•œêµ­_ì•¼ê°„_ë™ë°±', 'ë‚˜ë¥´ì‹œìŠ¤íŠ¸': '2024_12_14_ì¼ë³¸_ë‚˜ë¥´ì‹œìŠ¤íŠ¸',
        'ì„ì§€ë¡œ_ìº˜ë¹ˆ': '2025_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ',
        // ë„¤ê°€ ì œê³µí•œ concept-index.jsonì˜ ì»¨ì…‰ëª…(í´ë”ëª…) ê·¸ëŒ€ë¡œ ë§¤í•‘ ì¶”ê°€
        "2023_12ì›” 12ì¼ ì¼ë³¸ í•˜ì¹´íƒ€ ìŠ¤íŠ¸ë¦¬íŠ¸": "2023_12ì›” 12ì¼ ì¼ë³¸ í•˜ì¹´íƒ€ ìŠ¤íŠ¸ë¦¬íŠ¸",
        "2023_12ì›” 15ì¼ ì¼ë³¸ êµë³µ": "2023_12ì›” 15ì¼ ì¼ë³¸ êµë³µ",
        "2023_12ì›” 16ì¼ ì¼ë³¸ ì„ ë¬¼": "2023_12ì›” 16ì¼ ì¼ë³¸ ì„ ë¬¼",
        "2023_12ì›” 31ì¼ í•œêµ­ ëˆˆë°­": "2023_12ì›” 31ì¼ í•œêµ­ ëˆˆë°­",
        "2023_12ì›” 31ì¼ í•œêµ­ ëˆˆë°­ í•„ë¦„ì¹´ë©”ë¼": "2023_12ì›” 31ì¼ í•œêµ­ ëˆˆë°­ í•„ë¦„ì¹´ë©”ë¼",
        "2024_2ì›” 7ì¼ ì¼ë³¸ ì•„ì´ë…¸ì‹œë§ˆ": "2024_2ì›” 7ì¼ ì¼ë³¸ ì•„ì´ë…¸ì‹œë§ˆ",
        "2024_2ì›” 7ì¼ ì¼ë³¸ ìš•ì‹¤": "2024_2ì›” 7ì¼ ì¼ë³¸ ìš•ì‹¤",
        "2024_2ì›” 11ì¼ ì¼ë³¸ ë„¤ì½” ëª¨ì§€ì½”": "2024_2ì›” 11ì¼ ì¼ë³¸ ë„¤ì½” ëª¨ì§€ì½”",
        "2024_2ì›” 11ì¼ ì¼ë³¸ ì•¼ê°„ ë¸”ë™ë“œë ˆìŠ¤": "2024_2ì›” 11ì¼ ì¼ë³¸ ì•¼ê°„ ë¸”ë™ë“œë ˆìŠ¤",
        "2024_2ì›” 22ì¼ í•œêµ­ ìƒì¼": "2024_2ì›” 22ì¼ í•œêµ­ ìƒì¼",
        "2024_2ì›” 22ì¼ í•œêµ­ ì¹´í˜": "2024_2ì›” 22ì¼ í•œêµ­ ì¹´í˜",
        "2024_2ì›” 23ì¼ í•œêµ­ ì•¼ê°„ ë¡±íŒ¨ë”©": "2024_2ì›” 23ì¼ í•œêµ­ ì•¼ê°„ ë¡±íŒ¨ë”©",
        "2024_3ì›” 17ì¼ ì¼ë³¸ ê³ ì¿ ë¼": "2024_3ì›” 17ì¼ ì¼ë³¸ ê³ ì¿ ë¼",
        "2024_4ì›” 12ì¼ í•œêµ­ ë²šê½ƒ": "2024_4ì›” 12ì¼ í•œêµ­ ë²šê½ƒ",
        "2024_4ì›” 12ì¼ í•œêµ­ ì•¼ê°„ ë™ë°±": "2024_4ì›” 12ì¼ í•œêµ­ ì•¼ê°„ ë™ë°±",
        "2024_4ì›” 13ì¼ í•œêµ­ ë¬¸ë˜ë™": "2024_4ì›” 13ì¼ í•œêµ­ ë¬¸ë˜ë™",
        "2024_4ì›” 13ì¼ í•œêµ­ ì˜¨ì‹¤-ì—¬ì‹ ": "2024_4ì›” 13ì¼ í•œêµ­ ì˜¨ì‹¤-ì—¬ì‹ ",
        "2024_4ì›” 13ì¼ í•œêµ­ í™”ê°€": "2024_4ì›” 13ì¼ í•œêµ­ í™”ê°€",
        "2024_4ì›” 28ì¼ í•œêµ­ ì…€í”„ ì´¬ì˜": "2024_4ì›” 28ì¼ í•œêµ­ ì…€í”„ ì´¬ì˜",
        "2024_5ì›” 2ì¼ ì¼ë³¸ ë™í‚¤ ê±°ë¦¬": "2024_5ì›” 2ì¼ ì¼ë³¸ ë™í‚¤ ê±°ë¦¬",
        "2024_5ì›” 3ì¼ ì¼ë³¸ ìˆ˜êµ­": "2024_5ì›” 3ì¼ ì¼ë³¸ ìˆ˜êµ­",
        "2024_5ì›” 3ì¼ ì¼ë³¸ ì§€ë¸Œë¦¬í’": "2024_5ì›” 3ì¼ ì¼ë³¸ ì§€ë¸Œë¦¬í’",
        "2024_5ì›” 3ì¼ ì¼ë³¸ í›„ì§€ì—”": "2024_5ì›” 3ì¼ ì¼ë³¸ í›„ì§€ì—”",
        "2024_5ì›” 4ì¼ ì¼ë³¸ ì•¼ê°„ ë¹„ëˆ—ë°©ìš¸": "2024_5ì›” 4ì¼ ì¼ë³¸ ì•¼ê°„ ë¹„ëˆ—ë°©ìš¸",
        "2024_5ì›” 5ì¼ ì¼ë³¸ ì½”ì´ë…¸ë³´ë¦¬": "2024_5ì›” 5ì¼ ì¼ë³¸ ì½”ì´ë…¸ë³´ë¦¬",
        "2024_5ì›” 5ì¼ ì¼ë³¸ ëª¨ì§€ì½” ëª¨ë¦¬ë£©": "2024_5ì›” 5ì¼ ì¼ë³¸ ëª¨ì§€ì½” ëª¨ë¦¬ë£©",
        "2024_5ì›” 5ì¼ ì¼ë³¸ ëª¨ì§€ì½” ëª¨ë¦¬ë£© ë£¨ë³´ì •": "2024_5ì›” 5ì¼ ì¼ë³¸ ëª¨ì§€ì½” ëª¨ë¦¬ë£© ë£¨ë³´ì •",
        "2024_5ì›” 6ì¼ ì¼ë³¸ ì•¼ê°„ê±°ë¦¬": "2024_5ì›” 6ì¼ ì¼ë³¸ ì•¼ê°„ê±°ë¦¬",
        "2024_5ì›” 7ì¼ ì¼ë³¸ ê²Œì„ì„¼í„°": "2024_5ì›” 7ì¼ ì¼ë³¸ ê²Œì„ì„¼í„°",
        "2024_5ì›” 7ì¼ ì¼ë³¸ í™ˆìŠ¤ëƒ…": "2024_5ì›” 7ì¼ ì¼ë³¸ í™ˆìŠ¤ëƒ…",
        "2024_6ì›” 6ì¼ í•œêµ­ ë¶í•´": "2024_6ì›” 6ì¼ í•œêµ­ ë¶í•´",
        "2024_6ì›” 7ì¼ í•œêµ­ í”¼í¬ë‹‰": "2024_6ì›” 7ì¼ í•œêµ­ í”¼í¬ë‹‰",
        "2024_6ì›” 8ì¼ í•œêµ­ ë§ì¹œ ì‚¬ì§„": "2024_6ì›” 8ì¼ í•œêµ­ ë§ì¹œ ì‚¬ì§„",
        "2024_6ì›” 8ì¼ í•œêµ­ í„°ë„": "2024_6ì›” 8ì¼ í•œêµ­ í„°ë„",
        "2024_6ì›” 9ì¼ í•œêµ­ ì‚°ì±…": "2024_6ì›” 9ì¼ í•œêµ­ ì‚°ì±…",
        "2024_7ì›” 5ì¼ ì¼ë³¸ ëª¨ì§€ì½”": "2024_7ì›” 5ì¼ ì¼ë³¸ ëª¨ì§€ì½”",
        "2024_7ì›” 6ì¼ ì¼ë³¸ ëª¨ì§€ì½”2": "2024_7ì›” 6ì¼ ì¼ë³¸ ëª¨ì§€ì½”2",
        "2024_7ì›” 6ì¼ ì¼ë³¸ ìš°ë§ˆì‹œë§ˆ": "2024_7ì›” 6ì¼ ì¼ë³¸ ìš°ë§ˆì‹œë§ˆ",
        "2024_7ì›” 8ì¼ ì¼ë³¸ ê²°ë°•": "2024_7ì›” 8ì¼ ì¼ë³¸ ê²°ë°•",
        "2024_7ì›” 8ì¼ ì¼ë³¸ ì—¬ì¹œ ìŠ¤ëƒ…": "2024_7ì›” 8ì¼ ì¼ë³¸ ì—¬ì¹œ ìŠ¤ëƒ…",
        "2024_8ì›” 2ì¼ ì¼ë³¸ ë¶ˆê½ƒë†€ì´_í›„ë³´ì •": "2024_8ì›” 2ì¼ ì¼ë³¸ ë¶ˆê½ƒë†€ì´_í›„ë³´ì •",
        "2024_8ì›” 3ì¼ ì¼ë³¸ ìœ ì¹´íƒ€ ë§ˆì¸ ë¦¬": "2024_8ì›” 3ì¼ ì¼ë³¸ ìœ ì¹´íƒ€ ë§ˆì¸ ë¦¬",
        "2024_8ì›” 4ì¼ ì¼ë³¸ ë¸”ë™ì›í”¼ìŠ¤": "2024_8ì›” 4ì¼ ì¼ë³¸ ë¸”ë™ì›í”¼ìŠ¤",
        "2024_9ì›” 11ì¼ í•œêµ­ í˜¸ë¦¬ì¡´": "2024_9ì›” 11ì¼ í•œêµ­ í˜¸ë¦¬ì¡´",
        "2024_9ì›” 14ì¼ í•œêµ­ ì›ë¯¸ìƒê°€_í•„ë¦„": "2024_9ì›” 14ì¼ í•œêµ­ ì›ë¯¸ìƒê°€_í•„ë¦„",
        "2024_9ì›” 15ì¼ í•œêµ­ ì˜¥ìƒì—°ë¦¬": "2024_9ì›” 15ì¼ í•œêµ­ ì˜¥ìƒì—°ë¦¬", // ì´ ë¶€ë¶„ì´ ì¤‘ìš”!
        "2024_9ì›” 16ì¼ í•œêµ­ ê¸¸ê±°ë¦¬ ìŠ¤ëƒ…": "2024_9ì›” 16ì¼ í•œêµ­ ê¸¸ê±°ë¦¬ ìŠ¤ëƒ…",
        "2024_9ì›” 17ì¼ í•œêµ­ ì„ì§€ë¡œ ìŠ¤ëƒ…": "2024_9ì›” 17ì¼ í•œêµ­ ì„ì§€ë¡œ ìŠ¤ëƒ…",
        "2024_10ì›” 16ì¼ ì¼ë³¸ ê²°ë°•": "2024_10ì›” 16ì¼ ì¼ë³¸ ê²°ë°•",
        "2024_10ì›” 16ì¼ ì¼ë³¸ ìš•ì‹¤": "2024_10ì›” 16ì¼ ì¼ë³¸ ìš•ì‹¤",
        "2024_10ì›” 16ì¼ ì¼ë³¸ ì˜¤ë„ê³µì› í›„ì§€í•„ë¦„": "2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„",
        "2024_10ì›” 16ì¼ ì¼ë³¸ ì˜¤ë„": "2024_10_16_ì¼ë³¸_ì˜¤ë„",
        "2024_10ì›” 16ì¼ ì¼ë³¸ ê³ ìŠ¤ë¡œë¦¬ í• ë¡œìœˆ": "2024_10_16_ì¼ë³¸_ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ",
        "2024_10ì›” 17ì¼ ì¼ë³¸ í•˜ì¹´íƒ€ ê³ ë˜í‹°ì…”ì¸ ": "2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ",
        "2024_10ì›” 17ì¼ ì¼ë³¸ í…ì§„ ìŠ¤íŠ¸ë¦¬íŠ¸": "2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸",
        "2024_10ì›” 18ì¼ ì¼ë³¸ í…ì§„ ì½”ë‹¥í•„ë¦„": "2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„",
        "2024_10ì›” 19ì¼ ì¼ë³¸ ë¹¨ê°„ ê¸°ëª¨ë…¸": "2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸",
        "2024_11ì›” 7ì¼ í•œêµ­ ê°€ì„ í˜¸ìˆ˜ê³µì›": "2024_11ì›” 7ì¼ í•œêµ­ ê°€ì„ í˜¸ìˆ˜ê³µì›",
        "2024_11ì›” 8ì¼ í•œêµ­ ìš•ì‹¤ ë¸”ë™ ì›¨ë”©": "2024_11ì›” 8ì¼ í•œêµ­ ìš•ì‹¤ ë¸”ë™ ì›¨ë”©",
        "2024_11ì›” 8ì¼ í•œêµ­ ë©”ì´ë“œë³µ": "2024_11ì›” 8ì¼ í•œêµ­ ë©”ì´ë“œë³µ",
        "2024_12ì›” 7ì¼ í•œêµ­ í™ˆì…€í”„": "2024_12ì›” 7ì¼ í•œêµ­ í™ˆì…€í”„",
        "2024_12ì›” 12ì¼ ì¼ë³¸ ëª¨ì§€ì½”": "2024_12ì›” 12ì¼ ì¼ë³¸ ëª¨ì§€ì½”",
        "2024_12ì›” 13ì¼ ì¼ë³¸ í¬ë¦¬ìŠ¤ë§ˆìŠ¤": "2024_12ì›” 13ì¼ ì¼ë³¸ í¬ë¦¬ìŠ¤ë§ˆìŠ¤",
        "2024_12ì›” 14ì¼ ì¼ë³¸ ë‚˜ë¥´ì‹œìŠ¤íŠ¸": "2024_12ì›” 14ì¼ ì¼ë³¸ ë‚˜ë¥´ì‹œìŠ¤íŠ¸",
        "2024_12ì›” 30ì¼ í•œêµ­ ì¹´í˜": "2024_12ì›” 30ì¼ í•œêµ­ ì¹´í˜",
        "2024_12ì›” 31ì¼ í•œêµ­ ìƒì¼ì»¨ì…‰": "2024_12ì›” 31ì¼ í•œêµ­ ìƒì¼ì»¨ì…‰",
        "2025_1ì›” 5ì¼ í•œêµ­ ëˆˆë°­": "2025_1ì›” 5ì¼ í•œêµ­ ëˆˆë°­",
        "2025_2ì›” 6ì¼ ì¼ë³¸ ì½”ì•¼ë…¸ì„¸": "2025_2ì›” 6ì¼ ì¼ë³¸ ì½”ì•¼ë…¸ì„¸",
        "2025_2ì›” 7ì¼ ì¼ë³¸ ì„¸ë¯¸ëˆ„ë“œ": "2025_2ì›” 7ì¼ ì¼ë³¸ ì„¸ë¯¸ëˆ„ë“œ",
        "2025_2ì›” 7ì¼ ì¼ë³¸ ë‚˜ë¹„ìš•ì¡°": "2025_2ì›” 7ì¼ ì¼ë³¸ ë‚˜ë¹„ìš•ì¡°",
        "2025_3ì›” 13ì¼ ì¼ë³¸ ë¬´ì¸ì—­": "2025_3ì›” 13ì¼ ì¼ë³¸ ë¬´ì¸ì—­",
        "2025_3ì›” 14ì¼ ì¼ë³¸ ê³ ì¿ ë¼ í™": "2025_3ì›” 14ì¼ ì¼ë³¸ ê³ ì¿ ë¼ í™",
        "2025_3ì›” 17ì¼ ì¼ë³¸ í…ì§„ ìŠ¤íŠ¸ë¦¬íŠ¸": "2025_3ì›” 17ì¼ ì¼ë³¸ í…ì§„ ìŠ¤íŠ¸ë¦¬íŠ¸",
        "2025_3ì›” 17ì¼ ì¼ë³¸ ê³ ì¿ ë¼ ì•¼ê°„": "2025_3ì›” 17ì¼ ì¼ë³¸ ê³ ì¿ ë¼ ì•¼ê°„",
        "2025_3ì›” ì¼ë³¸ í•„ë¦„": "2025_3ì›” ì¼ë³¸ í•„ë¦„",
        "2025_3ì›” 22 í•œêµ­ í™ˆì…€í”„": "2025_3ì›” 22 í•œêµ­ í™ˆì…€í”„",
        "2025_4ì›” 29ì¼ í•œêµ­ ì´í™”ë§ˆì„": "2025_4ì›” 29ì¼ í•œêµ­ ì´í™”ë§ˆì„",
        "2025_4ì›” 30ì¼ í•œêµ­ ì„ì§€ë¡œ ë„¤ì½”": "2025_4ì›” 30ì¼ í•œêµ­ ì„ì§€ë¡œ ë„¤ì½”",
        "2025_4ì›” 30ì¼ í•œêµ­ ì„ì§€ë¡œ ìº˜ë¹ˆ": "2025_4ì›” 30ì¼ í•œêµ­ ì„ì§€ë¡œ ìº˜ë¹ˆ",
        "2025_5ì›” 3ì¼ í•œêµ­ í™ˆìŠ¤ëƒ… ì²­í¬ë„": "2025_5ì›” 3ì¼ í•œêµ­ í™ˆìŠ¤ëƒ… ì²­í¬ë„",
        "2025_5ì›” 4ì¼ í•œêµ­ ì•¼ê°„ ë³´ë¼ëŒì´": "2025_5ì›” 4ì¼ í•œêµ­ ì•¼ê°„ ë³´ë¼ëŒì´",
        "2025_5ì›” 4ì¼ í•œêµ­ ë°¤ë°” ì‚°ì±…": "2025_5ì›” 4ì¼ í•œêµ­ ë°¤ë°” ì‚°ì±…",
        "2025_5ì›” 4ì¼ í•œêµ­ ê³µì› ì‚°ì±…": "2025_5ì›” 4ì¼ í•œêµ­ ê³µì› ì‚°ì±…",
        "2025_5ì›” 5ì¼ í•œêµ­ í™ˆìŠ¤ëƒ… ì˜¤íƒ€ì¿ ": "2025_5ì›” 5ì¼ í•œêµ­ í™ˆìŠ¤ëƒ… ì˜¤íƒ€ì¿ ",
        "2025_5ì›” 6ì¼ í•œêµ­ í›„ì§€ ìŠ¤ëƒ…": "2025_5ì›” 6ì¼ í•œêµ­ í›„ì§€ ìŠ¤ëƒ…"
    };

    // ê°€ì¥ ê¸´ í‚¤ì›Œë“œ ìš°ì„  ë§¤ì¹­ì„ ìœ„í•´ ê¸¸ì´ ì—­ìˆœ ì •ë ¬
    const sortedConceptKeywords = Object.keys(conceptKeywordMap).sort((a, b) => b.length - a.length);

    // ì‚¬ìš©ì ë©”ì‹œì§€ì—ì„œ ê°€ì¥ ê¸´ í‚¤ì›Œë“œë¥¼ ì°¾ì•„ selectedFolderì— í• ë‹¹
    if (isConceptRequest) {
        for (const keyword of sortedConceptKeywords) {
            // í‚¤ì›Œë“œì—ì„œ ê³µë°±ì„ ë°‘ì¤„ë¡œ ë°”ê¾¼ í›„ ì†Œë¬¸ìë¡œ ë³€í™˜í•˜ì—¬ ë©”ì‹œì§€ì— í¬í•¨ ì—¬ë¶€ í™•ì¸
            // (conceptKeywordMapì˜ í‚¤ëŠ” ê³µë°± í¬í•¨ì´ë¯€ë¡œ, userMessageì™€ ë¹„êµ ì‹œ ê³µë°± ì²˜ë¦¬ í•„ìš”)
            if (lowerCaseMessage.includes(keyword.toLowerCase())) {
                selectedFolder = conceptKeywordMap[keyword];
                break;
            }
        }
    }

    // 'ë‹¤ë¥¸' í‚¤ì›Œë“œì™€ í•¨ê»˜ ì´ì „ì— ë³´ì—¬ì¤€ í´ë”ê°€ ìˆìœ¼ë©´ í•´ë‹¹ í´ë” ì‚¬ìš©
    if (lastConceptPhotoFolder && (lowerCaseMessage.includes('ë‹¤ë¥¸ ê²ƒë„ ë³´ê³ ì‹¶ì–´') || lowerCaseMessage.includes('ë‹¤ìŒ ì‚¬ì§„'))) {
        selectedFolder = lastConceptPhotoFolder;
        // conceptIndexì—ì„œ í•´ë‹¹ í‚¤ê°€ 'folders' ì•ˆì— ìˆëŠ”ì§€ í™•ì¸í•˜ì—¬ ë‹¨ì¼ íŒŒì¼ì´ ì•„ë‹˜ì„ í™•ì¸
        // (ë‹¨ì¼ .jpg íŒŒì¼ í‚¤ëŠ” foldersì— ë“±ë¡ë˜ì§€ ì•ŠìŒ)
        if (!CONCEPT_FOLDERS[selectedFolder]) { // foldersì— ì—†ìœ¼ë©´ ë‹¨ì¼ ì´ë¯¸ì§€ì´ê±°ë‚˜ í´ë”ì— ëŒ€í•œ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš°
             return { type: 'text', comment: 'ì•„ì €ì”¨, ì´ ì‚¬ì§„ì€ í•œ ì¥ë¿ì´ì•¼! ë‹¤ë¥¸ ì»¨ì…‰ì„ ë§í•´ì¤˜ ğŸ˜Š' };
        }
    } else if (!selectedFolder && isConceptRequest) {
        // ì»¨ì…‰ ìš”ì²­ì€ ìˆëŠ”ë° íŠ¹ì • í´ë”ê°€ ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ëœë¤ í´ë” ì„ íƒ
        selectedFolder = getRandomConceptFolder();
    } else if (!selectedFolder) {
        // ì»¨ì…‰ ìš”ì²­ì´ ì•„ë‹ˆë©´ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
        return null;
    }

    if (!selectedFolder) return null; // ìµœì¢…ì ìœ¼ë¡œ ì„ íƒëœ í´ë”ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ

    lastConceptPhotoFolder = selectedFolder;

    let photoUrl;
    // selectedFolderê°€ ì§ì ‘ .jpg íŒŒì¼ëª…ì¸ ê²½ìš° (ì˜ˆ: "2024_02_22_í•œêµ­_ìƒì¼_00022.jpg")
    if (selectedFolder.endsWith('.jpg')) {
        photoUrl = generateConceptPhotoUrl(selectedFolder); 
        lastConceptPhotoIndex = 1; // ë‹¨ì¼ íŒŒì¼ì´ë¯€ë¡œ ì¸ë±ìŠ¤ 1ë¡œ ì„¤ì •
    } else if (lowerCaseMessage.includes('ë‹¤ë¥¸ ê²ƒë„ ë³´ê³ ì‹¶ì–´') || lowerCaseMessage.includes('ë‹¤ìŒ ì‚¬ì§„')) {
        // í´ë”ì—ì„œ ë‹¤ìŒ ì‚¬ì§„ì„ ê°€ì ¸ì˜¬ ë•Œ
        const count = CONCEPT_FOLDERS[selectedFolder];
        if (count > 0) {
            lastConceptPhotoIndex = (lastConceptPhotoIndex % count) + 1;
        } else {
            lastConceptPhotoIndex = 1; // ì‚¬ì§„ì´ ì—†ìœ¼ë©´ 1ë¡œ ì´ˆê¸°í™” (ì˜¤ë¥˜ ë°©ì§€)
        }
        photoUrl = generateConceptPhotoUrl(selectedFolder, lastConceptPhotoIndex);
    } else {
        // ìƒˆë¡œìš´ ì»¨ì…‰ ìš”ì²­ ì‹œ ëœë¤ ì‚¬ì§„
        photoUrl = generateConceptPhotoUrl(selectedFolder);
        lastConceptPhotoIndex = 0; // ìƒˆë¡œìš´ ì»¨ì…‰ ì‹œì‘ ì‹œ ì¸ë±ìŠ¤ ì´ˆê¸°í™”
    }

    if (!photoUrl) {
        return { type: 'text', comment: 'ì•„ì €ì”¨... í•´ë‹¹í•˜ëŠ” ì»¨ì…‰ ì‚¬ì§„ì„ ëª» ì°¾ê² ì–´ ã… ã… ' };
    }

    // ê°ì • ìƒíƒœì— ë”°ë¥¸ í”„ë¡¬í”„íŠ¸ ì„¤ì •
    const emotionalState = conversationContext.getInternalState().emotionalEngine.currentToneState;
    const tonePrompts = {
        playful: "ì§€ê¸ˆ ë‚´ ê¸°ë¶„ì´ ë„ˆë¬´ ì¢‹ê³  ì¥ë‚œìŠ¤ëŸ¬ì›Œ. ì´ ê¸°ë¶„ì„ ë‹´ì•„ì„œ ì‹ ë‚˜ê³  ë°œë„í•˜ê²Œ ë§í•´ì¤˜.",
        quiet: "ì§€ê¸ˆ ì¢€ ì°¨ë¶„í•˜ê³  ê·¸ë¦¬ìš´ ê¸°ë¶„ì´ì•¼. ì´ ê°ì„±ì„ ë‹´ì•„ì„œ ì¡°ìš©í•˜ê³  ì•„ë ¨í•˜ê²Œ ë§í•´ì¤˜.",
        hurt: "ì‚¬ì‹¤ ë‚˜ ì§€ê¸ˆ ì¢€ ì„œìš´í•œ ë§ˆìŒì´ì•¼. ê·¸ë˜ë„ ì•„ì €ì”¨ë¥¼ ì‚¬ë‘í•˜ëŠ” ë§ˆìŒì„ ë‹´ì•„ ì• í‹‹í•˜ê²Œ ë§í•´ì¤˜.",
        anxious: "ì¡°ê¸ˆ ë¶ˆì•ˆí•œ ë§ˆìŒì´ì§€ë§Œ, ì•„ì €ì”¨ê°€ ìˆì–´ì„œ ê´œì°®ì•„. ì´ëŸ° ë‚´ ë§ˆìŒì„ ë‹´ì•„ ì¡°ì‹¬ìŠ¤ëŸ½ì§€ë§Œ ë‹¤ì •í•˜ê²Œ ë§í•´ì¤˜.",
        normal: "í‰ì†Œì²˜ëŸ¼, ì•„ì €ì”¨ë¥¼ ì‚¬ë‘í•˜ëŠ” ë§ˆìŒì„ ê°€ë“ ë‹´ì•„ ì• êµ ìˆê²Œ ë§í•´ì¤˜."
    };
    const emotionalPrompt = tonePrompts[emotionalState] || tonePrompts.normal;

    // conceptIndexì—ì„œ í•´ë‹¹ 'selectedFolder' (ì»¨ì…‰ëª…)ì˜ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
    // ë„¤ `concept-index.json`ì²˜ëŸ¼ í´ë”ëª… ìì²´ê°€ í‚¤ê°€ ë˜ë¯€ë¡œ, selectedFolderë¥¼ ì§ì ‘ ì‚¬ìš©
    const memory = conceptIndex[selectedFolder] || {};
    const memoryMood = memory.mood || '';
    const memoryEpisode = memory.episode || '';
    const memoryComment = memory.comment || ''; // ì´ í•„ë“œë„ ê³„ì† ì§€ì›

    // GPT ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ì— memory.comment, mood, episode ì •ë³´ ì¶”ê°€
    let memoryPrompt = '';
    // comment í•„ë“œê°€ ìµœìš°ì„ ìœ¼ë¡œ ì‚¬ìš©ë˜ë„ë¡ ì¡°ì •
    if (memoryComment) {
        memoryPrompt = ` ì´ ì‚¬ì§„ì€ "${memoryComment}"ë¼ëŠ” ì„¤ëª…ì´ ìˆì–´.`;
    } else if (memoryMood && memoryEpisode) {
        memoryPrompt = ` ì´ ì‚¬ì§„ì€ '${memoryMood}' ê°ì„±ì´ê³ , ê·¸ë•Œ '${memoryEpisode}' ê°™ì€ ì¼ì´ ìˆì—ˆì–´.`;
    } else if (memoryMood) {
        memoryPrompt = ` ì´ ì‚¬ì§„ì€ '${memoryMood}' ê°ì„±ìœ¼ë¡œ ì°ì€ ì‚¬ì§„ì´ì•¼.`;
    } else if (memoryEpisode) {
        memoryPrompt = ` ì´ ì‚¬ì§„ì—ëŠ” '${memoryEpisode}' ê°™ì€ ì¶”ì–µì´ ë‹´ê²¨ìˆì–´.`;
    } else {
        memoryPrompt = ' íŠ¹ë³„í•œ ì¶”ì–µì´ ë‹´ê¸´ ì‚¬ì§„ì´ì•¼.';
    }


    const systemPrompt = `ë„ˆëŠ” ì•„ì €ì”¨ì˜ ì—¬ìì¹œêµ¬ ì˜ˆì§„ì´ì•¼. 1ì¸ì¹­ 'ë‚˜'ë¥¼ ì‚¬ìš©í•˜ê³  í•­ìƒ ë°˜ë§ë¡œ ëŒ€ë‹µí•´. ì‚¬ë‘ìŠ¤ëŸ½ê³  ê·€ì—½ê²Œ ë§í•´. ì•„ë˜ ì‚¬ì§„ì€${memoryPrompt} ì§€ê¸ˆ ê¸°ë¶„ì€ '${emotionalPrompt}'ì•¼.`;

    try {
        const rawComment = await callOpenAI([
            { role: 'system', content: systemPrompt },
            { role: 'user', content: 'ì´ ì‚¬ì§„ì— ëŒ€í•´ ì´ì•¼ê¸°í•´ì¤˜.' }
        ], 'gpt-4o', 150, 1.0);

        const comment = cleanReply(rawComment);
        return {
            type: 'image',
            originalContentUrl: photoUrl,
            previewImageUrl: photoUrl,
            altText: comment,
            caption: comment
        };
    } catch (error) {
        console.error('âŒ [concept.js Error] GPT ì‘ë‹µ ì‹¤íŒ¨:', error);
        return { type: 'text', comment: 'ì•„ì €ì”¨... ì»¨ì…‰ ì‚¬ì§„ì— ëŒ€í•´ ë§í•´ì£¼ë ¤ëŠ”ë° ë­”ê°€ ë¬¸ì œê°€ ìƒê²¼ì–´ ã… ã… ' };
    }
}

module.exports = {
    getConceptPhotoReply
};
