// memory/concept.js v1.21 (URL ì¸ì½”ë”© ë° ê²€ì¦ ê¸°ëŠ¥ ì¶”ê°€)

// ğŸ“¦ í•„ìˆ˜ ëª¨ë“ˆ ë¶ˆëŸ¬ì˜¤ê¸°
const moment = require('moment-timezone');
const path = require('path');
const axios = require('axios');

// ì»¨ì…‰ ì‚¬ì§„ì´ ì €ì¥ëœ ì›¹ ì„œë²„ì˜ ê¸°ë³¸ URL (HTTPS í•„ìˆ˜)
const BASE_CONCEPT_URL = 'https://photo.de-ji.net/photo/concept/';

// ì•„ì €ì”¨ê°€ ì œê³µí•´ì£¼ì‹  ì»¨ì…‰ ì‚¬ì§„ í´ë”ë³„ ì‚¬ì§„ ê°œìˆ˜ ë°ì´í„°
const CONCEPT_FOLDERS = {
    "2023_12_12_ì¼ë³¸_í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸": 29,
    "2023_12_13_ì¼ë³¸_ëª¨ì§€ì½”": 42,
    "2023_12_14_ì¼ë³¸_í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ": 75,
    "2023_12_15_ì¼ë³¸_êµë³µ": 51,
    "2023_12_16_ì¼ë³¸_ì„ ë¬¼": 113,
    "2023_12_31_í•œêµ­_ëˆˆë°­": 38,
    "2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼": 43,
    "2024_02_07_ì¼ë³¸_ì•„ì´ë…¸ì‹œë§ˆ": 65,
    "2024_02_07_ì¼ë³¸_ìš•ì‹¤": 61,
    "2024_02_11_ì¼ë³¸_ë„¤ì½”_ëª¨ì§€ì½”": 21,
    "2024_02_11_ì¼ë³¸_ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤": 31,
    "2024_02_22_í•œêµ­_ìƒì¼": 45,
    "2024_02_22_í•œêµ­_ìƒì¼_00022.jpg": 1,
    "2024_02_22_í•œêµ­_ì¹´í˜": 19,
    "2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©": 47,
    "2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg": 1,
    "2024_03_17_ì¼ë³¸_ê³ ì¿ ë¼": 19,
    "2024_04_12_í•œêµ­_ë²—ê½ƒ": 35,
    "2024_04_12_í•œêµ­_ì•¼ê°„_ë™ë°±": 26,
    "2024_04_13_í•œêµ­_ë¬¸ë˜ë™": 16,
    "2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ": 31,
    "2024_04_13_í•œêµ­_í™”ê°€": 30,
    "2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜": 111,
    "2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg": 1,
    "2024_05_02_ì¼ë³¸_ë™í‚¤_ê±°ë¦¬": 18,
    "2024_05_03_ì¼ë³¸_ìˆ˜êµ­": 14,
    "2024_05_03_ì¼ë³¸_ì§€ë¸Œë¦¬í’": 74,
    "2024_05_03_ì¼ë³¸_í›„ì§€ì—”": 40,
    "2024_05_04_ì¼ë³¸_ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸": 49,
    "2024_05_05_ì¼ë³¸_ëª¨ì§€ì½”_ëª¨ë¦¬ë£©": 64,
    "2024_05_05_ì¼ë³¸_ì½”ì´ë…¸ë³´ë¦¬": 17,
    "2024_05_06_ì¼ë³¸_ì•¼ê°„ê±°ë¦¬": 43,
    "2024_05_07_ì¼ë³¸_ê²Œì„ì„¼í„°": 19,
    "2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…": 323,
    "2024_06_06_í•œêµ­_ë¶í•´": 65,
    "2024_06_07_í•œêµ­__í”¼í¬ë‹‰": 36,
    "2024_06_08_í•œêµ­__í„°ë„": 28,
    "2024_06_08_í•œêµ­_ë§ì¹œ_ì‚¬ì§„": 52,
    "2024_06_09_í•œêµ­_ì‚°ì±…": 23,
    "2024_06_09_í•œêµ­_ì‚°ì±…_0000009.jpg": 1,
    "2024_06_09_í•œêµ­_ì‚°ì±…_0000109.jpg": 1,
    "2024_07_05_ì¼ë³¸_ëª¨ì§€ì½”": 26,
    "2024_07_06_ì¼ë³¸_ëª¨ì§€ì½”": 45,
    "2024_07_06_ì¼ë³¸_ìš°ë§ˆì‹œë§ˆ": 53,
    "2024_07_08_ì¼ë³¸_ì—¬ì¹œ_ìŠ¤ëƒ…": 41,
    "2024_07_08_ì¼ë³¸_ìš•ì¡°": 53,
    "2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•": 223,
    "2024_08_02_ì¼ë³¸_ë¶ˆê½ƒë†€ì´": 39,
    "2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬": 56,
    "2024_08_04_ì¼ë³¸_ë¸”ë™ì›í”¼ìŠ¤": 29,
    "2024_09_11_í•œêµ­_í˜¸ë¦¬ì¡´": 41,
    "2024_09_14_í•œêµ­_ì›ë¯¸ìƒê°€_í•„ë¦„": 34,
    "2024_09_15_í•œêµ­_ì˜¥ìƒì—°ë¦¬": 98,
    "2024_09_16_í•œêµ­_ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…": 46,
    "2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…": 46,
    "2024_10_16_ì¼ë³¸_ê²°ë°•": 137,
    "2024_10_16_ì¼ë³¸_ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ": 20,
    "2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›": 5,
    "2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„": 24,
    "2024_10_16_ì¼ë³¸_ìš•ì‹¤": 15,
    "2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸": 29,
    "2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ": 59,
    "2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„": 49,
    "2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸": 39,
    "2024_11_08_í•œêµ­_ë©”ì´ë“œë³µ": 14,
    "2024_11_08_í•œêµ­_ìš•ì‹¤_ë¸”ë™_ì›¨ë”©": 42,
    "2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›": 53,
    "2024_12_07_í•œêµ­_í™ˆì…€í”„": 81,
    "2024_12_12_ì¼ë³¸_ëª¨ì§€ì½”": 49,
    "2024_12_13_ì¼ë³¸_í¬ë¦¬ìŠ¤ë§ˆìŠ¤": 22,
    "2024_12_14_ì¼ë³¸_ë‚˜ë¥´ì‹œìŠ¤íŠ¸": 26,
    "2024_12_30_í•œêµ­_ì¹´í˜": 29,
    "2024_12_31_í•œêµ­_ìƒì¼ì»¨ì…‰": 43,
    "2025_01_05_í•œêµ­": 63,
    "2025_02_06_ì¼ë³¸_ì½”ì•¼ë…¸ì„¸": 43,
    "2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°": 48,
    "2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ": 92,
    "2025_03_13_ì¼ë³¸_ë¬´ì¸ì—­": 30,
    "2025_03_14_ì¼ë³¸_ê³ ì¿ ë¼": 32,
    "2025_03_17_ì¼ë³¸_ê³ ì¿ ë¼": 17,
    "2025_03_17_ì¼ë³¸_í…ì§„": 28,
    "2025_03_22": 27,
    "2025_03_ì¼ë³¸_í•„ë¦„": 64,
    "2025_04_29_í•œêµ­_ì´í™”ë§ˆì„": 55,
    "2025_04_30_í•œêµ­_ì„ì§€ë¡œ": 30,
    "2025_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ": 25,
    "2025_05_03_í•œêµ­_í™ˆìŠ¤ëƒ…_ì²­í¬ë„": 42,
    "2025_05_04_í•œêµ­": 43,
    "2025_05_04_í•œêµ­_ê³µì›_ì‚°ì±…": 32,
    "2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…": 32,
    "2025_05_05_í•œêµ­_í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ": 27,
    "2025_05_06_ë§ˆì§€ë§‰_í•œêµ­_í›„ì§€ìŠ¤ëƒ…": 34
};

/**
 * URLì´ ìœ íš¨í•œì§€ ê²€ì¦í•˜ëŠ” í•¨ìˆ˜
 */
async function validateImageUrl(url) {
    try {
        console.log(`[validateImageUrl] ê²€ì¦ ì‹œì‘: ${url}`);
        const response = await axios.head(url, { 
            timeout: 10000,
            headers: {
                'User-Agent': 'LINE-Bot-SDK/7.7.0'
            },
            maxRedirects: 3
        });
        
        // LINE ì´ë¯¸ì§€ ìš”êµ¬ì‚¬í•­ ê²€ì¦
        const contentType = response.headers['content-type'];
        const contentLength = parseInt(response.headers['content-length'] || '0');
        
        console.log(`[validateImageUrl] Content-Type: ${contentType}, Size: ${contentLength} bytes`);
        
        // JPEG/PNG í˜•ì‹ì´ê³  10MB ì´í•˜ì—¬ì•¼ í•¨
        if (!contentType || (!contentType.includes('image/jpeg') && !contentType.includes('image/png'))) {
            console.warn(`[validateImageUrl] ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹: ${contentType}`);
            return false;
        }
        
        if (contentLength > 10 * 1024 * 1024) { // 10MB ì œí•œ
            console.warn(`[validateImageUrl] ì´ë¯¸ì§€ í¬ê¸° ì´ˆê³¼: ${contentLength} bytes`);
            return false;
        }
        
        console.log(`[validateImageUrl] ê²€ì¦ ì„±ê³µ`);
        return true;
    } catch (error) {
        console.error(`[validateImageUrl] URL ê²€ì¦ ì‹¤íŒ¨: ${url}`, error.message);
        return false;
    }
}

/**
 * URL ì¸ì½”ë”©ì„ ì ìš©í•˜ëŠ” í•¨ìˆ˜
 */
function encodeImageUrl(url) {
    try {
        // URLì„ íŒŒì‹±í•˜ì—¬ path ë¶€ë¶„ë§Œ ì¸ì½”ë”©
        const urlObj = new URL(url);
        const pathParts = urlObj.pathname.split('/');
        const encodedParts = pathParts.map(part => {
            // ë¹ˆ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¸ì½”ë”©
            return part ? encodeURIComponent(part) : part;
        });
        urlObj.pathname = encodedParts.join('/');
        
        const encodedUrl = urlObj.toString();
        console.log(`[encodeImageUrl] ì›ë³¸: ${url}`);
        console.log(`[encodeImageUrl] ì¸ì½”ë”©: ${encodedUrl}`);
        
        return encodedUrl;
    } catch (error) {
        console.error(`[encodeImageUrl] URL ì¸ì½”ë”© ì‹¤íŒ¨: ${url}`, error);
        return url; // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
    }
}

/**
 * íŠ¹ì • ì»¨ì…‰ í´ë”ì—ì„œ ëœë¤ ë˜ëŠ” ë‹¤ìŒ ì‚¬ì§„ URLì„ ìƒì„±í•©ë‹ˆë‹¤.
 * @param {string} folderName - ì‚¬ì§„ì´ ë“¤ì–´ìˆëŠ” í´ë” ì´ë¦„ (ì´ì œ íŒŒì¼ ì´ë¦„ì˜ ì ‘ë‘ì‚¬ ì—­í• )
 * @param {number} [targetIndex=null] - íŠ¹ì • ì¸ë±ìŠ¤ì˜ ì‚¬ì§„ì„ ê°€ì ¸ì˜¬ ê²½ìš° (1ë¶€í„° ì‹œì‘)
 * @returns {string|null} ì‚¬ì§„ URL ë˜ëŠ” null
 */
function generateConceptPhotoUrl(folderName, targetIndex = null) {
    console.log(`[concept:generateConceptPhotoUrl] í´ë”ëª… (íŒŒì¼ì ‘ë‘ì‚¬): "${folderName}"`); 
    const photoCount = CONCEPT_FOLDERS[folderName];
    console.log(`[concept:generateConceptPhotoUrl] ì‚¬ì§„ ê°œìˆ˜: ${photoCount}`);
    
    // ë‹¨ì¼ íŒŒì¼ëª…ìœ¼ë¡œ ë“±ë¡ëœ ê²½ìš° ë°”ë¡œ í•´ë‹¹ íŒŒì¼ëª…ì„ ì‚¬ìš©
    if (folderName.endsWith('.jpg')) {
        const rawUrl = `${BASE_CONCEPT_URL}${folderName}`;
        const encodedUrl = encodeImageUrl(rawUrl);
        console.log(`[concept:generateConceptPhotoUrl] ë‹¨ì¼ íŒŒì¼ URL: ${encodedUrl}`);
        return encodedUrl;
    }

    if (photoCount === undefined || photoCount <= 0) {
        console.warn(`[concept.js] í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤: ${folderName}`);
        return null;
    }
    
    let indexToUse;
    if (targetIndex !== null && targetIndex >= 1 && targetIndex <= photoCount) {
        indexToUse = targetIndex;
    } else {
        indexToUse = Math.floor(Math.random() * photoCount) + 1;
    }
    console.log(`[concept:generateConceptPhotoUrl] ì‚¬ìš©í•  ì¸ë±ìŠ¤: ${indexToUse}`);

    // íŒŒì¼ëª… í˜•ì‹: "ë‚ ì§œ_ì¥ì†Œ_ì»¨ì…‰_000001.jpg"
    const fileName = `${folderName}_${String(indexToUse).padStart(6, '0')}.jpg`; 
    console.log(`[concept:generateConceptPhotoUrl] íŒŒì¼ëª…: ${fileName}`);
    
    // ìµœì¢… URLì€ BASE_CONCEPT_URL ë°”ë¡œ ì•„ë˜ íŒŒì¼ëª…ìœ¼ë¡œ êµ¬ì„±í•˜ê³  ì¸ì½”ë”© ì ìš©
    const rawUrl = `${BASE_CONCEPT_URL}${fileName}`;
    const encodedUrl = encodeImageUrl(rawUrl);
    console.log(`[concept:generateConceptPhotoUrl] ìµœì¢… ìƒì„± URL: ${encodedUrl}`);
    return encodedUrl;
}

// ë§ˆì§€ë§‰ìœ¼ë¡œ ë³´ì—¬ì¤€ ì»¨ì…‰ ì‚¬ì§„ í´ë”ë¥¼ ì €ì¥í•˜ì—¬ 'ë‹¤ë¥¸ ê²ƒë„' ìš”ì²­ ì‹œ í™œìš©
let lastConceptPhotoFolder = null;
let lastConceptPhotoIndex = 0;

/**
 * ì‚¬ìš©ì ë©”ì‹œì§€ì— ë”°ë¼ ì»¨ì…‰ ì‚¬ì§„ì„ ì„ íƒí•˜ê³ , AIê°€ ê°ì •/ì½”ë©˜íŠ¸ë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
 * @param {string} userMessage - ì‚¬ìš©ìì˜ ì›ë³¸ ë©”ì‹œì§€
 * @param {Function} saveLogFunc - ë¡œê·¸ ì €ì¥ì„ ìœ„í•œ saveLog í•¨ìˆ˜
 * @param {Function} callOpenAIFunc - OpenAI í˜¸ì¶œ í•¨ìˆ˜
 * @param {Function} cleanReplyFunc - ì‘ë‹µ ì •ë¦¬ í•¨ìˆ˜
 * @returns {Promise<{type: string, url?: string, caption?: string, comment?: string}|null>} ì‚¬ì§„ URLê³¼ ì½”ë©˜íŠ¸ ê°ì²´ ë˜ëŠ” null
 */
async function getConceptPhotoReply(userMessage, saveLogFunc, callOpenAIFunc, cleanReplyFunc) {
    console.log(`[concept:getConceptPhotoReply] ë©”ì‹œì§€ ìˆ˜ì‹ : "${userMessage}"`);
    const lowerCaseMessage = userMessage.toLowerCase();
    let selectedFolder = null;
    let folderDescription = '';
    let additionalPromptForYejinText = '';
    
    const conceptKeywords = ['ì»¨ì…‰ì‚¬ì§„', 'ì»¨ì…‰ ì‚¬ì§„', 'ìš•ì‹¤', 'ìš•ì¡°', 'ë‚˜ë¹„ìš•ì¡°', 'ì„¸ë¯¸ëˆ„ë“œ', 'ê²°ë°•', 'êµë³µ', 'í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ', 'í™ˆìŠ¤ëƒ…', 'ì§€ë¸Œë¦¬í’', 'ëª¨ì§€ì½”', 'í•˜ì¹´íƒ€', 'í…ì§„', 'ì•„ì´ë…¸ì‹œë§ˆ', 'í›„ì§€ì—”', 'ìœ ì¹´íƒ€', 'ë¶ˆê½ƒë†€ì´', 'ë©”ì´ë“œë³µ', 'ê³ ìŠ¤ë¡œë¦¬', 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', 'ìƒì¼ì»¨ì…‰', 'ì˜¥ìƒì—°ë¦¬', 'ì„ì§€ë¡œ', 'ì´í™”ë§ˆì„', 'ì½”ì•¼ë…¸ì„¸', 'ë¬´ì¸ì—­', 'ê³ ì¿ ë¼', 'ë²—ê½ƒ', 'ë™ë°±', 'ì˜¨ì‹¤', 'í™”ê°€', 'ë¬¸ë˜ë™', 'ë¶í•´', 'í”¼í¬ë‹‰', 'ì‚°ì±…', 'í„°ë„', 'ë§ì¹œ ì‚¬ì§„', 'ìš°ë§ˆì‹œë§ˆ', 'ë¹„ëˆ—ë°©ìš¸', 'ì•¼ê°„ê±°ë¦¬', 'ê²Œì„ì„¼í„°', 'ë™í‚¤ ê±°ë¦¬', 'ìˆ˜êµ­', 'ì½”ì´ë…¸ë³´ë¦¬', 'ë¸”ë™ì›í”¼ìŠ¤', 'í˜¸ë¦¬ì¡´', 'ì›ë¯¸ìƒê°€', 'ê¸¸ê±°ë¦¬ ìŠ¤ëƒ…', 'ì˜¤ë„', 'ë‚˜ë¥´ì‹œìŠ¤íŠ¸', 'ëˆˆë°­', 'í•„ë¦„ì¹´ë©”ë¼', 'ì²­í¬ë„', 'ë³´ë¼ëŒì´', 'ë°¤ë°”', 'ê³µì›', 'ì˜¤íƒ€ì¿ ', 'í™', 'ìº˜ë¹ˆ', 'ë„¤ì½”'];
    
    const isConceptRequest = conceptKeywords.some(keyword => lowerCaseMessage.includes(keyword));
    
    if (!isConceptRequest) {
        console.log(`[concept:getConceptPhotoReply] ì»¨ì…‰ì‚¬ì§„ ê´€ë ¨ í‚¤ì›Œë“œ ì—†ìŒ. null ë°˜í™˜.`);
        return null;
    }

    // í‚¤ì›Œë“œ ë§µ (ê¸¸ì´ì— ë”°ë¼ ì •ë ¬í•˜ì—¬ ë” êµ¬ì²´ì ì¸ í‚¤ì›Œë“œê°€ ë¨¼ì € ë§¤ì¹­ë˜ë„ë¡)
    const conceptKeywordMap = {
        '2ì›”_ìš•ì¡°': '2024_02_07_ì¼ë³¸_ìš•ì¡°', 
        '2ì›”_ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        '2ì›”_ë‚˜ë¹„ìš•ì¡°': '2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°',
        'í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ': '2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ',
        'ì¼ë³¸_í™ˆìŠ¤ëƒ…': '2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…', 
        'í™ˆìŠ¤ëƒ…': '2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…',
        'ì¼ë³¸_ê²°ë°•': '2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•',
        'ê²°ë°•': '2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•',
        'ì¼ë³¸_ì„ ë¬¼': '2023_12_16_ì¼ë³¸_ì„ ë¬¼', 
        'ì„ ë¬¼': '2023_12_16_ì¼ë³¸_ì„ ë¬¼',
        'í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg',
        'í•œêµ­_ì…€í”„_ì´¬ì˜': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜', 
        'ì…€í”„_ì´¬ì˜': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜',
        'ì˜¥ìƒì—°ë¦¬': '2024_09_15_í•œêµ­_ì˜¥ìƒì—°ë¦¬',
        'ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ': '2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ',
        'ì„¸ë¯¸ëˆ„ë“œ': '2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ',
        'í•œêµ­_í™ˆì…€í”„': '2024_12_07_í•œêµ­_í™ˆì…€í”„',
        'í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ': '2023_12_14_ì¼ë³¸_í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ',
        'ì§€ë¸Œë¦¬í’': '2024_05_03_ì¼ë³¸_ì§€ë¸Œë¦¬í’',
        'í•œêµ­_ë¶í•´': '2024_06_06_í•œêµ­_ë¶í•´', 
        'ë¶í•´': '2024_06_06_í•œêµ­_ë¶í•´',
        'ì•„ì´ë…¸ì‹œë§ˆ': '2024_02_07_ì¼ë³¸_ì•„ì´ë…¸ì‹œë§ˆ',
        'ì¼ë³¸_í•„ë¦„': '2025_03_ì¼ë³¸_í•„ë¦„',
        'ëª¨ì§€ì½”_ëª¨ë¦¬ë£©': '2024_05_05_ì¼ë³¸_ëª¨ì§€ì½”_ëª¨ë¦¬ë£©',
        'í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼': '2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼',
        'í•œêµ­_ëˆˆë°­': '2023_12_31_í•œêµ­_ëˆˆë°­',
        'ì¼ë³¸_ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        'ì¼ë³¸_ìš•ì¡°': '2024_07_08_ì¼ë³¸_ìš•ì¡°',
        'ë‚˜ë¹„ìš•ì¡°': '2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°',
        'ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬': '2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬',
        'ì´í™”ë§ˆì„': '2025_04_29_í•œêµ­_ì´í™”ë§ˆì„',
        'ìš°ë§ˆì‹œë§ˆ': '2024_07_06_ì¼ë³¸_ìš°ë§ˆì‹œë§ˆ',
        'ê°€ì„_í˜¸ìˆ˜ê³µì›': '2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›',
        'ë§ì¹œ_ì‚¬ì§„': '2024_06_08_í•œêµ­_ë§ì¹œ_ì‚¬ì§„',
        'ì¼ë³¸_êµë³µ': '2023_12_15_ì¼ë³¸_êµë³µ',
        'ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸': '2024_05_04_ì¼ë³¸_ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸',
        'ì¼ë³¸_ëª¨ì§€ì½”': '2024_12_12_ì¼ë³¸_ëª¨ì§€ì½”',
        'í…ì§„_ì½”ë‹¥í•„ë¦„': '2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„',
        'ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg': '2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg',
        'ì•¼ê°„_ë¡±íŒ¨ë”©': '2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©',
        'ì„ì§€ë¡œ_ìŠ¤ëƒ…': '2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…', 
        'ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…': '2024_09_16_í•œêµ­_ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…',
        'í•œêµ­_ìƒì¼_00022.jpg': '2024_02_22_í•œêµ­_ìƒì¼_00022.jpg',
        'í•œêµ­_ìƒì¼': '2024_02_22_í•œêµ­_ìƒì¼',
        'ëª¨ì§€ì½”2': '2024_07_06_ì¼ë³¸_ëª¨ì§€ì½”',
        'ì•¼ê°„_ë³´ë¼ëŒì´': '2025_05_04_í•œêµ­',
        'ì½”ì•¼ë…¸ì„¸': '2025_02_06_ì¼ë³¸_ì½”ì•¼ë…¸ì„¸',
        'ì•¼ê°„ê±°ë¦¬': '2024_05_06_ì¼ë³¸_ì•¼ê°„ê±°ë¦¬', 
        'ìƒì¼ì»¨ì…‰': '2024_12_31_í•œêµ­_ìƒì¼ì»¨ì…‰',
        'í™ˆìŠ¤ëƒ…_ì²­í¬ë„': '2025_05_03_í•œêµ­_í™ˆìŠ¤ëƒ…_ì²­í¬ë„',
        'ìš•ì‹¤_ë¸”ë™_ì›¨ë”©': '2024_11_08_í•œêµ­_ìš•ì‹¤_ë¸”ë™_ì›¨ë”©',
        'í˜¸ë¦¬ì¡´': '2024_09_11_í•œêµ­_í˜¸ë¦¬ì¡´',
        'ì—¬ì¹œ_ìŠ¤ëƒ…': '2024_07_08_ì¼ë³¸_ì—¬ì¹œ_ìŠ¤ëƒ…',
        'í›„ì§€ì—”': '2024_05_03_ì¼ë³¸_í›„ì§€ì—”',
        'ë¶ˆê½ƒë†€ì´': '2024_08_02_ì¼ë³¸_ë¶ˆê½ƒë†€ì´', 
        'ë¹¨ê°„_ê¸°ëª¨ë…¸': '2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸',
        'í”¼í¬ë‹‰': '2024_06_07_í•œêµ­__í”¼í¬ë‹‰',
        'ë²—ê½ƒ': '2024_04_12_í•œêµ­_ë²—ê½ƒ',
        'í›„ì§€_ìŠ¤ëƒ…': '2025_05_06_ë§ˆì§€ë§‰_í•œêµ­_í›„ì§€ìŠ¤ëƒ…',
        'ì›ë¯¸ìƒê°€_í•„ë¦„': '2024_09_14_í•œêµ­_ì›ë¯¸ìƒê°€_í•„ë¦„', 
        'ë°¤ë°”_ì‚°ì±…': '2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…',
        'ê³µì›_ì‚°ì±…': '2025_05_04_í•œêµ­_ê³µì›_ì‚°ì±…', 
        'ê³ ì¿ ë¼_í™': '2025_03_14_ì¼ë³¸_ê³ ì¿ ë¼',
        'ì˜¨ì‹¤_ì—¬ì‹ ': '2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ', 
        'ì„ì§€ë¡œ_ë„¤ì½”': '2025_04_30_í•œêµ­_ì„ì§€ë¡œ',
        'ë¬´ì¸ì—­': '2025_03_13_ì¼ë³¸_ë¬´ì¸ì—­', 
        'í™”ê°€': '2024_04_13_í•œêµ­_í™”ê°€',
        'ë¸”ë™ì›í”¼ìŠ¤': '2024_08_04_ì¼ë³¸_ë¸”ë™ì›í”¼ìŠ¤', 
        'ì¹´í˜': '2024_12_30_í•œêµ­_ì¹´í˜',
        'ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸': '2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸',
        'í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸': '2023_12_12_ì¼ë³¸_í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸',
        'í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ': '2025_05_05_í•œêµ­_í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ',
        'ì•¼ê°„_ë™ë°±': '2024_04_12_í•œêµ­_ì•¼ê°„_ë™ë°±',
        'ë‚˜ë¥´ì‹œìŠ¤íŠ¸': '2024_12_14_ì¼ë³¸_ë‚˜ë¥´ì‹œìŠ¤íŠ¸', 
        'ì„ì§€ë¡œ_ìº˜ë¹ˆ': '2025_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ',
        'ì‚°ì±…_0000009.jpg': '2024_06_09_í•œêµ­_ì‚°ì±…_0000009.jpg',
        'ì‚°ì±…_0000109.jpg': '2024_06_09_í•œêµ­_ì‚°ì±…_0000109.jpg',
        'ì‚°ì±…': '2024_06_09_í•œêµ­_ì‚°ì±…',
        'ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„': '2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„', 
        'í¬ë¦¬ìŠ¤ë§ˆìŠ¤': '2024_12_13_ì¼ë³¸_í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
        'ë„¤ì½”_ëª¨ì§€ì½”': '2024_02_11_ì¼ë³¸_ë„¤ì½”_ëª¨ì§€ì½”',
        'ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤': '2024_02_11_ì¼ë³¸_ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤',
        'ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ': '2024_10_16_ì¼ë³¸_ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ',
        'ê²Œì„ì„¼í„°': '2024_05_07_ì¼ë³¸_ê²Œì„ì„¼í„°',
        'ë™í‚¤_ê±°ë¦¬': '2024_05_02_ì¼ë³¸_ë™í‚¤_ê±°ë¦¬',
        'ê³ ì¿ ë¼_ì•¼ê°„': '2025_03_17_ì¼ë³¸_ê³ ì¿ ë¼',
        'ì½”ì´ë…¸ë³´ë¦¬': '2024_05_05_ì¼ë³¸_ì½”ì´ë…¸ë³´ë¦¬', 
        'ë¬¸ë˜ë™': '2024_04_13_í•œêµ­_ë¬¸ë˜ë™',
        'ìˆ˜êµ­': '2024_05_03_ì¼ë³¸_ìˆ˜êµ­',
        'ë©”ì´ë“œë³µ': '2024_11_08_í•œêµ­_ë©”ì´ë“œë³µ',
        'ì˜¤ë„ê³µì›': '2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›',
        'ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        'ìš•ì¡°': '2024_07_08_ì¼ë³¸_ìš•ì¡°'
    };

/**
 * URLì´ ìœ íš¨í•œì§€ ê²€ì¦í•˜ëŠ” í•¨ìˆ˜
 */
async function validateImageUrl(url) {
    try {
        console.log(`[validateImageUrl] ê²€ì¦ ì‹œì‘: ${url}`);
        const response = await axios.head(url, { 
            timeout: 10000,
            headers: {
                'User-Agent': 'LINE-Bot-SDK/7.7.0'
            },
            maxRedirects: 3
        });
        
        // LINE ì´ë¯¸ì§€ ìš”êµ¬ì‚¬í•­ ê²€ì¦
        const contentType = response.headers['content-type'];
        const contentLength = parseInt(response.headers['content-length'] || '0');
        
        console.log(`[validateImageUrl] Content-Type: ${contentType}, Size: ${contentLength} bytes`);
        
        // JPEG/PNG í˜•ì‹ì´ê³  10MB ì´í•˜ì—¬ì•¼ í•¨
        if (!contentType || (!contentType.includes('image/jpeg') && !contentType.includes('image/png'))) {
            console.warn(`[validateImageUrl] ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹: ${contentType}`);
            return false;
        }
        
        if (contentLength > 10 * 1024 * 1024) { // 10MB ì œí•œ
            console.warn(`[validateImageUrl] ì´ë¯¸ì§€ í¬ê¸° ì´ˆê³¼: ${contentLength} bytes`);
            return false;
        }
        
        console.log(`[validateImageUrl] ê²€ì¦ ì„±ê³µ`);
        return true;
    } catch (error) {
        console.error(`[validateImageUrl] URL ê²€ì¦ ì‹¤íŒ¨: ${url}`, error.message);
        return false;
    }
}

/**
 * URL ì¸ì½”ë”©ì„ ì ìš©í•˜ëŠ” í•¨ìˆ˜
 */
function encodeImageUrl(url) {
    try {
        // URLì„ íŒŒì‹±í•˜ì—¬ path ë¶€ë¶„ë§Œ ì¸ì½”ë”©
        const urlObj = new URL(url);
        const pathParts = urlObj.pathname.split('/');
        const encodedParts = pathParts.map(part => {
            // ë¹ˆ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¸ì½”ë”©
            return part ? encodeURIComponent(part) : part;
        });
        urlObj.pathname = encodedParts.join('/');
        
        const encodedUrl = urlObj.toString();
        console.log(`[encodeImageUrl] ì›ë³¸: ${url}`);
        console.log(`[encodeImageUrl] ì¸ì½”ë”©: ${encodedUrl}`);
        
        return encodedUrl;
    } catch (error) {
        console.error(`[encodeImageUrl] URL ì¸ì½”ë”© ì‹¤íŒ¨: ${url}`, error);
        return url; // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
    }
}

/**
 * íŠ¹ì • ì»¨ì…‰ í´ë”ì—ì„œ ëœë¤ ë˜ëŠ” ë‹¤ìŒ ì‚¬ì§„ URLì„ ìƒì„±í•©ë‹ˆë‹¤.
 * @param {string} folderName - ì‚¬ì§„ì´ ë“¤ì–´ìˆëŠ” í´ë” ì´ë¦„ (ì´ì œ íŒŒì¼ ì´ë¦„ì˜ ì ‘ë‘ì‚¬ ì—­í• )
 * @param {number} [targetIndex=null] - íŠ¹ì • ì¸ë±ìŠ¤ì˜ ì‚¬ì§„ì„ ê°€ì ¸ì˜¬ ê²½ìš° (1ë¶€í„° ì‹œì‘)
 * @returns {string|null} ì‚¬ì§„ URL ë˜ëŠ” null
 */
function generateConceptPhotoUrl(folderName, targetIndex = null) {
    console.log(`[concept:generateConceptPhotoUrl] í´ë”ëª… (íŒŒì¼ì ‘ë‘ì‚¬): "${folderName}"`); 
    const photoCount = CONCEPT_FOLDERS[folderName];
    console.log(`[concept:generateConceptPhotoUrl] ì‚¬ì§„ ê°œìˆ˜: ${photoCount}`);
    
    // ë‹¨ì¼ íŒŒì¼ëª…ìœ¼ë¡œ ë“±ë¡ëœ ê²½ìš° ë°”ë¡œ í•´ë‹¹ íŒŒì¼ëª…ì„ ì‚¬ìš©
    if (folderName.endsWith('.jpg')) {
        const rawUrl = `${BASE_CONCEPT_URL}${folderName}`;
        const encodedUrl = encodeImageUrl(rawUrl);
        console.log(`[concept:generateConceptPhotoUrl] ë‹¨ì¼ íŒŒì¼ URL: ${encodedUrl}`);
        return encodedUrl;
    }

    if (photoCount === undefined || photoCount <= 0) {
        console.warn(`[concept.js] í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤: ${folderName}`);
        return null;
    }
    
    let indexToUse;
    if (targetIndex !== null && targetIndex >= 1 && targetIndex <= photoCount) {
        indexToUse = targetIndex;
    } else {
        indexToUse = Math.floor(Math.random() * photoCount) + 1;
    }
    console.log(`[concept:generateConceptPhotoUrl] ì‚¬ìš©í•  ì¸ë±ìŠ¤: ${indexToUse}`);

    // íŒŒì¼ëª… í˜•ì‹: "ë‚ ì§œ_ì¥ì†Œ_ì»¨ì…‰_000001.jpg"
    const fileName = `${folderName}_${String(indexToUse).padStart(6, '0')}.jpg`; 
    console.log(`[concept:generateConceptPhotoUrl] íŒŒì¼ëª…: ${fileName}`);
    
    // ìµœì¢… URLì€ BASE_CONCEPT_URL ë°”ë¡œ ì•„ë˜ íŒŒì¼ëª…ìœ¼ë¡œ êµ¬ì„±í•˜ê³  ì¸ì½”ë”© ì ìš©
    const rawUrl = `${BASE_CONCEPT_URL}${fileName}`;
    const encodedUrl = encodeImageUrl(rawUrl);
    console.log(`[concept:generateConceptPhotoUrl] ìµœì¢… ìƒì„± URL: ${encodedUrl}`);
    return encodedUrl;
}

// ë§ˆì§€ë§‰ìœ¼ë¡œ ë³´ì—¬ì¤€ ì»¨ì…‰ ì‚¬ì§„ í´ë”ë¥¼ ì €ì¥í•˜ì—¬ 'ë‹¤ë¥¸ ê²ƒë„' ìš”ì²­ ì‹œ í™œìš©
let lastConceptPhotoFolder = null;
let lastConceptPhotoIndex = 0;

/**
 * ì‚¬ìš©ì ë©”ì‹œì§€ì— ë”°ë¼ ì»¨ì…‰ ì‚¬ì§„ì„ ì„ íƒí•˜ê³ , AIê°€ ê°ì •/ì½”ë©˜íŠ¸ë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
 * @param {string} userMessage - ì‚¬ìš©ìì˜ ì›ë³¸ ë©”ì‹œì§€
 * @param {Function} saveLogFunc - ë¡œê·¸ ì €ì¥ì„ ìœ„í•œ saveLog í•¨ìˆ˜
 * @param {Function} callOpenAIFunc - OpenAI í˜¸ì¶œ í•¨ìˆ˜
 * @param {Function} cleanReplyFunc - ì‘ë‹µ ì •ë¦¬ í•¨ìˆ˜
 * @returns {Promise<{type: string, url?: string, caption?: string, comment?: string}|null>} ì‚¬ì§„ URLê³¼ ì½”ë©˜íŠ¸ ê°ì²´ ë˜ëŠ” null
 */
async function getConceptPhotoReply(userMessage, saveLogFunc, callOpenAIFunc, cleanReplyFunc) {
    console.log(`[concept:getConceptPhotoReply] ë©”ì‹œì§€ ìˆ˜ì‹ : "${userMessage}"`);
    const lowerCaseMessage = userMessage.toLowerCase();
    let selectedFolder = null;
    let folderDescription = '';
    let additionalPromptForYejinText = '';
    
    const conceptKeywords = ['ì»¨ì…‰ì‚¬ì§„', 'ì»¨ì…‰ ì‚¬ì§„', 'ìš•ì‹¤', 'ìš•ì¡°', 'ë‚˜ë¹„ìš•ì¡°', 'ì„¸ë¯¸ëˆ„ë“œ', 'ê²°ë°•', 'êµë³µ', 'í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ', 'í™ˆìŠ¤ëƒ…', 'ì§€ë¸Œë¦¬í’', 'ëª¨ì§€ì½”', 'í•˜ì¹´íƒ€', 'í…ì§„', 'ì•„ì´ë…¸ì‹œë§ˆ', 'í›„ì§€ì—”', 'ìœ ì¹´íƒ€', 'ë¶ˆê½ƒë†€ì´', 'ë©”ì´ë“œë³µ', 'ê³ ìŠ¤ë¡œë¦¬', 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', 'ìƒì¼ì»¨ì…‰', 'ì˜¥ìƒì—°ë¦¬', 'ì„ì§€ë¡œ', 'ì´í™”ë§ˆì„', 'ì½”ì•¼ë…¸ì„¸', 'ë¬´ì¸ì—­', 'ê³ ì¿ ë¼', 'ë²—ê½ƒ', 'ë™ë°±', 'ì˜¨ì‹¤', 'í™”ê°€', 'ë¬¸ë˜ë™', 'ë¶í•´', 'í”¼í¬ë‹‰', 'ì‚°ì±…', 'í„°ë„', 'ë§ì¹œ ì‚¬ì§„', 'ìš°ë§ˆì‹œë§ˆ', 'ë¹„ëˆ—ë°©ìš¸', 'ì•¼ê°„ê±°ë¦¬', 'ê²Œì„ì„¼í„°', 'ë™í‚¤ ê±°ë¦¬', 'ìˆ˜êµ­', 'ì½”ì´ë…¸ë³´ë¦¬', 'ë¸”ë™ì›í”¼ìŠ¤', 'í˜¸ë¦¬ì¡´', 'ì›ë¯¸ìƒê°€', 'ê¸¸ê±°ë¦¬ ìŠ¤ëƒ…', 'ì˜¤ë„', 'ë‚˜ë¥´ì‹œìŠ¤íŠ¸', 'ëˆˆë°­', 'í•„ë¦„ì¹´ë©”ë¼', 'ì²­í¬ë„', 'ë³´ë¼ëŒì´', 'ë°¤ë°”', 'ê³µì›', 'ì˜¤íƒ€ì¿ ', 'í™', 'ìº˜ë¹ˆ', 'ë„¤ì½”'];
    
    const isConceptRequest = conceptKeywords.some(keyword => lowerCaseMessage.includes(keyword));
    
    if (!isConceptRequest) {
        console.log(`[concept:getConceptPhotoReply] ì»¨ì…‰ì‚¬ì§„ ê´€ë ¨ í‚¤ì›Œë“œ ì—†ìŒ. null ë°˜í™˜.`);
        return null;
    }

    // í‚¤ì›Œë“œ ë§µ (ê¸¸ì´ì— ë”°ë¼ ì •ë ¬í•˜ì—¬ ë” êµ¬ì²´ì ì¸ í‚¤ì›Œë“œê°€ ë¨¼ì € ë§¤ì¹­ë˜ë„ë¡)
    const conceptKeywordMap = {
        '2ì›”_ìš•ì¡°': '2024_02_07_ì¼ë³¸_ìš•ì¡°', 
        '2ì›”_ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        '2ì›”_ë‚˜ë¹„ìš•ì¡°': '2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°',
        'í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ': '2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ',
        'ì¼ë³¸_í™ˆìŠ¤ëƒ…': '2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…', 
        'í™ˆìŠ¤ëƒ…': '2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…',
        'ì¼ë³¸_ê²°ë°•': '2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•',
        'ê²°ë°•': '2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•',
        'ì¼ë³¸_ì„ ë¬¼': '2023_12_16_ì¼ë³¸_ì„ ë¬¼', 
        'ì„ ë¬¼': '2023_12_16_ì¼ë³¸_ì„ ë¬¼',
        'í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg',
        'í•œêµ­_ì…€í”„_ì´¬ì˜': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜', 
        'ì…€í”„_ì´¬ì˜': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜',
        'ì˜¥ìƒì—°ë¦¬': '2024_09_15_í•œêµ­_ì˜¥ìƒì—°ë¦¬',
        'ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ': '2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ',
        'ì„¸ë¯¸ëˆ„ë“œ': '2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ',
        'í•œêµ­_í™ˆì…€í”„': '2024_12_07_í•œêµ­_í™ˆì…€í”„',
        'í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ': '2023_12_14_ì¼ë³¸_í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ',
        'ì§€ë¸Œë¦¬í’': '2024_05_03_ì¼ë³¸_ì§€ë¸Œë¦¬í’',
        'í•œêµ­_ë¶í•´': '2024_06_06_í•œêµ­_ë¶í•´', 
        'ë¶í•´': '2024_06_06_í•œêµ­_ë¶í•´',
        'ì•„ì´ë…¸ì‹œë§ˆ': '2024_02_07_ì¼ë³¸_ì•„ì´ë…¸ì‹œë§ˆ',
        'ì¼ë³¸_í•„ë¦„': '2025_03_ì¼ë³¸_í•„ë¦„',
        'ëª¨ì§€ì½”_ëª¨ë¦¬ë£©': '2024_05_05_ì¼ë³¸_ëª¨ì§€ì½”_ëª¨ë¦¬ë£©',
        'í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼': '2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼',
        'í•œêµ­_ëˆˆë°­': '2023_12_31_í•œêµ­_ëˆˆë°­',
        'ì¼ë³¸_ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        'ì¼ë³¸_ìš•ì¡°': '2024_07_08_ì¼ë³¸_ìš•ì¡°',
        'ë‚˜ë¹„ìš•ì¡°': '2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°',
        'ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬': '2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬',
        'ì´í™”ë§ˆì„': '2025_04_29_í•œêµ­_ì´í™”ë§ˆì„',
        'ìš°ë§ˆì‹œë§ˆ': '2024_07_06_ì¼ë³¸_ìš°ë§ˆì‹œë§ˆ',
        'ê°€ì„_í˜¸ìˆ˜ê³µì›': '2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›',
        'ë§ì¹œ_ì‚¬ì§„': '2024_06_08_í•œêµ­_ë§ì¹œ_ì‚¬ì§„',
        'ì¼ë³¸_êµë³µ': '2023_12_15_ì¼ë³¸_êµë³µ',
        'ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸': '2024_05_04_ì¼ë³¸_ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸',
        'ì¼ë³¸_ëª¨ì§€ì½”': '2024_12_12_ì¼ë³¸_ëª¨ì§€ì½”',
        'í…ì§„_ì½”ë‹¥í•„ë¦„': '2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„',
        'ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg': '2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg',
        'ì•¼ê°„_ë¡±íŒ¨ë”©': '2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©',
        'ì„ì§€ë¡œ_ìŠ¤ëƒ…': '2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…', 
        'ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…': '2024_09_16_í•œêµ­_ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…',
        'í•œêµ­_ìƒì¼_00022.jpg': '2024_02_22_í•œêµ­_ìƒì¼_00022.jpg',
        'í•œêµ­_ìƒì¼': '2024_02_22_í•œêµ­_ìƒì¼',
        'ëª¨ì§€ì½”2': '2024_07_06_ì¼ë³¸_ëª¨ì§€ì½”',
        'ì•¼ê°„_ë³´ë¼ëŒì´': '2025_05_04_í•œêµ­',
        'ì½”ì•¼ë…¸ì„¸': '2025_02_06_ì¼ë³¸_ì½”ì•¼ë…¸ì„¸',
        'ì•¼ê°„ê±°ë¦¬': '2024_05_06_ì¼ë³¸_ì•¼ê°„ê±°ë¦¬', 
        'ìƒì¼ì»¨ì…‰': '2024_12_31_í•œêµ­_ìƒì¼ì»¨ì…‰',
        'í™ˆìŠ¤ëƒ…_ì²­í¬ë„': '2025_05_03_í•œêµ­_í™ˆìŠ¤ëƒ…_ì²­í¬ë„',
        'ìš•ì‹¤_ë¸”ë™_ì›¨ë”©': '2024_11_08_í•œêµ­_ìš•ì‹¤_ë¸”ë™_ì›¨ë”©',
        'í˜¸ë¦¬ì¡´': '2024_09_11_í•œêµ­_í˜¸ë¦¬ì¡´',
        'ì—¬ì¹œ_ìŠ¤ëƒ…': '2024_07_08_ì¼ë³¸_ì—¬ì¹œ_ìŠ¤ëƒ…',
        'í›„ì§€ì—”': '2024_05_03_ì¼ë³¸_í›„ì§€ì—”',
        'ë¶ˆê½ƒë†€ì´': '2024_08_02_ì¼ë³¸_ë¶ˆê½ƒë†€ì´', 
        'ë¹¨ê°„_ê¸°ëª¨ë…¸': '2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸',
        'í”¼í¬ë‹‰': '2024_06_07_í•œêµ­__í”¼í¬ë‹‰',
        'ë²—ê½ƒ': '2024_04_12_í•œêµ­_ë²—ê½ƒ',
        'í›„ì§€_ìŠ¤ëƒ…': '2025_05_06_ë§ˆì§€ë§‰_í•œêµ­_í›„ì§€ìŠ¤ëƒ…',
        'ì›ë¯¸ìƒê°€_í•„ë¦„': '2024_09_14_í•œêµ­_ì›ë¯¸ìƒê°€_í•„ë¦„', 
        'ë°¤ë°”_ì‚°ì±…': '2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…',
        'ê³µì›_ì‚°ì±…': '2025_05_04_í•œêµ­_ê³µì›_ì‚°ì±…', 
        'ê³ ì¿ ë¼_í™': '2025_03_14_ì¼ë³¸_ê³ ì¿ ë¼',
        'ì˜¨ì‹¤_ì—¬ì‹ ': '2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ', 
        'ì„ì§€ë¡œ_ë„¤ì½”': '2025_04_30_í•œêµ­_ì„ì§€ë¡œ',
        'ë¬´ì¸ì—­': '2025_03_13_ì¼ë³¸_ë¬´ì¸ì—­', 
        'í™”ê°€': '2024_04_13_í•œêµ­_í™”ê°€',
        'ë¸”ë™ì›í”¼ìŠ¤': '2024_08_04_ì¼ë³¸_ë¸”ë™ì›í”¼ìŠ¤', 
        'ì¹´í˜': '2024_12_30_í•œêµ­_ì¹´í˜',
        'ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸': '2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸',
        'í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸': '2023_12_12_ì¼ë³¸_í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸',
        'í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ': '2025_05_05_í•œêµ­_í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ',
        'ì•¼ê°„_ë™ë°±': '2024_04_12_í•œêµ­_ì•¼ê°„_ë™ë°±',
        'ë‚˜ë¥´ì‹œìŠ¤íŠ¸': '2024_12_14_ì¼ë³¸_ë‚˜ë¥´ì‹œìŠ¤íŠ¸', 
        'ì„ì§€ë¡œ_ìº˜ë¹ˆ': '2025_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ',
        'ì‚°ì±…_0000009.jpg': '2024_06_09_í•œêµ­_ì‚°ì±…_0000009.jpg',
        'ì‚°ì±…_0000109.jpg': '2024_06_09_í•œêµ­_ì‚°ì±…_0000109.jpg',
        'ì‚°ì±…': '2024_06_09_í•œêµ­_ì‚°ì±…',
        'ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„': '2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„', 
        'í¬ë¦¬ìŠ¤ë§ˆìŠ¤': '2024_12_13_ì¼ë³¸_í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
        'ë„¤ì½”_ëª¨ì§€ì½”': '2024_02_11_ì¼ë³¸_ë„¤ì½”_ëª¨ì§€ì½”',
        'ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤': '2024_02_11_ì¼ë³¸_ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤',
        'ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ': '2024_10_16_ì¼ë³¸_ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ',
        'ê²Œì„ì„¼í„°': '2024_05_07_ì¼ë³¸_ê²Œì„ì„¼í„°',
        'ë™í‚¤_ê±°ë¦¬': '2024_05_02_ì¼ë³¸_ë™í‚¤_ê±°ë¦¬',
        'ê³ ì¿ ë¼_ì•¼ê°„': '2025_03_17_ì¼ë³¸_ê³ ì¿ ë¼',
        'ì½”ì´ë…¸ë³´ë¦¬': '2024_05_05_ì¼ë³¸_ì½”ì´ë…¸ë³´ë¦¬', 
        'ë¬¸ë˜ë™': '2024_04_13_í•œêµ­_ë¬¸ë˜ë™',
        'ìˆ˜êµ­': '2024_05_03_ì¼ë³¸_ìˆ˜êµ­',
        'ë©”ì´ë“œë³µ': '2024_11_08_í•œêµ­_ë©”ì´ë“œë³µ',
        'ì˜¤ë„ê³µì›': '2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›',
        'ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        'ìš•ì¡°': '2024_07_08_ì¼ë³¸_ìš•ì¡°'
    };

/**
 * URLì´ ìœ íš¨í•œì§€ ê²€ì¦í•˜ëŠ” í•¨ìˆ˜
 */
async function validateImageUrl(url) {
    try {
        console.log(`[validateImageUrl] ê²€ì¦ ì‹œì‘: ${url}`);
        const response = await axios.head(url, { 
            timeout: 10000,
            headers: {
                'User-Agent': 'LINE-Bot-SDK/7.7.0'
            },
            maxRedirects: 3
        });
        
        // LINE ì´ë¯¸ì§€ ìš”êµ¬ì‚¬í•­ ê²€ì¦
        const contentType = response.headers['content-type'];
        const contentLength = parseInt(response.headers['content-length'] || '0');
        
        console.log(`[validateImageUrl] Content-Type: ${contentType}, Size: ${contentLength} bytes`);
        
        // JPEG/PNG í˜•ì‹ì´ê³  10MB ì´í•˜ì—¬ì•¼ í•¨
        if (!contentType || (!contentType.includes('image/jpeg') && !contentType.includes('image/png'))) {
            console.warn(`[validateImageUrl] ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹: ${contentType}`);
            return false;
        }
        
        if (contentLength > 10 * 1024 * 1024) { // 10MB ì œí•œ
            console.warn(`[validateImageUrl] ì´ë¯¸ì§€ í¬ê¸° ì´ˆê³¼: ${contentLength} bytes`);
            return false;
        }
        
        console.log(`[validateImageUrl] ê²€ì¦ ì„±ê³µ`);
        return true;
    } catch (error) {
        console.error(`[validateImageUrl] URL ê²€ì¦ ì‹¤íŒ¨: ${url}`, error.message);
        return false;
    }
}

/**
 * URL ì¸ì½”ë”©ì„ ì ìš©í•˜ëŠ” í•¨ìˆ˜
 */
function encodeImageUrl(url) {
    try {
        // URLì„ íŒŒì‹±í•˜ì—¬ path ë¶€ë¶„ë§Œ ì¸ì½”ë”©
        const urlObj = new URL(url);
        const pathParts = urlObj.pathname.split('/');
        const encodedParts = pathParts.map(part => {
            // ë¹ˆ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¸ì½”ë”©
            return part ? encodeURIComponent(part) : part;
        });
        urlObj.pathname = encodedParts.join('/');
        
        const encodedUrl = urlObj.toString();
        console.log(`[encodeImageUrl] ì›ë³¸: ${url}`);
        console.log(`[encodeImageUrl] ì¸ì½”ë”©: ${encodedUrl}`);
        
        return encodedUrl;
    } catch (error) {
        console.error(`[encodeImageUrl] URL ì¸ì½”ë”© ì‹¤íŒ¨: ${url}`, error);
        return url; // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
    }
}

/**
 * íŠ¹ì • ì»¨ì…‰ í´ë”ì—ì„œ ëœë¤ ë˜ëŠ” ë‹¤ìŒ ì‚¬ì§„ URLì„ ìƒì„±í•©ë‹ˆë‹¤.
 * @param {string} folderName - ì‚¬ì§„ì´ ë“¤ì–´ìˆëŠ” í´ë” ì´ë¦„ (ì´ì œ íŒŒì¼ ì´ë¦„ì˜ ì ‘ë‘ì‚¬ ì—­í• )
 * @param {number} [targetIndex=null] - íŠ¹ì • ì¸ë±ìŠ¤ì˜ ì‚¬ì§„ì„ ê°€ì ¸ì˜¬ ê²½ìš° (1ë¶€í„° ì‹œì‘)
 * @returns {string|null} ì‚¬ì§„ URL ë˜ëŠ” null
 */
function generateConceptPhotoUrl(folderName, targetIndex = null) {
    console.log(`[concept:generateConceptPhotoUrl] í´ë”ëª… (íŒŒì¼ì ‘ë‘ì‚¬): "${folderName}"`); 
    const photoCount = CONCEPT_FOLDERS[folderName];
    console.log(`[concept:generateConceptPhotoUrl] ì‚¬ì§„ ê°œìˆ˜: ${photoCount}`);
    
    // ë‹¨ì¼ íŒŒì¼ëª…ìœ¼ë¡œ ë“±ë¡ëœ ê²½ìš° ë°”ë¡œ í•´ë‹¹ íŒŒì¼ëª…ì„ ì‚¬ìš©
    if (folderName.endsWith('.jpg')) {
        const rawUrl = `${BASE_CONCEPT_URL}${folderName}`;
        const encodedUrl = encodeImageUrl(rawUrl);
        console.log(`[concept:generateConceptPhotoUrl] ë‹¨ì¼ íŒŒì¼ URL: ${encodedUrl}`);
        return encodedUrl;
    }

    if (photoCount === undefined || photoCount <= 0) {
        console.warn(`[concept.js] í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤: ${folderName}`);
        return null;
    }
    
    let indexToUse;
    if (targetIndex !== null && targetIndex >= 1 && targetIndex <= photoCount) {
        indexToUse = targetIndex;
    } else {
        indexToUse = Math.floor(Math.random() * photoCount) + 1;
    }
    console.log(`[concept:generateConceptPhotoUrl] ì‚¬ìš©í•  ì¸ë±ìŠ¤: ${indexToUse}`);

    // íŒŒì¼ëª… í˜•ì‹: "ë‚ ì§œ_ì¥ì†Œ_ì»¨ì…‰_000001.jpg"
    const fileName = `${folderName}_${String(indexToUse).padStart(6, '0')}.jpg`; 
    console.log(`[concept:generateConceptPhotoUrl] íŒŒì¼ëª…: ${fileName}`);
    
    // ìµœì¢… URLì€ BASE_CONCEPT_URL ë°”ë¡œ ì•„ë˜ íŒŒì¼ëª…ìœ¼ë¡œ êµ¬ì„±í•˜ê³  ì¸ì½”ë”© ì ìš©
    const rawUrl = `${BASE_CONCEPT_URL}${fileName}`;
    const encodedUrl = encodeImageUrl(rawUrl);
    console.log(`[concept:generateConceptPhotoUrl] ìµœì¢… ìƒì„± URL: ${encodedUrl}`);
    return encodedUrl;
}

// ë§ˆì§€ë§‰ìœ¼ë¡œ ë³´ì—¬ì¤€ ì»¨ì…‰ ì‚¬ì§„ í´ë”ë¥¼ ì €ì¥í•˜ì—¬ 'ë‹¤ë¥¸ ê²ƒë„' ìš”ì²­ ì‹œ í™œìš©
let lastConceptPhotoFolder = null;
let lastConceptPhotoIndex = 0;

/**
 * ì‚¬ìš©ì ë©”ì‹œì§€ì— ë”°ë¼ ì»¨ì…‰ ì‚¬ì§„ì„ ì„ íƒí•˜ê³ , AIê°€ ê°ì •/ì½”ë©˜íŠ¸ë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
 * @param {string} userMessage - ì‚¬ìš©ìì˜ ì›ë³¸ ë©”ì‹œì§€
 * @param {Function} saveLogFunc - ë¡œê·¸ ì €ì¥ì„ ìœ„í•œ saveLog í•¨ìˆ˜
 * @param {Function} callOpenAIFunc - OpenAI í˜¸ì¶œ í•¨ìˆ˜
 * @param {Function} cleanReplyFunc - ì‘ë‹µ ì •ë¦¬ í•¨ìˆ˜
 * @returns {Promise<{type: string, url?: string, caption?: string, comment?: string}|null>} ì‚¬ì§„ URLê³¼ ì½”ë©˜íŠ¸ ê°ì²´ ë˜ëŠ” null
 */
async function getConceptPhotoReply(userMessage, saveLogFunc, callOpenAIFunc, cleanReplyFunc) {
    console.log(`[concept:getConceptPhotoReply] ë©”ì‹œì§€ ìˆ˜ì‹ : "${userMessage}"`);
    const lowerCaseMessage = userMessage.toLowerCase();
    let selectedFolder = null;
    let folderDescription = '';
    let additionalPromptForYejinText = '';
    
    const conceptKeywords = ['ì»¨ì…‰ì‚¬ì§„', 'ì»¨ì…‰ ì‚¬ì§„', 'ìš•ì‹¤', 'ìš•ì¡°', 'ë‚˜ë¹„ìš•ì¡°', 'ì„¸ë¯¸ëˆ„ë“œ', 'ê²°ë°•', 'êµë³µ', 'í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ', 'í™ˆìŠ¤ëƒ…', 'ì§€ë¸Œë¦¬í’', 'ëª¨ì§€ì½”', 'í•˜ì¹´íƒ€', 'í…ì§„', 'ì•„ì´ë…¸ì‹œë§ˆ', 'í›„ì§€ì—”', 'ìœ ì¹´íƒ€', 'ë¶ˆê½ƒë†€ì´', 'ë©”ì´ë“œë³µ', 'ê³ ìŠ¤ë¡œë¦¬', 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', 'ìƒì¼ì»¨ì…‰', 'ì˜¥ìƒì—°ë¦¬', 'ì„ì§€ë¡œ', 'ì´í™”ë§ˆì„', 'ì½”ì•¼ë…¸ì„¸', 'ë¬´ì¸ì—­', 'ê³ ì¿ ë¼', 'ë²—ê½ƒ', 'ë™ë°±', 'ì˜¨ì‹¤', 'í™”ê°€', 'ë¬¸ë˜ë™', 'ë¶í•´', 'í”¼í¬ë‹‰', 'ì‚°ì±…', 'í„°ë„', 'ë§ì¹œ ì‚¬ì§„', 'ìš°ë§ˆì‹œë§ˆ', 'ë¹„ëˆ—ë°©ìš¸', 'ì•¼ê°„ê±°ë¦¬', 'ê²Œì„ì„¼í„°', 'ë™í‚¤ ê±°ë¦¬', 'ìˆ˜êµ­', 'ì½”ì´ë…¸ë³´ë¦¬', 'ë¸”ë™ì›í”¼ìŠ¤', 'í˜¸ë¦¬ì¡´', 'ì›ë¯¸ìƒê°€', 'ê¸¸ê±°ë¦¬ ìŠ¤ëƒ…', 'ì˜¤ë„', 'ë‚˜ë¥´ì‹œìŠ¤íŠ¸', 'ëˆˆë°­', 'í•„ë¦„ì¹´ë©”ë¼', 'ì²­í¬ë„', 'ë³´ë¼ëŒì´', 'ë°¤ë°”', 'ê³µì›', 'ì˜¤íƒ€ì¿ ', 'í™', 'ìº˜ë¹ˆ', 'ë„¤ì½”'];
    
    const isConceptRequest = conceptKeywords.some(keyword => lowerCaseMessage.includes(keyword));
    
    if (!isConceptRequest) {
        console.log(`[concept:getConceptPhotoReply] ì»¨ì…‰ì‚¬ì§„ ê´€ë ¨ í‚¤ì›Œë“œ ì—†ìŒ. null ë°˜í™˜.`);
        return null;
    }

    // í‚¤ì›Œë“œ ë§µ (ê¸¸ì´ì— ë”°ë¼ ì •ë ¬í•˜ì—¬ ë” êµ¬ì²´ì ì¸ í‚¤ì›Œë“œê°€ ë¨¼ì € ë§¤ì¹­ë˜ë„ë¡)
    const conceptKeywordMap = {
        '2ì›”_ìš•ì¡°': '2024_02_07_ì¼ë³¸_ìš•ì¡°', 
        '2ì›”_ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        '2ì›”_ë‚˜ë¹„ìš•ì¡°': '2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°',
        'í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ': '2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ',
        'ì¼ë³¸_í™ˆìŠ¤ëƒ…': '2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…', 
        'í™ˆìŠ¤ëƒ…': '2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…',
        'ì¼ë³¸_ê²°ë°•': '2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•',
        'ê²°ë°•': '2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•',
        'ì¼ë³¸_ì„ ë¬¼': '2023_12_16_ì¼ë³¸_ì„ ë¬¼', 
        'ì„ ë¬¼': '2023_12_16_ì¼ë³¸_ì„ ë¬¼',
        'í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg',
        'í•œêµ­_ì…€í”„_ì´¬ì˜': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜', 
        'ì…€í”„_ì´¬ì˜': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜',
        'ì˜¥ìƒì—°ë¦¬': '2024_09_15_í•œêµ­_ì˜¥ìƒì—°ë¦¬',
        'ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ': '2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ',
        'ì„¸ë¯¸ëˆ„ë“œ': '2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ',
        'í•œêµ­_í™ˆì…€í”„': '2024_12_07_í•œêµ­_í™ˆì…€í”„',
        'í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ': '2023_12_14_ì¼ë³¸_í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ',
        'ì§€ë¸Œë¦¬í’': '2024_05_03_ì¼ë³¸_ì§€ë¸Œë¦¬í’',
        'í•œêµ­_ë¶í•´': '2024_06_06_í•œêµ­_ë¶í•´', 
        'ë¶í•´': '2024_06_06_í•œêµ­_ë¶í•´',
        'ì•„ì´ë…¸ì‹œë§ˆ': '2024_02_07_ì¼ë³¸_ì•„ì´ë…¸ì‹œë§ˆ',
        'ì¼ë³¸_í•„ë¦„': '2025_03_ì¼ë³¸_í•„ë¦„',
        'ëª¨ì§€ì½”_ëª¨ë¦¬ë£©': '2024_05_05_ì¼ë³¸_ëª¨ì§€ì½”_ëª¨ë¦¬ë£©',
        'í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼': '2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼',
        'í•œêµ­_ëˆˆë°­': '2023_12_31_í•œêµ­_ëˆˆë°­',
        'ì¼ë³¸_ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        'ì¼ë³¸_ìš•ì¡°': '2024_07_08_ì¼ë³¸_ìš•ì¡°',
        'ë‚˜ë¹„ìš•ì¡°': '2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°',
        'ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬': '2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬',
        'ì´í™”ë§ˆì„': '2025_04_29_í•œêµ­_ì´í™”ë§ˆì„',
        'ìš°ë§ˆì‹œë§ˆ': '2024_07_06_ì¼ë³¸_ìš°ë§ˆì‹œë§ˆ',
        'ê°€ì„_í˜¸ìˆ˜ê³µì›': '2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›',
        'ë§ì¹œ_ì‚¬ì§„': '2024_06_08_í•œêµ­_ë§ì¹œ_ì‚¬ì§„',
        'ì¼ë³¸_êµë³µ': '2023_12_15_ì¼ë³¸_êµë³µ',
        'ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸': '2024_05_04_ì¼ë³¸_ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸',
        'ì¼ë³¸_ëª¨ì§€ì½”': '2024_12_12_ì¼ë³¸_ëª¨ì§€ì½”',
        'í…ì§„_ì½”ë‹¥í•„ë¦„': '2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„',
        'ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg': '2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg',
        'ì•¼ê°„_ë¡±íŒ¨ë”©': '2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©',
        'ì„ì§€ë¡œ_ìŠ¤ëƒ…': '2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…', 
        'ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…': '2024_09_16_í•œêµ­_ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…',
        'í•œêµ­_ìƒì¼_00022.jpg': '2024_02_22_í•œêµ­_ìƒì¼_00022.jpg',
        'í•œêµ­_ìƒì¼': '2024_02_22_í•œêµ­_ìƒì¼',
        'ëª¨ì§€ì½”2': '2024_07_06_ì¼ë³¸_ëª¨ì§€ì½”',
        'ì•¼ê°„_ë³´ë¼ëŒì´': '2025_05_04_í•œêµ­',
        'ì½”ì•¼ë…¸ì„¸': '2025_02_06_ì¼ë³¸_ì½”ì•¼ë…¸ì„¸',
        'ì•¼ê°„ê±°ë¦¬': '2024_05_06_ì¼ë³¸_ì•¼ê°„ê±°ë¦¬', 
        'ìƒì¼ì»¨ì…‰': '2024_12_31_í•œêµ­_ìƒì¼ì»¨ì…‰',
        'í™ˆìŠ¤ëƒ…_ì²­í¬ë„': '2025_05_03_í•œêµ­_í™ˆìŠ¤ëƒ…_ì²­í¬ë„',
        'ìš•ì‹¤_ë¸”ë™_ì›¨ë”©': '2024_11_08_í•œêµ­_ìš•ì‹¤_ë¸”ë™_ì›¨ë”©',
        'í˜¸ë¦¬ì¡´': '2024_09_11_í•œêµ­_í˜¸ë¦¬ì¡´',
        'ì—¬ì¹œ_ìŠ¤ëƒ…': '2024_07_08_ì¼ë³¸_ì—¬ì¹œ_ìŠ¤ëƒ…',
        'í›„ì§€ì—”': '2024_05_03_ì¼ë³¸_í›„ì§€ì—”',
        'ë¶ˆê½ƒë†€ì´': '2024_08_02_ì¼ë³¸_ë¶ˆê½ƒë†€ì´', 
        'ë¹¨ê°„_ê¸°ëª¨ë…¸': '2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸',
        'í”¼í¬ë‹‰': '2024_06_07_í•œêµ­__í”¼í¬ë‹‰',
        'ë²—ê½ƒ': '2024_04_12_í•œêµ­_ë²—ê½ƒ',
        'í›„ì§€_ìŠ¤ëƒ…': '2025_05_06_ë§ˆì§€ë§‰_í•œêµ­_í›„ì§€ìŠ¤ëƒ…',
        'ì›ë¯¸ìƒê°€_í•„ë¦„': '2024_09_14_í•œêµ­_ì›ë¯¸ìƒê°€_í•„ë¦„', 
        'ë°¤ë°”_ì‚°ì±…': '2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…',
        'ê³µì›_ì‚°ì±…': '2025_05_04_í•œêµ­_ê³µì›_ì‚°ì±…', 
        'ê³ ì¿ ë¼_í™': '2025_03_14_ì¼ë³¸_ê³ ì¿ ë¼',
        'ì˜¨ì‹¤_ì—¬ì‹ ': '2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ', 
        'ì„ì§€ë¡œ_ë„¤ì½”': '2025_04_30_í•œêµ­_ì„ì§€ë¡œ',
        'ë¬´ì¸ì—­': '2025_03_13_ì¼ë³¸_ë¬´ì¸ì—­', 
        'í™”ê°€': '2024_04_13_í•œêµ­_í™”ê°€',
        'ë¸”ë™ì›í”¼ìŠ¤': '2024_08_04_ì¼ë³¸_ë¸”ë™ì›í”¼ìŠ¤', 
        'ì¹´í˜': '2024_12_30_í•œêµ­_ì¹´í˜',
        'ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸': '2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸',
        'í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸': '2023_12_12_ì¼ë³¸_í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸',
        'í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ': '2025_05_05_í•œêµ­_í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ',
        'ì•¼ê°„_ë™ë°±': '2024_04_12_í•œêµ­_ì•¼ê°„_ë™ë°±',
        'ë‚˜ë¥´ì‹œìŠ¤íŠ¸': '2024_12_14_ì¼ë³¸_ë‚˜ë¥´ì‹œìŠ¤íŠ¸', 
        'ì„ì§€ë¡œ_ìº˜ë¹ˆ': '2025_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ',
        'ì‚°ì±…_0000009.jpg': '2024_06_09_í•œêµ­_ì‚°ì±…_0000009.jpg',
        'ì‚°ì±…_0000109.jpg': '2024_06_09_í•œêµ­_ì‚°ì±…_0000109.jpg',
        'ì‚°ì±…': '2024_06_09_í•œêµ­_ì‚°ì±…',
        'ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„': '2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„', 
        'í¬ë¦¬ìŠ¤ë§ˆìŠ¤': '2024_12_13_ì¼ë³¸_í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
        'ë„¤ì½”_ëª¨ì§€ì½”': '2024_02_11_ì¼ë³¸_ë„¤ì½”_ëª¨ì§€ì½”',
        'ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤': '2024_02_11_ì¼ë³¸_ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤',
        'ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ': '2024_10_16_ì¼ë³¸_ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ',
        'ê²Œì„ì„¼í„°': '2024_05_07_ì¼ë³¸_ê²Œì„ì„¼í„°',
        'ë™í‚¤_ê±°ë¦¬': '2024_05_02_ì¼ë³¸_ë™í‚¤_ê±°ë¦¬',
        'ê³ ì¿ ë¼_ì•¼ê°„': '2025_03_17_ì¼ë³¸_ê³ ì¿ ë¼',
        'ì½”ì´ë…¸ë³´ë¦¬': '2024_05_05_ì¼ë³¸_ì½”ì´ë…¸ë³´ë¦¬', 
        'ë¬¸ë˜ë™': '2024_04_13_í•œêµ­_ë¬¸ë˜ë™',
        'ìˆ˜êµ­': '2024_05_03_ì¼ë³¸_ìˆ˜êµ­',
        'ë©”ì´ë“œë³µ': '2024_11_08_í•œêµ­_ë©”ì´ë“œë³µ',
        'ì˜¤ë„ê³µì›': '2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›',
        'ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        'ìš•ì¡°': '2024_07_08_ì¼ë³¸_ìš•ì¡°'
    };

/**
 * URLì´ ìœ íš¨í•œì§€ ê²€ì¦í•˜ëŠ” í•¨ìˆ˜
 */
async function validateImageUrl(url) {
    try {
        console.log(`[validateImageUrl] ê²€ì¦ ì‹œì‘: ${url}`);
        const response = await axios.head(url, { 
            timeout: 10000,
            headers: {
                'User-Agent': 'LINE-Bot-SDK/7.7.0'
            },
            maxRedirects: 3
        });
        
        // LINE ì´ë¯¸ì§€ ìš”êµ¬ì‚¬í•­ ê²€ì¦
        const contentType = response.headers['content-type'];
        const contentLength = parseInt(response.headers['content-length'] || '0');
        
        console.log(`[validateImageUrl] Content-Type: ${contentType}, Size: ${contentLength} bytes`);
        
        // JPEG/PNG í˜•ì‹ì´ê³  10MB ì´í•˜ì—¬ì•¼ í•¨
        if (!contentType || (!contentType.includes('image/jpeg') && !contentType.includes('image/png'))) {
            console.warn(`[validateImageUrl] ì§€ì›í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ í˜•ì‹: ${contentType}`);
            return false;
        }
        
        if (contentLength > 10 * 1024 * 1024) { // 10MB ì œí•œ
            console.warn(`[validateImageUrl] ì´ë¯¸ì§€ í¬ê¸° ì´ˆê³¼: ${contentLength} bytes`);
            return false;
        }
        
        console.log(`[validateImageUrl] ê²€ì¦ ì„±ê³µ`);
        return true;
    } catch (error) {
        console.error(`[validateImageUrl] URL ê²€ì¦ ì‹¤íŒ¨: ${url}`, error.message);
        return false;
    }
}

/**
 * URL ì¸ì½”ë”©ì„ ì ìš©í•˜ëŠ” í•¨ìˆ˜
 */
function encodeImageUrl(url) {
    try {
        // URLì„ íŒŒì‹±í•˜ì—¬ path ë¶€ë¶„ë§Œ ì¸ì½”ë”©
        const urlObj = new URL(url);
        const pathParts = urlObj.pathname.split('/');
        const encodedParts = pathParts.map(part => {
            // ë¹ˆ ë¬¸ìì—´ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¸ì½”ë”©
            return part ? encodeURIComponent(part) : part;
        });
        urlObj.pathname = encodedParts.join('/');
        
        const encodedUrl = urlObj.toString();
        console.log(`[encodeImageUrl] ì›ë³¸: ${url}`);
        console.log(`[encodeImageUrl] ì¸ì½”ë”©: ${encodedUrl}`);
        
        return encodedUrl;
    } catch (error) {
        console.error(`[encodeImageUrl] URL ì¸ì½”ë”© ì‹¤íŒ¨: ${url}`, error);
        return url; // ì‹¤íŒ¨ ì‹œ ì›ë³¸ ë°˜í™˜
    }
}

/**
 * íŠ¹ì • ì»¨ì…‰ í´ë”ì—ì„œ ëœë¤ ë˜ëŠ” ë‹¤ìŒ ì‚¬ì§„ URLì„ ìƒì„±í•©ë‹ˆë‹¤.
 * @param {string} folderName - ì‚¬ì§„ì´ ë“¤ì–´ìˆëŠ” í´ë” ì´ë¦„ (ì´ì œ íŒŒì¼ ì´ë¦„ì˜ ì ‘ë‘ì‚¬ ì—­í• )
 * @param {number} [targetIndex=null] - íŠ¹ì • ì¸ë±ìŠ¤ì˜ ì‚¬ì§„ì„ ê°€ì ¸ì˜¬ ê²½ìš° (1ë¶€í„° ì‹œì‘)
 * @returns {string|null} ì‚¬ì§„ URL ë˜ëŠ” null
 */
function generateConceptPhotoUrl(folderName, targetIndex = null) {
    console.log(`[concept:generateConceptPhotoUrl] í´ë”ëª… (íŒŒì¼ì ‘ë‘ì‚¬): "${folderName}"`); 
    const photoCount = CONCEPT_FOLDERS[folderName];
    console.log(`[concept:generateConceptPhotoUrl] ì‚¬ì§„ ê°œìˆ˜: ${photoCount}`);
    
    // ë‹¨ì¼ íŒŒì¼ëª…ìœ¼ë¡œ ë“±ë¡ëœ ê²½ìš° ë°”ë¡œ í•´ë‹¹ íŒŒì¼ëª…ì„ ì‚¬ìš©
    if (folderName.endsWith('.jpg')) {
        const rawUrl = `${BASE_CONCEPT_URL}${folderName}`;
        const encodedUrl = encodeImageUrl(rawUrl);
        console.log(`[concept:generateConceptPhotoUrl] ë‹¨ì¼ íŒŒì¼ URL: ${encodedUrl}`);
        return encodedUrl;
    }

    if (photoCount === undefined || photoCount <= 0) {
        console.warn(`[concept.js] í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤: ${folderName}`);
        return null;
    }
    
    let indexToUse;
    if (targetIndex !== null && targetIndex >= 1 && targetIndex <= photoCount) {
        indexToUse = targetIndex;
    } else {
        indexToUse = Math.floor(Math.random() * photoCount) + 1;
    }
    console.log(`[concept:generateConceptPhotoUrl] ì‚¬ìš©í•  ì¸ë±ìŠ¤: ${indexToUse}`);

    // íŒŒì¼ëª… í˜•ì‹: "ë‚ ì§œ_ì¥ì†Œ_ì»¨ì…‰_000001.jpg"
    const fileName = `${folderName}_${String(indexToUse).padStart(6, '0')}.jpg`; 
    console.log(`[concept:generateConceptPhotoUrl] íŒŒì¼ëª…: ${fileName}`);
    
    // ìµœì¢… URLì€ BASE_CONCEPT_URL ë°”ë¡œ ì•„ë˜ íŒŒì¼ëª…ìœ¼ë¡œ êµ¬ì„±í•˜ê³  ì¸ì½”ë”© ì ìš©
    const rawUrl = `${BASE_CONCEPT_URL}${fileName}`;
    const encodedUrl = encodeImageUrl(rawUrl);
    console.log(`[concept:generateConceptPhotoUrl] ìµœì¢… ìƒì„± URL: ${encodedUrl}`);
    return encodedUrl;
}

// ë§ˆì§€ë§‰ìœ¼ë¡œ ë³´ì—¬ì¤€ ì»¨ì…‰ ì‚¬ì§„ í´ë”ë¥¼ ì €ì¥í•˜ì—¬ 'ë‹¤ë¥¸ ê²ƒë„' ìš”ì²­ ì‹œ í™œìš©
let lastConceptPhotoFolder = null;
let lastConceptPhotoIndex = 0;

/**
 * ì‚¬ìš©ì ë©”ì‹œì§€ì— ë”°ë¼ ì»¨ì…‰ ì‚¬ì§„ì„ ì„ íƒí•˜ê³ , AIê°€ ê°ì •/ì½”ë©˜íŠ¸ë¥¼ ìƒì„±í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.
 * @param {string} userMessage - ì‚¬ìš©ìì˜ ì›ë³¸ ë©”ì‹œì§€
 * @param {Function} saveLogFunc - ë¡œê·¸ ì €ì¥ì„ ìœ„í•œ saveLog í•¨ìˆ˜
 * @param {Function} callOpenAIFunc - OpenAI í˜¸ì¶œ í•¨ìˆ˜
 * @param {Function} cleanReplyFunc - ì‘ë‹µ ì •ë¦¬ í•¨ìˆ˜
 * @returns {Promise<{type: string, url?: string, caption?: string, comment?: string}|null>} ì‚¬ì§„ URLê³¼ ì½”ë©˜íŠ¸ ê°ì²´ ë˜ëŠ” null
 */
async function getConceptPhotoReply(userMessage, saveLogFunc, callOpenAIFunc, cleanReplyFunc) {
    console.log(`[concept:getConceptPhotoReply] ë©”ì‹œì§€ ìˆ˜ì‹ : "${userMessage}"`);
    const lowerCaseMessage = userMessage.toLowerCase();
    let selectedFolder = null;
    let folderDescription = '';
    let additionalPromptForYejinText = '';
    
    const conceptKeywords = ['ì»¨ì…‰ì‚¬ì§„', 'ì»¨ì…‰ ì‚¬ì§„', 'ìš•ì‹¤', 'ìš•ì¡°', 'ë‚˜ë¹„ìš•ì¡°', 'ì„¸ë¯¸ëˆ„ë“œ', 'ê²°ë°•', 'êµë³µ', 'í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ', 'í™ˆìŠ¤ëƒ…', 'ì§€ë¸Œë¦¬í’', 'ëª¨ì§€ì½”', 'í•˜ì¹´íƒ€', 'í…ì§„', 'ì•„ì´ë…¸ì‹œë§ˆ', 'í›„ì§€ì—”', 'ìœ ì¹´íƒ€', 'ë¶ˆê½ƒë†€ì´', 'ë©”ì´ë“œë³µ', 'ê³ ìŠ¤ë¡œë¦¬', 'í¬ë¦¬ìŠ¤ë§ˆìŠ¤', 'ìƒì¼ì»¨ì…‰', 'ì˜¥ìƒì—°ë¦¬', 'ì„ì§€ë¡œ', 'ì´í™”ë§ˆì„', 'ì½”ì•¼ë…¸ì„¸', 'ë¬´ì¸ì—­', 'ê³ ì¿ ë¼', 'ë²—ê½ƒ', 'ë™ë°±', 'ì˜¨ì‹¤', 'í™”ê°€', 'ë¬¸ë˜ë™', 'ë¶í•´', 'í”¼í¬ë‹‰', 'ì‚°ì±…', 'í„°ë„', 'ë§ì¹œ ì‚¬ì§„', 'ìš°ë§ˆì‹œë§ˆ', 'ë¹„ëˆ—ë°©ìš¸', 'ì•¼ê°„ê±°ë¦¬', 'ê²Œì„ì„¼í„°', 'ë™í‚¤ ê±°ë¦¬', 'ìˆ˜êµ­', 'ì½”ì´ë…¸ë³´ë¦¬', 'ë¸”ë™ì›í”¼ìŠ¤', 'í˜¸ë¦¬ì¡´', 'ì›ë¯¸ìƒê°€', 'ê¸¸ê±°ë¦¬ ìŠ¤ëƒ…', 'ì˜¤ë„', 'ë‚˜ë¥´ì‹œìŠ¤íŠ¸', 'ëˆˆë°­', 'í•„ë¦„ì¹´ë©”ë¼', 'ì²­í¬ë„', 'ë³´ë¼ëŒì´', 'ë°¤ë°”', 'ê³µì›', 'ì˜¤íƒ€ì¿ ', 'í™', 'ìº˜ë¹ˆ', 'ë„¤ì½”'];
    
    const isConceptRequest = conceptKeywords.some(keyword => lowerCaseMessage.includes(keyword));
    
    if (!isConceptRequest) {
        console.log(`[concept:getConceptPhotoReply] ì»¨ì…‰ì‚¬ì§„ ê´€ë ¨ í‚¤ì›Œë“œ ì—†ìŒ. null ë°˜í™˜.`);
        return null;
    }

    // í‚¤ì›Œë“œ ë§µ (ê¸¸ì´ì— ë”°ë¼ ì •ë ¬í•˜ì—¬ ë” êµ¬ì²´ì ì¸ í‚¤ì›Œë“œê°€ ë¨¼ì € ë§¤ì¹­ë˜ë„ë¡)
    const conceptKeywordMap = {
        '2ì›”_ìš•ì¡°': '2024_02_07_ì¼ë³¸_ìš•ì¡°', 
        '2ì›”_ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        '2ì›”_ë‚˜ë¹„ìš•ì¡°': '2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°',
        'í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ': '2024_10_17_ì¼ë³¸_í•˜ì¹´íƒ€_ê³ ë˜í‹°ì…”ì¸ ',
        'ì¼ë³¸_í™ˆìŠ¤ëƒ…': '2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…', 
        'í™ˆìŠ¤ëƒ…': '2024_05_07_ì¼ë³¸_í™ˆìŠ¤ëƒ…',
        'ì¼ë³¸_ê²°ë°•': '2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•',
        'ê²°ë°•': '2024_07_08_ì¼ë³¸_ì¼ë³¸_ê²°ë°•',
        'ì¼ë³¸_ì„ ë¬¼': '2023_12_16_ì¼ë³¸_ì„ ë¬¼', 
        'ì„ ë¬¼': '2023_12_16_ì¼ë³¸_ì„ ë¬¼',
        'í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜_00028.jpg',
        'í•œêµ­_ì…€í”„_ì´¬ì˜': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜', 
        'ì…€í”„_ì´¬ì˜': '2024_04_28_í•œêµ­_ì…€í”„_ì´¬ì˜',
        'ì˜¥ìƒì—°ë¦¬': '2024_09_15_í•œêµ­_ì˜¥ìƒì—°ë¦¬',
        'ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ': '2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ',
        'ì„¸ë¯¸ëˆ„ë“œ': '2025_02_07_ì¼ë³¸_ì„¸ë¯¸ëˆ„ë“œ',
        'í•œêµ­_í™ˆì…€í”„': '2024_12_07_í•œêµ­_í™ˆì…€í”„',
        'í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ': '2023_12_14_ì¼ë³¸_í”Œë¼ìŠ¤í‹±ëŸ¬ë¸Œ',
        'ì§€ë¸Œë¦¬í’': '2024_05_03_ì¼ë³¸_ì§€ë¸Œë¦¬í’',
        'í•œêµ­_ë¶í•´': '2024_06_06_í•œêµ­_ë¶í•´', 
        'ë¶í•´': '2024_06_06_í•œêµ­_ë¶í•´',
        'ì•„ì´ë…¸ì‹œë§ˆ': '2024_02_07_ì¼ë³¸_ì•„ì´ë…¸ì‹œë§ˆ',
        'ì¼ë³¸_í•„ë¦„': '2025_03_ì¼ë³¸_í•„ë¦„',
        'ëª¨ì§€ì½”_ëª¨ë¦¬ë£©': '2024_05_05_ì¼ë³¸_ëª¨ì§€ì½”_ëª¨ë¦¬ë£©',
        'í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼': '2023_12_31_í•œêµ­_ëˆˆë°­_í•„ë¦„_ì¹´ë©”ë¼',
        'í•œêµ­_ëˆˆë°­': '2023_12_31_í•œêµ­_ëˆˆë°­',
        'ì¼ë³¸_ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        'ì¼ë³¸_ìš•ì¡°': '2024_07_08_ì¼ë³¸_ìš•ì¡°',
        'ë‚˜ë¹„ìš•ì¡°': '2025_02_07_ì¼ë³¸_ë‚˜ë¹„ìš•ì¡°',
        'ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬': '2024_08_03_ì¼ë³¸_ìœ ì¹´íƒ€_ë§ˆì¸ ë¦¬',
        'ì´í™”ë§ˆì„': '2025_04_29_í•œêµ­_ì´í™”ë§ˆì„',
        'ìš°ë§ˆì‹œë§ˆ': '2024_07_06_ì¼ë³¸_ìš°ë§ˆì‹œë§ˆ',
        'ê°€ì„_í˜¸ìˆ˜ê³µì›': '2024_11_7_í•œêµ­_ê°€ì„_í˜¸ìˆ˜ê³µì›',
        'ë§ì¹œ_ì‚¬ì§„': '2024_06_08_í•œêµ­_ë§ì¹œ_ì‚¬ì§„',
        'ì¼ë³¸_êµë³µ': '2023_12_15_ì¼ë³¸_êµë³µ',
        'ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸': '2024_05_04_ì¼ë³¸_ì•¼ê°„_ë¹„ëˆ—ë°©ìš¸',
        'ì¼ë³¸_ëª¨ì§€ì½”': '2024_12_12_ì¼ë³¸_ëª¨ì§€ì½”',
        'í…ì§„_ì½”ë‹¥í•„ë¦„': '2024_10_18_ì¼ë³¸_í…ì§„_ì½”ë‹¥í•„ë¦„',
        'ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg': '2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©_00023.jpg',
        'ì•¼ê°„_ë¡±íŒ¨ë”©': '2024_02_23_í•œêµ­_ì•¼ê°„_ë¡±íŒ¨ë”©',
        'ì„ì§€ë¡œ_ìŠ¤ëƒ…': '2024_09_17_í•œêµ­_ì„ì§€ë¡œ_ìŠ¤ëƒ…', 
        'ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…': '2024_09_16_í•œêµ­_ê¸¸ê±°ë¦¬_ìŠ¤ëƒ…',
        'í•œêµ­_ìƒì¼_00022.jpg': '2024_02_22_í•œêµ­_ìƒì¼_00022.jpg',
        'í•œêµ­_ìƒì¼': '2024_02_22_í•œêµ­_ìƒì¼',
        'ëª¨ì§€ì½”2': '2024_07_06_ì¼ë³¸_ëª¨ì§€ì½”',
        'ì•¼ê°„_ë³´ë¼ëŒì´': '2025_05_04_í•œêµ­',
        'ì½”ì•¼ë…¸ì„¸': '2025_02_06_ì¼ë³¸_ì½”ì•¼ë…¸ì„¸',
        'ì•¼ê°„ê±°ë¦¬': '2024_05_06_ì¼ë³¸_ì•¼ê°„ê±°ë¦¬', 
        'ìƒì¼ì»¨ì…‰': '2024_12_31_í•œêµ­_ìƒì¼ì»¨ì…‰',
        'í™ˆìŠ¤ëƒ…_ì²­í¬ë„': '2025_05_03_í•œêµ­_í™ˆìŠ¤ëƒ…_ì²­í¬ë„',
        'ìš•ì‹¤_ë¸”ë™_ì›¨ë”©': '2024_11_08_í•œêµ­_ìš•ì‹¤_ë¸”ë™_ì›¨ë”©',
        'í˜¸ë¦¬ì¡´': '2024_09_11_í•œêµ­_í˜¸ë¦¬ì¡´',
        'ì—¬ì¹œ_ìŠ¤ëƒ…': '2024_07_08_ì¼ë³¸_ì—¬ì¹œ_ìŠ¤ëƒ…',
        'í›„ì§€ì—”': '2024_05_03_ì¼ë³¸_í›„ì§€ì—”',
        'ë¶ˆê½ƒë†€ì´': '2024_08_02_ì¼ë³¸_ë¶ˆê½ƒë†€ì´', 
        'ë¹¨ê°„_ê¸°ëª¨ë…¸': '2024_10_19_ì¼ë³¸_ë¹¨ê°„_ê¸°ëª¨ë…¸',
        'í”¼í¬ë‹‰': '2024_06_07_í•œêµ­__í”¼í¬ë‹‰',
        'ë²—ê½ƒ': '2024_04_12_í•œêµ­_ë²—ê½ƒ',
        'í›„ì§€_ìŠ¤ëƒ…': '2025_05_06_ë§ˆì§€ë§‰_í•œêµ­_í›„ì§€ìŠ¤ëƒ…',
        'ì›ë¯¸ìƒê°€_í•„ë¦„': '2024_09_14_í•œêµ­_ì›ë¯¸ìƒê°€_í•„ë¦„', 
        'ë°¤ë°”_ì‚°ì±…': '2025_05_04_í•œêµ­_ë°¤ë°”_ì‚°ì±…',
        'ê³µì›_ì‚°ì±…': '2025_05_04_í•œêµ­_ê³µì›_ì‚°ì±…', 
        'ê³ ì¿ ë¼_í™': '2025_03_14_ì¼ë³¸_ê³ ì¿ ë¼',
        'ì˜¨ì‹¤_ì—¬ì‹ ': '2024_04_13_í•œêµ­_ì˜¨ì‹¤_ì—¬ì‹ ', 
        'ì„ì§€ë¡œ_ë„¤ì½”': '2025_04_30_í•œêµ­_ì„ì§€ë¡œ',
        'ë¬´ì¸ì—­': '2025_03_13_ì¼ë³¸_ë¬´ì¸ì—­', 
        'í™”ê°€': '2024_04_13_í•œêµ­_í™”ê°€',
        'ë¸”ë™ì›í”¼ìŠ¤': '2024_08_04_ì¼ë³¸_ë¸”ë™ì›í”¼ìŠ¤', 
        'ì¹´í˜': '2024_12_30_í•œêµ­_ì¹´í˜',
        'ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸': '2024_10_17_ì¼ë³¸_í…ì§„_ìŠ¤íŠ¸ë¦¬íŠ¸',
        'í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸': '2023_12_12_ì¼ë³¸_í•˜ì¹´íƒ€_ìŠ¤íŠ¸ë¦¬íŠ¸',
        'í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ': '2025_05_05_í•œêµ­_í™ˆìŠ¤ëƒ…_ì˜¤íƒ€ì¿ ',
        'ì•¼ê°„_ë™ë°±': '2024_04_12_í•œêµ­_ì•¼ê°„_ë™ë°±',
        'ë‚˜ë¥´ì‹œìŠ¤íŠ¸': '2024_12_14_ì¼ë³¸_ë‚˜ë¥´ì‹œìŠ¤íŠ¸', 
        'ì„ì§€ë¡œ_ìº˜ë¹ˆ': '2025_04_30_í•œêµ­_ì„ì§€ë¡œ_ìº˜ë¹ˆ',
        'ì‚°ì±…_0000009.jpg': '2024_06_09_í•œêµ­_ì‚°ì±…_0000009.jpg',
        'ì‚°ì±…_0000109.jpg': '2024_06_09_í•œêµ­_ì‚°ì±…_0000109.jpg',
        'ì‚°ì±…': '2024_06_09_í•œêµ­_ì‚°ì±…',
        'ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„': '2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›_í›„ì§€í•„ë¦„', 
        'í¬ë¦¬ìŠ¤ë§ˆìŠ¤': '2024_12_13_ì¼ë³¸_í¬ë¦¬ìŠ¤ë§ˆìŠ¤',
        'ë„¤ì½”_ëª¨ì§€ì½”': '2024_02_11_ì¼ë³¸_ë„¤ì½”_ëª¨ì§€ì½”',
        'ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤': '2024_02_11_ì¼ë³¸_ì•¼ê°„_ë¸”ë™ë“œë ˆìŠ¤',
        'ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ': '2024_10_16_ì¼ë³¸_ê³ ìŠ¤ë¡œë¦¬_í• ë¡œìœˆ',
        'ê²Œì„ì„¼í„°': '2024_05_07_ì¼ë³¸_ê²Œì„ì„¼í„°',
        'ë™í‚¤_ê±°ë¦¬': '2024_05_02_ì¼ë³¸_ë™í‚¤_ê±°ë¦¬',
        'ê³ ì¿ ë¼_ì•¼ê°„': '2025_03_17_ì¼ë³¸_ê³ ì¿ ë¼',
        'ì½”ì´ë…¸ë³´ë¦¬': '2024_05_05_ì¼ë³¸_ì½”ì´ë…¸ë³´ë¦¬', 
        'ë¬¸ë˜ë™': '2024_04_13_í•œêµ­_ë¬¸ë˜ë™',
        'ìˆ˜êµ­': '2024_05_03_ì¼ë³¸_ìˆ˜êµ­',
        'ë©”ì´ë“œë³µ': '2024_11_08_í•œêµ­_ë©”ì´ë“œë³µ',
        'ì˜¤ë„ê³µì›': '2024_10_16_ì¼ë³¸_ì˜¤ë„ê³µì›',
        'ìš•ì‹¤': '2024_02_07_ì¼ë³¸_ìš•ì‹¤',
        'ìš•ì¡°': '2024_07_08_ì¼ë³¸_ìš•ì¡°'
    };
    
module.exports = {
    getConceptPhotoReply,
    validateImageUrl,
    encodeImageUrl
};
